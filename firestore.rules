rules_version='2'

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================
    // REGLAS DE SEGURIDAD CON AUTENTICACIÓN OBLIGATORIA
    // ============================================
    // IMPORTANTE: Todas las operaciones requieren que el usuario esté autenticado
    // Sin autenticación, NO se puede leer ni escribir NADA
    
    // Colección de paneles TFT - REQUIERE AUTENTICACIÓN
    match /paneles/{panelId} {
      allow read: if request.auth != null; // SOLO usuarios autenticados
      allow create: if request.auth != null 
                    && request.resource.data.keys().hasAll(['municipio', 'codigo'])
                    && request.resource.data.municipio is string
                    && request.resource.data.codigo is string;
      allow update: if request.auth != null
                    && request.resource.data.keys().hasAll(['municipio', 'codigo']);
      allow delete: if request.auth != null;
    }
    
    // Colección de incidencias - REQUIERE AUTENTICACIÓN
    match /incidencias/{incidenciaId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null
                    && request.resource.data.keys().hasAll(['panelId', 'descripcion', 'estado', 'fecha'])
                    && request.resource.data.estado in ['abierta', 'en_proceso', 'cerrada'];
      allow update: if request.auth != null;
      allow delete: if request.auth != null;
    }
    
    // Colección de facturas - REQUIERE AUTENTICACIÓN
    match /facturas/{facturaId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null
                    && request.resource.data.keys().hasAll(['clienteId', 'mes', 'año', 'total'])
                    && request.resource.data.total is number
                    && request.resource.data.total >= 0;
      allow update: if request.auth != null;
      allow delete: if request.auth != null;
    }
    
    // Colección de históricos mensuales - REQUIERE AUTENTICACIÓN
    match /historicos/{historicoId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }
    
    // Colección de operadores - REQUIERE AUTENTICACIÓN
    match /operadores/{operadorId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }
  }
}
