<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Paneles TFT – CRTM</title>
    
    <!-- TailwindCSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts - Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
    
    <!-- Firebase SDK v11 - Modular -->
    <script type="module">
      // ============================================
      // IMPORTAR FIREBASE MODULES
      // ============================================
      import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js';
      import { getFirestore, collection, getDocs, query, orderBy } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js';
      import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut, setPersistence, browserLocalPersistence } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js';
      
      // ============================================
      // CONFIGURACIÓN“N FIREBASE
      // ============================================
      const firebaseConfig = {
        apiKey: "AIzaSyBtOWKZh8WelWpsXIbsk_AWb7hBSJVUP3Y",
        authDomain: "piv-manager.firebaseapp.com",
        projectId: "piv-manager",
        storageBucket: "piv-manager.firebasestorage.app",
        messagingSenderId: "984787325363",
        appId: "1:984787325363:web:3b34b5dad3c3fde846fbc6"
      };
      
      // Inicializar Firebase
      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const auth = getAuth(app);
      
    // Configurar persistencia de sesión
      setPersistence(auth, browserLocalPersistence);
      
    console.log('✓ Firebase inicializado correctamente');
      
            // ============================================
            // FUNCIONES DE CONTROL DE PANTALLAS
            // ============================================

            // Normalizador de acentos/símbolos para corregir textos mal codificados en el DOM
            function normalizeAccents(root = document.body) {
                const pairs = [
                    ['Ã¡','á'], ['Ã©','ñ'], ['Ã­','í'], ['Ã³','ñ'], ['Ãº','ú'],
                    ['Ã','Á'], ['Ã‰','ñ'], ['Ã','Í'], ['Ã“','ñ'], ['Ãš','Ú'],
                    ['Ã±','ñ'], ['Ã‘','Ñ'], ['Ã¼','ü'], ['Ãœ','Ü'],
                    ['Â¿','¿'], ['Â¡','¡'], ['Âº','º'], ['Âª','ª'], ['Â·','·'], ['Â',''],
                      ['â€“','–'], ['â€”','—'], ['â€¦','…'], ['â€œ','“'], ['â€','”'], ['â€¢','•'],
                      ['â‚¬','€'], ['â„¢','™'], ['âœ…','✓'], ['âŒ','✖'], ['âš ï¸','⚠️'],
                      ['‚¬','€'], ['œ…','✓'], ['ñ—','×'], ['ðŸ“',''], ['ðŸ“…',''], ['ðŸ“ˆ',''], ['ðŸ“‰',''], ['ðŸ“¦',''], ['ðŸ’°',''],
                      ['ñ³','ñ'], ['ñº','ñ']
                ];

                const replaceAll = (text) => {
                    let out = text;
                    for (const [k, v] of pairs) {
                        if (out && out.includes(k)) out = out.split(k).join(v);
                    }
                    return out;
                };

                // Corrige título
                if (document.title) document.title = replaceAll(document.title);

                // Corrige nodos de texto
                const walker = document.createTreeWalker(root, NodeFilter.SHOW_TEXT, null);
                const toUpdate = [];
                while (walker.nextNode()) toUpdate.push(walker.currentNode);
                for (const node of toUpdate) {
                    const fixed = replaceAll(node.nodeValue);
                    if (fixed !== node.nodeValue) node.nodeValue = fixed;
                }

                // Corrige atributos comunes
                const attrNames = ['placeholder', 'title', 'aria-label', 'alt', 'value'];
                root.querySelectorAll('*').forEach(el => {
                    for (const a of attrNames) {
                        if (el.hasAttribute(a)) {
                            const val = el.getAttribute(a);
                            const fixed = replaceAll(val);
                            if (fixed !== val) el.setAttribute(a, fixed);
                        }
                    }
                });
            }
      
            function mostrarPantallaLogin() {
        const loginScreen = document.getElementById('loginScreen');
        if (loginScreen) loginScreen.style.display = 'flex';
                // Normaliza posibles textos mal codificados
                normalizeAccents();
      }
      
      function ocultarPantallaLogin() {
        const loginScreen = document.getElementById('loginScreen');
        if (loginScreen) loginScreen.style.display = 'none';
      }
      
            function mostrarAplicacion() {
        const appContainer = document.getElementById('appContainer');
        if (appContainer) appContainer.classList.add('visible');
                // Normaliza textos de toda la app (cabecera, cards, listas, etc.)
                normalizeAccents();
      }
      
            function ocultarAplicacion() {
        const appContainer = document.getElementById('appContainer');
        if (appContainer) appContainer.classList.remove('visible');
      }

            // Normaliza al cargar el documento por primera vez
            document.addEventListener('DOMContentLoaded', () => normalizeAccents());
      
      async function iniciarAplicacion(user) {
        console.log('½ Iniciando aplicaciñ³n para:', user.email);
        
        // Actualizar informaciñ³n del usuario en el header
        const userPhoto = document.getElementById('userPhoto');
        const userName = document.getElementById('userName');
        const userEmail = document.getElementById('userEmail');
        
        if (userPhoto) {
          userPhoto.src = user.photoURL || 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="50" height="50"><circle cx="25" cy="25" r="25" fill="%231e3a5f"/><text x="25" y="32" text-anchor="middle" fill="white" font-size="20" font-family="Arial">ðŸ‘¤</text></svg>';
        }
        if (userName) userName.textContent = user.displayName || 'Usuario';
        if (userEmail) userEmail.textContent = user.email;
        
        // Ocultar login y mostrar app
        ocultarPantallaLogin();
        mostrarAplicacion();
        
        // Cargar datos iniciales
        if (window.loadInitialData) {
          await window.loadInitialData();
        }
      }
      
      function cerrarAplicacion() {
        console.log('”’ Cerrando aplicaciñ³n');
        
        // Ocultar app y mostrar login
        ocultarAplicacion();
        mostrarPantallaLogin();
        
        // Limpiar datos sensibles si es necesario
        // (Los datos se mantendrán en memoria pero la UI estará oculta)
      }
      
      // ============================================
      // FUNCIONES DE AUTENTICACIñ“N
      // ============================================
      
      window.iniciarSesionConGoogle = async function() {
        const provider = new GoogleAuthProvider();
        
        try {
          const result = await signInWithPopup(auth, provider);
          console.log('Login exitoso:', result.user.email);
          
        } catch (error) {
          console.error('Error en login:', error);
          
          if (error.code === 'auth/popup-closed-by-user') {
            alert('Inicio de sesion cancelado');
          } else if (error.code === 'auth/network-request-failed') {
            alert('No hay conexion. Verifica tu internet');
          } else if (error.code === 'auth/unauthorized-domain') {
            alert('Dominio no autorizado. Contacta al administrador');
          } else {
            alert('Error al iniciar sesion. Intenta de nuevo');
          }
        }
      };
      
      window.cerrarSesion = async function() {
    const confirmar = confirm('¿Seguro que quieres cerrar sesión?');
        
        if (!confirmar) return;
        
        try {
          await signOut(auth);
          console.log('✓ Logout exitoso');
        } catch (error) {
          console.error('✖ Error en logout:', error);
          alert('Error al cerrar sesión');
        }
      };
      
      // ============================================
      // MONITOREAR ESTADO DE AUTENTICACIñ“N
      // ============================================
      
      onAuthStateChanged(auth, async (user) => {
        if (user) {
          // Usuario autenticado
          console.log('‘¤ Usuario autenticado:', user.email);
          await iniciarAplicacion(user);
        } else {
          // Usuario no autenticado
          console.log('‘¤ Usuario no autenticado');
          cerrarAplicacion();
        }
      });
      
      // ============================================
      // FUNCIñ“N PARA CARGAR PANELES DESDE FIRESTORE
      // ============================================
      
      window.cargarPanelesDesdeFirestore = async function() {
        try {
          console.log('“¥ Cargando paneles desde Firestore...');
          
          // Verificar que el usuario estñ© autenticado
          if (!auth.currentUser) {
            throw new Error('No hay usuario autenticado');
          }
          
          const q = query(collection(db, 'paneles'), orderBy('municipio'));
          const snapshot = await getDocs(q);
          
          const panelesFirestore = [];
          snapshot.forEach((doc) => {
            const data = doc.data();
            panelesFirestore.push({
              id: doc.id,
              municipio: data.municipio,
              codigo: data.codigo,
              fechaInstalacion: data.fechaInstalacion,
              fechaDesmontaje: data.fechaDesmontaje,
              estado: data.estado || (data.fechaDesmontaje ? 'desmontado' : 'activo'),
              operador: data.operador || 'UTE'
            });
          });
          
          console.log(`✓ ${panelesFirestore.length} paneles cargados desde Firestore`);
          
          return panelesFirestore;
        } catch (error) {
          console.error('✖ Error al cargar desde Firestore:', error);
          
          // Si es error de autenticaciñ³n, mostrar mensaje especial
          if (error.code === 'permission-denied' || error.message.includes('autenticado')) {
            alert('✖ sesión expirada. Por favor inicia sesión de nuevo');
            await signOut(auth);
          }
          
          return [];
        }
      };
      
      // Hacer disponibles globalmente
      window.firebaseApp = app;
      window.firebaseDB = db;
      window.firebaseAuth = auth;
    </script>
    
    <style>
        /* ============================================
           DISEñ‘O MINIMALISTA ESPAñ‘OL
           Inspiraciñ³n: Stripe, Vercel, GitHub moderno
           ============================================ */
        :root {
            /* Colores minimalistas */
            --black: #000000;
            --gray-dark: #374151;
            --gray: #6B7280;
            --gray-light: #D1D5DB;
            --gray-lighter: #F3F4F6;
            --white: #FFFFFF;
            --blue: #2563EB;
            --green: #10B981;
            --red: #EF4444;
            --orange: #F59E0B;
            
            /* Espaciado consistente */
            --space-xs: 8px;
            --space-sm: 16px;
            --space-md: 24px;
            --space-lg: 32px;
            --space-xl: 48px;
            --space-2xl: 64px;
            
            /* Bordes */
            --border-radius: 12px;
            --border-color: var(--gray-light);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Inter', 'Helvetica Neue', Arial, sans-serif;
            background: var(--white);
            color: var(--black);
            line-height: 1.6;
            font-size: 15px;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 var(--space-md);
        }

        /* ============================================
           HEADER MINIMALISTA
           ============================================ */
        .minimal-header {
            background: var(--white);
            border-bottom: 1px solid var(--border-color);
            padding: var(--space-md) 0;
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.95);
        }

        .minimal-header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 var(--space-md);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .minimal-logo {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }

        .minimal-logo-text {
            font-size: 20px;
            font-weight: 700;
            color: var(--black);
            letter-spacing: -0.5px;
        }

        .minimal-logo-subtitle {
            font-size: 13px;
            color: var(--gray);
            font-weight: 400;
            margin-left: var(--space-sm);
            padding-left: var(--space-sm);
            border-left: 1px solid var(--gray-light);
        }

        .minimal-user {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }

        .minimal-user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: 2px solid var(--gray-lighter);
        }

        .minimal-user-info {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }

        .minimal-user-name {
            font-size: 13px;
            font-weight: 600;
            color: var(--black);
        }

        .minimal-user-email {
            font-size: 12px;
            color: var(--gray);
        }

        .minimal-btn-logout {
            padding: 8px 16px;
            background: var(--white);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            color: var(--gray-dark);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .minimal-btn-logout:hover {
            background: var(--gray-lighter);
            border-color: var(--gray);
        }

        /* ============================================
           SECCIñ“N PRINCIPAL
           ============================================ */
        .minimal-main {
            max-width: 1200px;
            margin: 0 auto;
            padding: var(--space-2xl) var(--space-md);
        }

        .minimal-section-title {
            font-size: 28px;
            font-weight: 700;
            color: var(--black);
            margin-bottom: var(--space-xs);
            letter-spacing: -0.5px;
        }

        .minimal-section-subtitle {
            font-size: 15px;
            color: var(--gray);
            margin-bottom: var(--space-xl);
        }

        /* ============================================
           CARDS DE ESTADñSTICAS XXL
           ============================================ */
        .minimal-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: var(--space-2xl);
        }

        .minimal-stat-card {
            background: var(--white);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 28px;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-height: 180px;
        }

        .minimal-stat-card:hover {
            border-color: var(--gray);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.04);
        }

        .minimal-stat-label {
            font-size: 14px;
            font-weight: 600;
            color: var(--gray);
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .minimal-stat-value {
            font-size: 56px;
            font-weight: 700;
            color: var(--black);
            line-height: 1.1;
            letter-spacing: -1.5px;
            margin-bottom: 8px;
            word-break: break-word;
        }

        .minimal-stat-detail {
            font-size: 15px;
            color: var(--gray);
            font-weight: 500;
        }

        /* ============================================
           LISTA DE PANELES MINIMALISTA
           ============================================ */
        .minimal-list-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--space-md);
        }

        .minimal-list-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--black);
        }

        .minimal-btn-primary {
            padding: 12px 24px;
            background: var(--blue);
            color: var(--white);
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .minimal-btn-primary:hover {
            background: #1D4ED8;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2);
        }

        .minimal-search-box {
            margin-bottom: var(--space-md);
        }

        .minimal-search-input {
            width: 100%;
            max-width: 500px;
            padding: 12px 16px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 15px;
            font-family: inherit;
            transition: all 0.2s ease;
        }

        .minimal-search-input:focus {
            outline: none;
            border-color: var(--blue);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .minimal-list {
            background: var(--white);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            overflow: hidden;
        }

        .minimal-list-item {
            padding: var(--space-md);
            border-bottom: 1px solid var(--gray-lighter);
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .minimal-list-item:last-child {
            border-bottom: none;
        }

        .minimal-list-item:hover {
            background: var(--gray-lighter);
        }

        .minimal-list-item-main {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .minimal-list-item-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--black);
        }

        .minimal-list-item-separator {
            color: var(--gray-light);
            margin: 0 12px;
        }

        .minimal-list-item-meta {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 14px;
            color: var(--gray);
        }

        .minimal-list-item-detail {
            display: flex;
            align-items: center;
            gap: var(--space-md);
            font-size: 14px;
            color: var(--gray);
        }

        .minimal-list-item-price {
            font-size: 15px;
            font-weight: 600;
            color: var(--black);
        }

        .minimal-badge {
            padding: 4px 12px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 600;
        }

        .minimal-badge-green {
            background: rgba(16, 185, 129, 0.1);
            color: var(--green);
        }

        .minimal-badge-gray {
            background: var(--gray-lighter);
            color: var(--gray);
        }

        .minimal-badge-orange {
            background: rgba(245, 158, 11, 0.1);
            color: var(--orange);
        }

        .minimal-list-item-actions {
            display: flex;
            gap: 8px;
        }

        .minimal-btn-icon {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            background: var(--white);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 16px;
        }

        .minimal-btn-icon:hover {
            background: var(--gray-lighter);
            border-color: var(--gray);
        }

        /* ============================================
           BOTñ“N FLOTANTE
           ============================================ */
        .minimal-fab {
            position: fixed;
            bottom: 32px;
            right: 32px;
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background: var(--green);
            color: var(--white);
            border: none;
            box-shadow: 0 4px 16px rgba(16, 185, 129, 0.3);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            font-weight: 300;
            transition: all 0.3s ease;
            z-index: 90;
        }

        .minimal-fab:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 24px rgba(16, 185, 129, 0.4);
        }

        .minimal-fab:active {
            transform: scale(0.95);
        }

        /* ============================================
           SECCIñ“N DE PANELES
           ============================================ */
        .minimal-panels-section {
            margin-top: var(--space-2xl);
        }

        .minimal-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-xl);
            gap: var(--space-lg);
        }

        .minimal-list-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--space-lg);
            background: var(--white);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: var(--space-xs);
            transition: all 0.2s ease;
        }

        .minimal-list-item:hover {
            border-color: var(--gray);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        }

        .minimal-list-item-info {
            flex: 1;
            display: flex;
            align-items: center;
            gap: var(--space-lg);
        }

        .minimal-list-item-main {
            display: flex;
            align-items: center;
            gap: var(--space-md);
            min-width: 300px;
        }

        .minimal-list-item-municipio {
            font-size: 15px;
            font-weight: 600;
            color: var(--black);
        }

        .minimal-list-item-codigo {
            font-size: 14px;
            color: var(--gray);
            font-family: 'Monaco', 'Courier New', monospace;
        }

        .minimal-list-item-separator {
            color: var(--border-color);
            font-weight: 300;
        }

        .minimal-list-item-meta {
            display: flex;
            gap: var(--space-xl);
        }

        .minimal-list-item-stat {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .minimal-list-item-stat-label {
            font-size: 12px;
            color: var(--gray);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .minimal-list-item-stat-value {
            font-size: 15px;
            font-weight: 600;
            color: var(--black);
        }

        .minimal-list-item-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .minimal-badge-active {
            background: #DCFCE7;
            color: #166534;
        }

        .minimal-badge-paused {
            background: #FEF3C7;
            color: #92400E;
        }

        .minimal-badge-dismounted {
            background: #F3F4F6;
            color: #6B7280;
        }

        .minimal-list-item-actions {
            display: flex;
            gap: var(--space-sm);
        }

        .minimal-action-btn {
            width: 36px;
            height: 36px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            background: var(--white);
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            font-size: 14px;
        }

        .minimal-action-btn:hover {
            border-color: var(--blue);
            background: var(--background);
            transform: scale(1.05);
        }

        .minimal-action-btn.edit:hover {
            border-color: var(--blue);
            color: var(--blue);
        }

        .minimal-action-btn.delete:hover {
            border-color: var(--red);
            color: var(--red);
        }

        /* ============================================
           ANIMACIONES
           ============================================ */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fade-in {
            animation: fadeIn 0.3s ease forwards;
        }

        /* ============================================
           ESTILOS COMPATIBLES CON Cñ“DIGO EXISTENTE
           ============================================ */
        .vesta-nav {
            display: flex;
            align-items: center;
            gap: 0;
            overflow-x: auto;
            padding: 0 20px;
        }

        .vesta-nav-tab {
            padding: 16px 24px;
            color: rgba(255,255,255,0.8);
            text-decoration: none;
            font-weight: 500;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            cursor: pointer;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .vesta-nav-tab:hover {
            background: rgba(255,255,255,0.05);
            color: white;
        }

        .vesta-nav-tab.active {
            color: white;
            border-bottom-color: var(--vesta-orange);
            background: rgba(255,255,255,0.05);
        }

        .vesta-badge {
            background: var(--vesta-orange);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            min-width: 20px;
            text-align: center;
        }

        /* ============================================
           SUBBARRA DE ACCIONES
           ============================================ */
        .vesta-actionbar {
            background: white;
            border-bottom: 1px solid var(--vesta-border);
            padding: 12px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .vesta-btn-outline {
            padding: 8px 16px;
            border: 1px solid var(--vesta-border);
            background: white;
            color: var(--vesta-text);
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .vesta-btn-outline:hover {
            border-color: var(--vesta-gray);
            background: var(--vesta-hover);
        }

        .vesta-search {
            flex: 1;
            max-width: 400px;
            position: relative;
        }

        .vesta-search input {
            width: 100%;
            padding: 8px 36px 8px 12px;
            border: 1px solid var(--vesta-border);
            border-radius: 6px;
            font-size: 13px;
        }

        .vesta-search-icon {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--vesta-text-muted);
        }

        /* ============================================
           CONTENIDO PRINCIPAL
           ============================================ */
        .vesta-content {
            padding: 20px;
        }

        .vesta-card {
            background: var(--vesta-card);
            border: 1px solid var(--vesta-border);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
        }

        .vesta-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            transform: translateY(-2px);
        }

        .vesta-card-row {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .vesta-card-info {
            flex: 1;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .vesta-card-field {
            display: flex;
            flex-direction: column;
        }

        .vesta-card-label {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--vesta-text-muted);
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .vesta-card-value {
            font-size: 14px;
            font-weight: 500;
            color: var(--vesta-text);
        }

        .vesta-card-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        /* ============================================
           BOTONES DE ACCIñ“N
           ============================================ */
        .vesta-btn-action {
            width: 36px;
            height: 36px;
            border-radius: 6px;
            border: 1px solid var(--vesta-border);
            background: white;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            position: relative;
        }

        .vesta-btn-action:hover {
            transform: scale(1.1);
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        .vesta-btn-action.edit {
            border-color: var(--vesta-green);
            color: var(--vesta-green);
        }

        .vesta-btn-action.edit:hover {
            background: var(--vesta-green);
            color: white;
        }

        .vesta-btn-action.delete {
            border-color: var(--vesta-red);
            color: var(--vesta-red);
        }

        .vesta-btn-action.delete:hover {
            background: var(--vesta-red);
            color: white;
        }

        .vesta-btn-action.suspend {
            border-color: var(--vesta-text-muted);
            color: var(--vesta-text-muted);
        }

        .vesta-btn-action.suspend:hover {
            background: var(--vesta-text-muted);
            color: white;
        }

        /* ============================================
           BOTñ“N FLOTANTE (+)
           ============================================ */
        .vesta-fab {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--vesta-green);
            color: white;
            border: none;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            font-weight: 300;
            transition: all 0.3s ease;
            z-index: 90;
        }

        .vesta-fab:hover {
            transform: scale(1.1) rotate(90deg);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.5);
        }

        .vesta-fab:active {
            transform: scale(0.95) rotate(90deg);
        }

        /* ============================================
           TOOLTIPS
           ============================================ */
        [data-tooltip] {
            position: relative;
        }

        [data-tooltip]:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%) translateY(-8px);
            background: var(--vesta-topbar);
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 1000;
            opacity: 0;
            animation: tooltipFadeIn 0.2s forwards;
        }

        @keyframes tooltipFadeIn {
            to { opacity: 1; transform: translateX(-50%) translateY(-4px); }
        }

        /* ============================================
           STATS DASHBOARD
           ============================================ */
        .vesta-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .vesta-stat-card {
            background: white;
            border: 1px solid var(--vesta-border);
            border-radius: 12px;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 16px;
            transition: all 0.2s;
        }

        .vesta-stat-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }

        .vesta-stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .vesta-stat-icon.green {
            background: rgba(16, 185, 129, 0.1);
            color: var(--vesta-green);
        }

        .vesta-stat-icon.orange {
            background: rgba(249, 115, 22, 0.1);
            color: var(--vesta-orange);
        }

        .vesta-stat-icon.red {
            background: rgba(239, 68, 68, 0.1);
            color: var(--vesta-red);
        }

        .vesta-stat-icon.blue {
            background: rgba(59, 130, 246, 0.1);
            color: var(--vesta-blue);
        }

        .vesta-stat-content {
            flex: 1;
        }

        .vesta-stat-label {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--vesta-text-muted);
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .vesta-stat-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--vesta-text);
            line-height: 1;
        }

        .header {
            background: var(--bg);
            color: white;
            padding: 40px 32px;
            text-align: center;
            border-radius: 12px;
            margin-bottom: 24px;
        }

        .header h1 {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 8px;
            letter-spacing: -0.5px;
        }

        .header p {
            font-size: 16px;
            opacity: 0.85;
            font-weight: 400;
        }

        .card {
            background: var(--white);
            border-radius: var(--border-radius);
            padding: 28px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
            box-shadow: 0 1px 3px rgba(0,0,0,0.04);
        }

        .card-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--black);
            margin-bottom: 20px;
            letter-spacing: -0.3px;
        }

        .control-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-bottom: 16px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
        }

        label {
            font-size: 14px;
            font-weight: 600;
            color: var(--gray);
            margin-bottom: 8px;
            letter-spacing: 0;
        }

        input, select {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 16px;
            font-family: inherit;
            background: var(--white);
            color: var(--black);
            transition: all 0.2s ease;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--blue);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        button {
            width: 100%;
            height: auto;
            min-height: 48px;
            padding: 14px 20px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.15s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }

        button:focus-visible {
            outline: 2px solid var(--blue);
            outline-offset: 2px;
        }

        button:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .btn-primary {
            background: var(--blue);
            color: var(--white);
        }

        .btn-primary:hover:not(:disabled) {
            background: #1D4ED8;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2);
        }

        .btn-secondary {
            background: var(--white);
            color: var(--black);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover:not(:disabled) {
            background: var(--background);
            border-color: var(--gray);
        }

        .btn-success {
            background: var(--green);
            color: var(--white);
        }

        .btn-success:hover:not(:disabled) {
            background: #059669;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.2);
        }

        .btn-danger {
            background: var(--red);
            color: var(--white);
        }

        .btn-danger:hover:not(:disabled) {
            background: #DC2626;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.2);
        }

        .btn-warning {
            background: var(--orange);
            color: var(--white);
        }

        .btn-warning:hover:not(:disabled) {
            background: #EA580C;
            box-shadow: 0 4px 12px rgba(249, 115, 22, 0.2);
        }

        .actions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 14px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: var(--vesta-card);
            border: 1px solid var(--vesta-border);
            padding: 24px;
            border-radius: 12px;
            text-align: center;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-height: 140px;
        }

        .stat-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }

        .stat-card h3 {
            font-size: 12px;
            font-weight: 600;
            color: var(--vesta-text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
        }

        .stat-card .value {
            font-size: 36px;
            font-weight: 700;
            color: var(--vesta-text);
            line-height: 1.2;
            word-break: break-word;
        }

        .table-container {
            background: var(--vesta-card);
            border-radius: 12px;
            padding: 24px;
            border: 1px solid var(--vesta-border);
            overflow-x: auto;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .search-box input {
            width: 100%;
            max-width: 400px;
            height: 44px;
            padding: 0 var(--space-lg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 15px;
            background: var(--white);
            transition: all 0.2s ease;
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--blue);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .search-box input::placeholder {
            color: var(--gray);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: var(--vesta-card);
        }

        th {
            background: var(--vesta-topbar);
            color: white;
            padding: 12px 16px;
            text-align: left;
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        td {
            padding: 12px 16px;
            border-bottom: 1px solid var(--vesta-border);
            color: var(--vesta-text);
            font-size: 13px;
        }

        tr:hover {
            background: var(--vesta-hover);
        }

        .actions {
            display: flex;
            gap: 8px;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
            width: auto;
            height: auto;
            font-weight: 500;
        }

        .partial-badge {
            background: var(--warn);
            color: white;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--white);
            padding: 32px;
            border-radius: 12px;
            max-width: 540px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
            border: 1px solid var(--border-color);
        }

        .hidden {
            display: none !important;
        }

        .modal-header {
            margin-bottom: 24px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            color: var(--black);
            font-size: 22px;
            font-weight: 600;
            margin: 0;
        }

        .close-modal {
            font-size: 24px;
            font-weight: 400;
            cursor: pointer;
            color: var(--gray);
            line-height: 1;
            transition: color 0.2s ease;
            background: none;
            border: none;
            padding: 0;
            width: auto;
            height: auto;
        }

        .close-modal:hover {
            color: var(--black);
        }

        /* ============================================
           RESPONSIVE DESIGN MINIMALISTA
           ============================================ */
        @media (max-width: 1024px) {
            .minimal-stats {
                grid-template-columns: repeat(2, 1fr);
            }
            .minimal-stat-value {
                font-size: 40px;
            }
            .minimal-section-header {
                flex-direction: column;
                align-items: flex-start;
                gap: var(--space-md);
            }
            .search-box input {
                max-width: 100%;
            }
        }

        @media (max-width: 768px) {
            .minimal-header-content {
                flex-direction: column;
                gap: var(--space-sm);
                align-items: flex-start;
            }
            
            .minimal-logo-subtitle {
                display: none;
            }
            
            .minimal-user {
                width: 100%;
                justify-content: space-between;
            }
            
            .minimal-main {
                padding: 24px 16px;
            }
            
            .minimal-section-title {
                font-size: 26px;
            }
            
            .minimal-stats {
                grid-template-columns: 1fr;
                gap: 16px;
            }
            
            .minimal-stat-value {
                font-size: 44px;
            }
            
            .minimal-stat-card {
                padding: 24px;
                min-height: 160px;
            }
            
            .minimal-section-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .search-box input {
                max-width: 100%;
            }
            
            .minimal-list-item {
                flex-direction: column;
                gap: var(--space-md);
                align-items: flex-start;
            }
            
            .minimal-list-item-info {
                flex-direction: column;
                width: 100%;
                gap: var(--space-md);
            }
            
            .minimal-list-item-main {
                min-width: auto;
                flex-direction: column;
                align-items: flex-start;
                gap: 4px;
            }
            
            .minimal-list-item-meta {
                width: 100%;
                justify-content: space-between;
            }
            
            .minimal-list-item-actions {
                width: 100%;
                justify-content: space-between;
            }
            
            .minimal-fab {
                width: 56px;
                height: 56px;
                bottom: 20px;
                right: 20px;
                font-size: 28px;
            }
            
            .actions-grid {
                grid-template-columns: 1fr;
            }
            
            .stats {
                grid-template-columns: 1fr;
            }
            
            .card {
                padding: 24px;
            }
            
            .control-row {
                grid-template-columns: 1fr;
                gap: 14px;
            }
        }

        /* ============================================
           ESTILOS LEGACY (Mantener compatibilidad)
           ============================================ */
        .actions-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        /* Estilos para botñ³n principal de Cambios del mes */
        .btn-primary-large {
            background: linear-gradient(135deg, #1E3A8A 0%, #3B82F6 100%);
            color: white;
            border: none;
            padding: 16px 32px;
            font-size: 16px;
            font-weight: 600;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(30, 58, 138, 0.3);
            position: relative;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary-large:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(30, 58, 138, 0.4);
        }

        .btn-primary-large:active {
            transform: translateY(0);
        }

        /* Contenedor de dropdown y menú */
        .monthly-changes-container {
            position: relative;
            display: inline-block;
        }

        .dropdown-menu {
            position: absolute;
            top: calc(100% + 8px);
            left: 0;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            min-width: 280px;
            overflow: hidden;
            z-index: 1000;
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.3s ease;
            pointer-events: none;
        }

        .dropdown-menu.show {
            opacity: 1;
            transform: translateY(0);
            pointer-events: all;
        }

        .dropdown-menu.hidden {
            display: none;
        }

        .dropdown-item {
            padding: 14px 20px;
            cursor: pointer;
            transition: all 0.2s ease;
            border-bottom: 1px solid #F3F4F6;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 15px;
            font-weight: 500;
        }

        .dropdown-item:last-child {
            border-bottom: none;
        }

        .dropdown-item:hover {
            background: #F9FAFB;
            padding-left: 24px;
        }

        .dropdown-item[data-action="alta"] {
            color: #166534;
        }

        .dropdown-item[data-action="alta"]:hover {
            background: #F0FDF4;
        }

        .dropdown-item[data-action="reinstalacion"] {
            color: #1E40AF;
        }

        .dropdown-item[data-action="reinstalacion"]:hover {
            background: #EFF6FF;
        }

        .dropdown-item[data-action="baja"] {
            color: #991B1B;
        }

        .dropdown-item[data-action="baja"]:hover {
            background: #FEF2F2;
        }

        .dropdown-item[data-action="desmontaje"] {
            color: #C2410C;
        }

        .dropdown-item[data-action="desmontaje"]:hover {
            background: #FFF7ED;
        }

        .dropdown-item[data-action="tarifa"] {
            color: #6B21A8;
        }

        .dropdown-item[data-action="tarifa"]:hover {
            background: #FAF5FF;
        }

        /* Estilos para modales */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }

        .modal-overlay.show {
            opacity: 1;
            pointer-events: all;
        }

        .modal-overlay.hidden {
            display: none;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }

        .modal-overlay.show .modal-content {
            transform: scale(1);
        }

        .modal-header {
            padding: 24px 28px;
            border-bottom: 1px solid #E5E7EB;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-header h2 {
            font-size: 22px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 28px;
            color: #9CA3AF;
            cursor: pointer;
            padding: 0;
            line-height: 1;
            transition: color 0.2s;
        }

        .modal-close:hover {
            color: #374151;
        }

        .modal-body {
            padding: 32px;
        }

        .form-group {
            margin-bottom: 24px;
        }

        .form-group label {
            display: block;
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--text);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 14px 16px;
            font-size: 16px;
            border: 1px solid #D1D5DB;
            border-radius: 8px;
            transition: all 0.2s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #3B82F6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
            font-family: inherit;
        }

        /* Vista previa de facturaciñ³n */
        .billing-preview {
            background: linear-gradient(135deg, #F0F9FF 0%, #E0F2FE 100%);
            border-radius: 12px;
            padding: 20px;
            margin-top: 24px;
            border: 2px solid #BAE6FD;
        }

        .billing-preview h3 {
            font-size: 16px;
            font-weight: 600;
            color: #0C4A6E;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .billing-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #BAE6FD;
            font-size: 14px;
        }

        .billing-row:last-child {
            border-bottom: none;
            padding-top: 16px;
            font-weight: 600;
            font-size: 18px;
            color: #0C4A6E;
        }

        .billing-label {
            color: #475569;
        }

        .billing-value {
            font-weight: 600;
            color: #0F172A;
        }

        /* Componente de Búsqueda inteligente */
        .smart-search {
            position: relative;
        }

        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #D1D5DB;
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            display: none;
        }

        .search-results.show {
            display: block;
        }

        .search-result-item {
            padding: 12px 14px;
            cursor: pointer;
            border-bottom: 1px solid #F3F4F6;
            transition: background 0.2s;
        }

        .search-result-item:hover {
            background: #F9FAFB;
        }

        .search-result-item:last-child {
            border-bottom: none;
        }

        .search-result-codigo {
            font-weight: 600;
            color: #1E3A8A;
            font-size: 15px;
        }

        .search-result-municipio {
            font-size: 13px;
            color: #64748B;
            margin-top: 2px;
        }

        /* Botones de acciñ³n del modal */
        .modal-actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        .btn-modal-primary,
        .btn-modal-secondary {
            flex: 1;
            padding: 12px 24px;
            font-size: 15px;
            font-weight: 600;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-modal-primary {
            background: #1E3A8A;
            color: white;
        }

        .btn-modal-primary:hover {
            background: #1E40AF;
        }

        .btn-modal-secondary {
            background: #F3F4F6;
            color: #374151;
        }

        .btn-modal-secondary:hover {
            background: #E5E7EB;
        }

        /* Colores especñ­ficos por tipo de cambio */
        .modal-alta .modal-header {
            background: linear-gradient(135deg, #ECFDF5 0%, #D1FAE5 100%);
            border-bottom-color: #86EFAC;
        }

        .modal-alta .modal-header h2 {
            color: #166534;
        }

        .modal-reinstalacion .modal-header {
            background: linear-gradient(135deg, #EFF6FF 0%, #DBEAFE 100%);
            border-bottom-color: #93C5FD;
        }

        .modal-reinstalacion .modal-header h2 {
            color: #1E40AF;
        }

        .modal-baja .modal-header {
            background: linear-gradient(135deg, #FEF2F2 0%, #FEE2E2 100%);
            border-bottom-color: #FCA5A5;
        }

        .modal-baja .modal-header h2 {
            color: #991B1B;
        }

        .modal-desmontaje .modal-header {
            background: linear-gradient(135deg, #FFF7ED 0%, #FFEDD5 100%);
            border-bottom-color: #FDBA74;
        }

        .modal-desmontaje .modal-header h2 {
            color: #C2410C;
        }

        .modal-tarifa .modal-header {
            background: linear-gradient(135deg, #FAF5FF 0%, #F3E8FF 100%);
            border-bottom-color: #D8B4FE;
        }

        .modal-tarifa .modal-header h2 {
            color: #6B21A8;
        }

        /* Alertas de advertencia */
        .warning-box {
            background: #FEF3C7;
            border-left: 4px solid #F59E0B;
            padding: 14px 16px;
            border-radius: 8px;
            margin: 16px 0;
            display: flex;
            gap: 12px;
            align-items: start;
        }

        .warning-box-icon {
            font-size: 20px;
            flex-shrink: 0;
        }

        .warning-box-text {
            font-size: 14px;
            color: #92400E;
            line-height: 1.5;
        }

        /* Checkbox personalizado */
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 16px 0;
        }

        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .checkbox-group label {
            margin: 0;
            cursor: pointer;
            font-size: 14px;
        }
        /* ============================================
           ESTILOS PARA PANTALLA DE LOGIN (Tailwind)
           ============================================ */
        /* Los estilos de login ahora se manejan con TailwindCSS */

        /* ============================================
           ESTILOS PARA HEADER AUTENTICADO
           ============================================ */
        .auth-header {
            background: linear-gradient(135deg, #1e3a5f 0%, #2c5282 100%);
            color: white;
            padding: 24px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            flex-wrap: wrap;
            gap: 20px;
        }

        .auth-header-left h1 {
            margin: 0;
            font-size: 24px;
            font-weight: 700;
        }

        .auth-header-left p {
            margin: 4px 0 0 0;
            font-size: 14px;
            opacity: 0.9;
        }

        .auth-header-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 3px solid white;
            object-fit: cover;
        }

        .user-details {
            text-align: left;
        }

        .user-name {
            font-weight: 700;
            font-size: 15px;
            margin: 0;
        }

        .user-email {
            font-size: 13px;
            opacity: 0.8;
            margin: 2px 0 0 0;
        }

        .btn-logout {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-logout:hover {
            background: white;
            color: #1e3a5f;
        }

        /* ============================================
           CONTENEDOR DE APLICACIñ“N
           ============================================ */
        #appContainer {
            display: none;
        }

        #appContainer.visible {
            display: block;
        }

        /* Responsive para pantalla de login */
        @media (max-width: 600px) {
            .login-container {
                padding: 40px 30px;
            }
            
            .login-logo {
                font-size: 60px;
            }
            
            .login-title {
                font-size: 24px;
            }
            
            .login-subtitle {
                font-size: 14px;
            }
        }

        /* Responsive para header autenticado */
        @media (max-width: 768px) {
            .auth-header {
                padding: 20px;
                flex-direction: column;
                align-items: flex-start;
            }
            
            .auth-header-right {
                width: 100%;
                justify-content: space-between;
            }
        }
    </style>
</head>
<body class="antialiased">
    <!-- ============================================
         PANTALLA DE LOGIN GLASSMORPHISM
         ============================================ -->
    <div id="loginScreen" style="display:flex;align-items:center;justify-content:center;min-height:100vh;background:linear-gradient(135deg,#2d1b4e 0%,#4a2963 25%,#7a3d6b 50%,#4a2963 75%,#2d1b4e 100%);position:relative;overflow:hidden;">
        <div style="position:absolute;top:20%;left:20%;width:400px;height:400px;background:radial-gradient(circle,rgba(220,100,150,0.3) 0%,transparent 70%);filter:blur(60px);"></div>
        <div style="position:absolute;bottom:20%;right:20%;width:400px;height:400px;background:radial-gradient(circle,rgba(100,100,220,0.3) 0%,transparent 70%);filter:blur(60px);"></div>
        <div style="position:relative;background:rgba(255,255,255,0.1);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);border:1px solid rgba(255,255,255,0.2);border-radius:25px;padding:3rem 2.5rem;max-width:420px;width:90%;box-shadow:0 8px 32px rgba(0,0,0,0.3);display:flex;flex-direction:column;align-items:center;text-align:center;">
            <div style="width:120px;height:120px;border-radius:50%;background:radial-gradient(circle at 30% 30%,rgba(255,150,180,0.4),rgba(180,120,200,0.3));display:flex;align-items:center;justify-content:center;margin-bottom:1.5rem;">
                <svg width="60" height="60" viewBox="0 0 24 24" fill="rgba(255,255,255,0.7)"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
            </div>
            <h1 style="color:rgba(255,255,255,0.95);font-size:2rem;font-weight:700;margin:0 0 0.5rem 0;letter-spacing:-0.5px;">PIVCONTROL</h1>
            <p style="color:rgba(255,255,255,0.6);font-size:0.95rem;margin:0 0 2.5rem 0;line-height:1.4;">Control mensual de facturaciñn CRTM-PIV</p>
            <button onclick="iniciarSesionConGoogle()" style="width:100%;padding:1rem 2rem;border:none;border-radius:50px;background:linear-gradient(90deg,#6366f1 0%,#8b5cf6 50%,#d946ef 100%);color:white;font-size:1rem;font-weight:700;letter-spacing:1px;cursor:pointer;box-shadow:0 4px 15px rgba(139,92,246,0.4);transition:all 0.3s ease;display:flex;align-items:center;justify-content:center;gap:0.75rem;" onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 6px 20px rgba(139,92,246,0.6)';" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 4px 15px rgba(139,92,246,0.4)';">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="white"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
                Iniciar sesión con Google
            </button>
        </div>
    </div>

    <!-- ============================================
         CONTENEDOR DE LA APLICACIñ“N (Oculto por defecto)
         ============================================ -->
    <div id="appContainer">
        <!-- ============================================
             HEADER MINIMALISTA
             ============================================ -->
        <div class="minimal-header">
            <div class="minimal-header-content">
                <div class="minimal-logo">
                    <span class="minimal-logo-text">CRTM</span>
                    <span class="minimal-logo-subtitle">Gestión de Paneles TFT</span>
                </div>
                <div class="minimal-user">
                    <img id="userPhoto" class="minimal-user-avatar" src="" alt="Usuario">
                    <div class="minimal-user-info">
                        <div class="minimal-user-name" id="userName">Usuario</div>
                        <div class="minimal-user-email" id="userEmail">email@example.com</div>
                    </div>
                    <button class="minimal-btn-logout" onclick="cerrarSesion()">
                        Cerrar sesión
                    </button>
                </div>
            </div>
        </div>

        <!-- ============================================
             CONTENIDO PRINCIPAL MINIMALISTA
             ============================================ -->
        <div class="minimal-main">
            
            <!-- Tñ­tulo de secciñ³n -->
            <h1 class="minimal-section-title">Resumen del mes actual</h1>
            <p class="minimal-section-subtitle">Control de instalación, mantenimiento y facturaciñn de paneles TFT</p>

            <!-- Estadñ­sticas XXL -->
            <div class="minimal-stats">
                <div class="minimal-stat-card">
                    <div class="minimal-stat-label">Paneles</div>
                    <div class="minimal-stat-value" id="statTotal">0</div>
                    <div class="minimal-stat-detail">Total instalados</div>
                </div>
                <div class="minimal-stat-card">
                    <div class="minimal-stat-label">Pausados</div>
                    <div class="minimal-stat-value" id="statDesmontados">0</div>
                    <div class="minimal-stat-detail">Temporalmente</div>
                </div>
                <div class="minimal-stat-card">
                    <div class="minimal-stat-label">Facturaciñn</div>
                    <div class="minimal-stat-value" id="statFacturacion">0,00 €</div>
                    <div class="minimal-stat-detail">Mensual</div>
                </div>
                <div class="minimal-stat-card">
                    <div class="minimal-stat-label">Activos</div>
                    <div class="minimal-stat-value" id="statActivos">0</div>
                    <div class="minimal-stat-detail">Facturando</div>
                </div>
            </div>

        <div class="container" style="padding: 0; max-width: 100%; display: grid; grid-template-columns: 1fr 1.2fr; gap: 16px; align-items: start;">

        @media (max-width: 768px) {
            .container { grid-template-columns: 1fr !important; }
        }

        <div class="card">
            <h2 class="card-title">š™ï¸ Parámetros</h2>
            <div class="control-row">
                <div class="control-group">
                    <label>Mes Actual</label>
                    <select id="currentMonth">
                        <option value="01">Enero</option>
                        <option value="02">Febrero</option>
                        <option value="03">Marzo</option>
                        <option value="04">Abril</option>
                        <option value="05">Mayo</option>
                        <option value="06">Junio</option>
                        <option value="07">Julio</option>
                        <option value="08">Agosto</option>
                        <option value="09">Septiembre</option>
                        <option value="10" selected>Octubre</option>
                        <option value="11">Noviembre</option>
                        <option value="12">Diciembre</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>Año</label>
                    <input type="number" id="currentYear" value="2025" min="2020" max="2030">
                </div>
                <div class="control-group">
                    <label>Tarifa Base 30 Días</label>
                    <input type="number" id="baseRate" value="37.70" step="0.01">
                </div>
            </div>
        </div>

        <div class="card">
            <h2 class="card-title">Acciones</h2>
            <!-- Botñ³n Principal de Cambios Mensuales -->
            <div class="monthly-changes-container" style="margin-bottom: 20px;">
                <button id="btnCambiosMes" class="btn-primary-large" onclick="toggleDropdownMenu()">
                    ðŸ“‹ Cambios del mes <span style="font-size: 12px;">–¼</span>
                </button>
                
                <div id="dropdownMenu" class="dropdown-menu hidden">
                    <div class="dropdown-item" data-action="alta" onclick="openModalAlta()">
                        <span class="dropdown-icon" style="color: #4CAF50;">¢</span>
                        <span>Alta de Panel Nuevo</span>
                    </div>
                    <div class="dropdown-item" data-action="reinstalacion" onclick="openModalReinstalacion()">
                        <span class="dropdown-icon" style="color: #2196F3;">ðŸ”µ</span>
                        <span>Reinstalaciñ³n de Panel</span>
                    </div>
                    <div class="dropdown-item" data-action="baja" onclick="openModalBaja()">
                        <span class="dropdown-icon" style="color: #F44336;">½</span>
                        <span>Baja Definitiva de Panel</span>
                    </div>
                    <div class="dropdown-item" data-action="desmontaje" onclick="openModalDesmontaje()">
                        <span class="dropdown-icon" style="color: #FF9800;">½</span>
                        <span>Desmontaje Temporal</span>
                    </div>
                    <div class="dropdown-item" data-action="tarifa" onclick="openModalCambioTarifa()">
                        <span class="dropdown-icon" style="color: #9C27B0;">½</span>
                        <span>Cambio de Tarifa</span>
                    </div>
                </div>
            </div>
            
            <div class="actions-grid">
                <button onclick="exportData()" class="btn-primary">½ Exportar a Excel</button>
                <button onclick="viewHistory()" class="btn-secondary">📊 Ver histñrico mensual</button>
                <button onclick="viewMonthlyChanges()" class="btn-secondary">ðŸ“ Ver cambios del mes</button>
                <button onclick="exportHistory()" class="btn-secondary">💾 Exportar histñrico completo</button>
                <button onclick="backupComplete()" class="btn-secondary">ðŸ’¾ Copia de seguridad (JSON)</button>
            </div>
        </div>

        <!-- Modal: Alta de Panel Nuevo -->
        <div id="modalAlta" class="modal-overlay hidden">
            <div class="modal-content modal-alta">
                <div class="modal-header">
                    <h2><span>¢</span> Alta de Panel Nuevo</h2>
                    <button class="modal-close" onclick="closeModal('modalAlta')">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="altaMunicipio">Municipio *</label>
                        <select id="altaMunicipio" required>
                            <option value="">Seleccionar municipio...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="altaCodigo">Cñdigo del Panel *</label>
                        <input type="text" id="altaCodigo" placeholder="Ej: PIV-001" required>
                    </div>
                    <div class="form-group">
                        <label for="altaFecha">Fecha de Instalaciñ³n *</label>
                        <input type="date" id="altaFecha" required>
                    </div>
                    <div class="form-group">
                        <label for="altaObservaciones">Observaciones</label>
                        <textarea id="altaObservaciones" placeholder="Detalles adicionales (opcional)"></textarea>
                    </div>
                    
                    <div class="billing-preview" id="altaBillingPreview">
                        <h3>💶 Vista Previa de Facturaciñn</h3>
                        <div class="billing-row">
                            <span class="billing-label">Tarifa mensual base:</span>
                            <span class="billing-value">37,70 €</span>
                        </div>
                        <div class="billing-row">
                            <span class="billing-label">Días a facturar:</span>
                            <span class="billing-value" id="altaDias">-</span>
                        </div>
                        <div class="billing-row">
                            <span class="billing-label">Tarifa diaria (37,70/30):</span>
                            <span class="billing-value">1,26 €/día</span>
                        </div>
                        <div class="billing-row">
                            <span class="billing-label">Total a facturar:</span>
                            <span class="billing-value" id="altaTotal">-</span>
                        </div>
                    </div>

                    <div class="modal-actions">
                        <button class="btn-modal-secondary" onclick="closeModal('modalAlta')">Cancelar</button>
                        <button class="btn-modal-primary" onclick="guardarAlta()">✓ Dar de Alta</button>
                    </div>
                </div>
            </div>
        </div>

    <!-- Modal: reinstalación de Panel -->
        <div id="modalReinstalacion" class="modal-overlay hidden">
            <div class="modal-content modal-reinstalacion">
                <div class="modal-header">
                    <h2><span>ðŸ”µ</span> reinstalación de Panel</h2>
                    <button class="modal-close" onclick="closeModal('modalReinstalacion')">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="form-group smart-search">
                        <label for="reinstalacionBuscar">Buscar Panel *</label>
                        <input type="text" id="reinstalacionBuscar" placeholder="Buscar por Cñdigo o municipio..." oninput="buscarPanel('reinstalacion')">
                        <div id="reinstalacionResults" class="search-results"></div>
                    </div>
                    <div class="form-group">
                        <label>Panel Seleccionado</label>
                        <div id="reinstalacionPanelInfo" style="padding: 12px; background: #F9FAFB; border-radius: 8px; font-size: 14px; color: #64748B;">
                            Ningún panel seleccionado
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="reinstalacionFecha">Fecha de reinstalación *</label>
                        <input type="date" id="reinstalacionFecha" required>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="reinstalacionCambioMunicipio">
                        <label for="reinstalacionCambioMunicipio">Cambiar municipio de instalación</label>
                    </div>
                    <div class="form-group" id="reinstalacionNuevoMunicipioGroup" style="display: none;">
                        <label for="reinstalacionNuevoMunicipio">Nuevo Municipio *</label>
                        <select id="reinstalacionNuevoMunicipio">
                            <option value="">Seleccionar municipio...</option>
                        </select>
                    </div>

                    <div class="billing-preview" id="reinstalacionBillingPreview">
                        <h3>ðŸ’° Comparaciñn de Facturaciñn</h3>
                        <div class="billing-row">
                            <span class="billing-label">Facturaciñn sin reinstalación:</span>
                            <span class="billing-value" id="reinstalacionSin">-</span>
                        </div>
                        <div class="billing-row">
                            <span class="billing-label">Facturaciñn con reinstalación:</span>
                            <span class="billing-value" id="reinstalacionCon">-</span>
                        </div>
                        <div class="billing-row">
                            <span class="billing-label">Diferencia:</span>
                            <span class="billing-value" id="reinstalacionDif" style="color: #16A34A;">-</span>
                        </div>
                    </div>

                    <div class="modal-actions">
                        <button class="btn-modal-secondary" onclick="closeModal('modalReinstalacion')">Cancelar</button>
                        <button class="btn-modal-primary" onclick="guardarReinstalacion()">✓ Confirmar reinstalación</button>
                    </div>
                </div>
            </div>
        </div>

    <!-- Modal: Baja Definitiva de Panel -->
        <div id="modalBaja" class="modal-overlay hidden">
            <div class="modal-content modal-baja">
                <div class="modal-header">
                    <h2><span>ðŸ”´</span> Baja Definitiva de Panel</h2>
                    <button class="modal-close" onclick="closeModal('modalBaja')">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="form-group smart-search">
                        <label for="bajaBuscar">Buscar Panel *</label>
                        <input type="text" id="bajaBuscar" placeholder="Buscar por Cñdigo o municipio..." oninput="buscarPanel('baja')">
                        <div id="bajaResults" class="search-results"></div>
                    </div>
                    <div class="form-group">
                        <label>Panel Seleccionado</label>
                        <div id="bajaPanelInfo" style="padding: 12px; background: #F9FAFB; border-radius: 8px; font-size: 14px; color: #64748B;">
                            Ningún panel seleccionado
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="bajaMotivo">Motivo de la Baja *</label>
                        <select id="bajaMotivo" required>
                            <option value="">Seleccionar motivo...</option>
                            <option value="fin_contrato">Fin de contrato</option>
                            <option value="averia_irreparable">Avería irreparable</option>
                            <option value="vandalismo">Vandalismo</option>
                            <option value="decision_cliente">Decisiñn del cliente</option>
                            <option value="otro">Otro</option>
                        </select>
                    </div>

                    <div class="warning-box">
                        <div class="warning-box-icon">⚠️</div>
                        <div class="warning-box-text">
                            <strong>Atenciñn:</strong> Esta acciñn es definitiva. El panel dejará de facturarse desde este mes en adelante. La facturaciñn de meses anteriores se conserva.
                        </div>
                    </div>

                    <div class="checkbox-group">
                        <input type="checkbox" id="bajaConfirmacion">
                        <label for="bajaConfirmacion">Confirmo que deseo dar de baja definitivamente este panel</label>
                    </div>

                    <div class="billing-preview" id="bajaBillingPreview">
                        <h3>ðŸ’° Impacto en Facturaciñn</h3>
                        <div class="billing-row">
                            <span class="billing-label">Facturaciñn mensual actual:</span>
                            <span class="billing-value" id="bajaFacturacionActual">-</span>
                        </div>
                        <div class="billing-row">
                            <span class="billing-label">Facturaciñn despuñs de baja:</span>
                            <span class="billing-value">0,00 €</span>
                        </div>
                        <div class="billing-row">
                            <span class="billing-label">Pñrdida mensual:</span>
                            <span class="billing-value" id="bajaPerdida" style="color: #DC2626;">-</span>
                        </div>
                    </div>

                    <div class="modal-actions">
                        <button class="btn-modal-secondary" onclick="closeModal('modalBaja')">Cancelar</button>
                        <button class="btn-modal-primary" onclick="guardarBaja()" style="background: #DC2626;">✓ Dar de Baja</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal: Desmontaje Temporal -->
        <div id="modalDesmontaje" class="modal-overlay hidden">
            <div class="modal-content modal-desmontaje">
                <div class="modal-header">
                    <h2><span> </span> Desmontaje Temporal</h2>
                    <button class="modal-close" onclick="closeModal('modalDesmontaje')">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="form-group smart-search">
                        <label for="desmontajeBuscar">Buscar Panel *</label>
                        <input type="text" id="desmontajeBuscar" placeholder="Buscar por Cñdigo o municipio..." oninput="buscarPanel('desmontaje')">
                        <div id="desmontagResults" class="search-results"></div>
                    </div>
                    <div class="form-group">
                        <label>Panel Seleccionado</label>
                        <div id="desmontajePanelInfo" style="padding: 12px; background: #F9FAFB; border-radius: 8px; font-size: 14px; color: #64748B;">
                            Ningún panel seleccionado
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="desmontajeFecha">Fecha de Desmontaje *</label>
                        <input type="date" id="desmontajeFecha" required>
                    </div>
                    <div class="form-group">
                        <label for="desmontagMotivo">Motivo *</label>
                        <select id="desmontagMotivo" required>
                            <option value="">Seleccionar motivo...</option>
                            <option value="mantenimiento">Mantenimiento</option>
                            <option value="reparacion">Reparaciñn</option>
                            <option value="actualizacion">Actualizaciñn tñcnica</option>
                            <option value="temporal">Inactividad temporal</option>
                            <option value="otro">Otro</option>
                        </select>
                    </div>

                    <div class="billing-preview" id="desmontajeBillingPreview">
                        <h3>ðŸ’° Ajuste de Facturaciñn</h3>
                        <div class="billing-row">
                            <span class="billing-label">Facturaciñn mes completo:</span>
                            <span class="billing-value">37,70 €</span>
                        </div>
                        <div class="billing-row">
                            <span class="billing-label">Días activos en el mes:</span>
                            <span class="billing-value" id="desmontajeDias">-</span>
                        </div>
                        <div class="billing-row">
                            <span class="billing-label">Facturaciñn ajustada:</span>
                            <span class="billing-value" id="desmontagTotal">-</span>
                        </div>
                        <div class="billing-row">
                            <span class="billing-label">Ahorro por desmontaje:</span>
                            <span class="billing-value" id="desmontagAhorro" style="color: #DC2626;">-</span>
                        </div>
                    </div>

                    <div class="modal-actions">
                        <button class="btn-modal-secondary" onclick="closeModal('modalDesmontaje')">Cancelar</button>
                        <button class="btn-modal-primary" onclick="guardarDesmontaje()">✓ Confirmar Desmontaje</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal: Cambio de Tarifa -->
        <div id="modalCambioTarifa" class="modal-overlay hidden">
            <div class="modal-content modal-tarifa">
                <div class="modal-header">
                    <h2><span>£</span> Cambio de Tarifa</h2>
                    <button class="modal-close" onclick="closeModal('modalCambioTarifa')">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="form-group smart-search">
                        <label for="tarifaBuscar">Buscar Panel *</label>
                        <input type="text" id="tarifaBuscar" placeholder="Buscar por Cñdigo o municipio..." oninput="buscarPanel('tarifa')">
                        <div id="tarifaResults" class="search-results"></div>
                    </div>
                    <div class="form-group">
                        <label>Panel Seleccionado</label>
                        <div id="tarifaPanelInfo" style="padding: 12px; background: #F9FAFB; border-radius: 8px; font-size: 14px; color: #64748B;">
                            Ningún panel seleccionado
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="tarifaNueva">Nueva Tarifa Mensual (€) *</label>
                        <input type="number" id="tarifaNueva" step="0.01" min="0" placeholder="Ej: 42.50" required>
                    </div>
                    <div class="form-group">
                        <label>Alcance del Cambio *</label>
                        <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 8px;">
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="radio" name="tarifaAlcance" value="solo_este" checked>
                                <span>Solo este panel</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="radio" name="tarifaAlcance" value="todos_municipio">
                                <span>Todos los paneles del mismo municipio</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="radio" name="tarifaAlcance" value="todos">
                                <span>Todos los paneles (cambio global)</span>
                            </label>
                        </div>
                    </div>

                    <div class="billing-preview" id="tarifaBillingPreview">
                        <h3>ðŸ’° Impacto del Cambio</h3>
                        <div class="billing-row">
                            <span class="billing-label">Tarifa actual:</span>
                            <span class="billing-value" id="tarifaActual">-</span>
                        </div>
                        <div class="billing-row">
                            <span class="billing-label">Nueva tarifa:</span>
                            <span class="billing-value" id="tarifaNuevaPreview">-</span>
                        </div>
                        <div class="billing-row">
                            <span class="billing-label">Paneles afectados:</span>
                            <span class="billing-value" id="tarifaPanelesAfectados">-</span>
                        </div>
                        <div class="billing-row">
                            <span class="billing-label">Variaciñ³n total:</span>
                            <span class="billing-value" id="tarifaVariacion">-</span>
                        </div>
                    </div>

                    <div class="modal-actions">
                        <button class="btn-modal-secondary" onclick="closeModal('modalCambioTarifa')">Cancelar</button>
                        <button class="btn-modal-primary" onclick="guardarCambioTarifa()">✓ Aplicar Cambio</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="stats">
            <div class="stat-card">
                <h3>Total Paneles</h3>
                <div class="value" id="totalPanels">0</div>
            </div>
            <div class="stat-card">
                <h3>Facturaciñn Mensual</h3>
                <div class="value" id="totalRevenue">0,00 €</div>
            </div>
            <div class="stat-card">
                <h3>Municipios</h3>
                <div class="value" id="totalMunicipios">0</div>
            </div>
            <div class="stat-card">
                <h3>Paneles Parciales</h3>
                <div class="value" id="partialPanels">0</div>
            </div>
        </div>

        <div class="minimal-panels-section">
            <div class="minimal-section-header">
                <h2 class="minimal-section-title">Paneles</h2>
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="Buscar por municipio o Cñdigo..." onkeyup="filterTable()">
                </div>
            </div>
            <div class="minimal-list" id="panelsList">
                <!-- Los paneles se cargarán aquñ­ dinámicamente -->
            </div>
        </div>
    </div>

    <!-- Modal para añ±adir panel -->
    <div id="addPanelModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="close-modal" onclick="closeModal('addPanelModal')">&times;</span>
                <h2>ž• Añ±adir Nuevo Panel</h2>
            </div>
            <div class="control-group">
                <label>Municipio</label>
                <input type="text" id="newMunicipio" placeholder="Ej: Madrid">
            </div>
            <div class="control-group">
                <label>Cñdigo Parada</label>
                <input type="text" id="newCodigo" placeholder="Ej: 12345">
            </div>
            <div class="control-group">
                <label>Fecha Instalaciñ³n</label>
                <input type="date" id="newFechaInstalacion">
            </div>
            <div class="control-group" style="margin-top: 20px;">
                <button onclick="saveNewPanel()" class="btn-success">Guardar Panel</button>
            </div>
        </div>
    </div>

    <!-- Modal para eliminar panel -->
    <div id="removePanelModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="close-modal" onclick="closeModal('removePanelModal')">&times;</span>
                <h2>ž– Eliminar Panel</h2>
            </div>
            <div class="control-group">
                <label>Cñdigo Parada</label>
                <input type="text" id="removeCodigo" placeholder="Ej: 12345">
            </div>
            <div class="control-group" style="margin-top: 20px;">
                <button onclick="confirmRemovePanel()" class="btn-danger">Eliminar Panel</button>
            </div>
        </div>
    </div>

    <!-- Modal para Desmontar Panel -->
    <div id="dismountPanelModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="close-modal" onclick="closeModal('dismountPanelModal')">&times;</span>
                <h2>ðŸ“¦ Desmontar Panel</h2>
            </div>
            <div class="control-group">
                <label>Cñdigo Parada</label>
                <input type="text" id="dismountCodigo" placeholder="Ej: 12345">
            </div>
            <div class="control-group">
                <label>Fecha Desmontaje</label>
                <input type="date" id="dismountFecha">
            </div>
            <div class="control-group" style="margin-top: 20px;">
                <button onclick="confirmDismountPanel()" class="btn-warning">Desmontar Panel</button>
            </div>
        </div>
    </div>

    <!-- Modal para ver Histñrico -->
    <div id="historyModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <span class="close-modal" onclick="closeModal('historyModal')">&times;</span>
                <h2>📊 Histñrico Mensual</h2>
            </div>
            <div id="historyContent" style="max-height: 500px; overflow-y: auto;">
                <p>Cargando Histñrico...</p>
            </div>
        </div>
    </div>

    <script>
        // Base de datos en memoria (solo Firestore)
        let panelsData = [];
        const HISTORY_KEY = 'paneles_solares_history';
        const CHANGES_KEY = 'paneles_cambios_mensuales';
        let monthlyHistory = {};
        let monthlyChanges = {};
        let firestoreLoaded = false;

        // ============================================
        // FUNCIONES PARA PESTAñ‘AS VESTACP
        // ============================================
        function cambiarTab(event, tabName) {
            event.preventDefault();
            
            // Remover clase active de todas las pestañ±as
            document.querySelectorAll('.vesta-nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Añ±adir clase active a la pestañ±a clickeada
            event.currentTarget.classList.add('active');
            
            // Aquñ­ puedes añ±adir lñ³gica para mostrar/ocultar contenido segñºn la pestañ±a
            console.log('Pestañ±a seleccionada:', tabName);
        }

        // ============================================
        // FUNCIONES AUXILIARES VESTACP
        // ============================================
        function toggleAllPanels() {
            console.log('Toggle all panels');
            // Implementar lñ³gica de seleccionar/deseleccionar todos
        }

        function aplicarSeleccionados() {
            console.log('Aplicar a seleccionados');
            // Implementar lñ³gica de aplicar acciñ³n a seleccionados
        }

        function ordenarPor(campo) {
            console.log('Ordenar por:', campo);
            // La funciñ³n updateTable ya maneja el ordenamiento
            updateTable();
        }

        // ============================================
        // ACTUALIZAR BADGES EN PESTAñ‘AS
        // ============================================
        function actualizarBadges() {
            const totalPaneles = panelsData.length;
            const badgePaneles = document.getElementById('badgePaneles');
            if (badgePaneles) {
                badgePaneles.textContent = totalPaneles;
            }

            // Contar Cambios del mes actual
            const mes = parseInt(document.getElementById('currentMonth').value);
            const year = parseInt(document.getElementById('currentYear').value);
            const monthKey = `${year}-${String(mes).padStart(2, '0')}`;
            const cambiosMes = monthlyChanges[monthKey] ? monthlyChanges[monthKey].length : 0;
            
            const badgeCambios = document.getElementById('badgeCambios');
            if (badgeCambios) {
                badgeCambios.textContent = cambiosMes;
            }
        }

        // ============================================
        // ACTUALIZAR ESTADÍSTICAS DASHBOARD
        // ============================================
        function actualizarEstadisticas() {
            const mes = parseInt(document.getElementById('currentMonth').value);
            const year = parseInt(document.getElementById('currentYear').value);

            let activos = 0;      // días = 30
            let pausados = 0;     // 0 < días < 30
            let facturacionTotal = 0;

            panelsData.forEach(panel => {
                const fact = calcularFacturacion(panel, mes, year);
                const dias = Number(fact.dias) || 0;
                const importe = Number(fact.importe) || 0;

                if (dias >= 30) activos++;
                else if (dias > 0) pausados++;

                facturacionTotal += importe;
            });

            // Actualizar stats
            document.getElementById('statActivos').textContent = activos;
            // En UI el segundo contador muestra “Pausados”
            const elPausados = document.getElementById('statDesmontados');
            if (elPausados) elPausados.textContent = pausados;

            const fmtEUR = new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR' });
            document.getElementById('statFacturacion').textContent = fmtEUR.format(facturacionTotal);
            const totalRevenueEl = document.getElementById('totalRevenue');
            if (totalRevenueEl) totalRevenueEl.textContent = fmtEUR.format(facturacionTotal);
            document.getElementById('statTotal').textContent = panelsData.length;
        }


        // Cargar datos iniciales SOLO desde Firestore
        // Esta funciñ³n se llama automáticamente despuñ©s de autenticaciñ³n exitosa
        async function loadInitialData() {
            console.log('”„ Cargando paneles desde Firestore...');
            
            try {
                if (!window.cargarPanelesDesdeFirestore) {
                    throw new Error('Firebase no está inicializado');
                }
                
                const panelesFirestore = await window.cargarPanelesDesdeFirestore();
                
                if (panelesFirestore.length > 0) {
                    panelsData = panelesFirestore;
                    firestoreLoaded = true;
                    console.log(`œ… ${panelesFirestore.length} paneles cargados desde Firestore`);
                } else {
                    panelsData = [];
                    console.warn('š ï¸ No se encontraron paneles en Firestore');
                    alert('ðŸ“‹ No hay paneles en la base de datos.\n\nUsa el botñ³n "Cambios del mes †’ Alta" para añ±adir paneles.');
                }
            } catch (error) {
                console.error('Œ Error al cargar desde Firestore:', error);
                alert('Œ Error al conectar con Firestore:\n\n' + error.message + '\n\nRecarga la página.');
                panelsData = [];
            }
            
            // Cargar histñ³ricos desde localStorage
            const savedHistory = localStorage.getItem(HISTORY_KEY);
            if (savedHistory) {
                monthlyHistory = JSON.parse(savedHistory);
            } else {
                monthlyHistory = {};
            }
            
            // Cargar cambios mensuales desde localStorage
            const savedChanges = localStorage.getItem(CHANGES_KEY);
            if (savedChanges) {
                monthlyChanges = JSON.parse(savedChanges);
            } else {
                monthlyChanges = {};
            }
            
            updateTable();
        }
        
        // Exponer funciñ³n globalmente para que Firebase Auth pueda llamarla
        window.loadInitialData = loadInitialData;


        // Guardar histñ³rico en localStorage (NO paneles, solo histñ³ricos)
        function saveData() {
            // Ya NO guardamos panelsData en localStorage
            // Los paneles viven SOLO en Firestore
            
            // Guardar histñ³rico del mes actual
            const month = document.getElementById('currentMonth').value;
            const year = document.getElementById('currentYear').value;
            const monthKey = `${year}-${month}`;
            
            // Calcular snapshot del mes
            const snapshot = {
                fecha: new Date().toISOString(),
                mes: month,
                year: year,
                totalPaneles: panelsData.length,
                paneles: JSON.parse(JSON.stringify(panelsData)), // Deep copy
                facturacionTotal: 0
            };
            
            // Calcular facturaciñ³n
            panelsData.forEach(panel => {
                const facturacion = calcularFacturacion(panel, parseInt(month), parseInt(year));
                snapshot.facturacionTotal += facturacion.importe;
            });
            
            snapshot.facturacionTotal = parseFloat(snapshot.facturacionTotal.toFixed(2));
            
            // Guardar en histñ³rico
            monthlyHistory[monthKey] = snapshot;
            localStorage.setItem(HISTORY_KEY, JSON.stringify(monthlyHistory));
        }

        // FUNCIñN CORE: Calcular facturaciñn de un panel para un mes específico
        function calcularFacturacion(panel, mes, year) {
            // Tolerar tarifas como string "37,70" o "37.70" y valores faltantes
            const rawTarifa = (panel && panel.tarifa) != null ? panel.tarifa : 37.70;
            let tarifaNum = typeof rawTarifa === 'number' ? rawTarifa : parseFloat(String(rawTarifa).replace(',', '.'));
            if (Number.isNaN(tarifaNum) || !Number.isFinite(tarifaNum)) tarifaNum = 37.70;
            const tarifa = tarifaNum;
            const tarifaDiaria = tarifa / 30;
            const diasEnMes = getDaysInMonth(mes, year);
            const diasBase = Math.min(diasEnMes, 30); // Base de cálculo: 30 días

            let fechaInstalacion = null;
            let fechaDesmontaje = null;
            let diasFacturables = diasBase;
            let tipo = 'completo';

            // Detectar fecha de instalaciñ³n
            if (panel.fechaInstalacion) {
                fechaInstalacion = new Date(panel.fechaInstalacion);
            }

            // Detectar fecha de desmontaje
            if (panel.fechaDesmontaje) {
                fechaDesmontaje = new Date(panel.fechaDesmontaje);
            }

            // Caso 1: Panel instalado en este mes
            if (fechaInstalacion && 
                fechaInstalacion.getMonth() + 1 === mes && 
                fechaInstalacion.getFullYear() === year) {
                const diaInstalacion = fechaInstalacion.getDate();
                diasFacturables = diasBase - diaInstalacion + 1;
                tipo = 'parcial_instalacion';
            }

            // Caso 2: Panel desmontado en este mes
            if (fechaDesmontaje && 
                fechaDesmontaje.getMonth() + 1 === mes && 
                fechaDesmontaje.getFullYear() === year) {
                const diaDesmontaje = fechaDesmontaje.getDate();
                
                // Si tambiñn se instalñ este mes, calcular días entre ambas fechas
                if (tipo === 'parcial_instalacion') {
                    const diaInstalacion = fechaInstalacion.getDate();
                    diasFacturables = diaDesmontaje - diaInstalacion + 1;
                    tipo = 'parcial_instalacion_desmontaje';
                } else {
                    diasFacturables = diaDesmontaje;
                    tipo = 'parcial_desmontaje';
                }
            }

            // Caso 3: Panel no instalado aún en este mes
            if (fechaInstalacion && 
                (fechaInstalacion.getFullYear() > year || 
                 (fechaInstalacion.getFullYear() === year && fechaInstalacion.getMonth() + 1 > mes))) {
                diasFacturables = 0;
                tipo = 'inactivo';
            }

            // Caso 4: Panel ya desmontado antes de este mes
            if (fechaDesmontaje && 
                (fechaDesmontaje.getFullYear() < year || 
                 (fechaDesmontaje.getFullYear() === year && fechaDesmontaje.getMonth() + 1 < mes))) {
                diasFacturables = 0;
                tipo = 'inactivo';
            }

            const importe = diasFacturables * tarifaDiaria;

            return {
                dias: diasFacturables,
                importe: parseFloat(importe.toFixed(2)),
                tipo: tipo,
                tarifaDiaria: parseFloat(tarifaDiaria.toFixed(4)),
                desde: fechaInstalacion ? fechaInstalacion.toLocaleDateString('es-ES') : null,
                hasta: fechaDesmontaje ? fechaDesmontaje.toLocaleDateString('es-ES') : null
            };
        }

        // Calcular días del mes
        function getDaysInMonth(month, year) {
            return new Date(year, month, 0).getDate();
        }

        // Calcular facturaciñn (funciñn legacy - se mantiene por compatibilidad)
        function calculateBilling(days) {
            const baseRate = parseFloat(document.getElementById('baseRate').value);
            const dailyRate = baseRate / 30;
            return (days * dailyRate).toFixed(2);
        }

        // Calcular días facturables (funciñn legacy - se mantiene por compatibilidad)
        function calculateDays(panel, month, year) {
            const facturacion = calcularFacturacion(panel, month, year);
            return facturacion.dias;
        }

        // Actualizar tabla
        function updateTable() {
            const month = parseInt(document.getElementById('currentMonth').value);
            const year = parseInt(document.getElementById('currentYear').value);
            const searchInput = document.getElementById('searchInput');
            const searchTerm = searchInput ? searchInput.value.toUpperCase() : '';
            const panelsList = document.getElementById('panelsList');
            panelsList.innerHTML = '';

            let totalRevenue = 0;
            let partialCount = 0;
            const municipios = new Set();

            panelsData.forEach((panel, index) => {
                // Filtrar por Búsqueda
                const matchSearch = !searchTerm || 
                    panel.municipio.toUpperCase().includes(searchTerm) ||
                    panel.codigo.toUpperCase().includes(searchTerm);

                if (!matchSearch) return;

                const days = calculateDays(panel, month, year);
                const billing = calculateBilling(days);
                totalRevenue += parseFloat(billing);
                municipios.add(panel.municipio);

                if (days < 30) partialCount++;

                // Determinar estado
                let estadoBadge = '';
                let estadoClass = '';
                if (panel.fechaDesmontaje) {
                    estadoBadge = 'Desmontado';
                    estadoClass = 'minimal-badge-dismounted';
                } else if (days < 30) {
                    estadoBadge = 'Pausado';
                    estadoClass = 'minimal-badge-paused';
                } else {
                    estadoBadge = 'Activo';
                    estadoClass = 'minimal-badge-active';
                }

                const listItem = document.createElement('div');
                listItem.className = 'minimal-list-item fade-in';
                listItem.innerHTML = `
                    <div class="minimal-list-item-info">
                        <div class="minimal-list-item-main">
                            <span class="minimal-list-item-municipio">${panel.municipio}</span>
                            <span class="minimal-list-item-separator">·</span>
                            <span class="minimal-list-item-codigo">${panel.codigo}</span>
                        </div>
                        <div class="minimal-list-item-meta">
                            <div class="minimal-list-item-stat">
                                <span class="minimal-list-item-stat-label">Días</span>
                                <span class="minimal-list-item-stat-value">${days}</span>
                            </div>
                            <div class="minimal-list-item-stat">
                                <span class="minimal-list-item-stat-label">Facturaciñn</span>
                                <span class="minimal-list-item-stat-value">${billing} €</span>
                            </div>
                        </div>
                    </div>
                    <div class="minimal-list-item-actions">
                        <span class="minimal-list-item-badge ${estadoClass}">${estadoBadge}</span>
                        <button class="minimal-action-btn delete" onclick="deletePanel(${index})" title="Eliminar">
                            <span>ðŸ—‘ï¸</span>
                        </button>
                    </div>
                `;
                panelsList.appendChild(listItem);
            });

            // Actualizar estadñ­sticas
            document.getElementById('totalPanels').textContent = panelsData.length;
            document.getElementById('totalRevenue').textContent = totalRevenue.toFixed(2).replace('.', ',') + ' €';
            document.getElementById('totalMunicipios').textContent = municipios.size;
            document.getElementById('partialPanels').textContent = partialCount;

            // Actualizar estadñ­sticas VestaCP
            actualizarEstadisticas();
            actualizarBadges();
        }

        // Filtrar tabla
        function filterTable() {
            updateTable(); // Simplemente recargar con el filtro aplicado
        }

        // Modales
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function addPanel() {
            openModal('addPanelModal');
        }

        function removePanel() {
            openModal('removePanelModal');
        }

        function dismountPanel() {
            openModal('dismountPanelModal');
        }

        function saveNewPanel() {
            const municipio = document.getElementById('newMunicipio').value.trim();
            const codigo = document.getElementById('newCodigo').value.trim();
            const fecha = document.getElementById('newFechaInstalacion').value;

            if (!municipio || !codigo) {
                alert('Por favor completa todos los campos');
                return;
            }

            panelsData.push({
                municipio: municipio,
                codigo: codigo,
                fechaInstalacion: fecha || null,
                fechaDesmontaje: null
            });

            saveData();
            updateTable();
            closeModal('addPanelModal');
            
            // Limpiar formulario
            document.getElementById('newMunicipio').value = '';
            document.getElementById('newCodigo').value = '';
            document.getElementById('newFechaInstalacion').value = '';
        }

        function confirmRemovePanel() {
            const codigo = document.getElementById('removeCodigo').value.trim();
            const index = panelsData.findIndex(p => p.codigo === codigo);

            if (index === -1) {
                alert('Panel no encontrado');
                return;
            }

            if (confirm(`¿Eliminar panel ${codigo}?`)) {
                panelsData.splice(index, 1);
                saveData();
                updateTable();
                closeModal('removePanelModal');
                document.getElementById('removeCodigo').value = '';
            }
        }

        function confirmDismountPanel() {
            const codigo = document.getElementById('dismountCodigo').value.trim();
            const fecha = document.getElementById('dismountFecha').value;
            const index = panelsData.findIndex(p => p.codigo === codigo);

            if (index === -1) {
                alert('Panel no encontrado');
                return;
            }

            if (!fecha) {
                alert('Por favor indica la fecha de desmontaje');
                return;
            }

            panelsData[index].fechaDesmontaje = fecha;
            saveData();
            updateTable();
            closeModal('dismountPanelModal');
            
            document.getElementById('dismountCodigo').value = '';
            document.getElementById('dismountFecha').value = '';
        }

        function deletePanel(index) {
            if (confirm('¿Eliminar este panel?')) {
                panelsData.splice(index, 1);
                saveData();
                updateTable();
            }
        }

        // Exportar a CSV
        function exportData() {
            const month = document.getElementById('currentMonth').value;
            const year = document.getElementById('currentYear').value;
            
            let csv = 'Municipio,Cñdigo Parada,Días,Facturaciñn\n';
            
            panelsData.forEach(panel => {
                const days = calculateDays(panel, parseInt(month), parseInt(year));
                const billing = calculateBilling(days);
                csv += `${panel.municipio},${panel.codigo},${days},${billing}\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `paneles_${month}_${year}.csv`;
            a.click();
        }

        // Funciñ³n auxiliar para obtener nombre del mes
        function getMonthName(month) {
            const months = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                          'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            return months[parseInt(month) - 1];
        }

        // Ver histñ³rico mensual
        function viewHistory() {
            const historyContent = document.getElementById('historyContent');
            
            if (Object.keys(monthlyHistory).length === 0) {
                historyContent.innerHTML = '<p style="text-align: center; padding: 20px; color: var(--muted);">No hay Histñrico guardado aún.</p>';
            } else {
                let html = '<table style="width: 100%; border-collapse: collapse;">';
                html += '<thead><tr style="background: var(--bg); color: white;">';
                html += '<th style="padding: 10px; text-align: left;">Mes/Año</th>';
                html += '<th style="padding: 10px; text-align: center;">Paneles</th>';
                html += '<th style="padding: 10px; text-align: right;">Facturaciñn</th>';
                html += '<th style="padding: 10px; text-align: center;">Fecha Guardado</th>';
                html += '</tr></thead><tbody>';
                
                // Ordenar por fecha
                const sortedKeys = Object.keys(monthlyHistory).sort().reverse();
                
                sortedKeys.forEach((key, index) => {
                    const record = monthlyHistory[key];
                    const bgColor = index % 2 === 0 ? 'var(--bg-soft)' : 'var(--card)';
                    const fecha = new Date(record.fecha);
                    const fechaFormat = fecha.toLocaleDateString('es-ES');
                    
                    const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 
                                       'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
                    const monthName = monthNames[parseInt(record.mes) - 1];
                    
                    html += `<tr style="background: ${bgColor};">`;
                    html += `<td style="padding: 10px; color: var(--text);"><strong>${monthName} ${record.year}</strong></td>`;
                    html += `<td style="padding: 10px; text-align: center; color: var(--text);">${record.totalPaneles}</td>`;
                    html += `<td style="padding: 10px; text-align: right; color: var(--text);">${record.facturacionTotal.toFixed(2)} €</td>`;
                    html += `<td style="padding: 10px; text-align: center; font-size: 13px; color: var(--muted);">${fechaFormat}</td>`;
                    html += '</tr>';
                });
                
                html += '</tbody></table>';
                historyContent.innerHTML = html;
            }
            
            openModal('historyModal');
        }

        // Ver cambios del mes registrados
        function viewMonthlyChanges() {
            if (Object.keys(monthlyChanges).length === 0) {
                alert('ðŸ“‹ No hay cambios mensuales registrados.\n\nLos cambios se registran automáticamente cuando procesas el archivo de cambios mensuales.');
                return;
            }
            
            let html = '<div style="max-height: 600px; overflow-y: auto;">';
            
            // Ordenar meses cronolñ³gicamente (más reciente primero)
            const sortedKeys = Object.keys(monthlyChanges).sort().reverse();
            
            sortedKeys.forEach((monthKey, index) => {
                const cambios = monthlyChanges[monthKey];
                const monthName = getMonthName(cambios.mes);
                const [yyyy] = monthKey.split('-');
                const fechaProceso = new Date(cambios.fecha_proceso).toLocaleString('es-ES');
                
                const totalCambios = 
                    cambios.altas.length + 
                    cambios.bajas.length + 
                    cambios.desmontajes.length + 
                    cambios.cambios_tarifa.length;
                
                html += `<div style="margin-bottom: 24px; padding: 20px; background: ${index % 2 === 0 ? 'var(--bg-soft)' : 'white'}; border-radius: 8px; border: 1px solid var(--border);">`;
                html += `<h3 style="color: var(--primary); margin-bottom: 8px;">${monthName} ${yyyy}</h3>`;
                html += `<p style="font-size: 13px; color: var(--muted); margin-bottom: 16px;">Procesado: ${fechaProceso} | Total cambios: ${totalCambios}</p>`;
                
                // ALTAS
                if (cambios.altas.length > 0) {
                    html += `<div style="margin-bottom: 12px;">`;
                    html += `<h4 style="color: #059669; margin-bottom: 8px;">Altas (${cambios.altas.length})</h4>`;
                    html += `<table style="width: 100%; font-size: 13px; border-collapse: collapse;">`;
                    html += `<tr style="background: #D1FAE5; font-weight: 600;">`;
                    html += `<th style="padding: 6px; text-align: left;">Cñdigo</th>`;
                    html += `<th style="padding: 6px; text-align: left;">Municipio</th>`;
                    html += `<th style="padding: 6px; text-align: center;">Fecha instalación</th>`;
                    html += `<th style="padding: 6px; text-align: right;">Tarifa</th>`;
                    html += `</tr>`;
                    
                    cambios.altas.forEach((alta, i) => {
                        const bg = i % 2 === 0 ? '#ECFDF5' : '#F0FDF4';
                        html += `<tr style="background: ${bg};">`;
                        html += `<td style="padding: 6px;"><strong>${alta.codigo}</strong></td>`;
                        html += `<td style="padding: 6px;">${alta.municipio}</td>`;
                        html += `<td style="padding: 6px; text-align: center;">${alta.fechaInstalacion || '-'}</td>`;
                        html += `<td style=\"padding: 6px; text-align: right;\">${alta.tarifa ? (alta.tarifa.toFixed(2) + ' €') : 'Base'}</td>`;
                        html += `</tr>`;
                    });
                    
                    html += `</table></div>`;
                }
                
                // BAJAS
                if (cambios.bajas.length > 0) {
                    html += `<div style="margin-bottom: 12px;">`;
                    html += `<h4 style="color: #DC2626; margin-bottom: 8px;">Bajas (${cambios.bajas.length})</h4>`;
                    html += `<table style="width: 100%; font-size: 13px; border-collapse: collapse;">`;
                    html += `<tr style="background: #FEE2E2; font-weight: 600;">`;
                    html += `<th style="padding: 6px; text-align: left;">Cñdigo</th>`;
                    html += `<th style="padding: 6px; text-align: left;">Municipio</th>`;
                    html += `<th style="padding: 6px; text-align: center;">Fecha Baja</th>`;
                    html += `<th style="padding: 6px; text-align: left;">Motivo</th>`;
                    html += `</tr>`;
                    
                    cambios.bajas.forEach((baja, i) => {
                        const bg = i % 2 === 0 ? '#FEF2F2' : '#FEE2E2';
                        html += `<tr style="background: ${bg};">`;
                        html += `<td style="padding: 6px;"><strong>${baja.codigo}</strong></td>`;
                        html += `<td style="padding: 6px;">${baja.municipio}</td>`;
                        html += `<td style="padding: 6px; text-align: center;">${baja.fechaBaja || '-'}</td>`;
                        html += `<td style="padding: 6px;">${baja.motivo || '-'}</td>`;
                        html += `</tr>`;
                    });
                    
                    html += `</table></div>`;
                }
                
                // DESMONTAJES
                if (cambios.desmontajes.length > 0) {
                    html += `<div style="margin-bottom: 12px;">`;
                    html += `<h4 style="color: #D97706; margin-bottom: 8px;">Desmontajes (${cambios.desmontajes.length})</h4>`;
                    html += `<table style="width: 100%; font-size: 13px; border-collapse: collapse;">`;
                    html += `<tr style="background: #FED7AA; font-weight: 600;">`;
                    html += `<th style="padding: 6px; text-align: left;">Cñdigo</th>`;
                    html += `<th style="padding: 6px; text-align: left;">Municipio</th>`;
                    html += `<th style="padding: 6px; text-align: center;">Fecha Desmontaje</th>`;
                    html += `</tr>`;
                    
                    cambios.desmontajes.forEach((desm, i) => {
                        const bg = i % 2 === 0 ? '#FEF3C7' : '#FED7AA';
                        html += `<tr style="background: ${bg};">`;
                        html += `<td style="padding: 6px;"><strong>${desm.codigo}</strong></td>`;
                        html += `<td style="padding: 6px;">${desm.municipio}</td>`;
                        html += `<td style="padding: 6px; text-align: center;">${desm.fechaDesmontaje || '-'}</td>`;
                        html += `</tr>`;
                    });
                    
                    html += `</table></div>`;
                }
                
                // CAMBIOS DE TARIFA
                if (cambios.cambios_tarifa.length > 0) {
                    html += `<div style="margin-bottom: 12px;">`;
                    html += `<h4 style="color: #7C3AED; margin-bottom: 8px;">Cambios de Tarifa (${cambios.cambios_tarifa.length})</h4>`;
                    html += `<table style="width: 100%; font-size: 13px; border-collapse: collapse;">`;
                    html += `<tr style="background: #DDD6FE; font-weight: 600;">`;
                    html += `<th style="padding: 6px; text-align: left;">Cñdigo</th>`;
                    html += `<th style="padding: 6px; text-align: left;">Municipio</th>`;
                    html += `<th style="padding: 6px; text-align: right;">Tarifa Anterior</th>`;
                    html += `<th style="padding: 6px; text-align: right;">Tarifa Nueva</th>`;
                    html += `<th style="padding: 6px; text-align: center;">Fecha Cambio</th>`;
                    html += `</tr>`;
                    
                    cambios.cambios_tarifa.forEach((tarifa, i) => {
                        const bg = i % 2 === 0 ? '#EDE9FE' : '#DDD6FE';
                        html += `<tr style="background: ${bg};">`;
                        html += `<td style="padding: 6px;"><strong>${tarifa.codigo}</strong></td>`;
                        html += `<td style="padding: 6px;">${tarifa.municipio}</td>`;
                        html += `<td style=\"padding: 6px; text-align: right;\">${tarifa.tarifaAnterior ? (tarifa.tarifaAnterior.toFixed(2) + ' €') : 'Base'}</td>`;
                        html += `<td style=\"padding: 6px; text-align: right; color: #7C3AED; font-weight: 600;\">${tarifa.tarifaNueva.toFixed(2)} €</td>`;
                        html += `<td style="padding: 6px; text-align: center;">${tarifa.fechaCambio || '-'}</td>`;
                        html += `</tr>`;
                    });
                    
                    html += `</table></div>`;
                }
                
                html += `</div>`;
            });
            
            html += '</div>';
            
            // Crear modal temporal
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 10000; padding: 20px;';
            
            const content = document.createElement('div');
            content.style.cssText = 'background: white; border-radius: 12px; max-width: 1200px; width: 100%; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column;';
            
            content.innerHTML = `
                <div style="padding: 24px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
                    <h2 style="color: var(--primary); margin: 0;">Historial de Cambios Mensuales</h2>
                    <button onclick="this.closest('.temp-modal').remove()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--muted);">×</button>
                </div>
                <div style="padding: 24px; overflow-y: auto;">
                    ${html}
                </div>
            `;
            
            modal.className = 'temp-modal';
            modal.appendChild(content);
            modal.onclick = (e) => {
                if (e.target === modal) modal.remove();
            };
            
            document.body.appendChild(modal);
        }

        // Exportar histñ³rico completo
        function exportHistory() {
            if (Object.keys(monthlyHistory).length === 0) {
                alert('No hay Histñrico para exportar');
                return;
            }
            
            let csv = 'Mes,Año,Total Paneles,Facturaciñn Total,Fecha Guardado\n';
            
            const sortedKeys = Object.keys(monthlyHistory).sort();
            sortedKeys.forEach(key => {
                const record = monthlyHistory[key];
                const fecha = new Date(record.fecha).toLocaleDateString('es-ES');
                const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 
                                   'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
                const monthName = monthNames[parseInt(record.mes) - 1];
                
                csv += `${monthName},${record.year},${record.totalPaneles},${record.facturacionTotal.toFixed(2)},${fecha}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `historico_completo_paneles.csv`;
            a.click();
        }

        // Cargar mes especñ­fico del histñ³rico
        function loadMonthFromHistory() {
            if (Object.keys(monthlyHistory).length === 0) {
                alert('No hay Histñrico guardado');
                return;
            }
            
            const month = document.getElementById('currentMonth').value;
            const year = document.getElementById('currentYear').value;
            const monthKey = `${year}-${month}`;
            
            if (monthlyHistory[monthKey]) {
                if (confirm(`¿Cargar datos guardados de ${month}/${year}?\n\nEsto reemplazará los datos actuales.`)) {
                    panelsData = JSON.parse(JSON.stringify(monthlyHistory[monthKey].paneles));
                    saveData();
                    updateTable();
                    alert('Datos del Histñrico cargados correctamente');
                }
            } else {
                alert(`No hay datos guardados para ${month}/${year}`);
            }
        }

        // Hacer backup completo (datos actuales + histñ³rico)
        
        // ====================
        // FUNCIONES DEL SISTEMA DE CAMBIOS MENSUALES
        // ====================

        // Funciñ³n para actualizar dashboard en tiempo real
        function actualizarDashboard() {
            const month = parseInt(document.getElementById('currentMonth').value);
            const year = parseInt(document.getElementById('currentYear').value);
            
            let totalPaneles = 0;
            let facturacionTotal = 0;
            let panelesParciales = 0;
            const municipiosUnicos = new Set();

            panelsData.forEach(panel => {
                const facturacion = calcularFacturacion(panel, month, year);
                
                // Solo contar paneles activos en este mes
                if (facturacion.importe > 0) {
                    totalPaneles++;
                    facturacionTotal += facturacion.importe;
                    municipiosUnicos.add(panel.municipio);
                    
                    if (facturacion.dias < 30) {
                        panelesParciales++;
                    }
                }
            });

            // Actualizar DOM
            document.getElementById('totalPanels').textContent = totalPaneles;
            document.getElementById('totalRevenue').textContent = facturacionTotal.toFixed(2).replace('.', ',') + ' €';
            document.getElementById('totalMunicipios').textContent = municipiosUnicos.size;
            document.getElementById('partialPanels').textContent = panelesParciales;
        }

        // Toggle dropdown menu
        function toggleDropdownMenu() {
            const dropdown = document.getElementById('dropdownMenu');
            dropdown.classList.toggle('hidden');
            dropdown.classList.toggle('show');
        }

        // Cerrar dropdown al hacer click fuera
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('dropdownMenu');
            const button = document.getElementById('btnCambiosMes');
            
            if (dropdown && button && !dropdown.contains(event.target) && event.target !== button) {
                dropdown.classList.add('hidden');
                dropdown.classList.remove('show');
            }
        });

        // Cerrar modal
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('show');
                modal.classList.add('hidden');
                
                // Limpiar formularios
                const form = modal.querySelector('.modal-body');
                if (form) {
                    const inputs = form.querySelectorAll('input, select, textarea');
                    inputs.forEach(input => {
                        if (input.type === 'checkbox' || input.type === 'radio') {
                            input.checked = false;
                        } else {
                            input.value = '';
                        }
                    });
                }
            }
        }

        // ====================
        // MODAL: ALTA DE PANEL NUEVO
        // ====================

        function openModalAlta() {
            const modal = document.getElementById('modalAlta');
            const selectMunicipio = document.getElementById('altaMunicipio');
            const inputFecha = document.getElementById('altaFecha');
            
            // Poblar municipios ñºnicos
            const municipios = [...new Set(panelsData.map(p => p.municipio))].sort();
            selectMunicipio.innerHTML = '<option value="">Seleccionar municipio...</option>';
            municipios.forEach(m => {
                selectMunicipio.innerHTML += `<option value="${m}">${m}</option>`;
            });
            
            // Establecer fecha actual por defecto
            const today = new Date().toISOString().split('T')[0];
            inputFecha.value = today;
            
            // Mostrar modal
            modal.classList.remove('hidden');
            setTimeout(() => modal.classList.add('show'), 10);
            
            // Calcular vista previa inicial
            actualizarVistaPreviewAlta();
        }

        function actualizarVistaPreviewAlta() {
            const fecha = document.getElementById('altaFecha').value;
            if (!fecha) {
                document.getElementById('altaDias').textContent = '-';
                document.getElementById('altaTotal').textContent = '-';
                return;
            }

            const fechaInstalacion = new Date(fecha);
            const mes = parseInt(document.getElementById('currentMonth').value);
            const year = parseInt(document.getElementById('currentYear').value);
            
            // Calcular dñ­as a facturar
            let diasFacturables = 30;
            if (fechaInstalacion.getMonth() + 1 === mes && fechaInstalacion.getFullYear() === year) {
                const diaInstalacion = fechaInstalacion.getDate();
                diasFacturables = 30 - diaInstalacion + 1;
            }

            const tarifaDiaria = 37.70 / 30;
            const total = diasFacturables * tarifaDiaria;

            document.getElementById('altaDias').textContent = `${diasFacturables} días`;
            document.getElementById('altaTotal').textContent = `${total.toFixed(2)} €`;
        }

        async function guardarAlta() {
            const municipio = document.getElementById('altaMunicipio').value;
            const codigo = document.getElementById('altaCodigo').value.trim();
            const fecha = document.getElementById('altaFecha').value;
            const observaciones = document.getElementById('altaObservaciones').value.trim();

            // Validaciones
            if (!municipio) {
                alert('š ï¸ Por favor selecciona un municipio');
                return;
            }
            if (!codigo) {
                alert('⚠️ Por favor ingresa un Cñdigo de panel');
                return;
            }
            if (!fecha) {
                alert('š ï¸ Por favor selecciona una fecha de instalaciñ³n');
                return;
            }

            // Verificar Cñdigo duplicado
            const duplicado = panelsData.find(p => p.codigo.toLowerCase() === codigo.toLowerCase());
            if (duplicado) {
                alert(`⚠️ Ya existe un panel con el Cñdigo "${codigo}"\n\nPor favor usa un Cñdigo diferente.`);
                return;
            }

            // Crear nuevo panel
            const nuevoPanel = {
                municipio: municipio,
                codigo: codigo,
                tarifa: 37.70,
                fechaInstalacion: fecha,
                observaciones: observaciones || null
            };

            try {
                // Guardar en Firestore
                if (window.firebaseDB) {
                    const { collection, addDoc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
                    await addDoc(collection(window.firebaseDB, 'paneles'), nuevoPanel);
                }

                // añadir a panelsData
                panelsData.push(nuevoPanel);
                
                // Registrar cambio
                const mes = parseInt(document.getElementById('currentMonth').value);
                const year = parseInt(document.getElementById('currentYear').value);
                const monthKey = `${year}-${String(mes).padStart(2, '0')}`;
                
                if (!monthlyChanges[monthKey]) {
                    monthlyChanges[monthKey] = [];
                }
                
                monthlyChanges[monthKey].push({
                    tipo: 'ALTA',
                    codigo: codigo,
                    municipio: municipio,
                    fecha: fecha,
                    observaciones: observaciones,
                    timestamp: new Date().toISOString()
                });
                
                localStorage.setItem(CHANGES_KEY, JSON.stringify(monthlyChanges));
                
                // Actualizar interfaz
                updateTable();
                actualizarDashboard();
                saveData();
                
                alert(`✓ Panel dado de alta exitosamente\n\nCñdigo: ${codigo}\nMunicipio: ${municipio}`);
                closeModal('modalAlta');
                
            } catch (error) {
                console.error('✖ Error al guardar:', error);
                alert(`✖ Error al guardar el panel:\n\n${error.message}`);
            }
        }

        // ====================
        // MODAL: REINSTALACIñ“N
        // ====================

        let panelSeleccionadoReinstalacion = null;

        function openModalReinstalacion() {
            const modal = document.getElementById('modalReinstalacion');
            const selectMunicipio = document.getElementById('reinstalacionNuevoMunicipio');
            
            // Poblar municipios
            const municipios = [...new Set(panelsData.map(p => p.municipio))].sort();
            selectMunicipio.innerHTML = '<option value="">Seleccionar municipio...</option>';
            municipios.forEach(m => {
                selectMunicipio.innerHTML += `<option value="${m}">${m}</option>`;
            });
            
            // Mostrar modal
            modal.classList.remove('hidden');
            setTimeout(() => modal.classList.add('show'), 10);
            
            panelSeleccionadoReinstalacion = null;
        }

        function buscarPanel(modalType) {
            const query = document.getElementById(`${modalType}Buscar`).value.toLowerCase();
            const resultsContainer = document.getElementById(`${modalType}Results`);
            
            if (query.length < 2) {
                resultsContainer.classList.remove('show');
                resultsContainer.innerHTML = '';
                return;
            }

            // Filtrar paneles segñºn el tipo de modal
            let resultados = [];
            
            if (modalType === 'reinstalacion') {
                // Solo paneles desmontados
                resultados = panelsData.filter(p => 
                    p.fechaDesmontaje && (
                        p.codigo.toLowerCase().includes(query) ||
                        p.municipio.toLowerCase().includes(query)
                    )
                );
            } else if (modalType === 'baja' || modalType === 'desmontaje' || modalType === 'tarifa') {
                // Paneles activos
                resultados = panelsData.filter(p => 
                    !p.fechaDesmontaje && (
                        p.codigo.toLowerCase().includes(query) ||
                        p.municipio.toLowerCase().includes(query)
                    )
                );
            }

            if (resultados.length === 0) {
                const mensaje = modalType === 'reinstalacion' 
                    ? 'No se encontraron paneles desmontados'
                    : 'No se encontraron paneles activos';
                resultsContainer.innerHTML = `<div style="padding: 12px; color: #64748B; font-size: 14px;">${mensaje}</div>`;
            } else {
                resultsContainer.innerHTML = resultados.map(p => `
                    <div class="search-result-item" onclick="seleccionarPanel${modalType.charAt(0).toUpperCase() + modalType.slice(1)}('${p.codigo}')">
                        <div class="search-result-codigo">${p.codigo}</div>
                        <div class="search-result-municipio">${p.municipio}${p.fechaDesmontaje ? ' · Desmontado: ' + new Date(p.fechaDesmontaje).toLocaleDateString('es-ES') : ''}</div>
                    </div>
                `).join('');
            }
            
            resultsContainer.classList.add('show');
        }

        function seleccionarPanelReinstalacion(codigo) {
            panelSeleccionadoReinstalacion = panelsData.find(p => p.codigo === codigo);
            
            if (panelSeleccionadoReinstalacion) {
                document.getElementById('reinstalacionPanelInfo').innerHTML = `
                    <strong>${panelSeleccionadoReinstalacion.codigo}</strong><br>
                    <span style="color: #64748B; font-size: 13px;">
                        ${panelSeleccionadoReinstalacion.municipio} · 
                        Desmontado: ${new Date(panelSeleccionadoReinstalacion.fechaDesmontaje).toLocaleDateString('es-ES')}
                    </span>
                `;
                
                document.getElementById('reinstalacionResults').classList.remove('show');
                document.getElementById('reinstalacionBuscar').value = panelSeleccionadoReinstalacion.codigo;
            }
        }

        async function guardarReinstalacion() {
            if (!panelSeleccionadoReinstalacion) {
                alert('š ï¸ Por favor selecciona un panel');
                return;
            }

            const fecha = document.getElementById('reinstalacionFecha').value;
            const cambioMunicipio = document.getElementById('reinstalacionCambioMunicipio').checked;
            const nuevoMunicipio = cambioMunicipio ? document.getElementById('reinstalacionNuevoMunicipio').value : null;

            if (!fecha) {
                alert('š ï¸ Por favor selecciona una fecha de reinstalaciñ³n');
                return;
            }

            if (cambioMunicipio && !nuevoMunicipio) {
                alert('š ï¸ Por favor selecciona el nuevo municipio');
                return;
            }

            try {
                // Actualizar panel
                const panel = panelsData.find(p => p.codigo === panelSeleccionadoReinstalacion.codigo);
                if (panel) {
                    panel.fechaDesmontaje = null; // Quitar desmontaje
                    panel.fechaInstalacion = fecha; // Nueva fecha de instalaciñ³n
                    
                    if (cambioMunicipio) {
                        panel.municipio = nuevoMunicipio;
                    }

                    // Registrar cambio
                    const mes = parseInt(document.getElementById('currentMonth').value);
                    const year = parseInt(document.getElementById('currentYear').value);
                    const monthKey = `${year}-${String(mes).padStart(2, '0')}`;
                    
                    if (!monthlyChanges[monthKey]) {
                        monthlyChanges[monthKey] = [];
                    }
                    
                    monthlyChanges[monthKey].push({
                        tipo: 'REINSTALACION',
                        codigo: panel.codigo,
                        municipio: panel.municipio,
                        municipioAnterior: cambioMunicipio ? panelSeleccionadoReinstalacion.municipio : null,
                        fecha: fecha,
                        timestamp: new Date().toISOString()
                    });
                    
                    localStorage.setItem(CHANGES_KEY, JSON.stringify(monthlyChanges));
                    
                    // Actualizar interfaz
                    updateTable();
                    actualizarDashboard();
                    saveData();
                    
                    alert(`✓ Panel reinstalado exitosamente\n\nCñdigo: ${panel.codigo}\nMunicipio: ${panel.municipio}`);
                    closeModal('modalReinstalacion');
                }
                
            } catch (error) {
                console.error('✖ Error:', error);
                alert(`✖ Error al reinstalar:\n\n${error.message}`);
            }
        }

        // ====================
        // MODAL: BAJA DEFINITIVA
        // ====================

        let panelSeleccionadoBaja = null;

        function openModalBaja() {
            const modal = document.getElementById('modalBaja');
            modal.classList.remove('hidden');
            setTimeout(() => modal.classList.add('show'), 10);
            panelSeleccionadoBaja = null;
        }

        function seleccionarPanelBaja(codigo) {
            panelSeleccionadoBaja = panelsData.find(p => p.codigo === codigo);
            
            if (panelSeleccionadoBaja) {
                document.getElementById('bajaPanelInfo').innerHTML = `
                    <strong>${panelSeleccionadoBaja.codigo}</strong><br>
                    <span style="color: #64748B; font-size: 13px;">
                        ${panelSeleccionadoBaja.municipio} · Tarifa: ${(panelSeleccionadoBaja.tarifa || 37.70).toFixed(2)} €/mes
                    </span>
                `;
                
                document.getElementById('bajaResults').classList.remove('show');
                document.getElementById('bajaBuscar').value = panelSeleccionadoBaja.codigo;
                
                // Actualizar preview
                document.getElementById('bajaFacturacionActual').textContent = `${(panelSeleccionadoBaja.tarifa || 37.70).toFixed(2)} €`;
                document.getElementById('bajaPerdida').textContent = `${(panelSeleccionadoBaja.tarifa || 37.70).toFixed(2)} €`;
            }
        }

        async function guardarBaja() {
            if (!panelSeleccionadoBaja) {
                alert('š ï¸ Por favor selecciona un panel');
                return;
            }

            const motivo = document.getElementById('bajaMotivo').value;
            const confirmacion = document.getElementById('bajaConfirmacion').checked;

            if (!motivo) {
                alert('š ï¸ Por favor selecciona el motivo de la baja');
                return;
            }

            if (!confirmacion) {
                alert('š ï¸ Debes confirmar la baja definitiva del panel');
                return;
            }

            try {
                // Eliminar panel de panelsData
                const index = panelsData.findIndex(p => p.codigo === panelSeleccionadoBaja.codigo);
                if (index !== -1) {
                    panelsData.splice(index, 1);

                    // Registrar cambio
                    const mes = parseInt(document.getElementById('currentMonth').value);
                    const year = parseInt(document.getElementById('currentYear').value);
                    const monthKey = `${year}-${String(mes).padStart(2, '0')}`;
                    
                    if (!monthlyChanges[monthKey]) {
                        monthlyChanges[monthKey] = [];
                    }
                    
                    monthlyChanges[monthKey].push({
                        tipo: 'BAJA',
                        codigo: panelSeleccionadoBaja.codigo,
                        municipio: panelSeleccionadoBaja.municipio,
                        motivo: motivo,
                        timestamp: new Date().toISOString()
                    });
                    
                    localStorage.setItem(CHANGES_KEY, JSON.stringify(monthlyChanges));
                    
                    // Actualizar interfaz
                    updateTable();
                    actualizarDashboard();
                    saveData();
                    
                    alert(`✓ Panel dado de baja exitosamente\n\nCñdigo: ${panelSeleccionadoBaja.codigo}\nMotivo: ${motivo}`);
                    closeModal('modalBaja');
                }
                
            } catch (error) {
                console.error('✖ Error:', error);
                alert(`✖ Error al dar de baja:\n\n${error.message}`);
            }
        }

        // ====================
        // MODAL: DESMONTAJE TEMPORAL
        // ====================

        let panelSeleccionadoDesmontaje = null;

        function openModalDesmontaje() {
            const modal = document.getElementById('modalDesmontaje');
            const inputFecha = document.getElementById('desmontajeFecha');
            
            // Establecer fecha actual
            const today = new Date().toISOString().split('T')[0];
            inputFecha.value = today;
            
            modal.classList.remove('hidden');
            setTimeout(() => modal.classList.add('show'), 10);
            panelSeleccionadoDesmontaje = null;
        }

        function seleccionarPanelDesmontaje(codigo) {
            panelSeleccionadoDesmontaje = panelsData.find(p => p.codigo === codigo);
            
            if (panelSeleccionadoDesmontaje) {
                document.getElementById('desmontajePanelInfo').innerHTML = `
                    <strong>${panelSeleccionadoDesmontaje.codigo}</strong><br>
                    <span style="color: #64748B; font-size: 13px;">
                        ${panelSeleccionadoDesmontaje.municipio} · Tarifa: ${(panelSeleccionadoDesmontaje.tarifa || 37.70).toFixed(2)} €/mes
                    </span>
                `;
                
                document.getElementById('desmontagResults').classList.remove('show');
                document.getElementById('desmontajeBuscar').value = panelSeleccionadoDesmontaje.codigo;
                
                actualizarVistaPreviewDesmontaje();
            }
        }

        function actualizarVistaPreviewDesmontaje() {
            if (!panelSeleccionadoDesmontaje) return;

            const fecha = document.getElementById('desmontajeFecha').value;
            if (!fecha) return;

            const fechaDesmontaje = new Date(fecha);
            const mes = parseInt(document.getElementById('currentMonth').value);
            const year = parseInt(document.getElementById('currentYear').value);
            
            let diasActivos = 30;
            if (fechaDesmontaje.getMonth() + 1 === mes && fechaDesmontaje.getFullYear() === year) {
                diasActivos = fechaDesmontaje.getDate();
            }

            const tarifaDiaria = (panelSeleccionadoDesmontaje.tarifa || 37.70) / 30;
            const facturacionAjustada = diasActivos * tarifaDiaria;
            const ahorro = ((panelSeleccionadoDesmontaje.tarifa || 37.70) - facturacionAjustada);

            document.getElementById('desmontajeDias').textContent = `${diasActivos} días`;
            document.getElementById('desmontagTotal').textContent = `${facturacionAjustada.toFixed(2)} €`;
            document.getElementById('desmontagAhorro').textContent = `${ahorro.toFixed(2)} €`;
        }

        async function guardarDesmontaje() {
            if (!panelSeleccionadoDesmontaje) {
                alert('š ï¸ Por favor selecciona un panel');
                return;
            }

            const fecha = document.getElementById('desmontajeFecha').value;
            const motivo = document.getElementById('desmontagMotivo').value;

            if (!fecha) {
                alert('š ï¸ Por favor selecciona una fecha de desmontaje');
                return;
            }

            if (!motivo) {
                alert('š ï¸ Por favor selecciona el motivo del desmontaje');
                return;
            }

            try {
                // Actualizar panel
                const panel = panelsData.find(p => p.codigo === panelSeleccionadoDesmontaje.codigo);
                if (panel) {
                    panel.fechaDesmontaje = fecha;

                    // Registrar cambio
                    const mes = parseInt(document.getElementById('currentMonth').value);
                    const year = parseInt(document.getElementById('currentYear').value);
                    const monthKey = `${year}-${String(mes).padStart(2, '0')}`;
                    
                    if (!monthlyChanges[monthKey]) {
                        monthlyChanges[monthKey] = [];
                    }
                    
                    monthlyChanges[monthKey].push({
                        tipo: 'DESMONTAJE',
                        codigo: panel.codigo,
                        municipio: panel.municipio,
                        fecha: fecha,
                        motivo: motivo,
                        timestamp: new Date().toISOString()
                    });
                    
                    localStorage.setItem(CHANGES_KEY, JSON.stringify(monthlyChanges));
                    
                    // Actualizar interfaz
                    updateTable();
                    actualizarDashboard();
                    saveData();
                    
                    alert(`✓ Panel desmontado exitosamente\n\nCñdigo: ${panel.codigo}\nFecha: ${new Date(fecha).toLocaleDateString('es-ES')}`);
                    closeModal('modalDesmontaje');
                }
                
            } catch (error) {
                console.error('✖ Error:', error);
                alert(`✖ Error al desmontar:\n\n${error.message}`);
            }
        }

        // ====================
        // MODAL: CAMBIO DE TARIFA
        // ====================

        let panelSeleccionadoTarifa = null;

        function openModalCambioTarifa() {
            const modal = document.getElementById('modalCambioTarifa');
            modal.classList.remove('hidden');
            setTimeout(() => modal.classList.add('show'), 10);
            panelSeleccionadoTarifa = null;
        }

        function seleccionarPanelTarifa(codigo) {
            panelSeleccionadoTarifa = panelsData.find(p => p.codigo === codigo);
            
            if (panelSeleccionadoTarifa) {
                document.getElementById('tarifaPanelInfo').innerHTML = `
                    <strong>${panelSeleccionadoTarifa.codigo}</strong><br>
                    <span style="color: #64748B; font-size: 13px;">
                        ${panelSeleccionadoTarifa.municipio} · Tarifa actual: ${(panelSeleccionadoTarifa.tarifa || 37.70).toFixed(2)} €/mes
                    </span>
                `;
                
                document.getElementById('tarifaResults').classList.remove('show');
                document.getElementById('tarifaBuscar').value = panelSeleccionadoTarifa.codigo;
                
                document.getElementById('tarifaActual').textContent = `${(panelSeleccionadoTarifa.tarifa || 37.70).toFixed(2)} €`;
            }
        }

        function actualizarVistaPreviewTarifa() {
            const nuevaTarifa = parseFloat(document.getElementById('tarifaNueva').value);
            const alcance = document.querySelector('input[name="tarifaAlcance"]:checked')?.value;
            
            if (!nuevaTarifa || isNaN(nuevaTarifa)) {
                document.getElementById('tarifaNuevaPreview').textContent = '-';
                document.getElementById('tarifaPanelesAfectados').textContent = '-';
                document.getElementById('tarifaVariacion').textContent = '-';
                return;
            }

            document.getElementById('tarifaNuevaPreview').textContent = `${nuevaTarifa.toFixed(2)} €`;

            let panelesAfectados = 0;
            let variacion = 0;

            if (alcance === 'solo_este' && panelSeleccionadoTarifa) {
                panelesAfectados = 1;
                variacion = nuevaTarifa - (panelSeleccionadoTarifa.tarifa || 37.70);
            } else if (alcance === 'todos_municipio' && panelSeleccionadoTarifa) {
                const panelesMunicipio = panelsData.filter(p => p.municipio === panelSeleccionadoTarifa.municipio);
                panelesAfectados = panelesMunicipio.length;
                panelesMunicipio.forEach(p => {
                    variacion += nuevaTarifa - (p.tarifa || 37.70);
                });
            } else if (alcance === 'todos') {
                panelesAfectados = panelsData.length;
                panelsData.forEach(p => {
                    variacion += nuevaTarifa - (p.tarifa || 37.70);
                });
            }

            document.getElementById('tarifaPanelesAfectados').textContent = panelesAfectados;
            
            const variacionColor = variacion >= 0 ? '#16A34A' : '#DC2626';
            const variacionSigno = variacion >= 0 ? '+' : '';
            document.getElementById('tarifaVariacion').innerHTML = 
                `<span style="color: ${variacionColor};">${variacionSigno}${variacion.toFixed(2)} €</span>`;
        }

        async function guardarCambioTarifa() {
            if (!panelSeleccionadoTarifa) {
                alert('š ï¸ Por favor selecciona un panel');
                return;
            }

            const nuevaTarifa = parseFloat(document.getElementById('tarifaNueva').value);
            const alcance = document.querySelector('input[name="tarifaAlcance"]:checked')?.value;

            if (!nuevaTarifa || isNaN(nuevaTarifa) || nuevaTarifa <= 0) {
                alert('š ï¸ Por favor ingresa una tarifa válida');
                return;
            }

            if (!alcance) {
                alert('š ï¸ Por favor selecciona el alcance del cambio');
                return;
            }

            try {
                let panelesModificados = [];

                if (alcance === 'solo_este') {
                    const panel = panelsData.find(p => p.codigo === panelSeleccionadoTarifa.codigo);
                    if (panel) {
                        panel.tarifa = nuevaTarifa;
                        panelesModificados.push(panel.codigo);
                    }
                } else if (alcance === 'todos_municipio') {
                    panelsData.forEach(p => {
                        if (p.municipio === panelSeleccionadoTarifa.municipio) {
                            p.tarifa = nuevaTarifa;
                            panelesModificados.push(p.codigo);
                        }
                    });
                } else if (alcance === 'todos') {
                    panelsData.forEach(p => {
                        p.tarifa = nuevaTarifa;
                        panelesModificados.push(p.codigo);
                    });
                }

                // Registrar cambio
                const mes = parseInt(document.getElementById('currentMonth').value);
                const year = parseInt(document.getElementById('currentYear').value);
                const monthKey = `${year}-${String(mes).padStart(2, '0')}`;
                
                if (!monthlyChanges[monthKey]) {
                    monthlyChanges[monthKey] = [];
                }
                
                monthlyChanges[monthKey].push({
                    tipo: 'CAMBIO_TARIFA',
                    alcance: alcance,
                    nuevaTarifa: nuevaTarifa,
                    panelesAfectados: panelesModificados,
                    municipio: alcance === 'todos_municipio' ? panelSeleccionadoTarifa.municipio : null,
                    timestamp: new Date().toISOString()
                });
                
                localStorage.setItem(CHANGES_KEY, JSON.stringify(monthlyChanges));
                
                // Actualizar interfaz
                updateTable();
                actualizarDashboard();
                saveData();
                
                alert(`✓ Tarifa actualizada exitosamente\n\nPaneles afectados: ${panelesModificados.length}\nNueva tarifa: ${nuevaTarifa.toFixed(2)} €`);
                closeModal('modalCambioTarifa');
                
            } catch (error) {
                console.error('✖ Error:', error);
                alert(`✖ Error al cambiar tarifa:\n\n${error.message}`);
            }
        }

        // ====================
        // FIN DEL SISTEMA DE CAMBIOS MENSUALES
        // ====================

        function backupComplete() {
            const backup = {
                fecha_backup: new Date().toISOString(),
                datos_actuales: panelsData,
                historico_mensual: monthlyHistory,
                mes_actual: document.getElementById('currentMonth').value,
                year_actual: document.getElementById('currentYear').value
            };
            
            const json = JSON.stringify(backup, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            const fecha = new Date().toISOString().split('T')[0];
            a.href = url;
            a.download = `backup_completo_${fecha}.json`;
            a.click();
            
            alert('✓ Backup completo creado\n\nIncluye:\n• Datos actuales\n• Todo el Histñrico mensual\n• CONFIGURACIÓNn actual');
        }

        // Inicializar event listeners
        // NOTA: loadInitialData() ya NO se llama aquñ­
        // Se llama automáticamente despuñ©s de autenticaciñ³n exitosa
        document.addEventListener('DOMContentLoaded', () => {
            // NO llamar loadInitialData() aquñ­ - se llama en iniciarAplicacion()
            
            document.getElementById('currentMonth').addEventListener('change', updateTable);
            document.getElementById('currentYear').addEventListener('change', updateTable);
            document.getElementById('baseRate').addEventListener('change', updateTable);
            
            // Event listeners para vista previa en tiempo real
            const altaFecha = document.getElementById('altaFecha');
            if (altaFecha) {
                altaFecha.addEventListener('change', actualizarVistaPreviewAlta);
            }

            const desmontajeFecha = document.getElementById('desmontajeFecha');
            if (desmontajeFecha) {
                desmontajeFecha.addEventListener('change', actualizarVistaPreviewDesmontaje);
            }

            const tarifaNueva = document.getElementById('tarifaNueva');
            if (tarifaNueva) {
                tarifaNueva.addEventListener('input', actualizarVistaPreviewTarifa);
            }

            const radiosTarifa = document.getElementsByName('tarifaAlcance');
            radiosTarifa.forEach(radio => {
                radio.addEventListener('change', actualizarVistaPreviewTarifa);
            });

            const reinstalacionCambioMunicipio = document.getElementById('reinstalacionCambioMunicipio');
            const reinstalacionNuevoMunicipioGroup = document.getElementById('reinstalacionNuevoMunicipioGroup');
            if (reinstalacionCambioMunicipio && reinstalacionNuevoMunicipioGroup) {
                reinstalacionCambioMunicipio.addEventListener('change', function() {
                    reinstalacionNuevoMunicipioGroup.style.display = this.checked ? 'block' : 'none';
                });
            }
        });
    </script>

        <!-- ============================================
             BOTñ“N FLOTANTE MINIMALISTA
             ============================================ -->
        <button class="minimal-fab" onclick="toggleDropdownMenu()" title="añadir nuevo cambio">
            +
        </button>

    </div> <!-- Fin de minimal-main -->
    </div> <!-- Fin de appContainer -->
</body>
</html>















