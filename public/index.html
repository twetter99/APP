<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Paneles TFT – CRTM</title>
    
    <!-- TailwindCSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- SheetJS para exportar Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- Google Fonts - Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
    
    <!-- Firebase SDK v10 - Compat Mode (para compatibilidad con código legacy) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    
    <script>
      // ============================================
      // CONFIGURACIÓN FIREBASE (COMPAT MODE)
      // ============================================
      const firebaseConfig = {
        apiKey: "AIzaSyBtOWKZh8WelWpsXIbsk_AWb7hBSJVUP3Y",
        authDomain: "piv-manager.firebaseapp.com",
        projectId: "piv-manager",
        storageBucket: "piv-manager.firebasestorage.app",
        messagingSenderId: "984787325363",
        appId: "1:984787325363:web:3b34b5dad3c3fde846fbc6"
      };
      
      // Inicializar Firebase (modo compat - expone variables globales)
      const firebaseApp = firebase.initializeApp(firebaseConfig);
      const firebaseDB = firebase.firestore();
      const firebaseAuth = firebase.auth();
      
      // Configurar persistencia de sesión
      firebaseAuth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
      
      console.log('✅ Firebase inicializado correctamente (compat mode)');
      
      // ============================================
      // EXPONER AL SCOPE GLOBAL PARA CÓDIGO LEGACY
      // ============================================
      window.firebase = firebase;
      window.firebaseApp = firebaseApp;
      window.firebaseDB = firebaseDB;
      window.firebaseAuth = firebaseAuth;
      
      // Exponer clases y funciones de autenticación
      window.GoogleAuthProvider = firebase.auth.GoogleAuthProvider;
      window.signInWithPopup = (auth, provider) => auth.signInWithPopup(provider);
      window.signOut = (auth) => auth.signOut();
      window.onAuthStateChanged = (auth, callback) => auth.onAuthStateChanged(callback);
      
      // ============================================
      // FUNCIONES DE CONTROL DE PANTALLAS
      // ============================================
      
      function mostrarPantallaLogin() {
        const loginScreen = document.getElementById('loginScreen');
        if (loginScreen) loginScreen.style.display = 'flex';
      }
      
      function ocultarPantallaLogin() {
        const loginScreen = document.getElementById('loginScreen');
        if (loginScreen) loginScreen.style.display = 'none';
      }
      
      function mostrarAplicacion() {
        const appContainer = document.getElementById('appContainer');
        if (appContainer) appContainer.classList.add('visible');
      }
      
      function ocultarAplicacion() {
        const appContainer = document.getElementById('appContainer');
        if (appContainer) appContainer.classList.remove('visible');
      }
      
      async function iniciarAplicacion(user) {
        console.log('👤 Iniciando aplicación para:', user.email);
        
        // Actualizar información del usuario en el header
        const userPhoto = document.getElementById('userPhoto');
        const userName = document.getElementById('userName');
        const userEmail = document.getElementById('userEmail');
        
        if (userPhoto) {
          userPhoto.src = user.photoURL || 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="50" height="50"><circle cx="25" cy="25" r="25" fill="%231e3a5f"/><text x="25" y="32" text-anchor="middle" fill="white" font-size="20" font-family="Arial"></text></svg>';
        }
        if (userName) userName.textContent = user.displayName || 'Usuario';
        if (userEmail) userEmail.textContent = user.email;
        
        // Ocultar login y mostrar app
        ocultarPantallaLogin();
        mostrarAplicacion();
        
        // Cargar datos iniciales
        if (window.loadInitialData) {
          await window.loadInitialData();
        }
      }
      
      function cerrarAplicacion() {
        console.log('🚪 Cerrando aplicación');
        
        // Ocultar app y mostrar login
        ocultarAplicacion();
        mostrarPantallaLogin();
        
        // Limpiar datos sensibles si es necesario
        // (Los datos se mantendrán en memoria pero la UI estará oculta)
      }
      
      // ============================================
      // MONITOREAR ESTADO DE AUTENTICACIÓN
      // ============================================
      
      firebaseAuth.onAuthStateChanged(async (user) => {
        if (user) {
          // Usuario autenticado
          console.log('✅ Usuario autenticado:', user.email);
          await iniciarAplicacion(user);
        } else {
          // Usuario no autenticado
          console.log('❌ Usuario no autenticado');
          cerrarAplicacion();
        }
      });
      
      // ============================================
      // FUNCIÓN PARA CARGAR PANELES DESDE FIRESTORE
      // ============================================
      
      window.cargarPanelesDesdeFirestore = async function() {
        try {
          console.log('📦 Cargando paneles desde Firestore...');
          
          // Verificar que el usuario esté autenticado
          if (!firebaseAuth.currentUser) {
            throw new Error('No hay usuario autenticado');
          }
          
          const snapshot = await firebaseDB.collection('paneles')
            .orderBy('municipio')
            .get();
          
          const panelesFirestore = [];
          snapshot.forEach((doc) => {
            const data = doc.data();
            panelesFirestore.push({
              id: doc.id,
              municipio: data.municipio,
              codigo: data.codigo,
              tarifa: data.tarifa || 37.70,
              fechaInstalacion: data.fechaInstalacion,
              fechaDesmontaje: data.fechaDesmontaje,
              estado: data.estado || (data.fechaDesmontaje ? 'desmontado' : 'activo'),
              operador: data.operador || 'UTE'
            });
          });
          
          console.log(`✅ ${panelesFirestore.length} paneles cargados desde Firestore`);
          
          return panelesFirestore;
        } catch (error) {
          console.error('❌ Error al cargar desde Firestore:', error);
          
          // Si es error de autenticación, mostrar mensaje especial
          if (error.code === 'permission-denied' || error.message.includes('autenticado')) {
            alert('⚠️ Sesión expirada. Por favor inicia sesión de nuevo');
            await firebaseAuth.signOut();
          }
          
          return [];
        }
      };
      
    </script>
    
    <!-- Script de autenticación (NO module para onclick) -->
    <script src="auth.js"></script>
    
    <!-- Billing Service - Sistema de Facturación (cache-busting) -->
    <script src="billingService.js?v=20251106-1"></script>
    
    <style>
        /* ============================================
           DISEÑO MINIMALISTA ESPAÑOL
           Inspiración: Stripe, Vercel, GitHub moderno
           ============================================ */
        :root {
            /* Colores minimalistas */
            --black: #000000;
            --gray-dark: #374151;
            --gray: #6B7280;
            --gray-light: #D1D5DB;
            --gray-lighter: #F3F4F6;
            --white: #FFFFFF;
            --blue: #2563EB;
            --green: #10B981;
            --red: #EF4444;
            --orange: #F59E0B;
            
            /* Espaciado consistente */
            --space-xs: 8px;
            --space-sm: 16px;
            --space-md: 24px;
            --space-lg: 32px;
            --space-xl: 48px;
            --space-2xl: 64px;
            
            /* Bordes */
            --border-radius: 12px;
            --border-color: var(--gray-light);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Inter', 'Helvetica Neue', Arial, sans-serif;
            background: var(--white);
            color: var(--black);
            line-height: 1.6;
            font-size: 15px;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 var(--space-md);
        }

        /* ============================================
           HEADER MINIMALISTA
           ============================================ */
        .minimal-header {
            background: var(--white);
            border-bottom: 1px solid var(--border-color);
            padding: var(--space-md) 0;
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.95);
        }

        .minimal-header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 var(--space-md);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .minimal-logo {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }

        .minimal-logo-text {
            font-size: 20px;
            font-weight: 700;
            color: var(--black);
            letter-spacing: -0.5px;
        }

        .minimal-logo-subtitle {
            font-size: 13px;
            color: var(--gray);
            font-weight: 400;
            margin-left: var(--space-sm);
            padding-left: var(--space-sm);
            border-left: 1px solid var(--gray-light);
        }

        .minimal-user {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }

        .minimal-user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: 2px solid var(--gray-lighter);
        }

        .minimal-user-info {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }

        .minimal-user-name {
            font-size: 13px;
            font-weight: 600;
            color: var(--black);
        }

        .minimal-user-email {
            font-size: 12px;
            color: var(--gray);
        }

        .minimal-btn-logout {
            padding: 8px 16px;
            background: var(--white);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            color: var(--gray-dark);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .minimal-btn-logout:hover {
            background: var(--gray-lighter);
            border-color: var(--gray);
        }

        /* ============================================
           SECCIñN PRINCIPAL
           ============================================ */
        .minimal-main {
            max-width: 1200px;
            margin: 0 auto;
            padding: var(--space-2xl) var(--space-md);
        }

        .minimal-section-title {
            font-size: 28px;
            font-weight: 700;
            color: var(--black);
            margin-bottom: var(--space-xs);
            letter-spacing: -0.5px;
        }

        .minimal-section-subtitle {
            font-size: 15px;
            color: var(--gray);
            margin-bottom: var(--space-xl);
        }

        /* ============================================
           CARDS DE ESTADñSTICAS XXL
           ============================================ */
        .minimal-stats {
            display: grid;
            grid-template-columns: 0.9fr 0.9fr 1.3fr 0.9fr;
            gap: 14px;
            margin-bottom: var(--space-2xl);
            max-width: 100%;
        }

        .minimal-stat-card {
            background: var(--white);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 22px 18px;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-height: 160px;
        }

        .minimal-stat-card:hover {
            border-color: var(--gray);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.04);
        }

        .minimal-stat-label {
            font-size: 13px;
            font-weight: 600;
            color: var(--gray);
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .minimal-stat-value {
            font-size: 48px;
            font-weight: 700;
            color: var(--black);
            line-height: 1.1;
            letter-spacing: -1.2px;
            margin-bottom: 8px;
            word-break: break-word;
        }

        .minimal-stat-detail {
            font-size: 14px;
            color: var(--gray);
            font-weight: 500;
        }

        /* ============================================
           LISTA DE PANELES MINIMALISTA
           ============================================ */
        .minimal-list-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--space-md);
        }

        .minimal-list-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--black);
        }

        .minimal-btn-primary {
            padding: 12px 24px;
            background: var(--blue);
            color: var(--white);
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .minimal-btn-primary:hover {
            background: #1D4ED8;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2);
        }

        .minimal-search-box {
            margin-bottom: var(--space-md);
        }

        .minimal-search-input {
            width: 100%;
            max-width: 500px;
            padding: 12px 16px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 15px;
            font-family: inherit;
            transition: all 0.2s ease;
        }

        .minimal-search-input:focus {
            outline: none;
            border-color: var(--blue);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .minimal-list {
            background: var(--white);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            overflow: hidden;
        }

        .minimal-list-item {
            padding: var(--space-md);
            border-bottom: 1px solid var(--gray-lighter);
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .minimal-list-item:last-child {
            border-bottom: none;
        }

        .minimal-list-item:hover {
            background: var(--gray-lighter);
        }

        .minimal-list-item-main {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .minimal-list-item-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--black);
        }

        .minimal-list-item-separator {
            color: var(--gray-light);
            margin: 0 12px;
        }

        .minimal-list-item-meta {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 14px;
            color: var(--gray);
        }

        .minimal-list-item-detail {
            display: flex;
            align-items: center;
            gap: var(--space-md);
            font-size: 14px;
            color: var(--gray);
        }

        .minimal-list-item-price {
            font-size: 15px;
            font-weight: 600;
            color: var(--black);
        }

        .minimal-badge {
            padding: 4px 12px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 600;
        }

        .minimal-badge-green {
            background: rgba(16, 185, 129, 0.1);
            color: var(--green);
        }

        .minimal-badge-gray {
            background: var(--gray-lighter);
            color: var(--gray);
        }

        .minimal-badge-orange {
            background: rgba(245, 158, 11, 0.1);
            color: var(--orange);
        }

        .minimal-list-item-actions {
            display: flex;
            gap: 8px;
        }

        .minimal-btn-icon {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            background: var(--white);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 16px;
        }

        .minimal-btn-icon:hover {
            background: var(--gray-lighter);
            border-color: var(--gray);
        }

        /* ============================================
           BOTñN FLOTANTE
           ============================================ */
        .minimal-fab {
            position: fixed;
            bottom: 32px;
            right: 32px;
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background: var(--green);
            color: var(--white);
            border: none;
            box-shadow: 0 4px 16px rgba(16, 185, 129, 0.3);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            font-weight: 300;
            transition: all 0.3s ease;
            z-index: 90;
        }

        .minimal-fab:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 24px rgba(16, 185, 129, 0.4);
        }

        .minimal-fab:active {
            transform: scale(0.95);
        }

        /* ============================================
           SECCIñN DE PANELES
           ============================================ */
        .minimal-panels-section {
            margin-top: var(--space-2xl);
        }

        .minimal-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-xl);
            gap: var(--space-lg);
        }

        .minimal-list-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--space-lg);
            background: var(--white);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: var(--space-xs);
            transition: all 0.2s ease;
        }

        .minimal-list-item:hover {
            border-color: var(--gray);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        }

        .minimal-list-item-info {
            flex: 1;
            display: flex;
            align-items: center;
            gap: var(--space-lg);
        }

        .minimal-list-item-main {
            display: flex;
            align-items: center;
            gap: var(--space-md);
            min-width: 300px;
        }

        .minimal-list-item-municipio {
            font-size: 15px;
            font-weight: 600;
            color: var(--black);
        }

        .minimal-list-item-codigo {
            font-size: 14px;
            color: var(--gray);
            font-family: 'Monaco', 'Courier New', monospace;
        }

        .minimal-list-item-separator {
            color: var(--border-color);
            font-weight: 300;
        }

        .minimal-list-item-meta {
            display: flex;
            gap: var(--space-xl);
        }

        .minimal-list-item-stat {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .minimal-list-item-stat-label {
            font-size: 12px;
            color: var(--gray);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .minimal-list-item-stat-value {
            font-size: 15px;
            font-weight: 600;
            color: var(--black);
        }

        .minimal-list-item-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .minimal-badge-active {
            background: #DCFCE7;
            color: #166534;
        }

        .minimal-badge-paused {
            background: #FEF3C7;
            color: #92400E;
        }

        .minimal-badge-dismounted {
            background: #F3F4F6;
            color: #6B7280;
        }

        .minimal-list-item-actions {
            display: flex;
            gap: var(--space-sm);
        }

        .minimal-action-btn {
            width: 36px;
            height: 36px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            background: var(--white);
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            font-size: 14px;
        }

        .minimal-action-btn:hover {
            border-color: var(--blue);
            background: var(--background);
            transform: scale(1.05);
        }

        .minimal-action-btn.edit:hover {
            border-color: var(--blue);
            color: var(--blue);
        }

        .minimal-action-btn.delete:hover {
            border-color: var(--red);
            color: var(--red);
        }

        /* ============================================
           ANIMACIONES
           ============================================ */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fade-in {
            animation: fadeIn 0.3s ease forwards;
        }

        /* ============================================
           ESTILOS COMPATIBLES CON CñDIGO EXISTENTE
           ============================================ */
        .vesta-nav {
            display: flex;
            align-items: center;
            gap: 0;
            overflow-x: auto;
            padding: 0 20px;
        }

        .vesta-nav-tab {
            padding: 16px 24px;
            color: rgba(255,255,255,0.8);
            text-decoration: none;
            font-weight: 500;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            cursor: pointer;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .vesta-nav-tab:hover {
            background: rgba(255,255,255,0.05);
            color: white;
        }

        .vesta-nav-tab.active {
            color: white;
            border-bottom-color: var(--vesta-orange);
            background: rgba(255,255,255,0.05);
        }

        .vesta-badge {
            background: var(--vesta-orange);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            min-width: 20px;
            text-align: center;
        }

        /* ============================================
           SUBBARRA DE ACCIONES
           ============================================ */
        .vesta-actionbar {
            background: white;
            border-bottom: 1px solid var(--vesta-border);
            padding: 12px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .vesta-btn-outline {
            padding: 8px 16px;
            border: 1px solid var(--vesta-border);
            background: white;
            color: var(--vesta-text);
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .vesta-btn-outline:hover {
            border-color: var(--vesta-gray);
            background: var(--vesta-hover);
        }

        .vesta-search {
            flex: 1;
            max-width: 400px;
            position: relative;
        }

        .vesta-search input {
            width: 100%;
            padding: 8px 36px 8px 12px;
            border: 1px solid var(--vesta-border);
            border-radius: 6px;
            font-size: 13px;
        }

        .vesta-search-icon {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--vesta-text-muted);
        }

        /* ============================================
           CONTENIDO PRINCIPAL
           ============================================ */
        .vesta-content {
            padding: 20px;
        }

        .vesta-card {
            background: var(--vesta-card);
            border: 1px solid var(--vesta-border);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
        }

        .vesta-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            transform: translateY(-2px);
        }

        .vesta-card-row {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .vesta-card-info {
            flex: 1;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .vesta-card-field {
            display: flex;
            flex-direction: column;
        }

        .vesta-card-label {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--vesta-text-muted);
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .vesta-card-value {
            font-size: 14px;
            font-weight: 500;
            color: var(--vesta-text);
        }

        .vesta-card-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        /* ============================================
           BOTONES DE ACCIñN
           ============================================ */
        .vesta-btn-action {
            width: 36px;
            height: 36px;
            border-radius: 6px;
            border: 1px solid var(--vesta-border);
            background: white;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            position: relative;
        }

        .vesta-btn-action:hover {
            transform: scale(1.1);
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        .vesta-btn-action.edit {
            border-color: var(--vesta-green);
            color: var(--vesta-green);
        }

        .vesta-btn-action.edit:hover {
            background: var(--vesta-green);
            color: white;
        }

        .vesta-btn-action.delete {
            border-color: var(--vesta-red);
            color: var(--vesta-red);
        }

        .vesta-btn-action.delete:hover {
            background: var(--vesta-red);
            color: white;
        }

        .vesta-btn-action.suspend {
            border-color: var(--vesta-text-muted);
            color: var(--vesta-text-muted);
        }

        .vesta-btn-action.suspend:hover {
            background: var(--vesta-text-muted);
            color: white;
        }

        /* ============================================
           BOTñN FLOTANTE (+)
           ============================================ */
        .vesta-fab {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--vesta-green);
            color: white;
            border: none;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            font-weight: 300;
            transition: all 0.3s ease;
            z-index: 90;
        }

        .vesta-fab:hover {
            transform: scale(1.1) rotate(90deg);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.5);
        }

        .vesta-fab:active {
            transform: scale(0.95) rotate(90deg);
        }

        /* ============================================
           TOOLTIPS
           ============================================ */
        [data-tooltip] {
            position: relative;
        }

        [data-tooltip]:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%) translateY(-8px);
            background: var(--vesta-topbar);
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 1000;
            opacity: 0;
            animation: tooltipFadeIn 0.2s forwards;
        }

        @keyframes tooltipFadeIn {
            to { opacity: 1; transform: translateX(-50%) translateY(-4px); }
        }

        /* ============================================
           STATS DASHBOARD
           ============================================ */
        .vesta-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .vesta-stat-card {
            background: white;
            border: 1px solid var(--vesta-border);
            border-radius: 12px;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 16px;
            transition: all 0.2s;
        }

        .vesta-stat-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }

        .vesta-stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .vesta-stat-icon.green {
            background: rgba(16, 185, 129, 0.1);
            color: var(--vesta-green);
        }

        .vesta-stat-icon.orange {
            background: rgba(249, 115, 22, 0.1);
            color: var(--vesta-orange);
        }

        .vesta-stat-icon.red {
            background: rgba(239, 68, 68, 0.1);
            color: var(--vesta-red);
        }

        .vesta-stat-icon.blue {
            background: rgba(59, 130, 246, 0.1);
            color: var(--vesta-blue);
        }

        .vesta-stat-content {
            flex: 1;
        }

        .vesta-stat-label {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--vesta-text-muted);
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .vesta-stat-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--vesta-text);
            line-height: 1;
        }

        .header {
            background: var(--bg);
            color: white;
            padding: 40px 32px;
            text-align: center;
            border-radius: 12px;
            margin-bottom: 24px;
        }

        .header h1 {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 8px;
            letter-spacing: -0.5px;
        }

        .header p {
            font-size: 16px;
            opacity: 0.85;
            font-weight: 400;
        }

        .card {
            background: var(--white);
            border-radius: var(--border-radius);
            padding: 28px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
            box-shadow: 0 1px 3px rgba(0,0,0,0.04);
        }

        .card-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--black);
            margin-bottom: 20px;
            letter-spacing: -0.3px;
        }

        .control-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-bottom: 16px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
        }

        label {
            font-size: 14px;
            font-weight: 600;
            color: var(--gray);
            margin-bottom: 8px;
            letter-spacing: 0;
        }

        input, select {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 16px;
            font-family: inherit;
            background: var(--white);
            color: var(--black);
            transition: all 0.2s ease;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--blue);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        button {
            width: 100%;
            height: auto;
            min-height: 48px;
            padding: 14px 20px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.15s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }

        button:focus-visible {
            outline: 2px solid var(--blue);
            outline-offset: 2px;
        }

        button:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .btn-primary {
            background: var(--white);
            color: var(--black);
            border: 1px solid var(--border-color);
        }

        .btn-primary:hover:not(:disabled) {
            background: var(--gray-lighter);
            border-color: var(--gray);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .btn-secondary {
            background: var(--white);
            color: var(--black);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover:not(:disabled) {
            background: var(--gray-lighter);
            border-color: var(--gray);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .btn-success {
            background: var(--green);
            color: var(--white);
        }

        .btn-success:hover:not(:disabled) {
            background: #059669;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.2);
        }

        .btn-danger {
            background: var(--red);
            color: var(--white);
        }

        .btn-danger:hover:not(:disabled) {
            background: #DC2626;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.2);
        }

        .btn-warning {
            background: var(--orange);
            color: var(--white);
        }

        .btn-warning:hover:not(:disabled) {
            background: #EA580C;
            box-shadow: 0 4px 12px rgba(249, 115, 22, 0.2);
        }

        .actions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 14px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: var(--vesta-card);
            border: 1px solid var(--vesta-border);
            padding: 24px;
            border-radius: 12px;
            text-align: center;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-height: 140px;
        }

        .stat-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }

        .stat-card h3 {
            font-size: 12px;
            font-weight: 600;
            color: var(--vesta-text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
        }

        .stat-card .value {
            font-size: 36px;
            font-weight: 700;
            color: var(--vesta-text);
            line-height: 1.2;
            word-break: break-word;
        }

        .table-container {
            background: var(--vesta-card);
            border-radius: 12px;
            padding: 24px;
            border: 1px solid var(--vesta-border);
            overflow-x: auto;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        /* Estilos para gestión de eventos */
        .event-item {
            transition: background 0.2s ease;
        }

        .event-item:hover {
            background: var(--gray-lighter);
        }

        .btn-event-menu {
            transition: all 0.2s ease;
        }

        .btn-event-menu:hover {
            border-color: var(--gray);
            background: var(--gray-lighter);
        }

        .event-dropdown {
            animation: fadeInDown 0.2s ease;
        }

        .event-dropdown.hidden {
            display: none;
        }

        .event-dropdown button:hover {
            background: var(--gray-lighter);
        }

        /* Dropdown flotante para desglose dinámico */
        .desglose-dropdown {
            position: fixed !important; /* Sacar del flujo y del clipping del contenedor */
            top: 0;
            left: 0;
            background: #FFFFFF;
            border: 1px solid var(--gray-light);
            border-radius: 8px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.15);
            min-width: 180px;
            z-index: 4000; /* Más alto que cualquier card */
            overflow: hidden;
        }
        .desglose-dropdown button {
            background: transparent;
            transition: background 0.15s ease;
        }
        .desglose-dropdown button:hover {
            background: #F3F4F6;
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .minimal-btn-secondary {
            padding: 8px 16px;
            background: var(--white);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            color: var(--gray-dark);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .minimal-btn-secondary:hover {
            background: var(--gray-lighter);
            border-color: var(--gray);
        }

        .search-box input {
            width: 100%;
            max-width: 400px;
            height: 44px;
            padding: 0 var(--space-lg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 15px;
            background: var(--white);
            transition: all 0.2s ease;
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--blue);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .search-box input::placeholder {
            color: var(--gray);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: var(--vesta-card);
        }

        th {
            background: var(--vesta-topbar);
            color: white;
            padding: 12px 16px;
            text-align: left;
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        td {
            padding: 12px 16px;
            border-bottom: 1px solid var(--vesta-border);
            color: var(--vesta-text);
            font-size: 13px;
        }

        tr:hover {
            background: var(--vesta-hover);
        }

        .actions {
            display: flex;
            gap: 8px;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
            width: auto;
            height: auto;
            font-weight: 500;
        }

        .partial-badge {
            background: var(--warn);
            color: white;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--white);
            padding: 32px;
            border-radius: 12px;
            max-width: 540px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
            border: 1px solid var(--border-color);
        }

        .hidden {
            display: none !important;
        }

        .modal-header {
            margin-bottom: 24px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            color: var(--black);
            font-size: 22px;
            font-weight: 600;
            margin: 0;
        }

        .close-modal {
            font-size: 24px;
            font-weight: 400;
            cursor: pointer;
            color: var(--gray);
            line-height: 1;
            transition: color 0.2s ease;
            background: none;
            border: none;
            padding: 0;
            width: auto;
            height: auto;
        }

        .close-modal:hover {
            color: var(--black);
        }

        /* ============================================
           RESPONSIVE DESIGN MINIMALISTA
           ============================================ */
        
        /* Estilos para barra de filtros responsive */
        .filters-bar {
            background: var(--gray-lighter);
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            align-items: center;
        }

        .filter-select,
        .filter-input {
            padding: 8px 12px;
            border: 1px solid var(--gray-light);
            border-radius: 6px;
            background: white;
            font-size: 14px;
            color: var(--text);
            transition: border-color 0.2s ease;
        }

        .filter-select:focus,
        .filter-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(124, 58, 237, 0.1);
        }

        .filters-actions {
            display: flex;
            justify-content: flex-end;
        }

        .btn-clear-filters {
            background: var(--gray-dark);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .btn-clear-filters:hover {
            background: var(--gray-darker);
        }

        .results-counter {
            text-align: center;
            font-size: 13px;
            color: var(--muted);
            font-weight: 500;
        }

        /* Responsive design para filtros */
        @media (max-width: 1024px) {
            .filters-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 640px) {
            .filters-grid {
                grid-template-columns: 1fr;
            }
            
            .filters-bar {
                padding: 12px;
            }
            
            .filters-actions {
                justify-content: center;
            }
        }

        /* ===== ESTILOS PANEL PICKER ===== */
        
        .panel-picker {
            position: relative;
            width: 100%;
        }

        .panel-picker-input-container {
            position: relative;
            display: flex;
            align-items: center;
        }

        .panel-picker-input {
            width: 100%;
            padding: 10px 40px 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 14px;
            background: white;
            color: var(--text);
            transition: all 0.2s ease;
        }

        .panel-picker-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(124, 58, 237, 0.1);
        }

        .panel-picker-clear {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            font-size: 18px;
            color: var(--muted);
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: color 0.2s ease;
        }

        .panel-picker-clear:hover {
            color: var(--text);
            background: var(--gray-lighter);
        }

        .panel-picker-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            max-height: 200px;
            overflow-y: auto;
        }

        .panel-picker-loading,
        .panel-picker-no-results {
            padding: 12px 16px;
            text-align: center;
            color: var(--muted);
            font-size: 14px;
        }

        .panel-picker-option {
            padding: 10px 16px;
            cursor: pointer;
            border-bottom: 1px solid var(--gray-lighter);
            transition: background-color 0.2s ease;
        }

        .panel-picker-option:last-child {
            border-bottom: none;
        }

        .panel-picker-option:hover,
        .panel-picker-option.highlighted {
            background: var(--gray-lighter);
        }

        .panel-picker-selected {
            margin-top: 8px;
            padding: 8px 12px;
            background: var(--gray-lighter);
            border-radius: 4px;
            font-size: 13px;
        }

        .panel-picker-selected small {
            color: var(--muted);
            display: block;
            margin-bottom: 4px;
        }

        .panel-picker-selected-info {
            font-weight: 500;
            color: var(--text);
        }

        @media (max-width: 640px) {
            .panel-picker-dropdown {
                max-height: 150px;
            }
        }

        /* ===== FIN ESTILOS PANEL PICKER ===== */

        /* Lista de paneles */

        .results-count {
            font-size: 12px;
            color: var(--gray);
            font-weight: 500;
        }

        @media (max-width: 1200px) {
            .minimal-stats {
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
            }
            .minimal-stat-card {
                min-height: 150px;
                padding: 20px 16px;
            }
            .minimal-stat-value {
                font-size: 42px;
            }
        }

        @media (max-width: 1024px) {
            .minimal-section-header {
                flex-direction: column;
                align-items: flex-start;
                gap: var(--space-md);
            }
            .search-box input {
                max-width: 100%;
            }
        }

        @media (max-width: 768px) {
            .minimal-header-content {
                flex-direction: column;
                gap: var(--space-sm);
                align-items: flex-start;
            }
            
            .minimal-logo-subtitle {
                display: none;
            }
            
            .minimal-user {
                width: 100%;
                justify-content: space-between;
            }
            
            .minimal-main {
                padding: 24px 16px;
            }
            
            .minimal-section-title {
                font-size: 26px;
            }
            
            .minimal-stats {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            .minimal-stat-value {
                font-size: 40px;
            }
            
            .minimal-stat-card {
                padding: 20px 16px;
                min-height: 140px;
            }
            
            .minimal-section-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .search-box input {
                max-width: 100%;
            }
            
            .minimal-list-item {
                flex-direction: column;
                gap: var(--space-md);
                align-items: flex-start;
            }
            
            .minimal-list-item-info {
                flex-direction: column;
                width: 100%;
                gap: var(--space-md);
            }
            
            .minimal-list-item-main {
                min-width: auto;
                flex-direction: column;
                align-items: flex-start;
                gap: 4px;
            }
            
            .minimal-list-item-meta {
                width: 100%;
                justify-content: space-between;
            }
            
            .minimal-list-item-actions {
                width: 100%;
                justify-content: space-between;
            }
            
            .minimal-fab {
                width: 56px;
                height: 56px;
                bottom: 20px;
                right: 20px;
                font-size: 28px;
            }
            
            .actions-grid {
                grid-template-columns: 1fr;
            }
            
            .stats {
                grid-template-columns: 1fr;
            }
            
            .card {
                padding: 24px;
            }
            
            .control-row {
                grid-template-columns: 1fr;
                gap: 14px;
            }
        }

        /* ============================================
           ESTILOS LEGACY (Mantener compatibilidad)
           ============================================ */
        .actions-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        /* ============================================
           GRID PARA PARÁMETROS Y ACCIONES
           ============================================ */
        .params-actions-grid {
            display: grid;
            grid-template-columns: 1fr 1.2fr;
            gap: 16px;
            align-items: start;
            padding: 0;
            max-width: 100%;
            margin-bottom: var(--space-xl);
        }

        /* Estilos para botón principal de Cambios del mes */
        .btn-primary-large {
            background: var(--white);
            color: var(--black);
            border: 1px solid var(--border-color);
            padding: 16px 32px;
            font-size: 16px;
            font-weight: 600;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            position: relative;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary-large:hover {
            background: var(--gray-lighter);
            border-color: var(--gray);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .btn-primary-large:active {
            transform: translateY(0);
        }

        /* Contenedor de dropdown y menú */
        .monthly-changes-container {
            position: relative;
            display: inline-block;
        }

        .dropdown-menu {
            position: absolute;
            top: calc(100% + 8px);
            left: 0;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            min-width: 280px;
            overflow: hidden;
            z-index: 1000;
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.3s ease;
            pointer-events: none;
        }

        .dropdown-menu.show {
            opacity: 1;
            transform: translateY(0);
            pointer-events: all;
        }

        .dropdown-menu.hidden {
            display: none;
        }

        .dropdown-item {
            padding: 14px 20px;
            cursor: pointer;
            transition: all 0.2s ease;
            border-bottom: 1px solid #F3F4F6;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 15px;
            font-weight: 500;
        }

        .dropdown-item:last-child {
            border-bottom: none;
        }

        .dropdown-item:hover {
            background: #F9FAFB;
            padding-left: 24px;
        }

        .dropdown-item[data-action="alta"] {
            color: #166534;
        }

        .dropdown-item[data-action="alta"]:hover {
            background: #F0FDF4;
        }

        .dropdown-item[data-action="reinstalacion"] {
            color: #1E40AF;
        }

        .dropdown-item[data-action="reinstalacion"]:hover {
            background: #EFF6FF;
        }

        .dropdown-item[data-action="baja"] {
            color: #991B1B;
        }

        .dropdown-item[data-action="baja"]:hover {
            background: #FEF2F2;
        }

        .dropdown-item[data-action="desmontaje"] {
            color: #C2410C;
        }

        .dropdown-item[data-action="desmontaje"]:hover {
            background: #FFF7ED;
        }

        .dropdown-item[data-action="tarifa"] {
            color: #6B21A8;
        }

        .dropdown-item[data-action="tarifa"]:hover {
            background: #FAF5FF;
        }

        /* Estilos para modales */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }

        .modal-overlay.show {
            opacity: 1;
            pointer-events: all;
        }

        .modal-overlay.hidden {
            display: none;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }

        .modal-overlay.show .modal-content {
            transform: scale(1);
        }

        .modal-header {
            padding: 24px 28px;
            border-bottom: 1px solid #E5E7EB;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-header h2 {
            font-size: 22px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 28px;
            color: #9CA3AF;
            cursor: pointer;
            padding: 0;
            line-height: 1;
            transition: color 0.2s;
        }

        .modal-close:hover {
            color: #374151;
        }

        .modal-body {
            padding: 32px;
        }

        .form-group {
            margin-bottom: 24px;
        }

        .form-group label {
            display: block;
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--text);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 14px 16px;
            font-size: 16px;
            border: 1px solid #D1D5DB;
            border-radius: 8px;
            transition: all 0.2s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #3B82F6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
            font-family: inherit;
        }

        /* Vista previa de facturación */
        .billing-preview {
            background: linear-gradient(135deg, #F0F9FF 0%, #E0F2FE 100%);
            border-radius: 12px;
            padding: 20px;
            margin-top: 24px;
            border: 2px solid #BAE6FD;
        }

        .billing-preview h3 {
            font-size: 16px;
            font-weight: 600;
            color: #0C4A6E;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .billing-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #BAE6FD;
            font-size: 14px;
        }

        .billing-row:last-child {
            border-bottom: none;
            padding-top: 16px;
            font-weight: 600;
            font-size: 18px;
            color: #0C4A6E;
        }

        .billing-label {
            color: #475569;
        }

        .billing-value {
            font-weight: 600;
            color: #0F172A;
        }

        /* Componente de Búsqueda inteligente */
        .smart-search {
            position: relative;
        }

        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #D1D5DB;
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            display: none;
        }

        .search-results.show {
            display: block;
        }

        .search-result-item {
            padding: 12px 14px;
            cursor: pointer;
            border-bottom: 1px solid #F3F4F6;
            transition: background 0.2s;
        }

        .search-result-item:hover {
            background: #F9FAFB;
        }

        .search-result-item:last-child {
            border-bottom: none;
        }

        .search-result-codigo {
            font-weight: 600;
            color: #1E3A8A;
            font-size: 15px;
        }

        .search-result-municipio {
            font-size: 13px;
            color: #64748B;
            margin-top: 2px;
        }

        /* Botones de acción del modal */
        .modal-actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        .btn-modal-primary,
        .btn-modal-secondary {
            flex: 1;
            padding: 12px 24px;
            font-size: 15px;
            font-weight: 600;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-modal-primary {
            background: #1E3A8A;
            color: white;
        }

        .btn-modal-primary:hover {
            background: #1E40AF;
        }

        .btn-modal-secondary {
            background: #F3F4F6;
            color: #374151;
        }

        .btn-modal-secondary:hover {
            background: #E5E7EB;
        }

        /* Colores específicos por tipo de cambio */
        .modal-alta .modal-header {
            background: linear-gradient(135deg, #ECFDF5 0%, #D1FAE5 100%);
            border-bottom-color: #86EFAC;
        }

        .modal-alta .modal-header h2 {
            color: #166534;
        }

        .modal-reinstalacion .modal-header {
            background: linear-gradient(135deg, #EFF6FF 0%, #DBEAFE 100%);
            border-bottom-color: #93C5FD;
        }

        .modal-reinstalacion .modal-header h2 {
            color: #1E40AF;
        }

        .modal-baja .modal-header {
            background: linear-gradient(135deg, #FEF2F2 0%, #FEE2E2 100%);
            border-bottom-color: #FCA5A5;
        }

        .modal-baja .modal-header h2 {
            color: #991B1B;
        }

        .modal-desmontaje .modal-header {
            background: linear-gradient(135deg, #FFF7ED 0%, #FFEDD5 100%);
            border-bottom-color: #FDBA74;
        }

        .modal-desmontaje .modal-header h2 {
            color: #C2410C;
        }

        .modal-tarifa .modal-header {
            background: linear-gradient(135deg, #FAF5FF 0%, #F3E8FF 100%);
            border-bottom-color: #D8B4FE;
        }

        .modal-tarifa .modal-header h2 {
            color: #6B21A8;
        }

        /* Alertas de advertencia */
        .warning-box {
            background: #FEF3C7;
            border-left: 4px solid #F59E0B;
            padding: 14px 16px;
            border-radius: 8px;
            margin: 16px 0;
            display: flex;
            gap: 12px;
            align-items: start;
        }

        .warning-box-icon {
            font-size: 20px;
            flex-shrink: 0;
        }

        .warning-box-text {
            font-size: 14px;
            color: #92400E;
            line-height: 1.5;
        }

        /* Checkbox personalizado */
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 16px 0;
        }

        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .checkbox-group label {
            margin: 0;
            cursor: pointer;
            font-size: 14px;
        }
        /* ============================================
           ESTILOS PARA PANTALLA DE LOGIN (Tailwind)
           ============================================ */
        /* Los estilos de login ahora se manejan con TailwindCSS */

        /* ============================================
           ESTILOS PARA HEADER AUTENTICADO
           ============================================ */
        .auth-header {
            background: linear-gradient(135deg, #1e3a5f 0%, #2c5282 100%);
            color: white;
            padding: 24px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            flex-wrap: wrap;
            gap: 20px;
        }

        .auth-header-left h1 {
            margin: 0;
            font-size: 24px;
            font-weight: 700;
        }

        .auth-header-left p {
            margin: 4px 0 0 0;
            font-size: 14px;
            opacity: 0.9;
        }

        .auth-header-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 3px solid white;
            object-fit: cover;
        }

        .user-details {
            text-align: left;
        }

        .user-name {
            font-weight: 700;
            font-size: 15px;
            margin: 0;
        }

        .user-email {
            font-size: 13px;
            opacity: 0.8;
            margin: 2px 0 0 0;
        }

        .btn-logout {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-logout:hover {
            background: white;
            color: #1e3a5f;
        }

        /* ============================================
           CONTENEDOR DE APLICACIñN
           ============================================ */
        #appContainer {
            display: none;
        }

        #appContainer.visible {
            display: block;
        }

        /* Responsive para pantalla de login */
        @media (max-width: 600px) {
            .login-container {
                padding: 40px 30px;
            }
            
            .login-logo {
                font-size: 60px;
            }
            
            .login-title {
                font-size: 24px;
            }
            
            .login-subtitle {
                font-size: 14px;
            }
        }

        /* Responsive para header autenticado */
        @media (max-width: 768px) {
            .auth-header {
                padding: 20px;
                flex-direction: column;
                align-items: flex-start;
            }
            
            .auth-header-right {
                width: 100%;
                justify-content: space-between;
            }
            
            /* Responsive para el grid de parámetros/acciones */
            .params-actions-grid {
                grid-template-columns: 1fr !important;
            }
        }
    </style>
</head>
<body class="antialiased">
    <!-- ============================================
         PANTALLA DE LOGIN GLASSMORPHISM
         ============================================ -->
    <div id="loginScreen" style="display:flex;align-items:center;justify-content:center;min-height:100vh;background:linear-gradient(135deg,#2d1b4e 0%,#4a2963 25%,#7a3d6b 50%,#4a2963 75%,#2d1b4e 100%);position:relative;overflow:hidden;">
        <div style="position:absolute;top:20%;left:20%;width:400px;height:400px;background:radial-gradient(circle,rgba(220,100,150,0.3) 0%,transparent 70%);filter:blur(60px);"></div>
        <div style="position:absolute;bottom:20%;right:20%;width:400px;height:400px;background:radial-gradient(circle,rgba(100,100,220,0.3) 0%,transparent 70%);filter:blur(60px);"></div>
        <div style="position:relative;background:rgba(255,255,255,0.1);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);border:1px solid rgba(255,255,255,0.2);border-radius:25px;padding:3rem 2.5rem;max-width:420px;width:90%;box-shadow:0 8px 32px rgba(0,0,0,0.3);display:flex;flex-direction:column;align-items:center;text-align:center;">
            <div style="width:120px;height:120px;border-radius:50%;background:radial-gradient(circle at 30% 30%,rgba(255,150,180,0.4),rgba(180,120,200,0.3));display:flex;align-items:center;justify-content:center;margin-bottom:1.5rem;">
                <svg width="60" height="60" viewBox="0 0 24 24" fill="rgba(255,255,255,0.7)"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
            </div>
            <h1 style="color:rgba(255,255,255,0.95);font-size:2rem;font-weight:700;margin:0 0 0.5rem 0;letter-spacing:-0.5px;">PIVCONTROL</h1>
            <p style="color:rgba(255,255,255,0.6);font-size:0.95rem;margin:0 0 2.5rem 0;line-height:1.4;">Control mensual de Facturación CRTM-PIV</p>
            <button onclick="iniciarSesionConGoogle()" style="width:100%;padding:1rem 2rem;border:none;border-radius:50px;background:linear-gradient(90deg,#6366f1 0%,#8b5cf6 50%,#d946ef 100%);color:white;font-size:1rem;font-weight:700;letter-spacing:1px;cursor:pointer;box-shadow:0 4px 15px rgba(139,92,246,0.4);transition:all 0.3s ease;display:flex;align-items:center;justify-content:center;gap:0.75rem;" onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 6px 20px rgba(139,92,246,0.6)';" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 4px 15px rgba(139,92,246,0.4)';"><svg width="20" height="20" viewBox="0 0 24 24" fill="white"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>Iniciar sesión con Google</button>
        </div>
    </div>

    <!-- ============================================
         CONTENEDOR DE LA APLICACIñN (Oculto por defecto)
         ============================================ -->
    <div id="appContainer">
        <!-- ============================================
             HEADER MINIMALISTA
             ============================================ -->
        <div class="minimal-header">
            <div class="minimal-header-content">
                <div class="minimal-logo">
                    <span class="minimal-logo-text">CRTM</span>
                    <span class="minimal-logo-subtitle">Gestión de Paneles TFT</span>
                </div>
                <div class="minimal-user">
                    <img id="userPhoto" class="minimal-user-avatar" src="" alt="Usuario">
                    <div class="minimal-user-info">
                        <div class="minimal-user-name" id="userName">Usuario</div>
                        <div class="minimal-user-email" id="userEmail">email@example.com</div>
                    </div>
                    <button class="minimal-btn-logout" onclick="cerrarSesion()">
                        Cerrar sesión
                    </button>
                </div>
            </div>
        </div>

        <!-- ============================================
             CONTENIDO PRINCIPAL MINIMALISTA
             ============================================ -->
        <div class="minimal-main">
            
            <!-- Título de sección -->
            <h1 class="minimal-section-title" id="tituloMes">Resumen del mes actual</h1>
            <p class="minimal-section-subtitle">Control de instalación, mantenimiento y Facturación de paneles TFT</p>

            <!-- Estadísticas XXL -->
            <div class="minimal-stats">
                <div class="minimal-stat-card">
                    <div class="minimal-stat-label">Paneles</div>
                    <div class="minimal-stat-value" id="statTotal">0</div>
                    <div class="minimal-stat-detail">Total instalados</div>
                </div>
                <div class="minimal-stat-card">
                    <div class="minimal-stat-label">Pausados</div>
                    <div class="minimal-stat-value" id="statDesmontados">0</div>
                    <div class="minimal-stat-detail">Temporalmente</div>
                </div>
                <div class="minimal-stat-card">
                    <div class="minimal-stat-label">Facturación</div>
                    <div class="minimal-stat-value" id="statFacturacion">0,00 €</div>
                    <div class="minimal-stat-detail">Mensual</div>
                </div>
                <div class="minimal-stat-card">
                    <div class="minimal-stat-label">Activos</div>
                    <div class="minimal-stat-value" id="statActivos">0</div>
                    <div class="minimal-stat-detail">Facturando</div>
                </div>
            </div>

        <!-- Desglose de Eventos y Ajustes -->
        <div id="desgloseEventos" class="card" style="display: none; margin-top: 20px;">
            <h2 class="card-title">📊 Desglose de Facturación Dinámica</h2>
            <div id="desgloseContent" style="padding: 15px;">
                <!-- Se llenará dinámicamente -->
            </div>
        </div>

        <div class="params-actions-grid">

        <div class="card">
            <h2 class="card-title">🎚️ Parámetros</h2>
            <div class="control-row">
                <div class="control-group">
                    <label>Mes Actual</label>
                    <select id="currentMonth">
                        <option value="01">Enero</option>
                        <option value="02">Febrero</option>
                        <option value="03">Marzo</option>
                        <option value="04">Abril</option>
                        <option value="05">Mayo</option>
                        <option value="06">Junio</option>
                        <option value="07">Julio</option>
                        <option value="08">Agosto</option>
                        <option value="09">Septiembre</option>
                        <option value="10">Octubre</option>
                        <option value="11">Noviembre</option>
                        <option value="12">Diciembre</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>Año</label>
                    <input type="number" id="currentYear" value="2025" min="2020" max="2030">
                </div>
                <div class="control-group">
                    <label>Tarifa Base 30 Días</label>
                    <input type="number" id="baseRate" value="37.70" step="0.01">
                </div>
            </div>
        </div>

        <div class="card">
            <h2 class="card-title">Acciones</h2>
            <!-- Botón Principal de Cambios Mensuales -->
            <div class="monthly-changes-container" style="margin-bottom: 20px;">
                <button id="btnCambiosMes" class="btn-primary-large" onclick="toggleDropdownMenu()">
                    Cambios del mes <span style="font-size: 12px;">▼</span>
                </button>
                
                <div id="dropdownMenu" class="dropdown-menu hidden">
                    <div class="dropdown-item" data-action="alta" onclick="openModalAlta()">
                        <span class="dropdown-icon" style="color: #4CAF50;">+</span>
                        <span>Alta de Panel Nuevo</span>
                    </div>
                    <div class="dropdown-item" data-action="reinstalacion" onclick="openModalReinstalacion()">
                        <span class="dropdown-icon" style="color: #2196F3;">↻</span>
                        <span>Reinstalación de Panel</span>
                    </div>
                    <div class="dropdown-item" data-action="baja" onclick="openModalBaja()">
                        <span class="dropdown-icon" style="color: #F44336;"></span>
                        <span>Baja Definitiva de Panel</span>
                    </div>
                    <div class="dropdown-item" data-action="desmontaje" onclick="openModalDesmontaje()">
                        <span class="dropdown-icon" style="color: #FF9800;"></span>
                        <span>Desmontaje Temporal</span>
                    </div>
                    <div class="dropdown-item" data-action="tarifa" onclick="openModalCambioTarifa()">
                        <span class="dropdown-icon" style="color: #9C27B0;"></span>
                        <span>Cambio de Tarifa</span>
                    </div>
                </div>
            </div>
            
            <div class="actions-grid">
                <button onclick="regenerarFacturacionMesActual(event)" class="btn-secondary" style="font-weight: 600;" title="Regenera la facturación del mes visualizado copiando datos del mes anterior">
                    ♻️ Regenerar facturación
                </button>
                <button onclick="exportData()" class="btn-primary">Exportar a Excel</button>
                <button onclick="viewHistory()" class="btn-secondary">Ver histórico mensual</button>
                <button onclick="viewMonthlyChanges()" class="btn-secondary">Ver cambios del mes</button>
                <button onclick="exportHistory()" class="btn-secondary">Exportar histórico completo</button>
                <button onclick="backupComplete()" class="btn-secondary">Copia de seguridad (JSON)</button>
            </div>
        </div>

        </div> <!-- Fin params-actions-grid -->

        <!-- Modal: Alta de Panel Nuevo -->
        <div id="modalAlta" class="modal-overlay hidden">
            <div class="modal-content modal-alta">
                <div class="modal-header">
                    <h2><span></span> Alta de Panel Nuevo</h2>
                    <button class="modal-close" onclick="closeModal('modalAlta')">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="altaMunicipio">Municipio *</label>
                        <select id="altaMunicipio" required>
                            <option value="">Seleccionar municipio...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="altaCodigo">Código del Panel *</label>
                        <input type="text" id="altaCodigo" placeholder="Ej: PIV-001" required>
                    </div>
                    <div class="form-group">
                        <label for="altaFecha">Fecha de Instalación *</label>
                        <input type="date" id="altaFecha" required>
                    </div>
                    <div class="form-group">
                        <label for="altaObservaciones">Observaciones</label>
                        <textarea id="altaObservaciones" placeholder="Detalles adicionales (opcional)"></textarea>
                    </div>
                    
                    <div class="billing-preview" id="altaBillingPreview">
                        <h3> Vista Previa de Facturación</h3>
                        <div class="billing-row">
                            <span class="billing-label">Facturación mes completo:</span>
                            <span class="billing-value">37,70 €</span>
                        </div>
                        <div class="billing-row">
                            <span class="billing-label">Días facturables:</span>
                            <span class="billing-value" id="altaDias">-</span>
                        </div>
                        <div class="billing-row">
                            <span class="billing-label">Importe a facturar:</span>
                            <span class="billing-value" id="altaTotal">-</span>
                        </div>
                        <div class="billing-row">
                            <span class="billing-label">Importe no facturado:</span>
                            <span class="billing-value" id="altaNoFacturado" style="color: #999;">-</span>
                        </div>
                    </div>

                    <div class="modal-actions">
                        <button class="btn-modal-secondary" onclick="closeModal('modalAlta')">Cancelar</button>
                        <button class="btn-modal-primary" onclick="guardarAlta()"> Dar de Alta</button>
                    </div>
                </div>
            </div>
        </div>

    <!-- Modal: reinstalación de Panel -->
        <div id="modalReinstalacion" class="modal-overlay hidden">
            <div class="modal-content modal-reinstalacion">
                <div class="modal-header">
                    <h2><span></span> reinstalación de Panel</h2>
                    <button class="modal-close" onclick="closeModal('modalReinstalacion')">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label>Buscar Panel *</label>
                        <div id="reinstalacionPanelPicker"></div>
                    </div>
                    <div class="form-group">
                        <label>Panel Seleccionado</label>
                        <div id="reinstalacionPanelInfo" style="padding: 12px; background: #F9FAFB; border-radius: 8px; font-size: 14px; color: #64748B;">
                            Ningún panel seleccionado
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="reinstalacionFecha">Fecha de reinstalación *</label>
                        <input type="date" id="reinstalacionFecha" required>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="reinstalacionCambioMunicipio">
                        <label for="reinstalacionCambioMunicipio">Cambiar municipio de instalación</label>
                    </div>
                    <div class="form-group" id="reinstalacionNuevoMunicipioGroup" style="display: none;">
                        <label for="reinstalacionNuevoMunicipio">Nuevo Municipio *</label>
                        <select id="reinstalacionNuevoMunicipio">
                            <option value="">Seleccionar municipio...</option>
                        </select>
                    </div>

                    <div class="billing-preview" id="reinstalacionBillingPreview">
                        <h3> Comparación de Facturación</h3>
                        <div class="billing-row">
                            <span class="billing-label">Importe sin reinstalación:</span>
                            <span class="billing-value" id="reinstalacionSin">-</span>
                        </div>
                        <div class="billing-row">
                            <span class="billing-label">Importe con reinstalación:</span>
                            <span class="billing-value" id="reinstalacionCon">-</span>
                        </div>
                        <div class="billing-row">
                            <span class="billing-label">Diferencia:</span>
                            <span class="billing-value" id="reinstalacionDif" style="color: #16A34A;">-</span>
                        </div>
                    </div>

                    <div class="modal-actions">
                        <button class="btn-modal-secondary" onclick="closeModal('modalReinstalacion')">Cancelar</button>
                        <button class="btn-modal-primary" onclick="guardarReinstalacion()"> Confirmar reinstalación</button>
                    </div>
                </div>
            </div>
        </div>

    <!-- Modal: Baja Definitiva de Panel -->
        <div id="modalBaja" class="modal-overlay hidden">
            <div class="modal-content modal-baja">
                <div class="modal-header">
                    <h2><span></span> Baja Definitiva de Panel</h2>
                    <button class="modal-close" onclick="closeModal('modalBaja')">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label>Buscar Panel *</label>
                        <div id="bajaPanelPicker"></div>
                    </div>
                    <div class="form-group">
                        <label>Panel Seleccionado</label>
                        <div id="bajaPanelInfo" style="padding: 12px; background: #F9FAFB; border-radius: 8px; font-size: 14px; color: #64748B;">
                            Ningún panel seleccionado
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="bajaMotivo">Motivo de la Baja *</label>
                        <select id="bajaMotivo" required>
                            <option value="">Seleccionar motivo...</option>
                            <option value="fin_contrato">Fin de contrato</option>
                            <option value="averia_irreparable">Avería irreparable</option>
                            <option value="vandalismo">Vandalismo</option>
                            <option value="decision_cliente">Decisiñn del cliente</option>
                            <option value="otro">Otro</option>
                        </select>
                    </div>

                    <div class="warning-box">
                        <div class="warning-box-icon"></div>
                        <div class="warning-box-text">
                            <strong>Atenciñn:</strong> Esta acciñn es definitiva. El panel dejará de facturarse desde este mes en adelante. La Facturación de meses anteriores se conserva.
                        </div>
                    </div>

                    <div class="checkbox-group">
                        <input type="checkbox" id="bajaConfirmacion">
                        <label for="bajaConfirmacion">Confirmo que deseo dar de baja definitivamente este panel</label>
                    </div>

                    <div class="billing-preview" id="bajaBillingPreview">
                        <h3> Impacto en Facturación</h3>
                        <div class="billing-row">
                            <span class="billing-label">Importe mensual actual:</span>
                            <span class="billing-value" id="bajaFacturacionActual">-</span>
                        </div>
                        <div class="billing-row">
                            <span class="billing-label">Importe después de baja:</span>
                            <span class="billing-value">0,00 €</span>
                        </div>
                        <div class="billing-row">
                            <span class="billing-label">Pérdida mensual:</span>
                            <span class="billing-value" id="bajaPerdida" style="color: #DC2626;">-</span>
                        </div>
                    </div>

                    <div class="modal-actions">
                        <button class="btn-modal-secondary" onclick="closeModal('modalBaja')">Cancelar</button>
                        <button class="btn-modal-primary" onclick="guardarBaja()" style="background: #DC2626;"> Dar de Baja</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal: Desmontaje Temporal -->
        <div id="modalDesmontaje" class="modal-overlay hidden">
            <div class="modal-content modal-desmontaje">
                <div class="modal-header">
                    <h2><span></span> Desmontaje Temporal</h2>
                    <button class="modal-close" onclick="closeModal('modalDesmontaje')">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label>Buscar Panel *</label>
                        <div id="desmontajePanelPicker"></div>
                    </div>
                    <div class="form-group">
                        <label>Panel Seleccionado</label>
                        <div id="desmontajePanelInfo" style="padding: 12px; background: #F9FAFB; border-radius: 8px; font-size: 14px; color: #64748B;">
                            Ningún panel seleccionado
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="desmontajeFecha">Fecha de Desmontaje *</label>
                        <input type="date" id="desmontajeFecha" required>
                    </div>
                    <div class="form-group">
                        <label for="desmontagMotivo">Motivo *</label>
                        <select id="desmontagMotivo" required>
                            <option value="">Seleccionar motivo...</option>
                            <option value="mantenimiento">Mantenimiento</option>
                            <option value="reparacion">Reparaciñn</option>
                            <option value="actualizacion">Actualizaciñn tñcnica</option>
                            <option value="temporal">Inactividad temporal</option>
                            <option value="otro">Otro</option>
                        </select>
                    </div>

                    <div class="billing-preview" id="desmontajeBillingPreview">
                        <h3> Ajuste de Facturación</h3>
                        <div class="billing-row">
                            <span class="billing-label">Facturación mes completo:</span>
                            <span class="billing-value">37,70 €</span>
                        </div>
                        <div class="billing-row">
                            <span class="billing-label">Días facturables:</span>
                            <span class="billing-value" id="desmontajeDias">-</span>
                        </div>
                        <div class="billing-row">
                            <span class="billing-label">Importe a facturar:</span>
                            <span class="billing-value" id="desmontagTotal">-</span>
                        </div>
                        <div class="billing-row">
                            <span class="billing-label">Importe no facturado:</span>
                            <span class="billing-value" id="desmontagAhorro" style="color: #999;">-</span>
                        </div>
                    </div>

                    <div class="modal-actions">
                        <button class="btn-modal-secondary" onclick="closeModal('modalDesmontaje')">Cancelar</button>
                        <button class="btn-modal-primary" onclick="guardarDesmontaje()"> Confirmar Desmontaje</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal: Ver Eventos del Panel -->
        <div id="modalEventosPanel" class="modal-overlay hidden">
            <div class="modal-content" style="max-width: 900px;">
                <div class="modal-header">
                    <h2>📋 Eventos del Panel <span id="eventoPanelCodigo"></span></h2>
                    <button class="modal-close" onclick="closeModal('modalEventosPanel')">&times;</button>
                </div>

                <div class="modal-body">
                    <div id="listaEventos" style="max-height: 400px; overflow-y: auto;">
                        <!-- Lista de eventos se cargará aquí -->
                    </div>
                </div>

                <div class="modal-actions">
                    <button class="btn-modal-secondary" onclick="closeModal('modalEventosPanel')">Cerrar</button>
                </div>
            </div>
        </div>

        <!-- Modal: Editar Evento -->
        <div id="modalEditarEvento" class="modal-overlay hidden">
            <div class="modal-content" style="max-width: 560px;">
                <div class="modal-header">
                    <h2>Editar Evento</h2>
                    <button class="modal-close" onclick="closeModal('modalEditarEvento')">&times;</button>
                </div>

                <div class="modal-body">
                    <input type="hidden" id="editEventoId">
                    <input type="hidden" id="editEventoPanelId">

                    <div class="form-group">
                        <label>Acción</label>
                        <select id="editEventoAccion">
                            <option value="ALTA">ALTA</option>
                            <option value="REINSTALACION">REINSTALACIÓN</option>
                            <option value="DESMONTAJE_TEMPORAL">DESMONTAJE TEMPORAL</option>
                            <option value="BAJA_DEFINITIVA">BAJA DEFINITIVA</option>
                            <option value="CAMBIO_TARIFA">CAMBIO DE TARIFA</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Fecha Efectiva</label>
                        <input type="date" id="editEventoFecha">
                    </div>

                    <div class="form-group">
                        <label>Tarifa Base Mes (€)</label>
                        <input type="number" id="editEventoTarifa" step="0.01" placeholder="37.70">
                    </div>

                    <div class="form-group">
                        <label>Motivo (opcional)</label>
                        <textarea id="editEventoMotivo" rows="3" placeholder="Descripción del cambio..."></textarea>
                    </div>

                    <div id="editEventoPreview" style="margin-top: 20px; padding: 16px; background: var(--gray-lighter); border-radius: 8px; display: none;">
                        <h4 style="font-size: 14px; font-weight: 600; margin-bottom: 12px;">Vista Previa</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 13px;">
                            <div>
                                <strong>Estado actual:</strong> <span id="editPreviewEstadoActual"></span>
                            </div>
                            <div>
                                <strong>Estado futuro:</strong> <span id="editPreviewEstadoFuturo"></span>
                            </div>
                            <div>
                                <strong>Días facturables:</strong> <span id="editPreviewDias"></span>
                            </div>
                            <div>
                                <strong>Importe:</strong> <span id="editPreviewImporte"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="modal-actions">
                    <button class="btn-modal-secondary" onclick="closeModal('modalEditarEvento')">Cancelar</button>
                    <button class="btn-modal-primary" onclick="guardarEdicionEvento()">💾 Guardar Cambios</button>
                </div>
            </div>
        </div>

        <!-- Modal: Editar Datos Agregados (panel_month_billing) -->
        <div id="modalEditarAgregado" class="modal-overlay hidden">
            <div class="modal-content" style="max-width: 540px; background: #fff; border-radius: 12px; box-shadow: 0 4px 24px rgba(0,0,0,0.08);">
                <div class="modal-header" style="border-bottom: 1px solid #e5e7eb; padding: 20px 28px 12px 28px;">
                    <div style="display: flex; align-items: center; justify-content: space-between; gap: 0;">
                        <span style="font-size: 1.45rem; font-weight: 700; color: #222; letter-spacing: 0.01em; white-space: nowrap;">Editar facturación mensual</span>
                        <button class="modal-close" onclick="closeModal('modalEditarAgregado')" style="background: none; border: none; font-size: 1.7rem; color: #888; cursor: pointer; margin-left: 32px;">&times;</button>
                    </div>
                </div>

                <div class="modal-body" style="padding: 24px 28px;">
                    <input type="hidden" id="editAgregadoPanelId">
                    <input type="hidden" id="editAgregadoMonthKey">
                    <input type="hidden" id="editAgregadoDocId">

                    <!-- Información del Panel en Grid -->
                    <div id="editAgregadoInfo" style="margin-bottom: 24px; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                        <!-- Se llenará dinámicamente -->
                    </div>

                    <!-- Campos de Edición en Grid 2 Columnas -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <div class="form-group" style="margin: 0;">
                            <label for="editAgregadoDias" style="font-weight: 500; color: #222; margin-bottom: 6px; display: block;">Días Facturables</label>
                            <input type="number" 
                                   id="editAgregadoDias" 
                                   min="0" 
                                   max="30" 
                                   step="1" 
                                   placeholder="0-30" 
                                   onchange="recalcularImporteAgregado()"
                                   style="width: 100%; padding: 10px 12px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 15px; font-weight: 500; text-align: center; background: #fafbfc;">
                            <small style="display: block; margin-top: 4px; color: #888; font-size: 11px;">0-30 días del mes</small>
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <label for="editAgregadoTarifa" style="font-weight: 500; color: #222; margin-bottom: 6px; display: block;">Tarifa Base (€/mes)</label>
                            <input type="number" 
                                   id="editAgregadoTarifa" 
                                   step="0.01" 
                                   min="0" 
                                   value="37.70" 
                                   onchange="recalcularImporteAgregado()"
                                   style="width: 100%; padding: 10px 12px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 15px; font-weight: 500; text-align: center; background: #fafbfc;">
                            <small style="display: block; margin-top: 4px; color: #888; font-size: 11px;">Tarifa mensual completa</small>
                        </div>
                    </div>

                    <!-- Importe Total - Destacado -->
                    <div class="form-group" style="margin: 0 0 20px 0;">
               <label for="editAgregadoImporte" style="font-weight: 500; color: #222; margin-bottom: 6px; display: block;">Importe Total (€)</label>
               <input type="number" 
                   id="editAgregadoImporte" 
                   step="0.01" 
                   min="0" 
                   placeholder="0.00" 
                   readonly
                   style="width: 100%; padding: 14px 16px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 24px; font-weight: 600; color: #222; background: #f6f7f9; text-align: center;">
                    </div>

                    <!-- Vista Previa del Cálculo -->
                    <div id="editAgregadoPreview" style="padding: 16px 20px; background: linear-gradient(135deg, #EEF2FF 0%, #E0E7FF 100%); border-left: 4px solid #667eea; border-radius: 8px; margin-bottom: 20px;">
                        <div style="font-size: 13px; color: #444; font-family: 'Courier New', monospace; font-weight: 500;">
                            <span id="editAgregadoCalculo">-</span>
                        </div>
                    </div>

                    <!-- Nota Informativa -->
                    <div style="padding: 14px 16px; background: #FFFBEB; border-left: 4px solid #F59E0B; border-radius: 8px; font-size: 12px; color: #92400E; line-height: 1.5;">
                        <strong style="font-size: 12px; color: #222; font-weight: 600; margin-bottom: 4px; display: block;">Información</strong>
                        Los cambios se guardan directamente en Firestore (<code style="background: #f3f4f6; padding: 2px 6px; border-radius: 3px; font-size: 10px;">panel_month_billing</code>). El importe se calcula automáticamente: <strong>(Días × Tarifa) ÷ 30</strong>.
                    </div>
                </div>

                <div class="modal-actions" style="padding: 16px 24px; background: #F9FAFB; border-top: 1px solid #E5E7EB; display: flex; gap: 12px; justify-content: flex-end;">
                    <button class="btn-modal-secondary" onclick="closeModal('modalEditarAgregado')" style="padding: 10px 24px; font-weight: 500; background: #f3f4f6; border: 1px solid #e5e7eb; border-radius: 6px; color: #222;">Cancelar</button>
                    <button class="btn-modal-primary" onclick="guardarDatosAgregados()" style="padding: 10px 32px; font-weight: 600; background: #222; color: #fff; border-radius: 6px; border: none;">Guardar Cambios</button>
                </div>
            </div>
        </div>

        <!-- Modal: Cambio de Tarifa -->
        <div id="modalCambioTarifa" class="modal-overlay hidden">
            <div class="modal-content modal-tarifa">
                <div class="modal-header">
                    <h2><span></span> Cambio de Tarifa</h2>
                    <button class="modal-close" onclick="closeModal('modalCambioTarifa')">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label>Buscar Panel *</label>
                        <div id="tarifaPanelPicker"></div>
                    </div>
                    <div class="form-group">
                        <label>Panel Seleccionado</label>
                        <div id="tarifaPanelInfo" style="padding: 12px; background: #F9FAFB; border-radius: 8px; font-size: 14px; color: #64748B;">
                            Ningún panel seleccionado
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="tarifaNueva">Nueva Tarifa Mensual (€) *</label>
                        <input type="number" id="tarifaNueva" step="0.01" min="0" placeholder="Ej: 42.50" required>
                    </div>
                    <div class="form-group">
                        <label>Alcance del Cambio *</label>
                        <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 8px;">
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="radio" name="tarifaAlcance" value="solo_este" checked>
                                <span>Solo este panel</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="radio" name="tarifaAlcance" value="todos_municipio">
                                <span>Todos los paneles del mismo municipio</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="radio" name="tarifaAlcance" value="todos">
                                <span>Todos los paneles (cambio global)</span>
                            </label>
                        </div>
                    </div>

                    <div class="billing-preview" id="tarifaBillingPreview">
                        <h3> Impacto del Cambio</h3>
                        <div class="billing-row">
                            <span class="billing-label">Importe actual:</span>
                            <span class="billing-value" id="tarifaActual">-</span>
                        </div>
                        <div class="billing-row">
                            <span class="billing-label">Nuevo importe:</span>
                            <span class="billing-value" id="tarifaNuevaPreview">-</span>
                        </div>
                        <div class="billing-row">
                            <span class="billing-label">Paneles afectados:</span>
                            <span class="billing-value" id="tarifaPanelesAfectados">-</span>
                        </div>
                        <div class="billing-row">
                            <span class="billing-label">Variación total:</span>
                            <span class="billing-value" id="tarifaVariacion">-</span>
                        </div>
                    </div>

                    <div class="modal-actions">
                        <button class="btn-modal-secondary" onclick="closeModal('modalCambioTarifa')">Cancelar</button>
                        <button class="btn-modal-primary" onclick="guardarCambioTarifa()"> Aplicar Cambio</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="minimal-panels-section">
            <div class="minimal-section-header">
                <h2 class="minimal-section-title">Paneles</h2>
            </div>
            
            <!-- Barra de filtros responsive -->
            <div class="filters-bar">
                <div class="filters-grid">
                    <select id="filterMunicipio" class="filter-select">
                        <option value="">Todos los municipios</option>
                    </select>
                    
                    <select id="filterEstado" class="filter-select">
                        <option value="">Todos los estados</option>
                        <option value="activo">Activo</option>
                        <option value="pausado">Pausado</option>
                        <option value="desmontado">Desmontado</option>
                    </select>
                    
                    <select id="filterFacturacion" class="filter-select">
                        <option value="">Todas las facturaciones</option>
                        <option value="completa">Completa (30 días)</option>
                        <option value="parcial">Parcial (< 30 días)</option>
                        <option value="sin_facturar">Sin facturar (0 días)</option>
                    </select>
                    
                    <input type="text" id="searchInput" class="filter-input" placeholder="Código o municipio...">
                </div>
                
                <div class="filters-actions">
                    <button id="clearFiltersBtn" class="btn-clear-filters">Limpiar filtros</button>
                </div>
                
                <div class="results-counter">
                    <span id="resultsCount">0 paneles</span>
                </div>
            </div>
            
            <div class="minimal-list" id="panelsList">
                <!-- Los paneles se cargarán aquí dinámicamente -->
            </div>
        </div>
    </div>

    <!-- Modal para añadir panel -->
    <div id="addPanelModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="close-modal" onclick="closeModal('addPanelModal')">&times;</span>
                <h2>• Añadir Nuevo Panel</h2>
            </div>
            <div class="control-group">
                <label>Municipio</label>
                <input type="text" id="newMunicipio" placeholder="Ej: Madrid">
            </div>
            <div class="control-group">
                <label>Código Parada</label>
                <input type="text" id="newCodigo" placeholder="Ej: 12345">
            </div>
            <div class="control-group">
                <label>Fecha Instalación</label>
                <input type="date" id="newFechaInstalacion">
            </div>
            <div class="control-group" style="margin-top: 20px;">
                <button onclick="saveNewPanel()" class="btn-success">Guardar Panel</button>
            </div>
        </div>
    </div>

    <!-- Modal para eliminar panel -->
    <div id="removePanelModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="close-modal" onclick="closeModal('removePanelModal')">&times;</span>
                <h2>– Eliminar Panel</h2>
            </div>
            <div class="control-group">
                <label>Código Parada</label>
                <input type="text" id="removeCodigo" placeholder="Ej: 12345">
            </div>
            <div class="control-group" style="margin-top: 20px;">
                <button onclick="confirmRemovePanel()" class="btn-danger">Eliminar Panel</button>
            </div>
        </div>
    </div>

    <!-- Modal para Desmontar Panel -->
    <div id="dismountPanelModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="close-modal" onclick="closeModal('dismountPanelModal')">&times;</span>
                <h2> Desmontar Panel</h2>
            </div>
            <div class="control-group">
                <label>Código Parada</label>
                <input type="text" id="dismountCodigo" placeholder="Ej: 12345">
            </div>
            <div class="control-group">
                <label>Fecha Desmontaje</label>
                <input type="date" id="dismountFecha">
            </div>
            <div class="control-group" style="margin-top: 20px;">
                <button onclick="confirmDismountPanel()" class="btn-warning">Desmontar Panel</button>
            </div>
        </div>
    </div>

    <!-- Modal para ver histórico -->
    <div id="historyModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <span class="close-modal" onclick="closeModal('historyModal')">&times;</span>
                <h2> histórico Mensual</h2>
            </div>
            <div id="historyContent" style="max-height: 500px; overflow-y: auto;">
                <p>Cargando histórico...</p>
            </div>
        </div>
    </div>

    <script>
        // Base de datos en memoria (solo Firestore)
        let panelsData = [];
        const HISTORY_KEY = 'paneles_solares_history';
        const CHANGES_KEY = 'paneles_cambios_mensuales';
        let monthlyHistory = {};
        let monthlyChanges = {};
        let firestoreLoaded = false;

        // ============================================
        // FUNCIONES PARA PESTAñAS VESTACP
        // ============================================
        function cambiarTab(event, tabName) {
            event.preventDefault();
            
            // Remover clase active de todas las pestañas
            document.querySelectorAll('.vesta-nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Añadir clase active a la pestaña clickeada
            event.currentTarget.classList.add('active');
            
            // Aquí puedes añadir lógica para mostrar/ocultar contenido según la pestaña
            console.log('Pestaña seleccionada:', tabName);
        }

        // ============================================
        // FUNCIONES AUXILIARES VESTACP
        // ============================================
        function toggleAllPanels() {
            console.log('Toggle all panels');
            // Implementar lógica de seleccionar/deseleccionar todos
        }

        function aplicarSeleccionados() {
            console.log('Aplicar a seleccionados');
            // Implementar lógica de aplicar acción a seleccionados
        }

        function ordenarPor(campo) {
            console.log('Ordenar por:', campo);
            // La función updateTable ya maneja el ordenamiento
            updateTable();
        }

        // ============================================
        // ACTUALIZAR BADGES EN PESTAñAS
        // ============================================
        function actualizarBadges() {
            const totalPaneles = panelsData.length;
            const badgePaneles = document.getElementById('badgePaneles');
            if (badgePaneles) {
                badgePaneles.textContent = totalPaneles;
            }

            // Contar Cambios del mes actual
            const mes = parseInt(document.getElementById('currentMonth').value);
            const year = parseInt(document.getElementById('currentYear').value);
            const monthKey = `${year}-${String(mes).padStart(2, '0')}`;
            const cambiosMes = monthlyChanges[monthKey] ? monthlyChanges[monthKey].length : 0;
            
            const badgeCambios = document.getElementById('badgeCambios');
            if (badgeCambios) {
                badgeCambios.textContent = cambiosMes;
            }
        }

        // ============================================
        // ACTUALIZAR ESTADÍSTICAS DASHBOARD - CON CÁLCULO DINÁMICO
        // ============================================
        async function actualizarEstadisticas() {
            const mes = parseInt(document.getElementById('currentMonth').value);
            const year = parseInt(document.getElementById('currentYear').value);
            const monthKey = `${year}-${String(mes).padStart(2, '0')}`;

            console.log('📊 Calculando estadísticas DINÁMICAS para', monthKey);
            
            // Actualizar título con el mes seleccionado
            const nombresMeses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 
                                  'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            const tituloMesEl = document.getElementById('tituloMes');
            if (tituloMesEl) {
                tituloMesEl.textContent = `Resumen de ${nombresMeses[mes - 1]} ${year}`;
            }

            try {
                // Verificar que la función de cálculo dinámico esté disponible
                if (!window.calcularFacturacionDinamica) {
                    console.warn('⚠️ Función de cálculo dinámico no disponible');
                    mostrarEstadisticasPorDefecto();
                    return;
                }

                // CALCULAR FACTURACIÓN DINÁMICA
                const resultado = await window.calcularFacturacionDinamica(monthKey);
                
                if (resultado) {
                    console.log('✅ Facturación calculada dinámicamente:', resultado);

                    // Actualizar estadísticas en la UI
                    const statTotalEl = document.getElementById('statTotal');
                    const statActivosEl = document.getElementById('statActivos');
                    const statPausadosEl = document.getElementById('statDesmontados');
                    const statFacturacionEl = document.getElementById('statFacturacion');
                    
                    if (statTotalEl) statTotalEl.textContent = resultado.totalPaneles || panelsData.length;
                    if (statActivosEl) statActivosEl.textContent = resultado.panelesActivos || 0;
                    if (statPausadosEl) statPausadosEl.textContent = resultado.panelesPausados || 0;
                    if (statFacturacionEl) statFacturacionEl.textContent = formatEuro(resultado.totalImporte);
                    
                    const totalRevenueEl = document.getElementById('totalRevenue');
                    if (totalRevenueEl) totalRevenueEl.textContent = formatEuro(resultado.totalImporte);
                    
                    // Mostrar desglose visual si hay eventos
                    mostrarDesgloseEventos(resultado);
                } else {
                    console.warn(`⚠️ No se pudo calcular facturación para ${monthKey}`);
                    mostrarEstadisticasPorDefecto();
                    ocultarDesgloseEventos();
                }
            } catch (error) {
                console.error('❌ Error calculando estadísticas:', error);
                console.warn('⚠️ Usando estadísticas por defecto debido a error');
                mostrarEstadisticasPorDefecto();
                ocultarDesgloseEventos();
            }
        }

        // Función auxiliar para mostrar estadísticas por defecto
        function mostrarEstadisticasPorDefecto() {
            const statTotalEl = document.getElementById('statTotal');
            const statActivosEl = document.getElementById('statActivos');
            const statPausadosEl = document.getElementById('statDesmontados');
            const statFacturacionEl = document.getElementById('statFacturacion');
            
            if (statTotalEl) statTotalEl.textContent = panelsData.length;
            if (statActivosEl) statActivosEl.textContent = 0;
            if (statPausadosEl) statPausadosEl.textContent = panelsData.length;
            if (statFacturacionEl) statFacturacionEl.textContent = formatEuro(0);
            
            const totalRevenueEl = document.getElementById('totalRevenue');
            if (totalRevenueEl) totalRevenueEl.textContent = formatEuro(0);
        }

        // ============================================
        // MOSTRAR DESGLOSE VISUAL DE EVENTOS
        // ============================================
        function mostrarDesgloseEventos(resultado) {
            const desgloseCard = document.getElementById('desgloseEventos');
            const desgloseContent = document.getElementById('desgloseContent');
            
            console.log('🔍 mostrarDesgloseEventos llamada con:', resultado);
            console.log('   desglose.length:', resultado.desglose ? resultado.desglose.length : 'undefined');
            
            if (!desgloseCard || !desgloseContent) return;
            
            // Si no hay eventos o desglose, ocultar
            if (!resultado.desglose || resultado.desglose.length === 0) {
                console.log('⚠️ No hay desglose - ocultando card');
                desgloseCard.style.display = 'none';
                return;
            }
            
            console.log(`✅ Mostrando desglose con ${resultado.desglose.length} eventos`);
            
            // Construir HTML del desglose
            let html = '';
            
            // Resumen general
            html += `<div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">`;
            html += `<h3 style="margin: 0 0 10px 0; color: #333;">📋 Resumen del Cálculo</h3>`;
            html += `<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">`;
            
            if (resultado.mesBase) {
                html += `<div>
                    <div style="font-size: 12px; color: #666;">Base (${resultado.mesBase})</div>
                    <div style="font-size: 18px; font-weight: bold; color: #1e3a5f;">${formatEuro(resultado.baseImporte)}</div>
                </div>`;
            }
            
            html += `<div>
                <div style="font-size: 12px; color: #666;">Eventos Aplicados</div>
                <div style="font-size: 18px; font-weight: bold; color: #2196F3;">${resultado.eventosAplicados || 'N/A'}</div>
            </div>`;
            
            html += `<div>
                <div style="font-size: 12px; color: #666;">Diferencia</div>
                <div style="font-size: 18px; font-weight: bold; color: ${resultado.diferencia >= 0 ? '#4CAF50' : '#F44336'};">
                    ${resultado.diferencia ? (resultado.diferencia >= 0 ? '+' : '') + formatEuro(resultado.diferencia) : 'N/A'}
                </div>
            </div>`;
            
            html += `<div>
                <div style="font-size: 12px; color: #666;">Total (${resultado.monthKey})</div>
                <div style="font-size: 18px; font-weight: bold; color: #1e3a5f;">${formatEuro(resultado.totalImporte)}</div>
            </div>`;
            
            html += `</div></div>`;
            
            // Ordenar por diferencia de importe (mayor impacto primero)
            const desgloseOrdenado = [...resultado.desglose].sort((a, b) => 
                Math.abs(b.diferenciaImporte || 0) - Math.abs(a.diferenciaImporte || 0)
            );
            
            const totalEventos = desgloseOrdenado.length;
            const mostrarColapsable = totalEventos > 5;
            
            // Tabla de ajustes individuales con botón de expandir/colapsar
            html += `<div style="margin: 20px 0;">`;
            html += `<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">`;
            html += `<h3 style="margin: 0; color: #333;">🔄 Ajustes por Panel (${totalEventos})</h3>`;
            
            if (mostrarColapsable) {
                html += `<button 
                    id="toggleDesgloseBtn" 
                    onclick="toggleTablaDesglose()"
                    style="
                        background: #2196F3; 
                        color: white; 
                        border: none; 
                        padding: 8px 16px; 
                        border-radius: 4px; 
                        cursor: pointer;
                        font-size: 13px;
                        display: flex;
                        align-items: center;
                        gap: 5px;
                    ">
                    <span id="toggleDesgloseIcon">▼</span>
                    <span id="toggleDesgloseText">Mostrar todos (${totalEventos})</span>
                </button>`;
            }
            
            html += `</div>`;
            
            // Contenedor de la tabla (colapsable si hay más de 5)
            html += `<div id="tablaDesgloseContainer" style="${mostrarColapsable ? 'display: none;' : 'display: block;'} overflow-x: auto;">`;
            html += `<table style="width: 100%; border-collapse: collapse; font-size: 13px;">`;
            html += `<thead style="background: #1e3a5f; color: white;">
                <tr>
                    <th style="padding: 10px; text-align: left;">Panel</th>
                    <th style="padding: 10px; text-align: left;">Municipio</th>
                    <th style="padding: 10px; text-align: center;">Eventos</th>
                    <th style="padding: 10px; text-align: right;">Días Base</th>
                    <th style="padding: 10px; text-align: right;">Días Nuevos</th>
                    <th style="padding: 10px; text-align: right;">Δ Días</th>
                    <th style="padding: 10px; text-align: right;">Importe Base</th>
                    <th style="padding: 10px; text-align: right;">Importe Nuevo</th>
                    <th style="padding: 10px; text-align: right;">Δ Importe</th>
                    <th style="padding: 10px; text-align: center;">Acciones</th>
                </tr>
            </thead><tbody>`;
            
            desgloseOrdenado.forEach((item, index) => {
                const rowColor = index % 2 === 0 ? '#ffffff' : '#f8f9fa';
                const deltaColor = (item.diferenciaImporte || 0) >= 0 ? '#4CAF50' : '#F44336';
                
                html += `<tr style="background: ${rowColor};">
                    <td style="padding: 8px; font-weight: 500;">${item.panelId}</td>
                    <td style="padding: 8px;">${item.municipio}</td>
                    <td style="padding: 8px; text-align: center;">
                        <span style="background: #2196F3; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px;">
                            ${item.eventos || 0}
                        </span>
                    </td>
                    <td style="padding: 8px; text-align: right; color: #666;">${item.diasBase || 0}</td>
                    <td style="padding: 8px; text-align: right; font-weight: 500;">${item.diasNuevos || 0}</td>
                    <td style="padding: 8px; text-align: right; color: ${deltaColor}; font-weight: bold;">
                        ${(item.diferenciaDias || 0) >= 0 ? '+' : ''}${item.diferenciaDias || 0}
                    </td>
                    <td style="padding: 8px; text-align: right; color: #666;">${formatEuro(item.importeBase || 0)}</td>
                    <td style="padding: 8px; text-align: right; font-weight: 500;">${formatEuro(item.importeNuevo || 0)}</td>
                    <td style="padding: 8px; text-align: right; color: ${deltaColor}; font-weight: bold;">
                        ${(item.diferenciaImporte || 0) >= 0 ? '+' : ''}${formatEuro(item.diferenciaImporte || 0)}
                    </td>
                    <td style="padding: 8px; text-align: center;">
                        <button class="btn-desglose-menu" onclick="toggleDesgloseMenu(event, ${index})" style="width: 28px; height: 28px; border: 1px solid #ddd; background: white; border-radius: 4px; cursor: pointer; font-size: 16px; line-height: 1;">⋮</button>
                        <div id="desgloseMenu${index}" class="event-dropdown desglose-dropdown hidden">
                            <button onclick="verEventosPanel('${item.panelId}', '${item.municipio}')" style="width: 100%; padding: 10px 16px; text-align: left; border: none; background: none; cursor: pointer; font-size: 14px; border-bottom: 1px solid var(--gray-lighter);">Ver eventos</button>
                            <button onclick="editarPrimerEvento('${item.panelId}', '${item.monthKey}')" style="width: 100%; padding: 10px 16px; text-align: left; border: none; background: none; cursor: pointer; font-size: 14px; border-bottom: 1px solid var(--gray-lighter);">Editar evento</button>
                            <button onclick="eliminarPrimerEvento('${item.panelId}', '${item.monthKey}', '${item.municipio}')" style="width: 100%; padding: 10px 16px; text-align: left; border: none; background: none; cursor: pointer; font-size: 14px; color: var(--red);">Eliminar evento</button>
                        </div>
                    </td>
                </tr>`;
            });
            
            html += `</tbody></table></div>`;
            html += `</div>`; // Cierra el contenedor de la tabla
            
            // Indicador si es desde caché o base de datos
            if (resultado.fromCache) {
                html += `<div style="margin-top: 15px; padding: 10px; background: #e3f2fd; border-left: 4px solid #2196F3; font-size: 12px; color: #1976D2;">
                    <strong>ℹ️ Mes cerrado</strong> - Datos desde caché (billing_summary)
                </div>`;
            } else if (resultado.fromDatabase) {
                html += `<div style="margin-top: 15px; padding: 10px; background: #e8f5e9; border-left: 4px solid #4CAF50; font-size: 12px; color: #2E7D32;">
                    <strong>✅ Datos guardados</strong> - Leído desde panel_month_billing
                </div>`;
            } else {
                html += `<div style="margin-top: 15px; padding: 10px; background: #fff3e0; border-left: 4px solid #FF9800; font-size: 12px; color: #F57C00;">
                    <strong>🔄 Cálculo dinámico</strong> - Calculado en tiempo real desde eventos
                </div>`;
            }
            
            desgloseContent.innerHTML = html;
            desgloseCard.style.display = 'block';
        }

        // Función para expandir/colapsar la tabla de desglose
        function toggleTablaDesglose() {
            const container = document.getElementById('tablaDesgloseContainer');
            const icon = document.getElementById('toggleDesgloseIcon');
            const text = document.getElementById('toggleDesgloseText');
            
            if (container.style.display === 'none') {
                container.style.display = 'block';
                icon.textContent = '▲';
                text.textContent = 'Ocultar';
            } else {
                container.style.display = 'none';
                icon.textContent = '▼';
                const totalEventos = container.querySelector('tbody').rows.length;
                text.textContent = `Mostrar todos (${totalEventos})`;
            }
        }

        function ocultarDesgloseEventos() {
            const desgloseCard = document.getElementById('desgloseEventos');
            if (desgloseCard) {
                desgloseCard.style.display = 'none';
            }
        }


        // Cargar datos iniciales SOLO desde Firestore
        // Esta función se llama automáticamente después de autenticación exitosa
        async function loadInitialData() {
            console.log('🔄 Cargando paneles desde Firestore...');
            
            // Establecer mes y año actuales en los selectores
            const fechaActual = new Date();
            const mesActual = fechaActual.getMonth() + 1; // getMonth() retorna 0-11
            const yearActual = fechaActual.getFullYear();
            
            const selectMes = document.getElementById('currentMonth');
            const inputYear = document.getElementById('currentYear');
            
            if (selectMes) {
                selectMes.value = String(mesActual).padStart(2, '0');
                console.log(`📅 Mes establecido a: ${mesActual} (${fechaActual.toLocaleString('es-ES', { month: 'long' })} ${yearActual})`);
            }
            if (inputYear) {
                inputYear.value = yearActual;
            }
            
            try {
                if (!window.cargarPanelesDesdeFirestore) {
                    throw new Error('Firebase no está inicializado');
                }
                
                const panelesFirestore = await window.cargarPanelesDesdeFirestore();
                
                if (panelesFirestore.length > 0) {
                    panelsData = panelesFirestore;
                    firestoreLoaded = true;
                    console.log(`✅ ${panelesFirestore.length} paneles cargados desde Firestore`);
                } else {
                    console.warn('⚠️ No se encontraron paneles en Firestore, intentando cargar desde JSON...');
                    
                    // Fallback: cargar desde archivo JSON local
                    try {
                        const response = await fetch('./paneles_octubre_2025.json');
                        const panelesJSON = await response.json();
                        
                        if (panelesJSON && panelesJSON.length > 0) {
                            panelsData = panelesJSON.map(panel => ({
                                ...panel,
                                tarifa: panel.tarifa || 37.70,
                                estado: panel.fechaDesmontaje ? 'desmontado' : 'activo'
                            }));
                            console.log(`✅ ${panelsData.length} paneles cargados desde JSON`);
                        } else {
                            panelsData = [];
                            console.warn('⚠️ No hay datos en el archivo JSON');
                        }
                    } catch (jsonError) {
                        console.error('❌ Error al cargar JSON:', jsonError);
                        panelsData = [];
                        alert('⚠️ No se pudieron cargar los datos.\n\nIntenta recargar la página.');
                    }
                }
            } catch (error) {
                console.error('❌ Error al cargar desde Firestore:', error);
                alert('❌ Error al conectar con Firestore:\n\n' + error.message + '\n\nRecarga la página.');
                panelsData = [];
            }
            
            // Cargar históricos desde localStorage
            const savedHistory = localStorage.getItem(HISTORY_KEY);
            if (savedHistory) {
                monthlyHistory = JSON.parse(savedHistory);
            } else {
                monthlyHistory = {};
            }
            
            // Cargar cambios mensuales desde localStorage
            const savedChanges = localStorage.getItem(CHANGES_KEY);
            if (savedChanges) {
                monthlyChanges = JSON.parse(savedChanges);
            } else {
                monthlyChanges = {};
            }
            
            updateTable();
            
            // Forzar actualización de estadísticas después de cargar datos
            await actualizarEstadisticas();
            
            console.log('✅ Datos cargados y estadísticas actualizadas');
            
            // DEBUG: Verificar elementos DOM
            console.log('🔍 Verificando elementos DOM:');
            console.log('statTotal:', document.getElementById('statTotal'));
            console.log('statActivos:', document.getElementById('statActivos'));
            console.log('statDesmontados:', document.getElementById('statDesmontados'));
            console.log('statFacturacion:', document.getElementById('statFacturacion'));
            
            // Forzar actualización manual como último recurso
            setTimeout(async () => {
                console.log('⏰ Ejecutando actualización diferida...');
                await actualizarEstadisticas();
                
                // Actualización manual directa
                const totalEl = document.getElementById('statTotal');
                if (totalEl && panelsData.length > 0) {
                    totalEl.textContent = panelsData.length;
                    console.log('🔧 Actualización manual aplicada:', panelsData.length);
                }
            }, 1000);
            
            // Poblar filtros después de cargar datos
            populateFilters();
        }
        
        // Exponer función globalmente para que Firebase Auth pueda llamarla
        window.loadInitialData = loadInitialData;

        // Función de debugging global
        window.debugStats = function() {
            console.log('🐛 DEBUG STATS:');
            console.log('panelsData.length:', panelsData.length);
            console.log('panelsData sample:', panelsData.slice(0, 3));
            
            const mes = parseInt(document.getElementById('currentMonth').value);
            const year = parseInt(document.getElementById('currentYear').value);
            console.log('Mes/Año actual:', mes, year);
            
            // Test cálculo manual
            if (panelsData.length > 0) {
                const testPanel = panelsData[0];
                const testCalc = calcularFacturacion(testPanel, mes, year);
                console.log('Test cálculo primer panel:', testCalc);
            }
            
            // Ejecutar actualización manual
            actualizarEstadisticas();
            
            // Forzar valores manualmente
            document.getElementById('statTotal').textContent = panelsData.length;
            document.getElementById('statActivos').textContent = panelsData.filter(p => !p.fechaDesmontaje).length;
            document.getElementById('statDesmontados').textContent = panelsData.filter(p => p.fechaDesmontaje).length;
            document.getElementById('statFacturacion').textContent = formatEuro(panelsData.length * 37.70);
            
            console.log('🔧 Valores forzados manualmente');
        };

        // Función de debugging para filtros
        window.debugFilters = function() {
            console.log('🔧 DEBUG FILTERS:');
            console.log('panelsData existe:', !!panelsData);
            console.log('panelsData.length:', panelsData ? panelsData.length : 'undefined');
            console.log('sample panelsData:', panelsData ? panelsData.slice(0, 3) : 'undefined');
            
            const filterMunicipio = document.getElementById('filterMunicipio');
            console.log('filterMunicipio elemento:', !!filterMunicipio);
            console.log('filterMunicipio opciones:', filterMunicipio ? filterMunicipio.options.length : 'elemento no encontrado');
            
            if (panelsData && panelsData.length > 0) {
                const municipios = [...new Set(panelsData.map(p => p.municipio))].filter(m => m).sort();
                console.log('Municipios únicos extraídos:', municipios);
                populateFilters();
            }
        };

        // Función de debugging para verificar facturación de un panel específico
        window.debugPanel = function(codigo) {
            console.log('🔍 DEBUG PANEL:', codigo);
            
            const panel = panelsData.find(p => p.codigo === codigo || String(p.codigo) === String(codigo));
            
            if (!panel) {
                console.error('❌ Panel no encontrado:', codigo);
                console.log('Paneles disponibles:', panelsData.map(p => p.codigo));
                return;
            }
            
            console.log('📋 Datos del panel:');
            console.log('  - Municipio:', panel.municipio);
            console.log('  - Código:', panel.codigo);
            console.log('  - Tarifa:', panel.tarifa);
            console.log('  - Estado:', panel.estado);
            console.log('  - Fecha Instalación:', panel.fechaInstalacion);
            console.log('  - Fecha Desmontaje:', panel.fechaDesmontaje);
            console.log('  - ID Firestore:', panel.id);
            
            const mes = parseInt(document.getElementById('currentMonth').value);
            const year = parseInt(document.getElementById('currentYear').value);
            console.log('📅 Calculando para:', mes + '/' + year);
            
            const calculo = calcularFacturacion(panel, mes, year);
            console.log('💰 Resultado del cálculo:');
            console.log('  - Días:', calculo.dias);
            console.log('  - Importe:', calculo.importe, '€');
            console.log('  - Tipo:', calculo.tipo);
            console.log('  - Tarifa diaria:', calculo.tarifaDiaria);
            console.log('  - Desde:', calculo.desde);
            console.log('  - Hasta:', calculo.hasta);
            
            // Explicar por qué tiene 0 días
            if (calculo.dias === 0) {
                console.warn('⚠️ RAZÓN DE 0 FACTURACIÓN:');
                if (calculo.tipo === 'inactivo') {
                    if (panel.fechaInstalacion) {
                        const fi = new Date(panel.fechaInstalacion);
                        if (fi.getFullYear() > year || (fi.getFullYear() === year && fi.getMonth() + 1 > mes)) {
                            console.warn('  ➡️ Panel AÚN NO INSTALADO en este mes');
                            console.warn('  ➡️ Se instalará el:', fi.toLocaleDateString('es-ES'));
                        }
                    }
                    if (panel.fechaDesmontaje) {
                        const fd = new Date(panel.fechaDesmontaje);
                        if (fd.getFullYear() < year || (fd.getFullYear() === year && fd.getMonth() + 1 < mes)) {
                            console.warn('  ➡️ Panel YA DESMONTADO antes de este mes');
                            console.warn('  ➡️ Se desmontó el:', fd.toLocaleDateString('es-ES'));
                        }
                    }
                }
            }
            
            return { panel, calculo };
        };

        // Función para verificar estructura de eventos
        window.verificarEventosPanel = async function(codigo) {
            try {
                console.log('🔍 VERIFICANDO ESTRUCTURA DE EVENTOS');
                console.log('═══════════════════════════════════════');
                
                const panel = panelsData.find(p => p.codigo === codigo || String(p.codigo) === String(codigo));
                if (!panel || !panel.id) {
                    console.error('❌ Panel no encontrado');
                    return;
                }
                
                const panelId = panel.id;
                
                // 1. Verificar colección 'eventos'
                console.log('1️⃣ Verificando paneles/' + panelId + '/eventos');
                console.log('─────────────────────────────────────');
                const eventosSnap = await firebaseDB.collection('paneles').doc(panelId).collection('eventos').get();
                
                if (eventosSnap.empty) {
                    console.log('❌ No hay documentos en /eventos');
                } else {
                    console.log(`✅ ${eventosSnap.size} documento(s) encontrado(s)`);
                    eventosSnap.forEach(doc => {
                        const data = doc.data();
                        console.log(`\n📋 Evento: ${doc.id}`);
                        console.log('   Campos:', Object.keys(data));
                        console.log('   Datos:', data);
                    });
                }
                
                console.log('\n');
                
                // 2. Verificar colección 'changes'
                console.log('2️⃣ Verificando paneles/' + panelId + '/changes');
                console.log('─────────────────────────────────────');
                const changesSnap = await firebaseDB.collection('paneles').doc(panelId).collection('changes').get();
                
                if (changesSnap.empty) {
                    console.log('❌ No hay documentos en /changes');
                } else {
                    console.log(`✅ ${changesSnap.size} documento(s) encontrado(s)`);
                    changesSnap.forEach(doc => {
                        const data = doc.data();
                        console.log(`\n📋 Change: ${doc.id}`);
                        console.log('   Campos:', Object.keys(data));
                        console.log('   Datos:', data);
                    });
                }
                
                console.log('\n═══════════════════════════════════════');
                
            } catch (error) {
                console.error('❌ Error:', error);
            }
        };

        // Función de diagnóstico completa de Firestore para un panel
        window.diagnosticarFirestore = async function(codigo, mes = '11', year = '2025') {
            try {
                console.log('🔍 DIAGNÓSTICO COMPLETO DE FIRESTORE');
                console.log('═══════════════════════════════════════');
                console.log('Panel:', codigo);
                console.log('Mes:', mes, 'Año:', year);
                console.log('═══════════════════════════════════════\n');
                
                const panel = panelsData.find(p => p.codigo === codigo || String(p.codigo) === String(codigo));
                
                if (!panel) {
                    console.error('❌ Panel no encontrado en memoria local');
                    return;
                }
                
                const panelId = panel.id;
                const monthKey = `${year}-${mes.padStart(2, '0')}`;
                
                // 1. Verificar documento principal del panel
                console.log('1️⃣ COLECCIÓN: paneles/' + panelId);
                console.log('─────────────────────────────────────');
                try {
                    const panelDoc = await firebaseDB.collection('paneles').doc(panelId).get();
                    if (panelDoc.exists) {
                        const data = panelDoc.data();
                        console.log('✅ Documento encontrado:');
                        console.log('   - municipio:', data.municipio);
                        console.log('   - codigo:', data.codigo);
                        console.log('   - tarifa:', data.tarifa, typeof data.tarifa);
                        console.log('   - estado:', data.estado);
                        console.log('   - fechaInstalacion:', data.fechaInstalacion);
                        console.log('   - fechaDesmontaje:', data.fechaDesmontaje);
                        console.log('   - operador:', data.operador);
                    } else {
                        console.error('❌ Documento NO existe en paneles/');
                    }
                } catch (err) {
                    console.error('❌ Error leyendo paneles/:', err.message);
                }
                
                console.log('\n');
                
                // 2. Verificar eventos del panel
                console.log('2️⃣ COLECCIÓN: paneles/' + panelId + '/eventos');
                console.log('─────────────────────────────────────');
                try {
                    const eventosSnapshot = await firebaseDB.collection('paneles').doc(panelId).collection('eventos').get();
                    if (eventosSnapshot.empty) {
                        console.log('ℹ️  No hay eventos registrados');
                    } else {
                        console.log(`✅ ${eventosSnapshot.size} evento(s) encontrado(s):`);
                        eventosSnapshot.forEach(doc => {
                            const data = doc.data();
                            console.log(`   📋 ID: ${doc.id}`);
                            console.log(`      - tipo: ${data.tipo}`);
                            console.log(`      - fecha: ${data.fecha}`);
                            console.log(`      - monthKey: ${data.monthKey}`);
                            console.log(`      - municipio: ${data.municipio}`);
                            console.log(`      - tarifa: ${data.tarifa}`);
                            console.log('');
                        });
                    }
                } catch (err) {
                    console.error('❌ Error leyendo eventos/:', err.message);
                }
                
                console.log('\n');
                
                // 3. Verificar billing del mes específico
                const billingDocId = `${codigo}_${monthKey}`;
                console.log('3️⃣ COLECCIÓN: panel_month_billing/' + billingDocId);
                console.log('─────────────────────────────────────');
                try {
                    const billingDoc = await firebaseDB.collection('panel_month_billing').doc(billingDocId).get();
                    if (billingDoc.exists) {
                        const data = billingDoc.data();
                        console.log('✅ Documento encontrado:');
                        console.log('   - panelId:', data.panelId);
                        console.log('   - monthKey:', data.monthKey);
                        console.log('   - dias:', data.dias);
                        console.log('   - importe:', data.importe);
                        console.log('   - tarifa:', data.tarifa);
                        console.log('   - tipo:', data.tipo);
                        console.log('   - eventos:', data.eventos ? data.eventos.length : 0);
                    } else {
                        console.log('ℹ️  Documento NO existe (se creará al calcular facturación)');
                    }
                } catch (err) {
                    console.error('❌ Error leyendo panel_month_billing/:', err.message);
                }
                
                console.log('\n');
                
                // 4. Verificar resumen de facturación del mes
                const summaryDocId = year + mes.padStart(2, '0');
                console.log('4️⃣ COLECCIÓN: billing_summary/' + summaryDocId);
                console.log('─────────────────────────────────────');
                try {
                    const summaryDoc = await firebaseDB.collection('billing_summary').doc(summaryDocId).get();
                    if (summaryDoc.exists) {
                        const data = summaryDoc.data();
                        console.log('✅ Resumen del mes encontrado:');
                        console.log('   - totalPaneles:', data.totalPaneles);
                        console.log('   - totalImporte:', data.totalImporte);
                        console.log('   - panelesActivos:', data.panelesActivos);
                        console.log('   - panelesParciales:', data.panelesParciales);
                        console.log('   - panelesInactivos:', data.panelesInactivos);
                    } else {
                        console.log('ℹ️  Resumen del mes NO existe');
                    }
                } catch (err) {
                    console.error('❌ Error leyendo billing_summary/:', err.message);
                }
                
                console.log('\n═══════════════════════════════════════');
                console.log('🏁 DIAGNÓSTICO COMPLETO');
                
            } catch (error) {
                console.error('❌ Error en diagnóstico:', error);
            }
        };

        // Función para regenerar TODA la facturación desde cero (solo paneles base)
        window.regenerarFacturacionCompleta = async function(mes = '11', year = '2025', copiarDelMesAnterior = false) {
            try {
                console.log('🔄 REGENERANDO FACTURACIÓN COMPLETA DESDE CERO');
                console.log('═══════════════════════════════════════════════');
                
                const monthKey = `${year}-${mes.padStart(2, '0')}`;
                const summaryDocId = year + mes.padStart(2, '0');
                
                // Si se solicita copiar del mes anterior
                if (copiarDelMesAnterior) {
                    console.log('📋 Modo: COPIAR DEL MES ANTERIOR (sin recalcular fechas)');
                    
                    // Calcular mes anterior
                    const mesNum = parseInt(mes);
                    const yearNum = parseInt(year);
                    const prevM = mesNum === 1 ? 12 : mesNum - 1;
                    const prevY = mesNum === 1 ? yearNum - 1 : yearNum;
                    const monthKeyAnterior = `${prevY}-${String(prevM).padStart(2, '0')}`;
                    
                    console.log(`📦 Copiando datos de ${monthKeyAnterior}...`);
                    
                    // Leer datos del mes anterior
                    const snapshotAnterior = await firebaseDB.collection('panel_month_billing')
                        .where('monthKey', '==', monthKeyAnterior)
                        .get();
                    
                    if (snapshotAnterior.empty) {
                        console.error('❌ No hay datos en el mes anterior');
                        alert('❌ No se encontraron datos en el mes anterior');
                        return;
                    }
                    
                    console.log(`✅ ${snapshotAnterior.size} paneles encontrados en ${monthKeyAnterior}`);
                    
                    // Copiar a nuevo mes
                    const batch = firebaseDB.batch();
                    let batchCount = 0;
                    const BATCH_SIZE = 500;
                    let totalImporte = 0;
                    let panelesActivos = 0;
                    let panelesParciales = 0;
                    let panelesInactivos = 0;
                    
                    snapshotAnterior.forEach(doc => {
                        const data = doc.data();
                        const nuevoDato = {
                            ...data,
                            monthKey: monthKey,
                            eventos: [],
                            acciones: {},
                            copiadoDe: monthKeyAnterior
                        };
                        
                        const docId = `${data.codigo}_${monthKey}`;
                        const docRef = firebaseDB.collection('panel_month_billing').doc(docId);
                        batch.set(docRef, nuevoDato);
                        batchCount++;
                        
                        totalImporte += data.totalImporte || 0;
                        const dias = data.totalDiasFacturables || 0;
                        if (dias === 0) panelesInactivos++;
                        else if (dias === 30) panelesActivos++;
                        else panelesParciales++;
                    });
                    
                    await batch.commit();
                    
                    totalImporte = Math.round(totalImporte * 100) / 100;
                    
                    // Guardar resumen
                    await firebaseDB.collection('billing_summary').doc(summaryDocId).set({
                        monthKey: monthKey,
                        totalPaneles: snapshotAnterior.size,
                        totalImporte: totalImporte,
                        panelesActivos: panelesActivos,
                        panelesParciales: panelesParciales,
                        panelesInactivos: panelesInactivos,
                        copiadoDe: monthKeyAnterior,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
                    console.log('📊 RESUMEN COPIADO:');
                    console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
                    console.log(`Total paneles: ${snapshotAnterior.size}`);
                    console.log(`  ├─ Activos (30 días): ${panelesActivos}`);
                    console.log(`  ├─ Parciales (< 30 días): ${panelesParciales}`);
                    console.log(`  └─ Inactivos (0 días): ${panelesInactivos}`);
                    console.log(`Total facturación: ${totalImporte.toFixed(2)} €`);
                    console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n');
                    
                    alert(`✅ Facturación copiada de ${monthKeyAnterior} a ${monthKey}\n\n` +
                          `Total paneles: ${snapshotAnterior.size}\n` +
                          `Total: ${totalImporte.toFixed(2)} €\n\n` +
                          `Recarga la página para ver los cambios`);
                    
                    return { totalPaneles: snapshotAnterior.size, totalImporte, panelesActivos, panelesParciales, panelesInactivos };
                }
                
                // Modo normal: calcular desde fechas
                // 1. Cargar TODOS los paneles desde Firestore
                console.log('📦 Cargando todos los paneles desde Firestore...');
                const snapshot = await firebaseDB.collection('paneles').orderBy('municipio').get();
                
                let totalPaneles = 0;
                let totalImporte = 0;
                let panelesActivos = 0;
                let panelesParciales = 0;
                let panelesInactivos = 0;
                
                console.log(`✅ ${snapshot.size} paneles cargados`);
                console.log('💰 Calculando facturación para cada panel...\n');
                
                const mesNum = parseInt(mes);
                const yearNum = parseInt(year);
                
                // Preparar batch para guardar panel_month_billing
                const batch = firebaseDB.batch();
                let batchCount = 0;
                const BATCH_SIZE = 500;
                
                const panelBillings = [];
                
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    const panel = {
                        id: doc.id,
                        municipio: data.municipio,
                        codigo: data.codigo,
                        tarifa: data.tarifa || 37.70,
                        fechaInstalacion: data.fechaInstalacion,
                        fechaDesmontaje: data.fechaDesmontaje,
                        estado: data.estado || (data.fechaDesmontaje ? 'desmontado' : 'activo')
                    };
                    
                    // Calcular facturación
                    const calculo = calcularFacturacion(panel, mesNum, yearNum);
                    
                    totalPaneles++;
                    
                    if (calculo.dias === 0) {
                        panelesInactivos++;
                    } else if (calculo.dias === 30) {
                        panelesActivos++;
                        totalImporte += calculo.importe;
                    } else {
                        panelesParciales++;
                        totalImporte += calculo.importe;
                    }
                    
                    // Crear documento panel_month_billing
                    panelBillings.push({
                        panelId: String(panel.codigo),
                        codigo: panel.codigo,
                        municipio: panel.municipio,
                        monthKey: monthKey,
                        totalDiasFacturables: calculo.dias,
                        totalImporte: calculo.importe,
                        tarifa: panel.tarifa,
                        tipo: calculo.tipo,
                        eventos: [],
                        acciones: {}
                    });
                });
                
                // Guardar todos los panel_month_billing en batches
                console.log(`💾 Guardando ${panelBillings.length} documentos en panel_month_billing...`);
                for (let i = 0; i < panelBillings.length; i++) {
                    const billingData = panelBillings[i];
                    const docId = `${billingData.codigo}_${monthKey}`;
                    const docRef = firebaseDB.collection('panel_month_billing').doc(docId);
                    batch.set(docRef, billingData);
                    batchCount++;
                    
                    // Commit cada 500 operaciones (límite de Firestore)
                    if (batchCount >= BATCH_SIZE) {
                        await batch.commit();
                        console.log(`  ✅ Guardados ${i + 1}/${panelBillings.length}...`);
                        batchCount = 0;
                    }
                }
                
                // Commit final
                if (batchCount > 0) {
                    await batch.commit();
                }
                console.log(`✅ ${panelBillings.length} documentos guardados en panel_month_billing`);
                
                // Redondear
                totalImporte = Math.round(totalImporte * 100) / 100;
                
                console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
                console.log('📊 RESUMEN CALCULADO:');
                console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
                console.log(`Total paneles: ${totalPaneles}`);
                console.log(`  ├─ Activos (30 días): ${panelesActivos}`);
                console.log(`  ├─ Parciales (< 30 días): ${panelesParciales}`);
                console.log(`  └─ Inactivos (0 días): ${panelesInactivos}`);
                console.log(`Total facturación: ${totalImporte.toFixed(2)} €`);
                console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n');
                
                // 2. Guardar en billing_summary
                console.log('💾 Guardando en billing_summary/' + summaryDocId + '...');
                await firebaseDB.collection('billing_summary').doc(summaryDocId).set({
                    monthKey: monthKey,
                    totalPaneles: totalPaneles,
                    totalImporte: totalImporte,
                    panelesActivos: panelesActivos,
                    panelesParciales: panelesParciales,
                    panelesInactivos: panelesInactivos,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    regeneratedBy: firebaseAuth.currentUser.email,
                    regeneratedAt: new Date().toISOString()
                });
                
                console.log('✅ Resumen guardado correctamente');
                console.log('═══════════════════════════════════════════════');
                
                alert(`✅ Facturación regenerada para ${monthKey}\n\n` +
                      `Total paneles: ${totalPaneles}\n` +
                      `Activos: ${panelesActivos}\n` +
                      `Parciales: ${panelesParciales}\n` +
                      `Inactivos: ${panelesInactivos}\n` +
                      `Total: ${totalImporte.toFixed(2)} €\n\n` +
                      `Recarga la página para ver los cambios`);
                
                return { totalPaneles, totalImporte, panelesActivos, panelesParciales, panelesInactivos };
                
            } catch (error) {
                console.error('❌ Error regenerando facturación:', error);
                alert(`❌ Error: ${error.message}`);
            }
        };

        // Función para limpiar datos obsoletos de un panel
        window.limpiarDatosPanel = async function(codigo, mes = '11', year = '2025') {
            try {
                console.log('🧹 LIMPIANDO DATOS OBSOLETOS DEL PANEL:', codigo);
                
                const panel = panelsData.find(p => p.codigo === codigo || String(p.codigo) === String(codigo));
                if (!panel || !panel.id) {
                    console.error('❌ Panel no encontrado');
                    return;
                }
                
                const monthKey = `${year}-${mes.padStart(2, '0')}`;
                const billingDocId = `${codigo}_${monthKey}`;
                
                // 1. Eliminar documento de panel_month_billing
                console.log('🗑️  Eliminando panel_month_billing/' + billingDocId);
                try {
                    await firebaseDB.collection('panel_month_billing').doc(billingDocId).delete();
                    console.log('✅ Eliminado');
                } catch (err) {
                    console.log('ℹ️  No existía el documento');
                }
                
                // 2. Eliminar todos los eventos del panel
                console.log('🗑️  Eliminando eventos del panel...');
                const eventosSnapshot = await firebaseDB.collection('paneles').doc(panel.id).collection('eventos').get();
                const batch = firebaseDB.batch();
                eventosSnapshot.forEach(doc => {
                    batch.delete(doc.ref);
                });
                await batch.commit();
                console.log(`✅ ${eventosSnapshot.size} evento(s) eliminado(s)`);
                
                console.log('✅ Limpieza completada');
                alert('✅ Datos obsoletos eliminados\n\nAhora ejecuta:\nregenerarFacturacionCompleta()');
                
            } catch (error) {
                console.error('❌ Error limpiando datos:', error);
                alert(`❌ Error: ${error.message}`);
            }
        };

        // Función para actualizar/restaurar la tarifa de un panel en Firestore
        window.actualizarTarifaPanel = async function(codigo, nuevaTarifa = 37.70) {
            try {
                console.log('🔄 Actualizando tarifa del panel:', codigo);
                
                const panel = panelsData.find(p => p.codigo === codigo || String(p.codigo) === String(codigo));
                
                if (!panel) {
                    console.error('❌ Panel no encontrado:', codigo);
                    return;
                }
                
                if (!panel.id) {
                    console.error('❌ Panel sin ID de Firestore:', codigo);
                    return;
                }
                
                // Actualizar en Firestore
                await firebaseDB.collection('paneles').doc(panel.id).update({
                    tarifa: nuevaTarifa,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                console.log('✅ Tarifa actualizada en Firestore');
                
                // Actualizar en memoria local
                panel.tarifa = nuevaTarifa;
                
                // Recargar tabla y estadísticas
                await updateTable();
                await actualizarEstadisticas();
                
                console.log('✅ Panel actualizado:', codigo, '- Nueva tarifa:', nuevaTarifa);
                alert(`✅ Tarifa actualizada\n\nPanel ${codigo}: ${nuevaTarifa} €/mes`);
                
                return true;
            } catch (error) {
                console.error('❌ Error actualizando tarifa:', error);
                alert(`❌ Error al actualizar:\n\n${error.message}`);
                return false;
            }
        };
        
        // Auto-ejecutar al cargar
        window.addEventListener('load', () => {
            setTimeout(() => {
                console.log('🚀 Auto-ejecutando debugStats después de 3 segundos...');
                if (window.debugStats) window.debugStats();
                
                // También ejecutar debugFilters
                console.log('🔧 Auto-ejecutando debugFilters...');
                if (window.debugFilters) window.debugFilters();
            }, 3000);
        });


        // Guardar histórico en localStorage (NO paneles, solo históricos)
        function saveData() {
            // Ya NO guardamos panelsData en localStorage
            // Los paneles viven SOLO en Firestore
            
            // Guardar histórico del mes actual
            const month = document.getElementById('currentMonth').value;
            const year = document.getElementById('currentYear').value;
            const monthKey = `${year}-${month}`;
            
            // Calcular snapshot del mes
            const snapshot = {
                fecha: new Date().toISOString(),
                mes: month,
                year: year,
                totalPaneles: panelsData.length,
                paneles: JSON.parse(JSON.stringify(panelsData)), // Deep copy
                facturacionTotal: 0
            };
            
            // Calcular facturación
            panelsData.forEach(panel => {
                const facturacion = calcularFacturacion(panel, parseInt(month), parseInt(year));
                snapshot.facturacionTotal += facturacion.importe;
            });
            
            snapshot.facturacionTotal = parseFloat(snapshot.facturacionTotal.toFixed(2));
            
            // Guardar en histórico
            monthlyHistory[monthKey] = snapshot;
            localStorage.setItem(HISTORY_KEY, JSON.stringify(monthlyHistory));
        }

        // FUNCIÓN CORE: Calcular Facturación de un panel para un mes específico
        function calcularFacturacion(panel, mes, year) {
            // Tolerar tarifas como string "37,70" o "37.70" y valores faltantes
            const rawTarifa = (panel && panel.tarifa) != null ? panel.tarifa : 37.70;
            let tarifaNum = typeof rawTarifa === 'number' ? rawTarifa : parseFloat(String(rawTarifa).replace(',', '.'));
            if (Number.isNaN(tarifaNum) || !Number.isFinite(tarifaNum)) tarifaNum = 37.70;
            const tarifa = tarifaNum;
            const tarifaDiaria = tarifa / 30;
            const diasEnMes = getDaysInMonth(mes, year);
            const diasBase = Math.min(diasEnMes, 30); // Base de cálculo: 30 días

            let fechaInstalacion = null;
            let fechaDesmontaje = null;
            let diasFacturables = diasBase;
            let tipo = 'completo';

            // Detectar fecha de instalación
            if (panel.fechaInstalacion && panel.fechaInstalacion !== null) {
                fechaInstalacion = new Date(panel.fechaInstalacion);
            }

            // Detectar fecha de desmontaje
            if (panel.fechaDesmontaje && panel.fechaDesmontaje !== null) {
                fechaDesmontaje = new Date(panel.fechaDesmontaje);
            }

            // Caso 1: Panel instalado en este mes
            if (fechaInstalacion && 
                fechaInstalacion.getMonth() + 1 === mes && 
                fechaInstalacion.getFullYear() === year) {
                const diaInstalacion = fechaInstalacion.getDate();
                diasFacturables = diasBase - diaInstalacion + 1;
                tipo = 'parcial_instalacion';
            }

            // Caso 2: Panel desmontado en este mes
            if (fechaDesmontaje && 
                fechaDesmontaje.getMonth() + 1 === mes && 
                fechaDesmontaje.getFullYear() === year) {
                const diaDesmontaje = fechaDesmontaje.getDate();
                
                // Si también se instaló este mes, calcular días entre ambas fechas
                if (tipo === 'parcial_instalacion') {
                    const diaInstalacion = fechaInstalacion.getDate();
                    diasFacturables = diaDesmontaje - diaInstalacion + 1;
                    tipo = 'parcial_instalacion_desmontaje';
                } else {
                    diasFacturables = diaDesmontaje;
                    tipo = 'parcial_desmontaje';
                }
            }

            // Caso 3: Panel no instalado aún en este mes
            if (fechaInstalacion && 
                (fechaInstalacion.getFullYear() > year || 
                 (fechaInstalacion.getFullYear() === year && fechaInstalacion.getMonth() + 1 > mes))) {
                diasFacturables = 0;
                tipo = 'inactivo';
            }

            // Caso 4: Panel ya desmontado antes de este mes
            if (fechaDesmontaje && 
                (fechaDesmontaje.getFullYear() < year || 
                 (fechaDesmontaje.getFullYear() === year && fechaDesmontaje.getMonth() + 1 < mes))) {
                diasFacturables = 0;
                tipo = 'inactivo';
            }

            // NUEVO: Si no hay fechas (null), asumir que está activo todo el mes
            if (!fechaInstalacion && !fechaDesmontaje) {
                diasFacturables = diasBase;
                tipo = 'completo';
            }

            const importe = diasFacturables * tarifaDiaria;

            return {
                dias: diasFacturables,
                importe: parseFloat(importe.toFixed(2)),
                tipo: tipo,
                tarifaDiaria: parseFloat(tarifaDiaria.toFixed(4)),
                desde: fechaInstalacion ? fechaInstalacion.toLocaleDateString('es-ES') : null,
                hasta: fechaDesmontaje ? fechaDesmontaje.toLocaleDateString('es-ES') : null
            };
        }

        // Calcular días del mes
        function getDaysInMonth(month, year) {
            return new Date(year, month, 0).getDate();
        }

        // ===== UTILIDADES PARA PANEL PICKER =====
        
        // Normalizar texto para búsqueda sin tildes ni mayúsculas
        function normalizeString(str) {
            if (!str) return '';
            return str.toLowerCase()
                     .normalize('NFD')
                     .replace(/[\u0300-\u036f]/g, ''); // Eliminar diacríticos
        }

        // Obtener paneles únicos y ordenados para el picker
        function getPanelsForPicker() {
            if (!panelsData || panelsData.length === 0) return [];
            
            // Eliminar duplicados por código
            const uniquePanels = panelsData.filter((panel, index, self) => 
                self.findIndex(p => p.codigo === panel.codigo) === index
            );
            
            // Ordenar por municipio y luego por código
            return uniquePanels.sort((a, b) => {
                const municipioCompare = a.municipio.localeCompare(b.municipio, 'es');
                if (municipioCompare !== 0) return municipioCompare;
                return a.codigo.localeCompare(b.codigo, undefined, { numeric: true });
            });
        }

        // ===== COMPONENTE PANEL PICKER =====
        
        let panelPickerInstances = {};
        
        function createPanelPicker(containerId, options = {}) {
            const {
                onChange = () => {},
                onClear = () => {},
                placeholder = "Buscar por código o municipio...",
                required = true,
                preselectedId = null
            } = options;

            const container = document.getElementById(containerId);
            if (!container) return null;

            // Estado del picker
            const state = {
                isOpen: false,
                selectedPanel: null,
                filteredPanels: [],
                highlightedIndex: -1,
                searchTerm: ''
            };

            // HTML del componente
            container.innerHTML = `
                <div class="panel-picker" role="combobox" aria-expanded="false" aria-haspopup="listbox">
                    <div class="panel-picker-input-container">
                        <input 
                            type="text" 
                            class="panel-picker-input" 
                            placeholder="${placeholder}"
                            autocomplete="off"
                            aria-autocomplete="list"
                            aria-label="Buscar panel"
                            ${required ? 'required' : ''}
                        />
                        <button type="button" class="panel-picker-clear" style="display: none;" aria-label="Limpiar selección">
                            <span>&times;</span>
                        </button>
                    </div>
                    <div class="panel-picker-dropdown" role="listbox" style="display: none;">
                        <div class="panel-picker-loading">Cargando paneles...</div>
                        <div class="panel-picker-no-results" style="display: none;">Sin resultados</div>
                        <div class="panel-picker-list"></div>
                    </div>
                    <div class="panel-picker-selected" style="display: none;">
                        <small>Panel seleccionado:</small>
                        <div class="panel-picker-selected-info"></div>
                    </div>
                </div>
            `;

            // Referencias a elementos
            const picker = container.querySelector('.panel-picker');
            const input = container.querySelector('.panel-picker-input');
            const clearBtn = container.querySelector('.panel-picker-clear');
            const dropdown = container.querySelector('.panel-picker-dropdown');
            const loading = container.querySelector('.panel-picker-loading');
            const noResults = container.querySelector('.panel-picker-no-results');
            const list = container.querySelector('.panel-picker-list');
            const selectedDiv = container.querySelector('.panel-picker-selected');
            const selectedInfo = container.querySelector('.panel-picker-selected-info');

            // Funciones internas
            function updateDropdown() {
                const panels = getPanelsForPicker();
                
                if (panels.length === 0) {
                    loading.style.display = 'block';
                    noResults.style.display = 'none';
                    list.innerHTML = '';
                    return;
                }

                loading.style.display = 'none';
                
                // Filtrar paneles
                const searchNormalized = normalizeString(state.searchTerm);
                state.filteredPanels = panels.filter(panel => {
                    const codigoNormalized = normalizeString(panel.codigo);
                    const municipioNormalized = normalizeString(panel.municipio);
                    return codigoNormalized.includes(searchNormalized) || 
                           municipioNormalized.includes(searchNormalized);
                });

                if (state.filteredPanels.length === 0) {
                    noResults.style.display = 'block';
                    list.innerHTML = '';
                } else {
                    noResults.style.display = 'none';
                    renderList();
                }
            }

            function renderList() {
                list.innerHTML = '';
                
                state.filteredPanels.forEach((panel, index) => {
                    const option = document.createElement('div');
                    option.className = 'panel-picker-option';
                    option.setAttribute('role', 'option');
                    option.setAttribute('aria-selected', 'false');
                    option.textContent = `${panel.codigo} — ${panel.municipio}`;
                    option.dataset.index = index;
                    
                    if (index === state.highlightedIndex) {
                        option.classList.add('highlighted');
                        option.setAttribute('aria-selected', 'true');
                    }
                    
                    option.addEventListener('click', () => selectPanel(panel));
                    list.appendChild(option);
                });
            }

            function selectPanel(panel) {
                state.selectedPanel = panel;
                input.value = `${panel.codigo} — ${panel.municipio}`;
                clearBtn.style.display = 'block';
                selectedDiv.style.display = 'block';
                selectedInfo.textContent = `${panel.codigo} — ${panel.municipio}`;
                closeDropdown();
                onChange(panel);
            }

            function clearSelection() {
                state.selectedPanel = null;
                input.value = '';
                clearBtn.style.display = 'none';
                selectedDiv.style.display = 'none';
                state.searchTerm = '';
                onClear();
            }

            function openDropdown() {
                state.isOpen = true;
                dropdown.style.display = 'block';
                picker.setAttribute('aria-expanded', 'true');
                updateDropdown();
            }

            function closeDropdown() {
                state.isOpen = false;
                dropdown.style.display = 'none';
                picker.setAttribute('aria-expanded', 'false');
                state.highlightedIndex = -1;
            }

            function navigateList(direction) {
                if (state.filteredPanels.length === 0) return;
                
                if (direction === 'up') {
                    state.highlightedIndex = state.highlightedIndex <= 0 
                        ? state.filteredPanels.length - 1 
                        : state.highlightedIndex - 1;
                } else {
                    state.highlightedIndex = state.highlightedIndex >= state.filteredPanels.length - 1 
                        ? 0 
                        : state.highlightedIndex + 1;
                }
                
                renderList();
                
                // Scroll automático
                const highlighted = list.querySelector('.highlighted');
                if (highlighted) {
                    highlighted.scrollIntoView({ block: 'nearest' });
                }
            }

            // Event listeners
            input.addEventListener('input', (e) => {
                state.searchTerm = e.target.value;
                state.highlightedIndex = -1;
                if (!state.isOpen) openDropdown();
                updateDropdown();
            });

            input.addEventListener('focus', () => {
                if (!state.isOpen) openDropdown();
            });

            input.addEventListener('keydown', (e) => {
                switch (e.key) {
                    case 'ArrowDown':
                        e.preventDefault();
                        if (!state.isOpen) openDropdown();
                        else navigateList('down');
                        break;
                    case 'ArrowUp':
                        e.preventDefault();
                        navigateList('up');
                        break;
                    case 'Enter':
                        e.preventDefault();
                        if (state.isOpen && state.highlightedIndex >= 0) {
                            selectPanel(state.filteredPanels[state.highlightedIndex]);
                        }
                        break;
                    case 'Escape':
                        e.preventDefault();
                        closeDropdown();
                        break;
                }
            });

            clearBtn.addEventListener('click', clearSelection);

            // Cerrar al hacer click fuera
            document.addEventListener('click', (e) => {
                if (!picker.contains(e.target)) {
                    closeDropdown();
                }
            });

            // Preselección si se proporciona
            if (preselectedId) {
                const panels = getPanelsForPicker();
                const preselected = panels.find(p => p.codigo === preselectedId);
                if (preselected) {
                    selectPanel(preselected);
                }
            }

            // API pública
            const api = {
                getValue: () => state.selectedPanel,
                setValue: (panelId) => {
                    const panels = getPanelsForPicker();
                    const panel = panels.find(p => p.codigo === panelId);
                    if (panel) selectPanel(panel);
                },
                clear: clearSelection,
                isValid: () => required ? !!state.selectedPanel : true
            };

            panelPickerInstances[containerId] = api;
            return api;
        }

        // Función para obtener instancia del picker
        function getPanelPicker(containerId) {
            return panelPickerInstances[containerId];
        }

        // ===== FIN PANEL PICKER =====

        // ===== CÁLCULOS DE FACTURACIÓN AJUSTADA =====

        // Función centralizada para calcular facturación ajustada según reglas de negocio
        function calcularFacturacionAjustada(fechaAlta, fechaDesmontaje, tarifaBaseMes = 37.70) {
            // Constantes
            const DIAS_BASE_MES = 30;
            const tarifaDiaria = tarifaBaseMes / DIAS_BASE_MES;
            
            let diasActivos = 0;
            let descripcion = '';
            
            // Parsear fechas si son strings
            const alta = fechaAlta ? new Date(fechaAlta) : null;
            const desmontaje = fechaDesmontaje ? new Date(fechaDesmontaje) : null;
            
            if (alta && desmontaje) {
                // Caso: ALTA y DESMONTAJE en el mismo mes
                const diaAlta = alta.getDate();
                const diaDesmontaje = desmontaje.getDate();
                diasActivos = Math.max(0, Math.min(30, diaDesmontaje - diaAlta + 1));
                descripcion = `Alta día ${diaAlta}, desmontaje día ${diaDesmontaje}`;
                
            } else if (desmontaje) {
                // Caso: Solo DESMONTAJE
                const diaDesmontaje = desmontaje.getDate();
                diasActivos = Math.min(30, diaDesmontaje);
                descripcion = `Desmontaje día ${diaDesmontaje}`;
                
            } else if (alta) {
                // Caso: Solo ALTA
                const diaAlta = alta.getDate();
                diasActivos = Math.max(0, 30 - diaAlta + 1);
                descripcion = `Alta día ${diaAlta}`;
                
            } else {
                // Caso: Mes completo
                diasActivos = 30;
                descripcion = 'Mes completo';
            }
            
            // Cálculos finales
            const facturacionAjustada = Math.round(tarifaDiaria * diasActivos * 100) / 100; // Redondeo bancario
            const facturacionCompleta = tarifaBaseMes;
            const ahorro = Math.round((facturacionCompleta - facturacionAjustada) * 100) / 100;
            
            // Limitar resultados: 0 ≤ facturación_ajustada ≤ tarifa_base_mes
            const facturacionFinal = Math.max(0, Math.min(tarifaBaseMes, facturacionAjustada));
            const ahorroFinal = Math.max(0, facturacionCompleta - facturacionFinal);
            
            return {
                diasActivos,
                facturacionCompleta,
                facturacionAjustada: facturacionFinal,
                ahorro: ahorroFinal,
                tarifaDiaria,
                descripcion
            };
        }

        // Formatear importe en euros según estándar español
        function formatearImporteEuro(cantidad) {
            return cantidad.toLocaleString('es-ES', {
                style: 'currency',
                currency: 'EUR',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }

        // Sistema de notificaciones Toast
        function showToast(message, type = 'info', duration = 5000) {
            // Crear contenedor de toasts si no existe
            let toastContainer = document.getElementById('toastContainer');
            if (!toastContainer) {
                toastContainer = document.createElement('div');
                toastContainer.id = 'toastContainer';
                toastContainer.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    z-index: 10000;
                    display: flex;
                    flex-direction: column;
                    gap: 10px;
                `;
                document.body.appendChild(toastContainer);
            }

            // Crear elemento toast
            const toast = document.createElement('div');
            toast.style.cssText = `
                background: ${type === 'success' ? '#16a34a' : type === 'error' ? '#dc2626' : type === 'warning' ? '#d97706' : '#2563eb'};
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                max-width: 400px;
                font-size: 14px;
                font-weight: 500;
                white-space: pre-line;
                opacity: 0;
                transform: translateX(100%);
                transition: all 0.3s ease;
            `;
            
            toast.textContent = message;
            toastContainer.appendChild(toast);

            // Animar entrada
            setTimeout(() => {
                toast.style.opacity = '1';
                toast.style.transform = 'translateX(0)';
            }, 10);

            // Animar salida y remover
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }, duration);

            return toast;
        }

        // Función de test para verificar cálculos
        function testCalculosFacturacion() {
            console.log('🧪 TESTS DE FACTURACIÓN AJUSTADA');
            console.log('Base: 37,70 € → Tarifa diaria: 1,256666...');
            
            const tests = [
                { desc: 'Solo DESMONTAJE 04/11/2025', alta: null, desmontaje: '2025-11-04', esperado: { dias: 4, ajustada: 5.03, ahorro: 32.67 } },
                { desc: 'Solo DESMONTAJE 30/11/2025', alta: null, desmontaje: '2025-11-30', esperado: { dias: 30, ajustada: 37.70, ahorro: 0.00 } },
                { desc: 'Solo ALTA 10/11/2025', alta: '2025-11-10', desmontaje: null, esperado: { dias: 21, ajustada: 26.39, ahorro: 11.31 } },
                { desc: 'ALTA 05/11 y DESMONTAJE 12/11', alta: '2025-11-05', desmontaje: '2025-11-12', esperado: { dias: 8, ajustada: 10.05, ahorro: 27.65 } }
            ];
            
            tests.forEach(test => {
                const resultado = calcularFacturacionAjustada(test.alta, test.desmontaje);
                console.log(`📋 ${test.desc}`);
                console.log(`   Días activos: ${resultado.diasActivos} (esperado: ${test.esperado.dias})`);
                console.log(`   Facturación ajustada: ${formatearImporteEuro(resultado.facturacionAjustada)} (esperado: ${test.esperado.ajustada} €)`);
                console.log(`   Ahorro: ${formatearImporteEuro(resultado.ahorro)} (esperado: ${test.esperado.ahorro} €)`);
                console.log('---');
            });
        }

        // Exponer función de test globalmente
        window.testCalculosFacturacion = testCalculosFacturacion;

        // ===== FIN CÁLCULOS DE FACTURACIÓN =====

        // Calcular Facturación (funciñn legacy - se mantiene por compatibilidad)
        function calculateBilling(days) {
            const baseRate = parseFloat(document.getElementById('baseRate').value);
            const dailyRate = baseRate / 30;
            return (days * dailyRate).toFixed(2);
        }

        // Calcular días facturables (funciñn legacy - se mantiene por compatibilidad)
        function calculateDays(panel, month, year) {
            const facturacion = calcularFacturacion(panel, month, year);
            return facturacion.dias;
        }

        // Formatear números al formato español (16.851,90 €)
        function formatEuro(amount) {
            if (amount === null || amount === undefined || isNaN(amount)) {
                return '0,00 €';
            }
            
            const numero = parseFloat(amount);
            return numero.toLocaleString('es-ES', {
                style: 'currency',
                currency: 'EUR',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }

        // Actualizar tabla
        async function updateTable() {
            const month = parseInt(document.getElementById('currentMonth').value);
            const year = parseInt(document.getElementById('currentYear').value);
            const monthKey = `${year}-${String(month).padStart(2, '0')}`;
            const searchInput = document.getElementById('searchInput');
            const searchTerm = searchInput ? searchInput.value.toUpperCase() : '';
            const panelsList = document.getElementById('panelsList');
            panelsList.innerHTML = '';

            console.log(`📋 Cargando datos de facturación desde panel_month_billing para ${monthKey}...`);
            console.log(`📦 panelsData tiene ${panelsData.length} paneles`);

            let totalRevenue = 0;
            let partialCount = 0;
            const municipios = new Set();

            // Cargar datos del mes actual
            const billingData = new Map();
            
            try {
                const billingSnapshot = await firebaseDB.collection('panel_month_billing')
                    .where('monthKey', '==', monthKey)
                    .get();
                
                billingSnapshot.forEach(doc => {
                    const data = doc.data();
                    billingData.set(data.panelId, {
                        dias: data.totalDiasFacturables || 0,
                        importe: data.totalImporte || 0,
                        acciones: data.acciones || {}
                    });
                });
                
                console.log(`✅ Cargados ${billingData.size} paneles del mes actual`);
                
                // Si hay pocos registros, buscar mes base para heredar
                const UMBRAL = 400;
                if (billingData.size < UMBRAL) {
                    console.log(`🔄 Solo ${billingData.size} registros en ${monthKey}, buscando mes base...`);
                    
                    // Buscar recursivamente hacia atrás
                    let buscarMes = monthKey;
                    for (let i = 1; i <= 12; i++) {
                        const [y, m] = buscarMes.split('-').map(Number);
                        const mesAnt = m === 1 ? 12 : m - 1;
                        const yearAnt = m === 1 ? y - 1 : y;
                        buscarMes = `${yearAnt}-${String(mesAnt).padStart(2, '0')}`;
                        
                        console.log(`   Buscando en ${buscarMes}...`);
                        
                        const baseSnap = await firebaseDB.collection('panel_month_billing')
                            .where('monthKey', '==', buscarMes)
                            .get();
                        
                        console.log(`   ${buscarMes}: ${baseSnap.size} registros encontrados`);
                        
                        if (baseSnap.size >= UMBRAL) {
                            console.log(`✅ Base encontrada: ${buscarMes} con ${baseSnap.size} registros`);
                            let heredados = 0;
                            // Copiar datos de la base para paneles SIN eventos en mes actual
                            baseSnap.forEach(doc => {
                                const data = doc.data();
                                const panelIdBase = String(data.panelId).trim();
                                if (!billingData.has(panelIdBase)) {
                                    billingData.set(panelIdBase, {
                                        dias: data.totalDiasFacturables || 0,
                                        importe: data.totalImporte || 0,
                                        heredado: true
                                    });
                                    heredados++;
                                }
                            });
                            console.log(`   ✅ ${heredados} paneles heredados de ${buscarMes}`);
                            console.log(`   📊 Total en billingData: ${billingData.size} paneles`);
                            break;
                        }
                    }
                }
                
            } catch (error) {
                console.error('❌ Error cargando facturación:', error);
            }

            // Procesar cada panel
            for (const panel of panelsData) {
                // Filtrar por Búsqueda
                const matchSearch = !searchTerm || 
                    panel.municipio.toUpperCase().includes(searchTerm) ||
                    panel.codigo.toUpperCase().includes(searchTerm);

                if (!matchSearch) continue;

                municipios.add(panel.municipio);

                // Obtener datos del panel (del mes actual o heredado de la base)
                const panelIdStr = String(panel.codigo).trim();
                const billing = billingData.get(panelIdStr);
                
                let days = 0;
                let importeFacturado = 0;
                
                if (billing) {
                    days = billing.dias;
                    importeFacturado = billing.importe;
                }
                // Si no hay billing, queda en 0 (panel no instalado aún)

                totalRevenue += importeFacturado;
                if (days > 0 && days < 30) partialCount++;

                // Determinar estado desde effectiveState en Firestore
                let estadoBadge = '';
                let estadoClass = '';
                
                if (days === 0) {
                    estadoBadge = 'Sin Facturación';
                    estadoClass = 'minimal-badge-gray';
                } else if (days < 30) {
                    estadoBadge = 'Parcial';
                    estadoClass = 'minimal-badge-orange';
                } else {
                    estadoBadge = 'Completo';
                    estadoClass = 'minimal-badge-green';
                }

                const listItem = document.createElement('div');
                listItem.className = 'minimal-list-item fade-in';
                listItem.innerHTML = `
                    <div class="minimal-list-item-info">
                        <div class="minimal-list-item-main">
                            <span class="minimal-list-item-municipio">${panel.municipio}</span>
                            <span class="minimal-list-item-separator"></span>
                            <span class="minimal-list-item-codigo">${panel.codigo}</span>
                        </div>
                        <div class="minimal-list-item-meta">
                            <div class="minimal-list-item-stat">
                                <span class="minimal-list-item-stat-label">Días</span>
                                <span class="minimal-list-item-stat-value">${days}</span>
                            </div>
                            <div class="minimal-list-item-stat">
                                <span class="minimal-list-item-stat-label">Facturación</span>
                                <span class="minimal-list-item-stat-value">${formatEuro(importeFacturado)}</span>
                            </div>
                        </div>
                    </div>
                    <div class="minimal-list-item-actions">
                        <span class="minimal-list-item-badge ${estadoClass}">${estadoBadge}</span>
                        <button class="minimal-btn-secondary btn-small" onclick="verEventosPanel('${panelIdStr}', '${panel.municipio}')" style="margin-left: 12px;">
                            Ver eventos
                        </button>
                    </div>
                `;
                panelsList.appendChild(listItem);
            }

            // Actualizar estadísticas
            const totalPanelsEl = document.getElementById('totalPanels');
            const totalRevenueEl = document.getElementById('totalRevenue');
            const totalMunicipiosEl = document.getElementById('totalMunicipios');
            const partialPanelsEl = document.getElementById('partialPanels');
            
            if (totalPanelsEl) totalPanelsEl.textContent = panelsData.length;
            if (totalRevenueEl) totalRevenueEl.textContent = formatEuro(totalRevenue);
            if (totalMunicipiosEl) totalMunicipiosEl.textContent = municipios.size;
            if (partialPanelsEl) partialPanelsEl.textContent = partialCount;

            console.log(`📊 Tabla actualizada: ${panelsData.length} paneles, ${billingData.size} con facturación, Total: ${formatEuro(totalRevenue)}`);

            // Actualizar estadísticas VestaCP
            await actualizarEstadisticas();
            actualizarBadges();
            
            // Asegurar que los filtros estén poblados
            populateFilters();
        }

        // Filtrar tabla
        function filterTable() {
            applyFilters(); // Redirigir a la nueva función
        }

        // Nueva función para aplicar múltiples filtros
        async function applyFilters() {
            const month = parseInt(document.getElementById('currentMonth').value);
            const year = parseInt(document.getElementById('currentYear').value);
            const monthKey = `${year}-${String(month).padStart(2, '0')}`;
            
            // Obtener valores de filtros
            const searchTerm = document.getElementById('searchInput').value.toUpperCase();
            const filterMunicipio = document.getElementById('filterMunicipio').value;
            const filterEstado = document.getElementById('filterEstado').value;
            const filterFacturacion = document.getElementById('filterFacturacion').value;
            
            const panelsList = document.getElementById('panelsList');
            panelsList.innerHTML = '';

            console.log(`📋 Aplicando filtros para ${monthKey}...`);

            let totalRevenue = 0;
            let partialCount = 0;
            let filteredCount = 0;
            const municipios = new Set();

            // Cargar datos de facturación desde Firestore
            const billingData = new Map();
            
            try {
                const billingSnapshot = await firebaseDB.collection('panel_month_billing')
                    .where('monthKey', '==', monthKey)
                    .get();
                
                billingSnapshot.forEach(doc => {
                    const data = doc.data();
                    billingData.set(data.panelId, {
                        dias: data.totalDiasFacturables || 0,
                        importe: data.totalImporte || 0,
                        acciones: data.acciones || {}
                    });
                });
                
                console.log(`✅ Cargados ${billingData.size} paneles con facturación para filtrado`);
            } catch (error) {
                console.error('❌ Error cargando datos de facturación:', error);
            }

            for (const panel of panelsData) {
                const panelIdStr = String(panel.codigo).trim();
                const billing = billingData.get(panelIdStr);
                
                let days = 0;
                let importeFacturado = 0;
                
                if (billing) {
                    days = billing.dias;
                    importeFacturado = billing.importe;
                } else {
                    days = 0;
                    importeFacturado = 0;
                }
                
                // Determinar estado del panel
                let estado = '';
                if (days === 0) {
                    estado = 'sin_facturar';
                } else if (days < 30) {
                    estado = 'parcial';
                } else {
                    estado = 'completo';
                }
                
                // Aplicar filtros
                let shouldShow = true;
                
                // Filtro de búsqueda
                if (searchTerm && !panel.municipio.toUpperCase().includes(searchTerm) && !panel.codigo.toUpperCase().includes(searchTerm)) {
                    shouldShow = false;
                }
                
                // Filtro de municipio
                if (filterMunicipio && panel.municipio !== filterMunicipio) {
                    shouldShow = false;
                }
                
                // Filtro de estado
                if (filterEstado && estado !== filterEstado) {
                    shouldShow = false;
                }
                
                // Filtro de facturación
                if (filterFacturacion) {
                    if (filterFacturacion === 'completa' && days < 30) shouldShow = false;
                    if (filterFacturacion === 'parcial' && (days >= 30 || days === 0)) shouldShow = false;
                    if (filterFacturacion === 'sin_facturar' && days > 0) shouldShow = false;
                }
                
                if (!shouldShow) continue;
                
                // Contar para estadísticas
                filteredCount++;
                totalRevenue += importeFacturado;
                municipios.add(panel.municipio);
                if (days > 0 && days < 30) partialCount++;

                // Determinar badge
                let estadoBadge = '';
                let estadoClass = '';
                
                if (days === 0) {
                    estadoBadge = 'Sin Facturación';
                    estadoClass = 'minimal-badge-gray';
                } else if (days < 30) {
                    estadoBadge = 'Parcial';
                    estadoClass = 'minimal-badge-orange';
                } else {
                    estadoBadge = 'Completo';
                    estadoClass = 'minimal-badge-green';
                }

                const listItem = document.createElement('div');
                listItem.className = 'minimal-list-item fade-in';
                listItem.innerHTML = `
                    <div class="minimal-list-item-info">
                        <div class="minimal-list-item-main">
                            <span class="minimal-list-item-municipio">${panel.municipio}</span>
                            <span class="minimal-list-item-separator">•</span>
                            <span class="minimal-list-item-codigo">${panel.codigo}</span>
                        </div>
                        <div class="minimal-list-item-meta">
                            <div class="minimal-list-item-stat">
                                <span class="minimal-list-item-stat-label">Días</span>
                                <span class="minimal-list-item-stat-value">${days}</span>
                            </div>
                            <div class="minimal-list-item-stat">
                                <span class="minimal-list-item-stat-label">Facturación</span>
                                <span class="minimal-list-item-stat-value">${formatEuro(importeFacturado)}</span>
                            </div>
                        </div>
                    </div>
                    <div class="minimal-list-item-actions">
                        <span class="minimal-list-item-badge ${estadoClass}">${estadoBadge}</span>
                    </div>
                `;
                panelsList.appendChild(listItem);
            }

            // Actualizar contador de resultados
            const resultsCount = document.getElementById('resultsCount');
            if (resultsCount) {
                resultsCount.textContent = `${filteredCount} de ${panelsData.length} paneles`;
            }

            // Actualizar estadísticas (solo las de la tabla inferior, no las principales)
            const totalPanelsEl = document.getElementById('totalPanels');
            const totalRevenueEl = document.getElementById('totalRevenue');
            const totalMunicipiosEl = document.getElementById('totalMunicipios');
            const partialPanelsEl = document.getElementById('partialPanels');
            
            if (totalPanelsEl) totalPanelsEl.textContent = panelsData.length;
            if (totalRevenueEl) totalRevenueEl.textContent = formatEuro(totalRevenue);
            if (totalMunicipiosEl) totalMunicipiosEl.textContent = municipios.size;
            if (partialPanelsEl) partialPanelsEl.textContent = partialCount;

            console.log(`📊 Filtros aplicados: ${filteredCount} paneles mostrados, Total: ${formatEuro(totalRevenue)}`);

            // Las estadísticas principales no cambian con los filtros
            await actualizarEstadisticas();
            actualizarBadges();
        }

        // Limpiar todos los filtros
        function clearFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('filterMunicipio').value = '';
            document.getElementById('filterEstado').value = '';
            document.getElementById('filterFacturacion').value = '';
            applyFilters();
        }

        // Poblar lista de municipios en el filtro
        function populateFilters() {
            console.log('🏛️ populateFilters() iniciando...');
            
            // Verificar que hay datos disponibles
            if (!panelsData || panelsData.length === 0) {
                console.warn('⚠️ populateFilters: No hay datos disponibles aún', {
                    panelsData: !!panelsData,
                    length: panelsData ? panelsData.length : 'undefined'
                });
                return;
            }

            console.log('📊 panelsData disponible:', panelsData.length, 'paneles');

            const municipios = [...new Set(panelsData.map(p => p.municipio))].filter(m => m).sort();
            console.log('🏘️ Municipios únicos encontrados:', municipios.length, municipios);
            
            const filterMunicipio = document.getElementById('filterMunicipio');
            console.log('🎯 Elemento filterMunicipio:', !!filterMunicipio);
            
            if (!filterMunicipio) {
                console.error('❌ No se encontró el elemento filterMunicipio');
                // Intentar de nuevo después de un breve retraso
                setTimeout(() => {
                    console.log('🔄 Reintentando populateFilters después de 1 segundo...');
                    populateFilters();
                }, 1000);
                return;
            }
            
            // Limpiar opciones existentes (excepto la primera)
            filterMunicipio.innerHTML = '<option value="">Todos los municipios</option>';
            console.log('🗑️ Select limpiado, opciones actuales:', filterMunicipio.options.length);
            
            municipios.forEach((municipio, index) => {
                const option = document.createElement('option');
                option.value = municipio;
                option.textContent = municipio;
                filterMunicipio.appendChild(option);
                if (index < 5) { // Solo loguear los primeros 5 para no saturar
                    console.log(`➕ Agregando municipio ${index + 1}:`, municipio);
                }
            });
            
            console.log(`✅ Filtro de municipios poblado con ${municipios.length} municipios. Total opciones:`, filterMunicipio.options.length);
        }

        // Modales
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function addPanel() {
            openModal('addPanelModal');
        }

        function removePanel() {
            openModal('removePanelModal');
        }

        function dismountPanel() {
            openModal('dismountPanelModal');
        }

        function saveNewPanel() {
            const municipio = document.getElementById('newMunicipio').value.trim();
            const codigo = document.getElementById('newCodigo').value.trim();
            const fecha = document.getElementById('newFechaInstalacion').value;

            if (!municipio || !codigo) {
                alert('Por favor completa todos los campos');
                return;
            }

            panelsData.push({
                municipio: municipio,
                codigo: codigo,
                fechaInstalacion: fecha || null,
                fechaDesmontaje: null
            });

            saveData();
            updateTable();
            closeModal('addPanelModal');
            
            // Limpiar formulario
            document.getElementById('newMunicipio').value = '';
            document.getElementById('newCodigo').value = '';
            document.getElementById('newFechaInstalacion').value = '';
        }

        function confirmRemovePanel() {
            const codigo = document.getElementById('removeCodigo').value.trim();
            const index = panelsData.findIndex(p => p.codigo === codigo);

            if (index === -1) {
                alert('Panel no encontrado');
                return;
            }

            if (confirm(`Eliminar panel ${codigo}?`)) {
                panelsData.splice(index, 1);
                saveData();
                updateTable();
                closeModal('removePanelModal');
                document.getElementById('removeCodigo').value = '';
            }
        }

        function confirmDismountPanel() {
            const codigo = document.getElementById('dismountCodigo').value.trim();
            const fecha = document.getElementById('dismountFecha').value;
            const index = panelsData.findIndex(p => p.codigo === codigo);

            if (index === -1) {
                alert('Panel no encontrado');
                return;
            }

            if (!fecha) {
                alert('Por favor indica la fecha de desmontaje');
                return;
            }

            panelsData[index].fechaDesmontaje = fecha;
            saveData();
            updateTable();
            closeModal('dismountPanelModal');
            
            document.getElementById('dismountCodigo').value = '';
            document.getElementById('dismountFecha').value = '';
        }

        function deletePanel(index) {
            if (confirm('Eliminar este panel?')) {
                panelsData.splice(index, 1);
                saveData();
                updateTable();
            }
        }

        // Regenerar facturación del mes actual visualizado
        async function regenerarFacturacionMesActual(evt) {
            try {
                const month = document.getElementById('currentMonth').value;
                const year = document.getElementById('currentYear').value;
                const monthName = getMonthName(month);
                
                const confirmacion = confirm(
                    `♻️ REGENERAR FACTURACIÓN\n\n` +
                    `Mes: ${monthName} ${year}\n\n` +
                    `Esta acción copiará los datos del mes anterior sin recalcular fechas.\n\n` +
                    `Esto es útil cuando:\n` +
                    `• No hay eventos nuevos en este mes\n` +
                    `• Quieres mantener los mismos valores del mes anterior\n` +
                    `• Has eliminado eventos incorrectos\n\n` +
                    `¿Continuar?`
                );
                
                if (!confirmacion) return;
                
                // Mostrar indicador de carga
                const btnElement = evt ? evt.target : null;
                const originalText = btnElement ? btnElement.textContent : '';
                if (btnElement) {
                    btnElement.textContent = '⏳ Regenerando...';
                    btnElement.disabled = true;
                }
                
                console.log(`🔄 Regenerando facturación para ${month}/${year}...`);
                
                // Ejecutar regeneración con modo "copiar del mes anterior"
                const resultado = await regenerarFacturacionCompleta(month, year, true);
                
                // Recargar datos
                await updateTable();
                await actualizarEstadisticas();
                
                // Restaurar botón
                if (btnElement) {
                    btnElement.textContent = originalText;
                    btnElement.disabled = false;
                }
                
                alert(
                    `✅ FACTURACIÓN REGENERADA\n\n` +
                    `Mes: ${monthName} ${year}\n` +
                    `Paneles: ${resultado.totalPaneles}\n` +
                    `Total: ${resultado.totalImporte.toFixed(2)} €\n\n` +
                    `La página se recargará para mostrar los cambios.`
                );
                
                // Recargar página
                location.reload();
                
            } catch (error) {
                console.error('❌ Error regenerando facturación:', error);
                alert(`❌ Error al regenerar:\n\n${error.message}`);
                
                // Restaurar botón en caso de error
                if (btnElement) {
                    btnElement.textContent = '♻️ Regenerar facturación';
                    btnElement.disabled = false;
                }
            }
        }

        // Exportar a Excel
        function exportData() {
            const month = document.getElementById('currentMonth').value;
            const year = document.getElementById('currentYear').value;
            const monthName = getMonthName(month);
            
            // Crear los datos para Excel
            const data = [];
            
            // Encabezados
            data.push(['Municipio', 'Código Parada', 'Días', 'Facturación']);
            
            // Datos de paneles
            panelsData.forEach(panel => {
                const days = calculateDays(panel, parseInt(month), parseInt(year));
                const billing = parseFloat(calculateBilling(days));
                data.push([
                    panel.municipio,
                    panel.codigo,
                    days,
                    billing
                ]);
            });

            // Crear un nuevo workbook
            const wb = XLSX.utils.book_new();
            
            // Crear worksheet a partir de los datos
            const ws = XLSX.utils.aoa_to_sheet(data);
            
            // Aplicar formato a los encabezados (primera fila)
            const headerStyle = {
                font: { bold: true },
                fill: { fgColor: { rgb: "D3D3D3" } }, // Gris claro
                alignment: { horizontal: "center" }
            };
            
            // Aplicar estilo a la primera fila (encabezados)
            ['A1', 'B1', 'C1', 'D1'].forEach(cell => {
                if (!ws[cell]) ws[cell] = {};
                ws[cell].s = headerStyle;
            });
            
            // Ajustar ancho de columnas automáticamente
            const colWidths = [];
            data.forEach(row => {
                row.forEach((cell, i) => {
                    const cellLength = cell ? cell.toString().length : 0;
                    if (!colWidths[i] || colWidths[i] < cellLength) {
                        colWidths[i] = cellLength;
                    }
                });
            });
            
            // Establecer ancho de columnas (con un mínimo de 10 y máximo de 50)
            ws['!cols'] = colWidths.map(width => ({
                wch: Math.max(10, Math.min(50, width + 2))
            }));
            
            // Formato para columna de facturación (números con 2 decimales)
            const range = XLSX.utils.decode_range(ws['!ref']);
            for (let row = 1; row <= range.e.r; row++) {
                const cellAddress = XLSX.utils.encode_cell({ r: row, c: 3 }); // Columna D (Facturación)
                if (ws[cellAddress] && typeof ws[cellAddress].v === 'number') {
                    if (!ws[cellAddress].s) ws[cellAddress].s = {};
                    ws[cellAddress].s.numFmt = '#,##0.00';
                }
            }
            
            // Agregar worksheet al workbook
            XLSX.utils.book_append_sheet(wb, ws, `Paneles ${monthName} ${year}`);
            
            // Generar nombre de archivo
            const fileName = `paneles_${monthName.toLowerCase()}_${year}.xlsx`;
            
            // Descargar el archivo
            XLSX.writeFile(wb, fileName);
            
            console.log(`✅ Archivo Excel generado: ${fileName}`);
        }

        // Función auxiliar para obtener nombre del mes
        function getMonthName(month) {
            const months = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                          'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            return months[parseInt(month) - 1];
        }

        // Ver histórico mensual
        function viewHistory() {
            const historyContent = document.getElementById('historyContent');
            
            if (Object.keys(monthlyHistory).length === 0) {
                historyContent.innerHTML = '<p style="text-align: center; padding: 20px; color: var(--muted);">No hay histórico guardado aún.</p>';
            } else {
                let html = '<table style="width: 100%; border-collapse: collapse;">';
                html += '<thead><tr style="background: var(--bg); color: white;">';
                html += '<th style="padding: 10px; text-align: left;">Mes/Año</th>';
                html += '<th style="padding: 10px; text-align: center;">Paneles</th>';
                html += '<th style="padding: 10px; text-align: right;">Facturación</th>';
                html += '<th style="padding: 10px; text-align: center;">Fecha Guardado</th>';
                html += '</tr></thead><tbody>';
                
                // Ordenar por fecha
                const sortedKeys = Object.keys(monthlyHistory).sort().reverse();
                
                sortedKeys.forEach((key, index) => {
                    const record = monthlyHistory[key];
                    const bgColor = index % 2 === 0 ? 'var(--bg-soft)' : 'var(--card)';
                    const fecha = new Date(record.fecha);
                    const fechaFormat = fecha.toLocaleDateString('es-ES');
                    
                    const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 
                                       'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
                    const monthName = monthNames[parseInt(record.mes) - 1];
                    
                    html += `<tr style="background: ${bgColor};">`;
                    html += `<td style="padding: 10px; color: var(--text);"><strong>${monthName} ${record.year}</strong></td>`;
                    html += `<td style="padding: 10px; text-align: center; color: var(--text);">${record.totalPaneles}</td>`;
                    html += `<td style="padding: 10px; text-align: right; color: var(--text);">${formatEuro(record.facturacionTotal)}</td>`;
                    html += `<td style="padding: 10px; text-align: center; font-size: 13px; color: var(--muted);">${fechaFormat}</td>`;
                    html += '</tr>';
                });
                
                html += '</tbody></table>';
                historyContent.innerHTML = html;
            }
            
            openModal('historyModal');
        }

        // Ver cambios del mes registrados
        function viewMonthlyChanges() {
            if (Object.keys(monthlyChanges).length === 0) {
                alert(' No hay cambios mensuales registrados.\n\nLos cambios se registran automáticamente cuando procesas el archivo de cambios mensuales.');
                return;
            }
            
            let html = '<div style="max-height: 600px; overflow-y: auto;">';
            
            // Ordenar meses cronológicamente (más reciente primero)
            const sortedKeys = Object.keys(monthlyChanges).sort().reverse();
            
            sortedKeys.forEach((monthKey, index) => {
                const cambios = monthlyChanges[monthKey];
                const monthName = getMonthName(cambios.mes);
                const [yyyy] = monthKey.split('-');
                const fechaProceso = new Date(cambios.fecha_proceso).toLocaleString('es-ES');
                
                const totalCambios = 
                    cambios.altas.length + 
                    cambios.bajas.length + 
                    cambios.desmontajes.length + 
                    cambios.cambios_tarifa.length;
                
                html += `<div style="margin-bottom: 24px; padding: 20px; background: ${index % 2 === 0 ? 'var(--bg-soft)' : 'white'}; border-radius: 8px; border: 1px solid var(--border);">`;
                html += `<h3 style="color: var(--primary); margin-bottom: 8px;">${monthName} ${yyyy}</h3>`;
                html += `<p style="font-size: 13px; color: var(--muted); margin-bottom: 16px;">Procesado: ${fechaProceso} | Total cambios: ${totalCambios}</p>`;
                
                // ALTAS
                if (cambios.altas.length > 0) {
                    html += `<div style="margin-bottom: 12px;">`;
                    html += `<h4 style="color: #059669; margin-bottom: 8px;">Altas (${cambios.altas.length})</h4>`;
                    html += `<table style="width: 100%; font-size: 13px; border-collapse: collapse;">`;
                    html += `<tr style="background: #D1FAE5; font-weight: 600;">`;
                    html += `<th style="padding: 6px; text-align: left;">Código</th>`;
                    html += `<th style="padding: 6px; text-align: left;">Municipio</th>`;
                    html += `<th style="padding: 6px; text-align: center;">Fecha instalación</th>`;
                    html += `<th style="padding: 6px; text-align: right;">Tarifa</th>`;
                    html += `</tr>`;
                    
                    cambios.altas.forEach((alta, i) => {
                        const bg = i % 2 === 0 ? '#ECFDF5' : '#F0FDF4';
                        html += `<tr style="background: ${bg};">`;
                        html += `<td style="padding: 6px;"><strong>${alta.codigo}</strong></td>`;
                        html += `<td style="padding: 6px;">${alta.municipio}</td>`;
                        html += `<td style="padding: 6px; text-align: center;">${alta.fechaInstalacion || '-'}</td>`;
                        html += `<td style=\"padding: 6px; text-align: right;\">${alta.tarifa ? formatEuro(alta.tarifa) : 'Base'}</td>`;
                        html += `</tr>`;
                    });
                    
                    html += `</table></div>`;
                }
                
                // BAJAS
                if (cambios.bajas.length > 0) {
                    html += `<div style="margin-bottom: 12px;">`;
                    html += `<h4 style="color: #DC2626; margin-bottom: 8px;">Bajas (${cambios.bajas.length})</h4>`;
                    html += `<table style="width: 100%; font-size: 13px; border-collapse: collapse;">`;
                    html += `<tr style="background: #FEE2E2; font-weight: 600;">`;
                    html += `<th style="padding: 6px; text-align: left;">Código</th>`;
                    html += `<th style="padding: 6px; text-align: left;">Municipio</th>`;
                    html += `<th style="padding: 6px; text-align: center;">Fecha Baja</th>`;
                    html += `<th style="padding: 6px; text-align: left;">Motivo</th>`;
                    html += `</tr>`;
                    
                    cambios.bajas.forEach((baja, i) => {
                        const bg = i % 2 === 0 ? '#FEF2F2' : '#FEE2E2';
                        html += `<tr style="background: ${bg};">`;
                        html += `<td style="padding: 6px;"><strong>${baja.codigo}</strong></td>`;
                        html += `<td style="padding: 6px;">${baja.municipio}</td>`;
                        html += `<td style="padding: 6px; text-align: center;">${baja.fechaBaja || '-'}</td>`;
                        html += `<td style="padding: 6px;">${baja.motivo || '-'}</td>`;
                        html += `</tr>`;
                    });
                    
                    html += `</table></div>`;
                }
                
                // DESMONTAJES
                if (cambios.desmontajes.length > 0) {
                    html += `<div style="margin-bottom: 12px;">`;
                    html += `<h4 style="color: #D97706; margin-bottom: 8px;">Desmontajes (${cambios.desmontajes.length})</h4>`;
                    html += `<table style="width: 100%; font-size: 13px; border-collapse: collapse;">`;
                    html += `<tr style="background: #FED7AA; font-weight: 600;">`;
                    html += `<th style="padding: 6px; text-align: left;">Código</th>`;
                    html += `<th style="padding: 6px; text-align: left;">Municipio</th>`;
                    html += `<th style="padding: 6px; text-align: center;">Fecha Desmontaje</th>`;
                    html += `</tr>`;
                    
                    cambios.desmontajes.forEach((desm, i) => {
                        const bg = i % 2 === 0 ? '#FEF3C7' : '#FED7AA';
                        html += `<tr style="background: ${bg};">`;
                        html += `<td style="padding: 6px;"><strong>${desm.codigo}</strong></td>`;
                        html += `<td style="padding: 6px;">${desm.municipio}</td>`;
                        html += `<td style="padding: 6px; text-align: center;">${desm.fechaDesmontaje || '-'}</td>`;
                        html += `</tr>`;
                    });
                    
                    html += `</table></div>`;
                }
                
                // CAMBIOS DE TARIFA
                if (cambios.cambios_tarifa.length > 0) {
                    html += `<div style="margin-bottom: 12px;">`;
                    html += `<h4 style="color: #7C3AED; margin-bottom: 8px;">Cambios de Tarifa (${cambios.cambios_tarifa.length})</h4>`;
                    html += `<table style="width: 100%; font-size: 13px; border-collapse: collapse;">`;
                    html += `<tr style="background: #DDD6FE; font-weight: 600;">`;
                    html += `<th style="padding: 6px; text-align: left;">Código</th>`;
                    html += `<th style="padding: 6px; text-align: left;">Municipio</th>`;
                    html += `<th style="padding: 6px; text-align: right;">Tarifa Anterior</th>`;
                    html += `<th style="padding: 6px; text-align: right;">Tarifa Nueva</th>`;
                    html += `<th style="padding: 6px; text-align: center;">Fecha Cambio</th>`;
                    html += `</tr>`;
                    
                    cambios.cambios_tarifa.forEach((tarifa, i) => {
                        const bg = i % 2 === 0 ? '#EDE9FE' : '#DDD6FE';
                        html += `<tr style="background: ${bg};">`;
                        html += `<td style="padding: 6px;"><strong>${tarifa.codigo}</strong></td>`;
                        html += `<td style="padding: 6px;">${tarifa.municipio}</td>`;
                        html += `<td style=\"padding: 6px; text-align: right;\">${tarifa.tarifaAnterior ? formatEuro(tarifa.tarifaAnterior) : 'Base'}</td>`;
                        html += `<td style=\"padding: 6px; text-align: right; color: #7C3AED; font-weight: 600;\">${formatEuro(tarifa.tarifaNueva)}</td>`;
                        html += `<td style="padding: 6px; text-align: center;">${tarifa.fechaCambio || '-'}</td>`;
                        html += `</tr>`;
                    });
                    
                    html += `</table></div>`;
                }
                
                html += `</div>`;
            });
            
            html += '</div>';
            
            // Crear modal temporal
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 10000; padding: 20px;';
            
            const content = document.createElement('div');
            content.style.cssText = 'background: white; border-radius: 12px; max-width: 1200px; width: 100%; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column;';
            
            content.innerHTML = `
                <div style="padding: 24px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
                    <h2 style="color: var(--primary); margin: 0;">Historial de Cambios Mensuales</h2>
                    <button onclick="this.closest('.temp-modal').remove()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--muted);">×</button>
                </div>
                <div style="padding: 24px; overflow-y: auto;">
                    ${html}
                </div>
            `;
            
            modal.className = 'temp-modal';
            modal.appendChild(content);
            modal.onclick = (e) => {
                if (e.target === modal) modal.remove();
            };
            
            document.body.appendChild(modal);
        }

        // Exportar histórico completo
        function exportHistory() {
            if (Object.keys(monthlyHistory).length === 0) {
                alert('No hay histórico para exportar');
                return;
            }
            
            let csv = 'Mes,Año,Total Paneles,Facturación Total,Fecha Guardado\n';
            
            const sortedKeys = Object.keys(monthlyHistory).sort();
            sortedKeys.forEach(key => {
                const record = monthlyHistory[key];
                const fecha = new Date(record.fecha).toLocaleDateString('es-ES');
                const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 
                                   'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
                const monthName = monthNames[parseInt(record.mes) - 1];
                
                csv += `${monthName},${record.year},${record.totalPaneles},${record.facturacionTotal.toFixed(2)},${fecha}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `historico_completo_paneles.csv`;
            a.click();
        }

        // Cargar mes específico del histórico
        function loadMonthFromHistory() {
            if (Object.keys(monthlyHistory).length === 0) {
                alert('No hay histórico guardado');
                return;
            }
            
            const month = document.getElementById('currentMonth').value;
            const year = document.getElementById('currentYear').value;
            const monthKey = `${year}-${month}`;
            
            if (monthlyHistory[monthKey]) {
                if (confirm(`Cargar datos guardados de ${month}/${year}?\n\nEsto reemplazará los datos actuales.`)) {
                    panelsData = JSON.parse(JSON.stringify(monthlyHistory[monthKey].paneles));
                    saveData();
                    updateTable();
                    alert('Datos del histórico cargados correctamente');
                }
            } else {
                alert(`No hay datos guardados para ${month}/${year}`);
            }
        }

        // Hacer backup completo (datos actuales + histórico)
        
        // ====================
        // FUNCIONES DEL SISTEMA DE CAMBIOS MENSUALES
        // ====================

        // Función para actualizar dashboard en tiempo real
        async function actualizarDashboard() {
            // Redirigir a la función de estadísticas dinámicas que tiene la lógica correcta
            console.log('📊 actualizarDashboard() → Llamando a actualizarEstadisticas()');
            await actualizarEstadisticas();
        }

        // Toggle dropdown menu
        function toggleDropdownMenu() {
            const dropdown = document.getElementById('dropdownMenu');
            dropdown.classList.toggle('hidden');
            dropdown.classList.toggle('show');
        }

        // Cerrar dropdown al hacer click fuera
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('dropdownMenu');
            const button = document.getElementById('btnCambiosMes');
            
            if (dropdown && button && !dropdown.contains(event.target) && event.target !== button) {
                dropdown.classList.add('hidden');
                dropdown.classList.remove('show');
            }
        });

        // Cerrar modal
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('show');
                modal.classList.add('hidden');
                
                // Limpiar formularios
                const form = modal.querySelector('.modal-body');
                if (form) {
                    const inputs = form.querySelectorAll('input, select, textarea');
                    inputs.forEach(input => {
                        if (input.type === 'checkbox' || input.type === 'radio') {
                            input.checked = false;
                        } else {
                            input.value = '';
                        }
                    });
                }
            }
        }

        // ====================
        // MODAL: ALTA DE PANEL NUEVO
        // ====================

        function openModalAlta() {
            const modal = document.getElementById('modalAlta');
            const selectMunicipio = document.getElementById('altaMunicipio');
            const inputFecha = document.getElementById('altaFecha');
            
            // Poblar municipios únicos
            const municipios = [...new Set(panelsData.map(p => p.municipio))].sort();
            selectMunicipio.innerHTML = '<option value="">Seleccionar municipio...</option>';
            municipios.forEach(m => {
                selectMunicipio.innerHTML += `<option value="${m}">${m}</option>`;
            });
            
            // Establecer fecha actual por defecto
            const today = new Date().toISOString().split('T')[0];
            inputFecha.value = today;
            
            // Mostrar modal
            modal.classList.remove('hidden');
            setTimeout(() => modal.classList.add('show'), 10);
            
            // Calcular vista previa inicial
            actualizarVistaPreviewAlta();
        }

        async function actualizarVistaPreviewAlta() {
            // Verificar que los elementos existen antes de usarlos
            const diasElement = document.getElementById('altaDias');
            const totalElement = document.getElementById('altaTotal');
            const noFacturadoElement = document.getElementById('altaNoFacturado');
            
            if (!diasElement || !totalElement || !noFacturadoElement) {
                console.warn('⚠️ Elementos del modal de alta no encontrados');
                return;
            }

            const fechaElement = document.getElementById('altaFecha');
            const fecha = fechaElement ? fechaElement.value : '';
            
            if (!fecha) {
                diasElement.textContent = '-';
                totalElement.textContent = '-';
                noFacturadoElement.textContent = '-';
                return;
            }

            // Generar ID temporal para el panel nuevo
            const codigoElement = document.getElementById('altaCodigo');
            const codigo = codigoElement ? codigoElement.value.trim() : '';
            
            if (!codigo) {
                diasElement.textContent = '-';
                totalElement.textContent = '-';
                noFacturadoElement.textContent = '-';
                return;
            }

            try {
                // Usar BillingService para previsualización de ALTA
                const preview = await BillingService.previewChange(
                    codigo,
                    BillingService.CHANGE_ACTIONS.ALTA,
                    fecha,
                    { tarifaBaseMes: BillingService.TARIFA_BASE_2025 }
                );

                if (preview.valid) {
                    const { diasFacturables, importeAFacturar, importeNoFacturado, estadoActual, estadoFuturo } = preview.preview;
                    
                    diasElement.textContent = `${diasFacturables} días`;
                    totalElement.textContent = formatearImporteEuro(importeAFacturar);
                    noFacturadoElement.textContent = formatearImporteEuro(importeNoFacturado);
                    
                    // Mostrar información de estado
                    console.log('📊 Previsualización Alta (BillingService):', {
                        codigo,
                        fecha,
                        estadoActual,
                        estadoFuturo,
                        diasFacturables,
                        importeAFacturar,
                        importeNoFacturado
                    });
                } else {
                    // Mostrar error de validación o usar cálculo local
                    console.warn('⚠️ Preview no válido, usando cálculo local:', preview.error);
                    
                    // Fallback al cálculo local
                    const calculo = calcularFacturacionAjustada(fecha, null, 37.70);
                    diasElement.textContent = `${calculo.diasActivos} días`;
                    totalElement.textContent = formatearImporteEuro(calculo.facturacionAjustada);
                    noFacturadoElement.textContent = formatearImporteEuro(calculo.ahorro);
                }
                
            } catch (error) {
                console.error('❌ Error obteniendo previsualización de alta:', error);
                
                // Fallback al cálculo anterior si BillingService falla
                const calculo = calcularFacturacionAjustada(fecha, null, 37.70);
                diasElement.textContent = `${calculo.diasActivos} días`;
                totalElement.textContent = formatearImporteEuro(calculo.facturacionAjustada);
                noFacturadoElement.textContent = formatearImporteEuro(calculo.ahorro);
            }
        }

        async function guardarAlta() {
            const municipio = document.getElementById('altaMunicipio').value;
            const codigo = document.getElementById('altaCodigo').value.trim();
            const fecha = document.getElementById('altaFecha').value;
            const observaciones = document.getElementById('altaObservaciones').value.trim();

            // Validaciones
            if (!municipio) {
                showToast('❌ Por favor selecciona un municipio', 'error');
                return;
            }
            if (!codigo) {
                showToast('❌ Por favor ingresa un código de panel', 'error');
                return;
            }
            if (!fecha) {
                showToast('❌ Por favor selecciona una fecha de instalación', 'error');
                return;
            }

            // Verificar código duplicado en datos locales
            const duplicado = panelsData.find(p => p.codigo.toLowerCase() === codigo.toLowerCase());
            if (duplicado) {
                showToast(`❌ Ya existe un panel con el código "${codigo}"\n\nPor favor usa un código diferente.`, 'error');
                return;
            }

            try {
                // Obtener usuario actual
                const user = firebase.auth().currentUser;
                if (!user) {
                    throw new Error('Usuario no autenticado');
                }

                showToast('Creando panel...', 'info');

                // Aplicar cambio usando BillingService
                const payload = {
                    action: BillingService.CHANGE_ACTIONS.ALTA,
                    effectiveDate: fecha,
                    motivo: observaciones || 'Alta de panel',
                    tarifaBaseMes: BillingService.TARIFA_BASE_2025,
                    uid: user.uid,
                    email: user.email
                };

                const result = await BillingService.applyChange(codigo, payload);

                if (result.success) {
                    if (result.duplicate) {
                        showToast('Panel ya dado de alta anteriormente', 'warning');
                    } else {
                        // Crear nuevo panel en datos locales
                        const nuevoPanel = {
                            municipio: municipio,
                            codigo: codigo,
                            tarifa: BillingService.TARIFA_BASE_2025,
                            fechaInstalacion: fecha,
                            observaciones: observaciones || null,
                            estadoActual: BillingService.PANEL_STATES.ACTIVO
                        };

                        // Añadir a panelsData
                        panelsData.push(nuevoPanel);
                        
                        // Guardar en Firestore legacy si existe
                        if (window.firebaseDB) {
                            try {
                                const { collection, addDoc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
                                await addDoc(collection(window.firebaseDB, 'paneles'), nuevoPanel);
                            } catch (firestoreError) {
                                console.warn('⚠️ Error guardando en Firestore legacy:', firestoreError);
                            }
                        }

                        // Registrar cambio en el sistema legacy si existe
                        if (typeof monthlyChanges !== 'undefined') {
                            const mes = parseInt(document.getElementById('currentMonth').value);
                            const year = parseInt(document.getElementById('currentYear').value);
                            const monthKey = `${year}-${String(mes).padStart(2, '0')}`;
                            
                            if (!monthlyChanges[monthKey]) {
                                monthlyChanges[monthKey] = [];
                            }
                            
                            monthlyChanges[monthKey].push({
                                tipo: 'ALTA',
                                codigo: codigo,
                                municipio: municipio,
                                fecha: fecha,
                                observaciones: observaciones,
                                timestamp: new Date().toISOString()
                            });
                            
                            localStorage.setItem(CHANGES_KEY, JSON.stringify(monthlyChanges));
                        }

                        showToast(`✅ Panel dado de alta exitosamente\n\nCódigo: ${codigo}\nMunicipio: ${municipio}`, 'success');
                    }

                    // Actualizar interfaz
                    updateTable();
                    await actualizarDashboard();
                    if (typeof saveData === 'function') saveData();
                    
                    closeModal('modalAlta');
                } else {
                    throw new Error('Error en la aplicación del cambio');
                }
                
            } catch (error) {
                console.error('❌ Error al guardar:', error);
                showToast(`❌ Error al guardar el panel:\n\n${error.message}`, 'error');
            }
        }

        // ====================
        // MODAL: REINSTALACIñN
        // ====================

        let panelSeleccionadoReinstalacion = null;

        function openModalReinstalacion() {
            const modal = document.getElementById('modalReinstalacion');
            const selectMunicipio = document.getElementById('reinstalacionNuevoMunicipio');
            
            // Poblar municipios
            const municipios = [...new Set(panelsData.map(p => p.municipio))].sort();
            selectMunicipio.innerHTML = '<option value="">Seleccionar municipio...</option>';
            municipios.forEach(m => {
                selectMunicipio.innerHTML += `<option value="${m}">${m}</option>`;
            });
            
            // Inicializar PanelPicker
            createPanelPicker('reinstalacionPanelPicker', {
                onChange: (panel) => {
                    panelSeleccionadoReinstalacion = panel;
                    actualizarVistaPreviewReinstalacion();
                },
                onClear: () => {
                    panelSeleccionadoReinstalacion = null;
                    actualizarVistaPreviewReinstalacion();
                }
            });
            
            // Mostrar modal
            modal.classList.remove('hidden');
            setTimeout(() => modal.classList.add('show'), 10);
            
            panelSeleccionadoReinstalacion = null;
        }

        function buscarPanel(modalType) {
            const query = document.getElementById(`${modalType}Buscar`).value.toLowerCase();
            const resultsContainer = document.getElementById(`${modalType}Results`);
            
            if (query.length < 2) {
                resultsContainer.classList.remove('show');
                resultsContainer.innerHTML = '';
                return;
            }

            // Filtrar paneles según el tipo de modal
            let resultados = [];
            
            if (modalType === 'reinstalacion') {
                // Solo paneles desmontados
                resultados = panelsData.filter(p => 
                    p.fechaDesmontaje && (
                        p.codigo.toLowerCase().includes(query) ||
                        p.municipio.toLowerCase().includes(query)
                    )
                );
            } else if (modalType === 'baja' || modalType === 'desmontaje' || modalType === 'tarifa') {
                // Paneles activos
                resultados = panelsData.filter(p => 
                    !p.fechaDesmontaje && (
                        p.codigo.toLowerCase().includes(query) ||
                        p.municipio.toLowerCase().includes(query)
                    )
                );
            }

            if (resultados.length === 0) {
                const mensaje = modalType === 'reinstalacion' 
                    ? 'No se encontraron paneles desmontados'
                    : 'No se encontraron paneles activos';
                resultsContainer.innerHTML = `<div style="padding: 12px; color: #64748B; font-size: 14px;">${mensaje}</div>`;
            } else {
                resultsContainer.innerHTML = resultados.map(p => `
                    <div class="search-result-item" onclick="seleccionarPanel${modalType.charAt(0).toUpperCase() + modalType.slice(1)}('${p.codigo}')">
                        <div class="search-result-codigo">${p.codigo}</div>
                        <div class="search-result-municipio">${p.municipio}${p.fechaDesmontaje ? '  Desmontado: ' + new Date(p.fechaDesmontaje).toLocaleDateString('es-ES') : ''}</div>
                    </div>
                `).join('');
            }
            
            resultsContainer.classList.add('show');
        }

        function seleccionarPanelReinstalacion(codigo) {
            panelSeleccionadoReinstalacion = panelsData.find(p => p.codigo === codigo);
            
            if (panelSeleccionadoReinstalacion) {
                document.getElementById('reinstalacionPanelInfo').innerHTML = `
                    <strong>${panelSeleccionadoReinstalacion.codigo}</strong><br>
                    <span style="color: #64748B; font-size: 13px;">
                        ${panelSeleccionadoReinstalacion.municipio}  
                        Desmontado: ${new Date(panelSeleccionadoReinstalacion.fechaDesmontaje).toLocaleDateString('es-ES')}
                    </span>
                `;
                
                document.getElementById('reinstalacionResults').classList.remove('show');
                document.getElementById('reinstalacionBuscar').value = panelSeleccionadoReinstalacion.codigo;
            }
        }

        function actualizarVistaPreviewReinstalacion() {
            const panelInfo = document.getElementById('reinstalacionPanelInfo');
            
            if (!panelInfo) {
                console.warn('⚠️ Elemento panelInfo del modal de reinstalación no encontrado');
                return;
            }
            
            if (panelSeleccionadoReinstalacion) {
                panelInfo.innerHTML = `
                    <strong>${panelSeleccionadoReinstalacion.codigo}</strong><br>
                    <span style="color: #64748B; font-size: 13px;">
                        ${panelSeleccionadoReinstalacion.municipio} — Tarifa: ${formatearImporteEuro(panelSeleccionadoReinstalacion.tarifa || 37.70)}/mes
                    </span>
                `;
            } else {
                panelInfo.innerHTML = 'Ningún panel seleccionado';
            }
        }

        async function guardarReinstalacion() {
            if (!panelSeleccionadoReinstalacion) {
                showToast('❌ Por favor selecciona un panel', 'error');
                return;
            }

            const fecha = document.getElementById('reinstalacionFecha').value;
            const cambioMunicipio = document.getElementById('reinstalacionCambioMunicipio').checked;
            const nuevoMunicipio = cambioMunicipio ? document.getElementById('reinstalacionNuevoMunicipio').value : null;

            if (!fecha) {
                showToast('❌ Por favor selecciona una fecha de reinstalación', 'error');
                return;
            }

            if (cambioMunicipio && !nuevoMunicipio) {
                showToast('❌ Por favor selecciona el nuevo municipio', 'error');
                return;
            }

            try {
                // Obtener usuario actual
                const user = firebase.auth().currentUser;
                if (!user) {
                    throw new Error('Usuario no autenticado');
                }

                showToast('Aplicando reinstalación...', 'info');

                // Aplicar cambio usando BillingService
                const motivo = cambioMunicipio ? 
                    `Reinstalación con cambio de municipio: ${nuevoMunicipio}` : 
                    'Reinstalación en mismo municipio';

                const payload = {
                    action: BillingService.CHANGE_ACTIONS.REINSTALACION,
                    effectiveDate: fecha,
                    motivo: motivo,
                    tarifaBaseMes: panelSeleccionadoReinstalacion.tarifa || BillingService.TARIFA_BASE_2025,
                    uid: user.uid,
                    email: user.email
                };

                const result = await BillingService.applyChange(
                    panelSeleccionadoReinstalacion.codigo,
                    payload
                );

                if (result.success) {
                    if (result.duplicate) {
                        showToast('Reinstalación ya aplicada anteriormente', 'warning');
                    } else {
                        // Actualizar datos locales si existe el panel en panelsData
                        const panel = panelsData.find(p => p.codigo === panelSeleccionadoReinstalacion.codigo);
                        if (panel) {
                            panel.fechaDesmontaje = null; // Quitar desmontaje
                            panel.fechaInstalacion = fecha; // Nueva fecha de instalación
                            panel.estadoActual = BillingService.PANEL_STATES.ACTIVO;
                            
                            if (cambioMunicipio) {
                                panel.municipio = nuevoMunicipio;
                            }
                        }

                        // Registrar cambio en el sistema legacy si existe
                        if (typeof monthlyChanges !== 'undefined') {
                            const mes = parseInt(document.getElementById('currentMonth').value);
                            const year = parseInt(document.getElementById('currentYear').value);
                            const monthKey = `${year}-${String(mes).padStart(2, '0')}`;
                            
                            if (!monthlyChanges[monthKey]) {
                                monthlyChanges[monthKey] = [];
                            }
                            
                            monthlyChanges[monthKey].push({
                                tipo: 'REINSTALACION',
                                codigo: panel.codigo,
                                municipio: panel.municipio,
                                fecha: fecha,
                                nuevoMunicipio: nuevoMunicipio,
                                timestamp: new Date().toISOString()
                            });
                            
                            localStorage.setItem(CHANGES_KEY, JSON.stringify(monthlyChanges));
                        }

                        showToast(`✅ Panel reinstalado exitosamente\n\nCódigo: ${panelSeleccionadoReinstalacion.codigo}\nFecha: ${new Date(fecha).toLocaleDateString('es-ES')}${cambioMunicipio ? `\nNuevo municipio: ${nuevoMunicipio}` : ''}`, 'success');
                    }

                    // Actualizar interfaz
                    updateTable();
                    await actualizarDashboard();
                    if (typeof saveData === 'function') saveData();
                    
                    closeModal('modalReinstalacion');
                } else {
                    throw new Error('Error en la aplicación del cambio');
                }
                
            } catch (error) {
                console.error('❌ Error:', error);
                showToast(`❌ Error al reinstalar:\n\n${error.message}`, 'error');
            }
        }

        // ====================
        // MODAL: BAJA DEFINITIVA
        // ====================

        let panelSeleccionadoBaja = null;

        function openModalBaja() {
            const modal = document.getElementById('modalBaja');
            
            // Inicializar PanelPicker
            createPanelPicker('bajaPanelPicker', {
                onChange: (panel) => {
                    panelSeleccionadoBaja = panel;
                    actualizarVistaPreviewBaja();
                },
                onClear: () => {
                    panelSeleccionadoBaja = null;
                    actualizarVistaPreviewBaja();
                }
            });
            
            modal.classList.remove('hidden');
            setTimeout(() => modal.classList.add('show'), 10);
            panelSeleccionadoBaja = null;
        }

        function seleccionarPanelBaja(codigo) {
            panelSeleccionadoBaja = panelsData.find(p => p.codigo === codigo);
            
            if (panelSeleccionadoBaja) {
                document.getElementById('bajaPanelInfo').innerHTML = `
                    <strong>${panelSeleccionadoBaja.codigo}</strong><br>
                    <span style="color: #64748B; font-size: 13px;">
                        ${panelSeleccionadoBaja.municipio}  Tarifa: ${formatEuro(panelSeleccionadoBaja.tarifa || 37.70)}/mes
                    </span>
                `;
                
                document.getElementById('bajaResults').classList.remove('show');
                document.getElementById('bajaBuscar').value = panelSeleccionadoBaja.codigo;
                
                // Actualizar preview
                document.getElementById('bajaFacturacionActual').textContent = formatEuro(panelSeleccionadoBaja.tarifa || 37.70);
                document.getElementById('bajaPerdida').textContent = formatEuro(panelSeleccionadoBaja.tarifa || 37.70);
            }
        }

        function actualizarVistaPreviewBaja() {
            const panelInfo = document.getElementById('bajaPanelInfo');
            const facturacionActualEl = document.getElementById('bajaFacturacionActual');
            const perdidaEl = document.getElementById('bajaPerdida');
            
            if (!panelInfo || !facturacionActualEl || !perdidaEl) {
                console.warn('⚠️ Elementos del modal de baja no encontrados');
                return;
            }
            
            if (panelSeleccionadoBaja) {
                panelInfo.innerHTML = `
                    <strong>${panelSeleccionadoBaja.codigo}</strong><br>
                    <span style="color: #64748B; font-size: 13px;">
                        ${panelSeleccionadoBaja.municipio} — Tarifa: ${formatearImporteEuro(panelSeleccionadoBaja.tarifa || 37.70)}/mes
                    </span>
                `;
                
                // Actualizar preview de facturación
                facturacionActualEl.textContent = formatearImporteEuro(panelSeleccionadoBaja.tarifa || 37.70);
                perdidaEl.textContent = formatearImporteEuro(panelSeleccionadoBaja.tarifa || 37.70);
            } else {
                panelInfo.innerHTML = 'Ningún panel seleccionado';
                facturacionActualEl.textContent = '-';
                perdidaEl.textContent = '-';
            }
        }

        async function guardarBaja() {
            if (!panelSeleccionadoBaja) {
                showToast('❌ Por favor selecciona un panel', 'error');
                return;
            }

            const motivo = document.getElementById('bajaMotivo').value;
            const confirmacion = document.getElementById('bajaConfirmacion').checked;

            if (!motivo) {
                showToast('❌ Por favor selecciona el motivo de la baja', 'error');
                return;
            }

            if (!confirmacion) {
                showToast('❌ Debes confirmar la baja definitiva del panel', 'error');
                return;
            }

            try {
                // Obtener usuario actual
                const user = firebase.auth().currentUser;
                if (!user) {
                    throw new Error('Usuario no autenticado');
                }

                showToast('Aplicando baja definitiva...', 'info');

                // Aplicar cambio usando BillingService
                const payload = {
                    action: BillingService.CHANGE_ACTIONS.BAJA_DEFINITIVA,
                    effectiveDate: new Date().toISOString().split('T')[0], // Fecha actual
                    motivo: motivo,
                    tarifaBaseMes: panelSeleccionadoBaja.tarifa || BillingService.TARIFA_BASE_2025,
                    uid: user.uid,
                    email: user.email
                };

                const result = await BillingService.applyChange(
                    panelSeleccionadoBaja.codigo,
                    payload
                );

                if (result.success) {
                    if (result.duplicate) {
                        showToast('Baja ya aplicada anteriormente', 'warning');
                    } else {
                        // Actualizar datos locales - marcar como BAJA en lugar de eliminar
                        const panel = panelsData.find(p => p.codigo === panelSeleccionadoBaja.codigo);
                        if (panel) {
                            panel.estadoActual = BillingService.PANEL_STATES.BAJA;
                            panel.fechaBaja = new Date().toISOString().split('T')[0];
                            panel.motivoBaja = motivo;
                        }

                        // Registrar cambio en el sistema legacy si existe
                        if (typeof monthlyChanges !== 'undefined') {
                            const mes = parseInt(document.getElementById('currentMonth').value);
                            const year = parseInt(document.getElementById('currentYear').value);
                            const monthKey = `${year}-${String(mes).padStart(2, '0')}`;
                            
                            if (!monthlyChanges[monthKey]) {
                                monthlyChanges[monthKey] = [];
                            }
                            
                            monthlyChanges[monthKey].push({
                                tipo: 'BAJA',
                                codigo: panelSeleccionadoBaja.codigo,
                                municipio: panelSeleccionadoBaja.municipio,
                                motivo: motivo,
                                timestamp: new Date().toISOString()
                            });
                            
                            localStorage.setItem(CHANGES_KEY, JSON.stringify(monthlyChanges));
                        }

                        showToast(`✅ Panel dado de baja exitosamente\n\nCódigo: ${panelSeleccionadoBaja.codigo}\nMotivo: ${motivo}`, 'success');
                    }

                    // Actualizar interfaz
                    updateTable();
                    await actualizarDashboard();
                    if (typeof saveData === 'function') saveData();
                    
                    closeModal('modalBaja');
                } else {
                    throw new Error('Error en la aplicación del cambio');
                }
                
            } catch (error) {
                console.error('❌ Error:', error);
                showToast(`❌ Error al dar de baja:\n\n${error.message}`, 'error');
            }
        }

        // ====================
        // MODAL: DESMONTAJE TEMPORAL
        // ====================

        let panelSeleccionadoDesmontaje = null;

        function openModalDesmontaje() {
            const modal = document.getElementById('modalDesmontaje');
            const inputFecha = document.getElementById('desmontajeFecha');
            
            // Establecer fecha actual
            const today = new Date().toISOString().split('T')[0];
            inputFecha.value = today;
            
            // Inicializar PanelPicker
            createPanelPicker('desmontajePanelPicker', {
                onChange: (panel) => {
                    panelSeleccionadoDesmontaje = panel;
                    actualizarVistaPreviewDesmontaje();
                },
                onClear: () => {
                    panelSeleccionadoDesmontaje = null;
                    actualizarVistaPreviewDesmontaje();
                }
            });
            
            modal.classList.remove('hidden');
            setTimeout(() => modal.classList.add('show'), 10);
            panelSeleccionadoDesmontaje = null;
        }

        function seleccionarPanelDesmontaje(codigo) {
            panelSeleccionadoDesmontaje = panelsData.find(p => p.codigo === codigo);
            
            if (panelSeleccionadoDesmontaje) {
                document.getElementById('desmontajePanelInfo').innerHTML = `
                    <strong>${panelSeleccionadoDesmontaje.codigo}</strong><br>
                    <span style="color: #64748B; font-size: 13px;">
                        ${panelSeleccionadoDesmontaje.municipio}  Tarifa: ${(panelSeleccionadoDesmontaje.tarifa || 37.70).toFixed(2)} €/mes
                    </span>
                `;
                
                document.getElementById('desmontagResults').classList.remove('show');
                document.getElementById('desmontajeBuscar').value = panelSeleccionadoDesmontaje.codigo;
                
                actualizarVistaPreviewDesmontaje();
            }
        }

        async function actualizarVistaPreviewDesmontaje() {
            // Verificar que los elementos existen antes de usarlos
            const diasElement = document.getElementById('desmontajeDias');
            const totalElement = document.getElementById('desmontagTotal');
            const ahorroElement = document.getElementById('desmontagAhorro');
            
            if (!diasElement || !totalElement || !ahorroElement) {
                console.warn('⚠️ Elementos del modal de desmontaje no encontrados');
                return;
            }

            if (!panelSeleccionadoDesmontaje) {
                // Limpiar campos si no hay panel seleccionado
                diasElement.textContent = '-';
                totalElement.textContent = '-';
                ahorroElement.textContent = '-';
                return;
            }

            const fechaElement = document.getElementById('desmontajeFecha');
            const fecha = fechaElement ? fechaElement.value : '';
            
            if (!fecha) {
                diasElement.textContent = '-';
                totalElement.textContent = '-';
                ahorroElement.textContent = '-';
                return;
            }

            try {
                // Usar BillingService para previsualización
                const preview = await BillingService.previewChange(
                    panelSeleccionadoDesmontaje.codigo,
                    BillingService.CHANGE_ACTIONS.DESMONTAJE_TEMPORAL,
                    fecha
                );

                if (preview.valid) {
                    const { diasFacturables, importeAFacturar, importeNoFacturado, estadoActual, estadoFuturo } = preview.preview;
                    
                    diasElement.textContent = `${diasFacturables} días`;
                    totalElement.textContent = formatearImporteEuro(importeAFacturar);
                    ahorroElement.textContent = formatearImporteEuro(importeNoFacturado);
                    
                    // Mostrar información de estado
                    console.log('📊 Previsualización Desmontaje (BillingService):', {
                        panel: panelSeleccionadoDesmontaje.codigo,
                        fecha,
                        estadoActual,
                        estadoFuturo,
                        diasFacturables,
                        importeAFacturar,
                        importeNoFacturado
                    });
                } else {
                    // Mostrar error de validación
                    diasElement.textContent = 'Error';
                    totalElement.textContent = 'Error';
                    ahorroElement.textContent = 'Error';
                    
                    console.error('❌ Error en previsualización:', preview.error);
                    
                    // Mostrar toast de error
                    showToast(`Error: ${preview.error}`, 'error');
                }
                
            } catch (error) {
                console.error('❌ Error obteniendo previsualización:', error);
                
                // Fallback al cálculo anterior si BillingService falla
                const tarifaBase = panelSeleccionadoDesmontaje.tarifa || 37.70;
                const calculo = calcularFacturacionAjustada(null, fecha, tarifaBase);

                diasElement.textContent = `${calculo.diasActivos} días`;
                totalElement.textContent = formatearImporteEuro(calculo.facturacionAjustada);
                ahorroElement.textContent = formatearImporteEuro(calculo.ahorro);
                
                showToast('Usando cálculo local (sin Firestore)', 'warning');
            }
        }

        async function guardarDesmontaje() {
            if (!panelSeleccionadoDesmontaje) {
                alert('❌ Por favor selecciona un panel');
                return;
            }

            const fecha = document.getElementById('desmontajeFecha').value;
            const motivo = document.getElementById('desmontagMotivo').value;

            if (!fecha) {
                alert('❌ Por favor selecciona una fecha de desmontaje');
                return;
            }

            if (!motivo) {
                alert('❌ Por favor selecciona el motivo del desmontaje');
                return;
            }

            try {
                // Obtener usuario actual
                const user = firebase.auth().currentUser;
                if (!user) {
                    throw new Error('Usuario no autenticado');
                }

                // Aplicar cambio usando BillingService
                const payload = {
                    action: BillingService.CHANGE_ACTIONS.DESMONTAJE_TEMPORAL,
                    effectiveDate: fecha,
                    motivo: motivo,
                    tarifaBaseMes: panelSeleccionadoDesmontaje.tarifa || BillingService.TARIFA_BASE_2025,
                    uid: user.uid,
                    email: user.email
                };

                showToast('Aplicando desmontaje...', 'info');

                const result = await BillingService.applyChange(
                    panelSeleccionadoDesmontaje.codigo,
                    payload
                );

                if (result.success) {
                    if (result.duplicate) {
                        showToast('Desmontaje ya aplicado anteriormente', 'warning');
                    } else {
                        // Actualizar datos locales si existe el panel en panelsData
                        const panel = panelsData.find(p => p.codigo === panelSeleccionadoDesmontaje.codigo);
                        if (panel) {
                            panel.fechaDesmontaje = fecha;
                            panel.estadoActual = BillingService.PANEL_STATES.DESMONTADO;
                        }

                        // Registrar cambio en el sistema legacy si existe
                        if (typeof monthlyChanges !== 'undefined') {
                            const mes = parseInt(document.getElementById('currentMonth').value);
                            const year = parseInt(document.getElementById('currentYear').value);
                            const monthKey = `${year}-${String(mes).padStart(2, '0')}`;
                            
                            if (!monthlyChanges[monthKey]) {
                                monthlyChanges[monthKey] = [];
                            }
                            
                            monthlyChanges[monthKey].push({
                                tipo: 'DESMONTAJE',
                                codigo: panel.codigo,
                                municipio: panel.municipio,
                                fecha: fecha,
                                motivo: motivo,
                                timestamp: new Date().toISOString()
                            });
                            
                            localStorage.setItem(CHANGES_KEY, JSON.stringify(monthlyChanges));
                        }

                        showToast(`✅ Panel desmontado exitosamente\n\nCódigo: ${panelSeleccionadoDesmontaje.codigo}\nFecha: ${new Date(fecha).toLocaleDateString('es-ES')}`, 'success');
                    }

                    // Actualizar interfaz
                    updateTable();
                    await actualizarDashboard();
                    if (typeof saveData === 'function') saveData();
                    
                    closeModal('modalDesmontaje');
                } else {
                    throw new Error('Error en la aplicación del cambio');
                }
                
            } catch (error) {
                console.error('❌ Error:', error);
                showToast(`❌ Error al desmontar:\n\n${error.message}`, 'error');
            }
        }

        // ====================
        // MODAL: CAMBIO DE TARIFA
        // ====================

        let panelSeleccionadoTarifa = null;

        function openModalCambioTarifa() {
            const modal = document.getElementById('modalCambioTarifa');
            
            // Inicializar PanelPicker
            createPanelPicker('tarifaPanelPicker', {
                onChange: (panel) => {
                    panelSeleccionadoTarifa = panel;
                    actualizarVistaPreviewTarifa();
                },
                onClear: () => {
                    panelSeleccionadoTarifa = null;
                    actualizarVistaPreviewTarifa();
                }
            });
            
            modal.classList.remove('hidden');
            setTimeout(() => modal.classList.add('show'), 10);
            panelSeleccionadoTarifa = null;
        }

        function seleccionarPanelTarifa(codigo) {
            panelSeleccionadoTarifa = panelsData.find(p => p.codigo === codigo);
            
            if (panelSeleccionadoTarifa) {
                document.getElementById('tarifaPanelInfo').innerHTML = `
                    <strong>${panelSeleccionadoTarifa.codigo}</strong><br>
                    <span style="color: #64748B; font-size: 13px;">
                        ${panelSeleccionadoTarifa.municipio}  Tarifa actual: ${(panelSeleccionadoTarifa.tarifa || 37.70).toFixed(2)} €/mes
                    </span>
                `;
                
                document.getElementById('tarifaResults').classList.remove('show');
                document.getElementById('tarifaBuscar').value = panelSeleccionadoTarifa.codigo;
                
                document.getElementById('tarifaActual').textContent = formatearImporteEuro(panelSeleccionadoTarifa.tarifa || 37.70);
            }
        }

        function actualizarVistaPreviewTarifa() {
            // Verificar que los elementos existen
            const nuevaTarifaEl = document.getElementById('tarifaNueva');
            const nuevaTarifaPreviewEl = document.getElementById('tarifaNuevaPreview');
            const panelesAfectadosEl = document.getElementById('tarifaPanelesAfectados');
            const variacionEl = document.getElementById('tarifaVariacion');
            
            if (!nuevaTarifaEl || !nuevaTarifaPreviewEl || !panelesAfectadosEl || !variacionEl) {
                console.warn('⚠️ Elementos del modal de cambio de tarifa no encontrados');
                return;
            }
            
            const nuevaTarifa = parseFloat(nuevaTarifaEl.value);
            const alcance = document.querySelector('input[name="tarifaAlcance"]:checked')?.value;
            
            if (!nuevaTarifa || isNaN(nuevaTarifa)) {
                nuevaTarifaPreviewEl.textContent = '-';
                panelesAfectadosEl.textContent = '-';
                variacionEl.textContent = '-';
                return;
            }

            nuevaTarifaPreviewEl.textContent = formatearImporteEuro(nuevaTarifa);

            let panelesAfectados = 0;
            let variacion = 0;

            if (alcance === 'solo_este' && panelSeleccionadoTarifa) {
                panelesAfectados = 1;
                variacion = nuevaTarifa - (panelSeleccionadoTarifa.tarifa || 37.70);
            } else if (alcance === 'todos_municipio' && panelSeleccionadoTarifa) {
                const panelesMunicipio = panelsData.filter(p => p.municipio === panelSeleccionadoTarifa.municipio);
                panelesAfectados = panelesMunicipio.length;
                panelesMunicipio.forEach(p => {
                    variacion += nuevaTarifa - (p.tarifa || 37.70);
                });
            } else if (alcance === 'todos') {
                panelesAfectados = panelsData.length;
                panelsData.forEach(p => {
                    variacion += nuevaTarifa - (p.tarifa || 37.70);
                });
            }

            panelesAfectadosEl.textContent = panelesAfectados;
            
            const variacionColor = variacion >= 0 ? '#16A34A' : '#DC2626';
            const variacionSigno = variacion >= 0 ? '+' : '';
            variacionEl.innerHTML = 
                `<span style="color: ${variacionColor};">${variacionSigno}${formatearImporteEuro(Math.abs(variacion))}</span>`;
        }

        async function guardarCambioTarifa() {
            if (!panelSeleccionadoTarifa) {
                alert('ï Por favor selecciona un panel');
                return;
            }

            const nuevaTarifa = parseFloat(document.getElementById('tarifaNueva').value);
            const alcance = document.querySelector('input[name="tarifaAlcance"]:checked')?.value;

            if (!nuevaTarifa || isNaN(nuevaTarifa) || nuevaTarifa <= 0) {
                alert('ï Por favor ingresa una tarifa válida');
                return;
            }

            if (!alcance) {
                alert('ï Por favor selecciona el alcance del cambio');
                return;
            }

            try {
                let panelesModificados = [];

                if (alcance === 'solo_este') {
                    const panel = panelsData.find(p => p.codigo === panelSeleccionadoTarifa.codigo);
                    if (panel) {
                        panel.tarifa = nuevaTarifa;
                        panelesModificados.push(panel.codigo);
                    }
                } else if (alcance === 'todos_municipio') {
                    panelsData.forEach(p => {
                        if (p.municipio === panelSeleccionadoTarifa.municipio) {
                            p.tarifa = nuevaTarifa;
                            panelesModificados.push(p.codigo);
                        }
                    });
                } else if (alcance === 'todos') {
                    panelsData.forEach(p => {
                        p.tarifa = nuevaTarifa;
                        panelesModificados.push(p.codigo);
                    });
                }

                // Registrar cambio
                const mes = parseInt(document.getElementById('currentMonth').value);
                const year = parseInt(document.getElementById('currentYear').value);
                const monthKey = `${year}-${String(mes).padStart(2, '0')}`;
                
                if (!monthlyChanges[monthKey]) {
                    monthlyChanges[monthKey] = [];
                }
                
                monthlyChanges[monthKey].push({
                    tipo: 'CAMBIO_TARIFA',
                    alcance: alcance,
                    nuevaTarifa: nuevaTarifa,
                    panelesAfectados: panelesModificados,
                    municipio: alcance === 'todos_municipio' ? panelSeleccionadoTarifa.municipio : null,
                    timestamp: new Date().toISOString()
                });
                
                localStorage.setItem(CHANGES_KEY, JSON.stringify(monthlyChanges));
                
                // Actualizar interfaz
                updateTable();
                await actualizarDashboard();
                saveData();
                
                alert(` Tarifa actualizada exitosamente\n\nPaneles afectados: ${panelesModificados.length}\nNueva tarifa: ${nuevaTarifa.toFixed(2)} €`);
                closeModal('modalCambioTarifa');
                
            } catch (error) {
                console.error(' Error:', error);
                alert(` Error al cambiar tarifa:\n\n${error.message}`);
            }
        }

        // ====================
        // FIN DEL SISTEMA DE CAMBIOS MENSUALES
        // ====================

        function backupComplete() {
            const backup = {
                fecha_backup: new Date().toISOString(),
                datos_actuales: panelsData,
                historico_mensual: monthlyHistory,
                mes_actual: document.getElementById('currentMonth').value,
                year_actual: document.getElementById('currentYear').value
            };
            
            const json = JSON.stringify(backup, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            const fecha = new Date().toISOString().split('T')[0];
            a.href = url;
            a.download = `backup_completo_${fecha}.json`;
            a.click();
            
            alert(' Backup completo creado\n\nIncluye:\n• Datos actuales\n• Todo el histórico mensual\n• CONFIGURACIÓNn actual');
        }

        // Inicializar event listeners
        // NOTA: loadInitialData() ya NO se llama aquí
        // Se llama automáticamente después de autenticación exitosa
        document.addEventListener('DOMContentLoaded', () => {
            // NO llamar loadInitialData() aquí - se llama en iniciarAplicacion()
            
            document.getElementById('currentMonth').addEventListener('change', updateTable);
            document.getElementById('currentYear').addEventListener('change', updateTable);
            document.getElementById('baseRate').addEventListener('change', updateTable);
            
            // Event listeners para los filtros
            document.getElementById('searchInput')?.addEventListener('input', applyFilters);
            document.getElementById('filterMunicipio')?.addEventListener('change', applyFilters);
            document.getElementById('filterEstado')?.addEventListener('change', applyFilters);
            document.getElementById('filterFacturacion')?.addEventListener('change', applyFilters);
            
            // Event listener para el botón de limpiar filtros
            document.getElementById('clearFiltersBtn')?.addEventListener('click', clearFilters);
            
            // Event listeners para vista previa en tiempo real
            const altaFecha = document.getElementById('altaFecha');
            const altaCodigo = document.getElementById('altaCodigo');
            if (altaFecha) {
                altaFecha.addEventListener('change', actualizarVistaPreviewAlta);
            }
            if (altaCodigo) {
                altaCodigo.addEventListener('input', actualizarVistaPreviewAlta);
            }

            const desmontajeFecha = document.getElementById('desmontajeFecha');
            if (desmontajeFecha) {
                desmontajeFecha.addEventListener('change', actualizarVistaPreviewDesmontaje);
            }

            const tarifaNueva = document.getElementById('tarifaNueva');
            if (tarifaNueva) {
                tarifaNueva.addEventListener('input', actualizarVistaPreviewTarifa);
            }

            const radiosTarifa = document.getElementsByName('tarifaAlcance');
            radiosTarifa.forEach(radio => {
                radio.addEventListener('change', actualizarVistaPreviewTarifa);
            });

            const reinstalacionCambioMunicipio = document.getElementById('reinstalacionCambioMunicipio');
            const reinstalacionNuevoMunicipioGroup = document.getElementById('reinstalacionNuevoMunicipioGroup');
            if (reinstalacionCambioMunicipio && reinstalacionNuevoMunicipioGroup) {
                reinstalacionCambioMunicipio.addEventListener('change', function() {
                    reinstalacionNuevoMunicipioGroup.style.display = this.checked ? 'block' : 'none';
                });
            }
        });
        
        // ===== FUNCIÓN DE MIGRACIÓN DE BILLING SUMMARY =====
        
        /**
         * Ejecuta la migración para reconstruir billing_summary
         */
        window.executeBillingSummaryMigration = async function(monthKey = null) {
            try {
                if (!window.BillingService) {
                    throw new Error('BillingService no está cargado');
                }
                
                showToast('🔄 Iniciando migración de billing_summary...', 'info');
                
                const result = await BillingService.migrateBillingSummary(monthKey);
                
                showToast(`✅ Migración completada:\n\n${result.totalPanelesFacturables} paneles activos\n${formatEuro(result.totalImporteMes)} facturación total`, 'success');
                
                // Actualizar dashboard con los nuevos datos
                await actualizarDashboard();
                
                return result;
                
            } catch (error) {
                console.error('❌ Error en migración:', error);
                showToast(`❌ Error en migración:\n\n${error.message}`, 'error');
                throw error;
            }
        };
        
        // ===== FUNCIÓN DE MIGRACIÓN DE DATOS DESDE JSON A FIRESTORE =====
        
        /**
         * Migra datos de facturación de octubre 2025 desde JSON a panel_month_billing
         * 
         * Esta función:
         * 1. Carga el archivo paneles_octubre_2025.json
         * 2. Para cada panel que NO tiene fechaDesmontaje:
         *    - Crea un registro en panel_month_billing con 30 días facturables
         * 3. Para paneles con fechaDesmontaje:
         *    - Calcula días hasta el desmontaje
         *    - Crea registro con días parciales
         * 4. Actualiza billing_summary con los totales
         * 
         * USO:
         * migrateOctober2025FromJSON()
         */
        window.migrateOctober2025FromJSON = async function() {
            console.log('🔄 Iniciando migración de datos de octubre 2025 desde JSON...');
            
            try {
                // Verificar autenticación
                if (!firebaseAuth.currentUser) {
                    throw new Error('Debes estar autenticado para ejecutar la migración');
                }
                
                const user = firebaseAuth.currentUser;
                const monthKey = '2025-10';
                const monthKeyCompact = '202510';
                const TARIFA_BASE = 37.70;
                const DIAS_BASE = 30;
                
                // 1. Cargar datos desde JSON
                console.log('📦 Cargando datos desde paneles_octubre_2025.json...');
                const response = await fetch('./paneles_octubre_2025.json');
                const panelesJSON = await response.json();
                
                console.log(`✅ ${panelesJSON.length} paneles cargados desde JSON`);
                
                // 2. Procesar cada panel
                let procesados = 0;
                let conFacturacion = 0;
                let sinFacturacion = 0;
                let errores = 0;
                let totalImporteMes = 0;
                
                const batch = firebaseDB.batch();
                const batchSize = 500; // Firestore limit
                let batchCount = 0;
                let batches = [batch];
                
                for (const panel of panelesJSON) {
                    try {
                        const panelId = String(panel.codigo).trim();
                        let diasFacturables = 0;
                        let importeFacturado = 0;
                        
                        // Calcular días facturables
                        if (!panel.fechaDesmontaje) {
                            // Panel activo todo el mes
                            diasFacturables = 30;
                        } else {
                            // Panel desmontado - calcular días hasta desmontaje
                            const fechaDesmontaje = new Date(panel.fechaDesmontaje);
                            const mesPanel = fechaDesmontaje.getMonth() + 1;
                            const yearPanel = fechaDesmontaje.getFullYear();
                            
                            if (yearPanel === 2025 && mesPanel === 10) {
                                // Desmontado en octubre - calcular días
                                diasFacturables = fechaDesmontaje.getDate();
                            } else if (yearPanel > 2025 || (yearPanel === 2025 && mesPanel > 10)) {
                                // Desmontado después de octubre - mes completo
                                diasFacturables = 30;
                            } else {
                                // Desmontado antes de octubre - sin facturación
                                diasFacturables = 0;
                            }
                        }
                        
                        // Calcular importe
                        const tarifaDiaria = TARIFA_BASE / DIAS_BASE;
                        importeFacturado = Math.round(diasFacturables * tarifaDiaria * 100) / 100;
                        
                        // Solo crear registro si hay facturación
                        if (diasFacturables > 0) {
                            const billingDocId = `${panelId}_${monthKeyCompact}`;
                            const billingDocRef = firebaseDB.collection('panel_month_billing').doc(billingDocId);
                            
                            // Crear registro de facturación
                            const currentBatch = batches[batches.length - 1];
                            currentBatch.set(billingDocRef, {
                                panelId: panelId,
                                monthKey: monthKey,
                                totalDiasFacturables: diasFacturables,
                                totalImporte: importeFacturado,
                                acciones: {
                                    MIGRACION_INICIAL: 1
                                },
                                lastChangeAt: firebase.firestore.FieldValue.serverTimestamp(),
                                lastChangeBy: {
                                    uid: user.uid,
                                    email: user.email
                                },
                                migratedFrom: 'paneles_octubre_2025.json',
                                migratedAt: firebase.firestore.FieldValue.serverTimestamp()
                            });
                            
                            batchCount++;
                            
                            // Crear nuevo batch si alcanzamos el límite
                            if (batchCount >= batchSize) {
                                batches.push(firebaseDB.batch());
                                batchCount = 0;
                            }
                            
                            conFacturacion++;
                            totalImporteMes += importeFacturado;
                        } else {
                            sinFacturacion++;
                        }
                        
                        procesados++;
                        
                        // Log de progreso cada 50 paneles
                        if (procesados % 50 === 0) {
                            console.log(`📊 Progreso: ${procesados}/${panelesJSON.length} paneles procesados`);
                        }
                        
                    } catch (error) {
                        console.error(`❌ Error procesando panel ${panel.codigo}:`, error);
                        errores++;
                    }
                }
                
                console.log('💾 Guardando registros en Firestore...');
                
                // Ejecutar todos los batches
                for (let i = 0; i < batches.length; i++) {
                    await batches[i].commit();
                    console.log(`✅ Batch ${i + 1}/${batches.length} guardado`);
                }
                
                // 3. Crear/actualizar billing_summary
                console.log('📊 Actualizando billing_summary...');
                const summaryDocRef = firebaseDB.collection('billing_summary').doc(monthKeyCompact);
                await summaryDocRef.set({
                    monthKey: monthKey,
                    totalPanelesFacturables: conFacturacion,
                    totalImporteMes: Math.round(totalImporteMes * 100) / 100,
                    totalAcciones: conFacturacion,
                    lastChangeAt: firebase.firestore.FieldValue.serverTimestamp(),
                    lastChangeBy: {
                        uid: user.uid,
                        email: user.email
                    },
                    migratedFrom: 'paneles_octubre_2025.json',
                    migratedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                console.log('✅ billing_summary actualizado');
                
                // 4. Resumen final
                const resultado = {
                    totalProcesados: procesados,
                    conFacturacion: conFacturacion,
                    sinFacturacion: sinFacturacion,
                    errores: errores,
                    totalImporteMes: Math.round(totalImporteMes * 100) / 100,
                    monthKey: monthKey
                };
                
                console.log('✅ MIGRACIÓN COMPLETADA:');
                console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
                console.log(`📊 Paneles procesados: ${resultado.totalProcesados}`);
                console.log(`✅ Con facturación: ${resultado.conFacturacion}`);
                console.log(`⚪ Sin facturación: ${resultado.sinFacturacion}`);
                console.log(`❌ Errores: ${resultado.errores}`);
                console.log(`💰 Importe total: ${formatEuro(resultado.totalImporteMes)}`);
                console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
                
                // Actualizar la UI
                alert(`✅ MIGRACIÓN COMPLETADA\n\n` +
                      `Paneles procesados: ${resultado.totalProcesados}\n` +
                      `Con facturación: ${resultado.conFacturacion}\n` +
                      `Sin facturación: ${resultado.sinFacturacion}\n` +
                      `Errores: ${resultado.errores}\n\n` +
                      `Importe total: ${formatEuro(resultado.totalImporteMes)}\n\n` +
                      `Los datos ya están disponibles en la app.`);
                
                // Recargar datos
                await updateTable();
                await actualizarEstadisticas();
                
                return resultado;
                
            } catch (error) {
                console.error('❌ ERROR EN MIGRACIÓN:', error);
                alert(`❌ Error en migración:\n\n${error.message}\n\nRevisa la consola para más detalles.`);
                throw error;
            }
        };
        
        // Para ejecutar la migración desde la consola del navegador:
        // executeBillingSummaryMigration() - migra el mes actual
        // executeBillingSummaryMigration('202410') - migra octubre 2024
        // migrateOctober2025FromJSON() - migra datos de octubre 2025 desde JSON
        
        // ===== FUNCIÓN PARA RECALCULAR BILLING_SUMMARY DESDE DATOS REALES =====
        
        /**
         * Recalcula billing_summary leyendo TODOS los panel_month_billing del mes
         * 
         * Esta función:
         * 1. Lee TODOS los documentos de panel_month_billing para el mes especificado
         * 2. Suma los importes y días REALES de cada panel
         * 3. Cuenta paneles activos (30 días) y pausados (< 30 días)
         * 4. Sobrescribe billing_summary con los datos correctos
         * 
         * USO:
         * recalculateBillingSummary('2025-10')  // Para octubre 2025
         * recalculateBillingSummary()           // Para el mes seleccionado en la UI
         */
        window.recalculateBillingSummary = async function(monthKey = null) {
            console.log('🔄 Iniciando recálculo de billing_summary desde datos reales...');
            
            try {
                // Verificar autenticación
                if (!firebaseAuth.currentUser) {
                    throw new Error('Debes estar autenticado para ejecutar el recálculo');
                }
                
                const user = firebaseAuth.currentUser;
                
                // Si no se especifica monthKey, usar el mes seleccionado en la UI
                if (!monthKey) {
                    const month = parseInt(document.getElementById('currentMonth').value);
                    const year = parseInt(document.getElementById('currentYear').value);
                    monthKey = `${year}-${String(month).padStart(2, '0')}`;
                }
                
                const monthKeyCompact = monthKey.replace('-', '');
                
                console.log(`📊 Recalculando billing_summary para ${monthKey}...`);
                
                // 1. Leer TODOS los panel_month_billing del mes
                console.log('📦 Cargando TODOS los registros de panel_month_billing...');
                const billingSnapshot = await firebaseDB.collection('panel_month_billing')
                    .where('monthKey', '==', monthKey)
                    .get();
                
                console.log(`✅ ${billingSnapshot.size} registros encontrados`);
                
                // 2. Calcular totales REALES
                let totalImporteMes = 0;
                let totalPanelesFacturables = 0;
                let panelesActivos = 0;      // 30 días
                let panelesPausados = 0;     // < 30 días
                let totalDiasFacturables = 0;
                let totalAcciones = 0;
                
                const detallesPaneles = [];
                
                billingSnapshot.forEach(doc => {
                    const data = doc.data();
                    const panelId = data.panelId;
                    const dias = data.totalDiasFacturables || 0;
                    const importe = data.totalImporte || 0;
                    
                    // Acumular totales
                    totalImporteMes += importe;
                    totalDiasFacturables += dias;
                    totalPanelesFacturables++;
                    
                    // Clasificar paneles
                    if (dias >= 30) {
                        panelesActivos++;
                    } else if (dias > 0 && dias < 30) {
                        panelesPausados++;
                    }
                    
                    // Contar acciones
                    const acciones = data.acciones || {};
                    totalAcciones += Object.values(acciones).reduce((sum, count) => sum + count, 0);
                    
                    // Guardar detalles para logging
                    detallesPaneles.push({
                        panelId,
                        dias,
                        importe: Math.round(importe * 100) / 100
                    });
                });
                
                // Redondear importe total
                totalImporteMes = Math.round(totalImporteMes * 100) / 100;
                
                // 3. Mostrar detalles en consola
                console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
                console.log('📊 DATOS REALES CALCULADOS:');
                console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
                console.log(`Total paneles facturables: ${totalPanelesFacturables}`);
                console.log(`  ├─ Activos (30 días): ${panelesActivos}`);
                console.log(`  └─ Pausados (< 30 días): ${panelesPausados}`);
                console.log(`Total días facturables: ${totalDiasFacturables}`);
                console.log(`Total importe mes: ${formatEuro(totalImporteMes)}`);
                console.log(`Total acciones: ${totalAcciones}`);
                console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
                
                // Mostrar primeros 10 paneles como muestra
                console.log('\n📋 Muestra de paneles (primeros 10):');
                detallesPaneles.slice(0, 10).forEach(p => {
                    console.log(`  Panel ${p.panelId}: ${p.dias} días → ${formatEuro(p.importe)}`);
                });
                if (detallesPaneles.length > 10) {
                    console.log(`  ... y ${detallesPaneles.length - 10} paneles más\n`);
                }
                
                // 4. Actualizar billing_summary con datos CORRECTOS
                console.log('💾 Actualizando billing_summary con datos recalculados...');
                const summaryDocRef = firebaseDB.collection('billing_summary').doc(monthKeyCompact);
                
                await summaryDocRef.set({
                    monthKey: monthKey,
                    totalPanelesFacturables: totalPanelesFacturables,
                    totalImporteMes: totalImporteMes,
                    totalDiasFacturables: totalDiasFacturables,
                    totalAcciones: totalAcciones,
                    panelesActivos: panelesActivos,
                    panelesPausados: panelesPausados,
                    lastChangeAt: firebase.firestore.FieldValue.serverTimestamp(),
                    lastChangeBy: {
                        uid: user.uid,
                        email: user.email
                    },
                    recalculatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    recalculatedBy: {
                        uid: user.uid,
                        email: user.email
                    }
                });
                
                console.log('✅ billing_summary actualizado correctamente');
                
                // 5. Resultado final
                const resultado = {
                    monthKey: monthKey,
                    totalPanelesFacturables: totalPanelesFacturables,
                    panelesActivos: panelesActivos,
                    panelesPausados: panelesPausados,
                    totalDiasFacturables: totalDiasFacturables,
                    totalImporteMes: totalImporteMes,
                    totalAcciones: totalAcciones
                };
                
                console.log('\n✅ RECÁLCULO COMPLETADO:');
                console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
                console.log(`Mes: ${monthKey}`);
                console.log(`Total facturación: ${formatEuro(totalImporteMes)}`);
                console.log(`Paneles: ${totalPanelesFacturables}`);
                console.log(`  ├─ Activos: ${panelesActivos}`);
                console.log(`  └─ Pausados: ${panelesPausados}`);
                console.log(`Total días: ${totalDiasFacturables}`);
                console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n');
                
                // Mostrar alerta con resumen
                alert(`✅ RECÁLCULO COMPLETADO\n\n` +
                      `Mes: ${monthKey}\n\n` +
                      `Total facturación: ${formatEuro(totalImporteMes)}\n` +
                      `Paneles: ${totalPanelesFacturables}\n` +
                      `  • Activos: ${panelesActivos}\n` +
                      `  • Pausados: ${panelesPausados}\n\n` +
                      `Los datos del dashboard se actualizarán automáticamente.`);
                
                // 6. Actualizar la UI
                console.log('🔄 Actualizando interfaz...');
                await actualizarEstadisticas();
                
                return resultado;
                
            } catch (error) {
                console.error('❌ ERROR EN RECÁLCULO:', error);
                alert(`❌ Error en recálculo:\n\n${error.message}\n\nRevisa la consola para más detalles.`);
                throw error;
            }
        };
        
        // ===== FUNCIÓN PARA REGENERAR panel_month_billing DESDE CSV CORRECTO =====
        
        /**
         * Regenera TODOS los panel_month_billing de octubre 2025 desde el CSV correcto
         * 
         * Esta función:
         * 1. Lee el archivo CSV con días y facturación EXACTOS
         * 2. Sobrescribe TODOS los panel_month_billing con datos correctos
         * 3. Recalcula billing_summary con los totales correctos
         * 
         * IMPORTANTE: 
         * - El CSV debe estar en: /Documentos Descargados App/paneles_10_2025.csv
         * - Debe tener las columnas: Municipio, Código Parada, Días, Facturación
         * - Sobrescribirá los datos existentes
         * 
         * USO:
         * regenerateFromCorrectCSV()
         */
        window.regenerateFromCorrectCSV = async function() {
            console.log('🔄 Iniciando regeneración desde CSV correcto...');
            
            try {
                // Verificar autenticación
                if (!firebaseAuth.currentUser) {
                    throw new Error('Debes estar autenticado para ejecutar la regeneración');
                }
                
                const user = firebaseAuth.currentUser;
                const monthKey = '2025-10';
                const monthKeyCompact = '202510';
                
                // 1. Leer el CSV correcto
                console.log('📦 Cargando CSV correcto...');
                
                // Leer desde la carpeta public
                const response = await fetch('./paneles_10_2025.csv');
                const csvText = await response.text();
                
                console.log('✅ CSV cargado, parseando datos...');
                
                // Parsear CSV con mejor manejo de espacios y encoding
                const lines = csvText.trim().split('\n').map(line => line.trim());
                const headers = lines[0].split(',').map(h => h.trim());
                
                // Verificar estructura
                console.log('📋 Columnas encontradas:', headers);
                
                const panelesCSV = [];
                let erroresParseo = 0;
                
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i];
                    if (!line) continue; // Saltar líneas vacías
                    
                    // Split por coma pero manteniendo valores
                    const values = line.split(',').map(v => v.trim());
                    
                    if (values.length >= 4) {
                        const municipio = values[0];
                        let codigo = values[1];
                        const diasStr = values[2];
                        const facturacionStr = values[3];
                        
                        // Limpiar código (remover espacios y paréntesis tipo "9657 (48)")
                        codigo = codigo.replace(/\s*\([^)]*\)\s*/g, '').trim();
                        
                        // Parsear números con manejo robusto
                        const dias = parseInt(diasStr.replace(/\s/g, ''));
                        const facturacion = parseFloat(facturacionStr.replace(',', '.').replace(/\s/g, ''));
                        
                        if (codigo && !isNaN(dias) && !isNaN(facturacion) && dias > 0) {
                            panelesCSV.push({
                                municipio,
                                codigo,
                                dias,
                                facturacion
                            });
                        } else {
                            erroresParseo++;
                            console.warn(`⚠️ Línea ${i}: Error parseando - codigo="${codigo}", dias="${diasStr}", facturacion="${facturacionStr}"`);
                        }
                    } else {
                        erroresParseo++;
                        console.warn(`⚠️ Línea ${i}: Formato incorrecto - ${line}`);
                    }
                }
                
                if (erroresParseo > 0) {
                    console.warn(`⚠️ Total errores de parseo: ${erroresParseo}`);
                }
                
                console.log(`✅ ${panelesCSV.length} paneles parseados desde CSV`);
                
                // Mostrar muestra
                console.log('\n📋 Muestra de datos (primeros 5):');
                panelesCSV.slice(0, 5).forEach(p => {
                    console.log(`  ${p.municipio} - Panel ${p.codigo}: ${p.dias} días → ${p.facturacion}€`);
                });
                console.log('');
                
                // 2. Confirmar con el usuario
                const confirmacion = confirm(
                    `⚠️ REGENERACIÓN DESDE CSV CORRECTO\n\n` +
                    `Se van a SOBRESCRIBIR ${panelesCSV.length} registros de panel_month_billing\n` +
                    `con los datos correctos del CSV.\n\n` +
                    `Mes: Octubre 2025\n` +
                    `Archivo: paneles_10_2025.csv\n\n` +
                    `¿Deseas continuar?`
                );
                
                if (!confirmacion) {
                    console.log('❌ Regeneración cancelada por el usuario');
                    return { cancelled: true };
                }
                
                // 3. Procesar cada panel
                let procesados = 0;
                let actualizados = 0;
                let errores = 0;
                let totalImporteMes = 0;
                let totalDiasFacturables = 0;
                let panelesActivos = 0;
                let panelesPausados = 0;
                
                const batch = firebaseDB.batch();
                const batchSize = 500;
                let batchCount = 0;
                let batches = [batch];
                
                for (const panel of panelesCSV) {
                    try {
                        const panelId = String(panel.codigo).trim();
                        const dias = panel.dias;
                        const importe = panel.facturacion;
                        
                        // Solo crear registro si hay facturación
                        if (dias > 0 && importe > 0) {
                            const billingDocId = `${panelId}_${monthKeyCompact}`;
                            const billingDocRef = firebaseDB.collection('panel_month_billing').doc(billingDocId);
                            
                            // Sobrescribir con datos CORRECTOS del CSV
                            const currentBatch = batches[batches.length - 1];
                            currentBatch.set(billingDocRef, {
                                panelId: panelId,
                                monthKey: monthKey,
                                totalDiasFacturables: dias,
                                totalImporte: importe,
                                acciones: {
                                    REGENERACION_CSV: 1
                                },
                                lastChangeAt: firebase.firestore.FieldValue.serverTimestamp(),
                                lastChangeBy: {
                                    uid: user.uid,
                                    email: user.email
                                },
                                regeneratedFrom: 'paneles_10_2025.csv',
                                regeneratedAt: firebase.firestore.FieldValue.serverTimestamp(),
                                municipio: panel.municipio
                            }, { merge: false }); // merge: false para sobrescribir completamente
                            
                            batchCount++;
                            
                            // Crear nuevo batch si alcanzamos el límite
                            if (batchCount >= batchSize) {
                                batches.push(firebaseDB.batch());
                                batchCount = 0;
                            }
                            
                            actualizados++;
                            totalImporteMes += importe;
                            totalDiasFacturables += dias;
                            
                            // Clasificar
                            if (dias >= 30) {
                                panelesActivos++;
                            } else if (dias > 0) {
                                panelesPausados++;
                            }
                        }
                        
                        procesados++;
                        
                        // Log de progreso cada 50 paneles
                        if (procesados % 50 === 0) {
                            console.log(`📊 Progreso: ${procesados}/${panelesCSV.length} paneles procesados`);
                        }
                        
                    } catch (error) {
                        console.error(`❌ Error procesando panel ${panel.codigo}:`, error);
                        errores++;
                    }
                }
                
                console.log('💾 Guardando registros CORREGIDOS en Firestore...');
                
                // Ejecutar todos los batches
                for (let i = 0; i < batches.length; i++) {
                    await batches[i].commit();
                    console.log(`✅ Batch ${i + 1}/${batches.length} guardado`);
                }
                
                // 4. Actualizar billing_summary con datos CORRECTOS
                console.log('📊 Actualizando billing_summary con datos corregidos...');
                
                totalImporteMes = Math.round(totalImporteMes * 100) / 100;
                
                const summaryDocRef = firebaseDB.collection('billing_summary').doc(monthKeyCompact);
                await summaryDocRef.set({
                    monthKey: monthKey,
                    totalPanelesFacturables: actualizados,
                    totalImporteMes: totalImporteMes,
                    totalDiasFacturables: totalDiasFacturables,
                    totalAcciones: actualizados,
                    panelesActivos: panelesActivos,
                    panelesPausados: panelesPausados,
                    lastChangeAt: firebase.firestore.FieldValue.serverTimestamp(),
                    lastChangeBy: {
                        uid: user.uid,
                        email: user.email
                    },
                    regeneratedFrom: 'paneles_10_2025.csv',
                    regeneratedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                console.log('✅ billing_summary actualizado');
                
                // 5. Resumen final
                const resultado = {
                    totalProcesados: procesados,
                    actualizados: actualizados,
                    errores: errores,
                    totalImporteMes: totalImporteMes,
                    totalDiasFacturables: totalDiasFacturables,
                    panelesActivos: panelesActivos,
                    panelesPausados: panelesPausados,
                    monthKey: monthKey
                };
                
                console.log('\n✅ REGENERACIÓN COMPLETADA:');
                console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
                console.log(`📊 Paneles procesados: ${resultado.totalProcesados}`);
                console.log(`✅ Actualizados: ${resultado.actualizados}`);
                console.log(`  ├─ Activos (30 días): ${resultado.panelesActivos}`);
                console.log(`  └─ Pausados (< 30 días): ${resultado.panelesPausados}`);
                console.log(`❌ Errores: ${resultado.errores}`);
                console.log(`💰 Importe total: ${formatEuro(resultado.totalImporteMes)}`);
                console.log(`📅 Días totales: ${resultado.totalDiasFacturables}`);
                console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n');
                
                // Alerta con resumen
                alert(`✅ REGENERACIÓN COMPLETADA\n\n` +
                      `Paneles actualizados: ${resultado.actualizados}\n` +
                      `  • Activos: ${resultado.panelesActivos}\n` +
                      `  • Pausados: ${resultado.panelesPausados}\n\n` +
                      `Total facturación: ${formatEuro(resultado.totalImporteMes)}\n` +
                      `Total días: ${resultado.totalDiasFacturables}\n\n` +
                      `Errores: ${resultado.errores}\n\n` +
                      `Los datos correctos ya están en Firestore.`);
                
                // 6. Actualizar la UI
                console.log('🔄 Actualizando interfaz...');
                await updateTable();
                await actualizarEstadisticas();
                
                return resultado;
                
            } catch (error) {
                console.error('❌ ERROR EN REGENERACIÓN:', error);
                alert(`❌ Error en regeneración:\n\n${error.message}\n\nRevisa la consola para más detalles.`);
                throw error;
            }
        };
        
        // ===== FUNCIÓN PARA GENERAR FACTURACIÓN COMPLETA DESDE FIRESTORE =====
        
        /**
         * Genera facturación de octubre 2025 con LÓGICA CORRECTA:
         * 
         * Para CADA panel en Firestore:
         * 1. Lee el panel de la colección paneles
         * 2. Verifica si tiene eventos en paneles/{id}/changes para octubre 2025
         * 3. Decide facturación:
         *    - SI tiene eventos → usa diasFacturables e importeAFacturar del evento
         *    - SI NO tiene eventos → calcula mes completo (30 días × 37.70€)
         * 4. Crea/actualiza panel_month_billing
         * 5. Recalcula billing_summary
         * 
         * USO:
         * generateCompleteBillingFromFirestore()
         * 
         * @version 2025-11-07-v2
         */
        window.generateCompleteBillingFromFirestore = async function() {
            console.log('🔄 Generando facturación completa desde Firestore con lógica correcta...');
            console.log('📌 Versión: 2025-11-07-v2');
            
            try {
                // Verificar autenticación
                if (!firebaseAuth.currentUser) {
                    throw new Error('Debes estar autenticado para ejecutar esta función');
                }
                
                const user = firebaseAuth.currentUser;
                const monthKey = '2025-10';
                const monthKeyCompact = '202510';
                const TARIFA_BASE = 37.70;
                const DIAS_MES_COMPLETO = 30;
                
                console.log(`📊 Procesando facturación para ${monthKey}...`);
                
                // 1. Obtener TODOS los paneles de la colección paneles
                console.log('📦 Cargando TODOS los paneles desde Firestore...');
                const panelesSnapshot = await firebaseDB.collection('paneles').get();
                
                console.log(`✅ ${panelesSnapshot.size} paneles encontrados en Firestore`);
                
                // 2. Procesar cada panel
                let procesados = 0;
                let conEventos = 0;
                let sinEventos = 0;
                let errores = 0;
                let totalImporteMes = 0;
                let totalDiasFacturables = 0;
                let panelesActivos = 0;
                let panelesPausados = 0;
                
                const batch = firebaseDB.batch();
                const batchSize = 500;
                let batchCount = 0;
                let batches = [batch];
                
                const detallesProcesamiento = [];
                
                for (const panelDoc of panelesSnapshot.docs) {
                    try {
                        const panelData = panelDoc.data();
                        const panelId = String(panelData.codigo || panelDoc.id).trim();
                        
                        // 2.1. Buscar eventos del panel en octubre 2025
                        const changesSnapshot = await panelDoc.ref
                            .collection('changes')
                            .where('monthKey', '==', monthKey)
                            .get();
                        
                        let dias = 0;
                        let importe = 0;
                        let tieneEventos = false;
                        let accionesRegistradas = {};
                        
                        if (!changesSnapshot.empty) {
                            // ✅ TIENE EVENTOS - Usar datos del evento
                            tieneEventos = true;
                            
                            // Sumar todos los eventos del mes (puede haber múltiples)
                            changesSnapshot.forEach(changeDoc => {
                                const changeData = changeDoc.data();
                                dias += changeData.diasFacturables || 0;
                                importe += changeData.importeAFacturar || 0;
                                
                                // Registrar acciones
                                const action = changeData.action;
                                if (action) {
                                    accionesRegistradas[action] = (accionesRegistradas[action] || 0) + 1;
                                }
                            });
                            
                            conEventos++;
                            
                            detallesProcesamiento.push({
                                panelId,
                                tipo: 'CON_EVENTOS',
                                eventos: changesSnapshot.size,
                                dias,
                                importe: Math.round(importe * 100) / 100
                            });
                            
                        } else {
                            // ⚪ NO TIENE EVENTOS - Mes completo
                            tieneEventos = false;
                            dias = DIAS_MES_COMPLETO;
                            importe = TARIFA_BASE;
                            accionesRegistradas = { MES_COMPLETO_SIN_EVENTOS: 1 };
                            
                            sinEventos++;
                            
                            detallesProcesamiento.push({
                                panelId,
                                tipo: 'SIN_EVENTOS',
                                dias,
                                importe
                            });
                        }
                        
                        // Redondear importe
                        importe = Math.round(importe * 100) / 100;
                        
                        // 2.2. Crear/actualizar panel_month_billing
                        if (dias > 0) {
                            const billingDocId = `${panelId}_${monthKeyCompact}`;
                            const billingDocRef = firebaseDB.collection('panel_month_billing').doc(billingDocId);
                            
                            const currentBatch = batches[batches.length - 1];
                            currentBatch.set(billingDocRef, {
                                panelId: panelId,
                                monthKey: monthKey,
                                totalDiasFacturables: dias,
                                totalImporte: importe,
                                acciones: accionesRegistradas,
                                tieneEventos: tieneEventos,
                                lastChangeAt: firebase.firestore.FieldValue.serverTimestamp(),
                                lastChangeBy: {
                                    uid: user.uid,
                                    email: user.email
                                },
                                generatedFrom: 'firestore_complete_logic',
                                generatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                                municipio: panelData.municipio || null
                            });
                            
                            batchCount++;
                            
                            // Crear nuevo batch si es necesario
                            if (batchCount >= batchSize) {
                                batches.push(firebaseDB.batch());
                                batchCount = 0;
                            }
                            
                            totalImporteMes += importe;
                            totalDiasFacturables += dias;
                            
                            // Clasificar
                            if (dias >= 30) {
                                panelesActivos++;
                            } else if (dias > 0) {
                                panelesPausados++;
                            }
                        }
                        
                        procesados++;
                        
                        // Log de progreso cada 50 paneles
                        if (procesados % 50 === 0) {
                            console.log(`📊 Progreso: ${procesados}/${panelesSnapshot.size} paneles | Con eventos: ${conEventos} | Sin eventos: ${sinEventos}`);
                        }
                        
                    } catch (error) {
                        console.error(`❌ Error procesando panel ${panelDoc.id}:`, error);
                        errores++;
                    }
                }
                
                console.log('\n💾 Guardando TODOS los registros en Firestore...');
                
                // Ejecutar todos los batches
                for (let i = 0; i < batches.length; i++) {
                    await batches[i].commit();
                    console.log(`✅ Batch ${i + 1}/${batches.length} guardado`);
                }
                
                // 3. Actualizar billing_summary
                console.log('📊 Actualizando billing_summary...');
                
                totalImporteMes = Math.round(totalImporteMes * 100) / 100;
                const totalPaneles = panelesActivos + panelesPausados;
                
                const summaryDocRef = firebaseDB.collection('billing_summary').doc(monthKeyCompact);
                await summaryDocRef.set({
                    monthKey: monthKey,
                    totalPanelesFacturables: totalPaneles,
                    totalImporteMes: totalImporteMes,
                    totalDiasFacturables: totalDiasFacturables,
                    totalAcciones: conEventos + sinEventos,
                    panelesActivos: panelesActivos,
                    panelesPausados: panelesPausados,
                    panelesConEventos: conEventos,
                    panelesSinEventos: sinEventos,
                    lastChangeAt: firebase.firestore.FieldValue.serverTimestamp(),
                    lastChangeBy: {
                        uid: user.uid,
                        email: user.email
                    },
                    generatedFrom: 'firestore_complete_logic',
                    generatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                console.log('✅ billing_summary actualizado');
                
                // 4. Mostrar resumen
                console.log('\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
                console.log('📊 RESUMEN DE PROCESAMIENTO:');
                console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
                console.log(`Total paneles procesados: ${procesados}`);
                console.log(`  ├─ Con eventos registrados: ${conEventos}`);
                console.log(`  └─ Sin eventos (mes completo): ${sinEventos}`);
                console.log(`\nTotal paneles facturables: ${totalPaneles}`);
                console.log(`  ├─ Activos (30 días): ${panelesActivos}`);
                console.log(`  └─ Pausados (< 30 días): ${panelesPausados}`);
                console.log(`\nTotal facturación: ${formatEuro(totalImporteMes)}`);
                console.log(`Total días: ${totalDiasFacturables}`);
                console.log(`Errores: ${errores}`);
                console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n');
                
                // Mostrar muestra de paneles procesados
                console.log('📋 Muestra de paneles procesados (primeros 10):');
                detallesProcesamiento.slice(0, 10).forEach(p => {
                    const tipo = p.tipo === 'CON_EVENTOS' ? '✅ CON EVENTOS' : '⚪ SIN EVENTOS';
                    const eventos = p.eventos ? ` (${p.eventos} eventos)` : '';
                    console.log(`  ${tipo} - Panel ${p.panelId}${eventos}: ${p.dias} días → ${formatEuro(p.importe)}`);
                });
                if (detallesProcesamiento.length > 10) {
                    console.log(`  ... y ${detallesProcesamiento.length - 10} paneles más\n`);
                }
                
                // Resultado
                const resultado = {
                    totalProcesados: procesados,
                    conEventos: conEventos,
                    sinEventos: sinEventos,
                    totalPanelesFacturables: totalPaneles,
                    panelesActivos: panelesActivos,
                    panelesPausados: panelesPausados,
                    totalImporteMes: totalImporteMes,
                    totalDiasFacturables: totalDiasFacturables,
                    errores: errores,
                    monthKey: monthKey
                };
                
                // Alerta
                alert(`✅ FACTURACIÓN COMPLETA GENERADA\n\n` +
                      `Total paneles: ${procesados}\n` +
                      `  • Con eventos: ${conEventos}\n` +
                      `  • Sin eventos (mes completo): ${sinEventos}\n\n` +
                      `Facturables: ${totalPaneles}\n` +
                      `  • Activos: ${panelesActivos}\n` +
                      `  • Pausados: ${panelesPausados}\n\n` +
                      `Total facturación: ${formatEuro(totalImporteMes)}\n` +
                      `Total días: ${totalDiasFacturables}\n\n` +
                      `Errores: ${errores}`);
                
                // Actualizar UI
                console.log('🔄 Actualizando interfaz...');
                await updateTable();
                await actualizarEstadisticas();
                
                return resultado;
                
            } catch (error) {
                console.error('❌ ERROR:', error);
                alert(`❌ Error generando facturación:\n\n${error.message}\n\nRevisa la consola.`);
                throw error;
            }
        };
        
        // ===== FUNCIÓN DE CÁLCULO DINÁMICO DE FACTURACIÓN =====
        
        /**
         * Calcula facturación de cualquier mes de forma DINÁMICA
         * 
         * LÓGICA:
         * 1. Determina el mes base (mes anterior al consultado)
         * 2. Obtiene la facturación base desde Firestore
         * 3. Calcula eventos del mes consultado en TIEMPO REAL
         * 4. Aplica ajustes proporcionales (precio diario: 1.2567€)
         * 5. Retorna resultado SIN guardarlo (solo lectura)
         * 
         * CARACTERÍSTICAS:
         * - NO modifica datos en Firestore
         * - Calcula cada vez que se consulta
         * - Funciona para presente y futuro
         * - Usa caché inteligente para meses cerrados
         * 
         * @param {string} monthKey - Mes a calcular (formato: 'YYYY-MM')
         * @returns {Object} Resultado con totales y desglose
         */
        window.calcularFacturacionDinamica = async function(monthKey) {
            console.log('='.repeat(60));
            console.log('🧮 CÁLCULO DINÁMICO - LÓGICA ACUMULATIVA');
            console.log(`📅 Mes consultado: ${monthKey}`);
            console.log('='.repeat(60) + '\n');
            
            try {
                // ========================================
                // PASO 1: ENCONTRAR MES BASE
                // ========================================
                console.log('📦 PASO 1: Buscando mes base...');
                
                let mesBase = null;
                let factBase = {};
                let baseImporteTotal = 0;
                const UMBRAL_MES_BASE = 400;

                // Regla especial: si el mes inmediatamente anterior tiene datos (>0), úsalo como base sin umbral
                const [yCur, mCur] = monthKey.split('-').map(Number);
                const prevM = mCur === 1 ? 12 : mCur - 1;
                const prevY = mCur === 1 ? yCur - 1 : yCur;
                const mesAnteriorInmediato = `${prevY}-${String(prevM).padStart(2, '0')}`;
                const snapshotInmediato = await firebaseDB.collection('panel_month_billing')
                    .where('monthKey', '==', mesAnteriorInmediato)
                    .get();
                console.log(`   Chequeo inmediato ${mesAnteriorInmediato}: ${snapshotInmediato.size} registros`);
                if (snapshotInmediato.size > 0) {
                    mesBase = mesAnteriorInmediato;
                    console.log(`✅ Mes base inmediato aceptado sin umbral: ${mesBase} (${snapshotInmediato.size} registros)\n`);
                    snapshotInmediato.forEach(doc => {
                        const data = doc.data();
                        factBase[data.panelId] = {
                            dias: data.totalDiasFacturables || 0,
                            importe: data.totalImporte || 0,
                            municipio: data.municipio || ''
                        };
                        baseImporteTotal += data.totalImporte || 0;
                    });
                }

                // Búsqueda histórica con umbral (solo si no se aceptó el inmediato anterior)
                if (!mesBase) {
                    console.log('   No hay datos en el mes anterior inmediato. Aplicando búsqueda con umbral…');
                    // Buscar hacia atrás hasta encontrar un mes con >400 registros
                    let buscarMes = monthKey;
                    for (let i = 0; i <= 24; i++) {
                        const baseSnapshot = await firebaseDB.collection('panel_month_billing')
                            .where('monthKey', '==', buscarMes)
                            .get();

                        console.log(`   ${buscarMes}: ${baseSnapshot.size} registros`);

                        if (baseSnapshot.size >= UMBRAL_MES_BASE) {
                            mesBase = buscarMes;
                            console.log(`✅ Mes base encontrado: ${mesBase} con ${baseSnapshot.size} paneles\n`);

                            baseSnapshot.forEach(doc => {
                                const data = doc.data();
                                factBase[data.panelId] = {
                                    dias: data.totalDiasFacturables || 0,
                                    importe: data.totalImporte || 0,
                                    municipio: data.municipio || ''
                                };
                                baseImporteTotal += data.totalImporte || 0;
                            });
                            break;
                        }

                        // Retroceder un mes
                        const [y, m] = buscarMes.split('-').map(Number);
                        const mesAnt = m === 1 ? 12 : m - 1;
                        const yearAnt = m === 1 ? y - 1 : y;
                        buscarMes = `${yearAnt}-${String(mesAnt).padStart(2, '0')}`;
                    }
                }
                
                if (!mesBase) {
                    console.error('❌ No se encontró mes base');
                    return {
                        monthKey: monthKey,
                        totalImporte: 0,
                        totalPaneles: 0,
                        panelesActivos: 0,
                        panelesPausados: 0,
                        sinDatos: true,
                        desglose: []
                    };
                }
                
                baseImporteTotal = Math.round(baseImporteTotal * 100) / 100;
                
                // ========================================
                // PASO 2: Si el mes consultado ES el mes base
                // ========================================
                if (monthKey === mesBase) {
                    console.log('📊 El mes consultado ES el mes base');
                    
                    let panelesActivos = 0;
                    let panelesPausados = 0;
                    let totalDias = 0;
                    
                    Object.values(factBase).forEach(panel => {
                        totalDias += panel.dias;
                        if (panel.dias >= 30) panelesActivos++;
                        else if (panel.dias > 0) panelesPausados++;
                    });
                    
                    console.log(`   Base: ${baseImporteTotal.toFixed(2)}€`);
                    console.log(`   Paneles: ${Object.keys(factBase).length} (${panelesActivos} activos, ${panelesPausados} pausados)\n`);
                    
                    return {
                        monthKey: monthKey,
                        totalImporte: baseImporteTotal,
                        totalPaneles: Object.keys(factBase).length,
                        panelesActivos: panelesActivos,
                        panelesPausados: panelesPausados,
                        totalDias: totalDias,
                        mesBase: true,
                        desglose: []
                    };
                }
                
                // ========================================
                // PASO 3: RECOPILAR TODOS LOS EVENTOS
                // ========================================
                console.log(`📦 PASO 2: Recopilando eventos desde ${mesBase} hasta ${monthKey}...`);
                
                // Obtener todos los meses entre base y consultado (EXCLUYENDO el mes consultado)
                const mesesIntermidios = [];
                let mesTemporal = mesBase;
                
                while (mesTemporal < monthKey) {  // ← CAMBIO: < en vez de <=
                    if (mesTemporal !== mesBase) {
                        mesesIntermidios.push(mesTemporal);
                    }
                    
                    const [y, m] = mesTemporal.split('-').map(Number);
                    const mesSig = m === 12 ? 1 : m + 1;
                    const yearSig = m === 12 ? y + 1 : y;
                    mesTemporal = `${yearSig}-${String(mesSig).padStart(2, '0')}`;
                }
                
                console.log(`   Meses a procesar (hasta mes anterior): ${mesesIntermidios.join(', ')}\n`);
                
                // Cargar TODOS los eventos
                const todosLosEventos = [];
                
                for (const mes of mesesIntermidios) {
                    const eventosSnapshot = await firebaseDB.collection('panel_month_billing')
                        .where('monthKey', '==', mes)
                        .get();
                    
                    eventosSnapshot.forEach(doc => {
                        const data = doc.data();
                        todosLosEventos.push({
                            mes: mes,
                            panelId: data.panelId,
                            municipio: data.municipio || '',
                            diasNuevos: data.totalDiasFacturables || 0,
                            importeNuevo: data.totalImporte || 0,
                            acciones: data.acciones || {}
                        });
                    });
                    
                    console.log(`   ${mes}: ${eventosSnapshot.size} eventos`);
                }
                
                console.log(`✅ Total eventos recopilados: ${todosLosEventos.length}\n`);
                
                // ========================================
                // PASO 4: APLICAR EVENTOS ACUMULADOS (hasta el mes anterior)
                // ========================================
                console.log(`📦 PASO 3: Aplicando eventos acumulados (meses intermedios)...`);
                
                const estadoFinal = JSON.parse(JSON.stringify(factBase));
                let eventosAplicados = 0;
                
                todosLosEventos.forEach(evento => {
                    // Actualizar estado final
                    estadoFinal[evento.panelId] = {
                        dias: evento.diasNuevos,
                        importe: evento.importeNuevo,
                        municipio: evento.municipio || estadoFinal[evento.panelId]?.municipio || ''
                    };
                    
                    const numEventos = Object.values(evento.acciones).reduce((a, b) => a + b, 0);
                    eventosAplicados += numEventos;
                });
                
                console.log(`   Eventos aplicados (meses intermedios): ${eventosAplicados}\n`);
                
                // ========================================
                // PASO 5: APLICAR EVENTOS DEL MES CONSULTADO
                // ========================================
                console.log(`📦 PASO 4: Procesando eventos DEL mes consultado (${monthKey})...`);
                
                const desglose = [];
                const eventosDelMes = await firebaseDB.collection('panel_month_billing')
                    .where('monthKey', '==', monthKey)
                    .get();
                
                console.log(`   Eventos encontrados en ${monthKey}: ${eventosDelMes.size}`);
                
                eventosDelMes.forEach(doc => {
                    const data = doc.data();
                    const panelId = data.panelId;
                    const estadoAnterior = estadoFinal[panelId] || { dias: 0, importe: 0, municipio: '' };
                    
                    const diasNuevos = data.totalDiasFacturables || 0;
                    const importeNuevo = data.totalImporte || 0;
                    
                    // Actualizar estado final con datos del mes actual
                    estadoFinal[panelId] = {
                        dias: diasNuevos,
                        importe: importeNuevo,
                        municipio: data.municipio || estadoAnterior.municipio
                    };
                    
                    // Calcular diferencias para el desglose
                    const diferenciaDias = diasNuevos - estadoAnterior.dias;
                    const diferenciaImporte = importeNuevo - estadoAnterior.importe;
                    
                    // ============================================================
                    // CORRECCIÓN: Solo mostrar paneles con EVENTOS REALES
                    // ============================================================
                    
                    // 1. Verificar que tiene acciones documentadas
                    const acciones = data.acciones || {};
                    const tieneAccionesReales = Object.keys(acciones).length > 0 && 
                                                !acciones.REGENERACION_CSV &&  // Excluir regeneraciones automáticas
                                                !data.copiadoDe;                 // Excluir copias automáticas del mes anterior
                    
                    // 2. Contar eventos reales
                    const numEventos = Object.values(acciones).reduce((a, b) => a + b, 0);
                    
                    // 3. Solo agregar al desglose si:
                    //    - Tiene acciones REALES documentadas
                    //    - Y además hay diferencia en días o importe
                    if (tieneAccionesReales && (Math.abs(diferenciaDias) > 0 || Math.abs(diferenciaImporte) > 0.01)) {
                        desglose.push({
                            panelId: panelId,
                            municipio: data.municipio || estadoAnterior.municipio,
                            monthKey: monthKey,
                            eventos: numEventos,
                            diasBase: estadoAnterior.dias,
                            diasNuevos: diasNuevos,
                            diferenciaDias: diferenciaDias,
                            importeBase: estadoAnterior.importe,
                            importeNuevo: importeNuevo,
                            diferenciaImporte: diferenciaImporte
                        });
                    }
                    
                    // Log para debugging: paneles excluidos del desglose
                    if (!tieneAccionesReales && (Math.abs(diferenciaDias) > 0 || Math.abs(diferenciaImporte) > 0.01)) {
                        console.log(`   ⚪ Panel ${panelId} excluido del desglose (sin acciones reales, solo herencia)`);
                    }
                });
                
                console.log(`   Cambios detectados en el mes: ${desglose.length}\n`);
                
                // ========================================
                // PASO 5: CALCULAR TOTALES FINALES
                // ========================================
                console.log(`📦 PASO 4: Calculando totales finales...`);
                
                let totalImporteFinal = 0;
                let totalDias = 0;
                let panelesActivos = 0;
                let panelesPausados = 0;
                
                Object.values(estadoFinal).forEach(panel => {
                    totalImporteFinal += panel.importe;
                    totalDias += panel.dias;
                    if (panel.dias >= 30) panelesActivos++;
                    else if (panel.dias > 0) panelesPausados++;
                });
                
                totalImporteFinal = Math.round(totalImporteFinal * 100) / 100;
                const diferencia = Math.round((totalImporteFinal - baseImporteTotal) * 100) / 100;
                
                console.log('='.repeat(60));
                console.log('✅ RESULTADO FINAL:');
                console.log(`   Base ${mesBase}: ${baseImporteTotal.toFixed(2)}€`);
                console.log(`   Diferencia acumulada: ${diferencia >= 0 ? '+' : ''}${diferencia.toFixed(2)}€`);
                console.log(`   Total ${monthKey}: ${totalImporteFinal.toFixed(2)}€`);
                console.log(`   Paneles: ${Object.keys(estadoFinal).length} (${panelesActivos} activos, ${panelesPausados} pausados)`);
                console.log('='.repeat(60) + '\n');
                
                return {
                    monthKey: monthKey,
                    mesBase: mesBase,
                    baseImporte: baseImporteTotal,
                    totalImporte: totalImporteFinal,
                    diferencia: diferencia,
                    eventosAplicados: eventosAplicados,
                    totalPaneles: Object.keys(estadoFinal).length,
                    panelesActivos: panelesActivos,
                    panelesPausados: panelesPausados,
                    totalDias: totalDias,
                    fromDatabase: true,
                    desglose: desglose
                };
                
            } catch (error) {
                console.error('❌ ERROR en cálculo dinámico:', error);
                throw error;
            }
        };

        // ============================================
        // GESTIÓN DE EVENTOS DEL PANEL
        // ============================================

        /**
         * Ver todos los eventos de un panel
         */
        async function verEventosPanel(panelId, municipio) {
            try {
                console.log(`📋 Abriendo eventos del panel ${panelId}`);
                
                const month = parseInt(document.getElementById('currentMonth').value);
                const year = parseInt(document.getElementById('currentYear').value);
                const monthKey = `${year}-${String(month).padStart(2, '0')}`;
                
                // Primero intentar obtener eventos detallados de la subcolección changes
                let eventos = await BillingService.getPanelChanges(panelId, monthKey);
                
                // Si no hay eventos detallados, buscar datos agregados en panel_month_billing
                let eventoAgregado = null;
                if (eventos.length === 0) {
                    console.log(`ℹ️ No hay eventos detallados. Consultando panel_month_billing...`);
                    const billingDocId = `${panelId}_${monthKey.replace('-', '')}`;
                    const billingSnap = await firebaseDB.collection('panel_month_billing').doc(billingDocId).get();
                    
                    if (billingSnap.exists) {
                        const data = billingSnap.data();
                        console.log(`✅ Encontrado documento agregado en panel_month_billing:`, data);
                        
                        // Construir evento sintético a partir de datos agregados
                        eventoAgregado = {
                            id: billingDocId,
                            panelId: data.panelId || panelId,
                            monthKey: data.monthKey || monthKey,
                            totalDiasFacturables: data.totalDiasFacturables || 0,
                            totalImporte: data.totalImporte || 0,
                            acciones: data.acciones || {},
                            municipio: data.municipio || municipio,
                            esAgregado: true // Marca para renderizar distinto
                        };
                    }
                }
                
                // Actualizar título del modal
                document.getElementById('eventoPanelCodigo').textContent = `${panelId} - ${municipio}`;
                
                // Renderizar lista de eventos
                const listaEventos = document.getElementById('listaEventos');
                
                if (eventos.length === 0 && !eventoAgregado) {
                    listaEventos.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: var(--gray);">
                            <p>No hay eventos registrados para este panel en ${monthKey}</p>
                            <p style="font-size: 12px; color: var(--gray); margin-top: 8px;">No se encontraron datos ni en 'changes' ni en 'panel_month_billing'.</p>
                        </div>
                    `;
                } else if (eventoAgregado && eventos.length === 0) {
                    // Mostrar vista de datos agregados
                    const accionesList = Object.entries(eventoAgregado.acciones)
                        .map(([action, count]) => {
                            const label = {
                                'ALTA': '📈 ALTA',
                                'REINSTALACION': '🔄 REINSTALACIÓN',
                                'DESMONTAJE_TEMPORAL': '📦 DESMONTAJE',
                                'BAJA_DEFINITIVA': '📉 BAJA',
                                'CAMBIO_TARIFA': '💰 CAMBIO TARIFA'
                            }[action] || action;
                            return `<span style="background: #E5E7EB; padding: 4px 10px; border-radius: 12px; font-size: 12px; margin-right: 8px;">${label} (${count})</span>`;
                        })
                        .join('');
                    
                    listaEventos.innerHTML = `
                        <div style="border: 1px solid #E5E7EB; border-radius: 8px; padding: 20px; background: #F9FAFB;">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 16px;">
                                <span style="font-size: 20px;">📊</span>
                                <h3 style="margin: 0; font-size: 16px; font-weight: 600;">Resumen de Facturación del Mes</h3>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                                <div>
                                    <div style="color: var(--gray); font-size: 12px; margin-bottom: 4px;">Días Facturables</div>
                                    <div style="font-size: 24px; font-weight: 700; color: #1F2937;">${eventoAgregado.totalDiasFacturables}</div>
                                </div>
                                <div>
                                    <div style="color: var(--gray); font-size: 12px; margin-bottom: 4px;">Importe Total</div>
                                    <div style="font-size: 24px; font-weight: 700; color: #059669;">${formatEuro(eventoAgregado.totalImporte)}</div>
                                </div>
                            </div>
                            <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #E5E7EB;">
                                <div style="color: var(--gray); font-size: 12px; margin-bottom: 8px;">Acciones del mes</div>
                                <div style="display: flex; flex-wrap: wrap; gap: 8px;">${accionesList || '<span style="color: var(--gray); font-size: 13px;">Sin acciones registradas</span>'}</div>
                            </div>
                            <div style="margin-top: 20px; padding: 12px; background: #FEF3C7; border-left: 3px solid #F59E0B; border-radius: 4px; font-size: 13px; color: #92400E;">
                                <strong>ℹ️ Datos agregados</strong><br>
                                Estos datos provienen de <code>panel_month_billing</code>. No hay eventos detallados en la subcolección <code>changes</code>.
                            </div>
                        </div>
                    `;
                } else {
                    listaEventos.innerHTML = eventos.map((evento, index) => {
                        const fecha = evento.effectiveDate.toDate ? 
                            evento.effectiveDate.toDate().toLocaleDateString('es-ES') : 
                            new Date(evento.effectiveDate).toLocaleDateString('es-ES');
                        
                        const accionLabel = {
                            'ALTA': '📈 ALTA',
                            'REINSTALACION': '🔄 REINSTALACIÓN',
                            'DESMONTAJE_TEMPORAL': '📦 DESMONTAJE',
                            'BAJA_DEFINITIVA': '📉 BAJA',
                            'CAMBIO_TARIFA': '💰 CAMBIO TARIFA'
                        }[evento.action] || evento.action;
                        
                        return `
                            <div class="event-item" style="border-bottom: 1px solid var(--gray-lighter); padding: 16px; position: relative;">
                                <div style="display: flex; justify-content: space-between; align-items: start;">
                                    <div style="flex: 1;">
                                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                                            <span style="font-weight: 600; font-size: 15px;">${accionLabel}</span>
                                            <span style="color: var(--gray); font-size: 13px;">${fecha}</span>
                                        </div>
                                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; font-size: 13px;">
                                            <div>
                                                <span style="color: var(--gray);">Días:</span>
                                                <strong>${evento.diasFacturables || 0}</strong>
                                            </div>
                                            <div>
                                                <span style="color: var(--gray);">Importe:</span>
                                                <strong>${formatEuro(evento.importeAFacturar || 0)}</strong>
                                            </div>
                                            <div>
                                                <span style="color: var(--gray);">Estado:</span>
                                                <strong>${evento.snapshotAfter?.estadoActual || '-'}</strong>
                                            </div>
                                        </div>
                                        ${evento.motivo ? `<div style="margin-top: 8px; font-size: 12px; color: var(--gray);">💬 ${evento.motivo}</div>` : ''}
                                    </div>
                                    <div class="event-actions-menu" style="position: relative;">
                                        <button class="btn-event-menu" onclick="toggleEventMenu(event, ${index})" style="width: 32px; height: 32px; border: 1px solid var(--gray-light); background: white; border-radius: 6px; cursor: pointer; font-size: 18px; line-height: 1;">⋮</button>
                                        <div id="eventMenu${index}" class="event-dropdown hidden" style="position: absolute; right: 0; top: 100%; margin-top: 4px; background: white; border: 1px solid var(--gray-light); border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); min-width: 140px; z-index: 1000;">
                                            <button onclick="verEvento('${panelId}', '${evento.id}', ${index})" style="width: 100%; padding: 10px 16px; text-align: left; border: none; background: none; cursor: pointer; font-size: 14px; border-bottom: 1px solid var(--gray-lighter);">Ver</button>
                                            <button onclick="editarEvento('${panelId}', '${evento.id}', ${index})" style="width: 100%; padding: 10px 16px; text-align: left; border: none; background: none; cursor: pointer; font-size: 14px; border-bottom: 1px solid var(--gray-lighter);">Editar</button>
                                            <button onclick="confirmarEliminarEvento('${panelId}', '${evento.id}', '${accionLabel}', '${fecha}')" style="width: 100%; padding: 10px 16px; text-align: left; border: none; background: none; cursor: pointer; font-size: 14px; color: var(--red);">Eliminar</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                }
                
                // Abrir modal
                document.getElementById('modalEventosPanel').classList.remove('hidden');
                document.getElementById('modalEventosPanel').classList.add('show');
                
            } catch (error) {
                console.error('❌ Error cargando eventos:', error);
                alert(`Error cargando eventos:\n\n${error.message}`);
            }
        }

        /**
         * Toggle del menú de 3 puntos
         */
        function toggleEventMenu(event, index) {
            event.stopPropagation();
            const menu = document.getElementById(`eventMenu${index}`);
            
            // Cerrar todos los demás menús
            document.querySelectorAll('.event-dropdown').forEach(m => {
                if (m !== menu) m.classList.add('hidden');
            });
            
            menu.classList.toggle('hidden');
        }

        // Cerrar menús al hacer click fuera
        document.addEventListener('click', () => {
            document.querySelectorAll('.event-dropdown').forEach(m => m.classList.add('hidden'));
        });

        /**
         * Editar un evento
         */
        async function editarEvento(panelId, eventoId, index) {
            try {
                console.log(`✏️ Editando evento ${eventoId}`);
                
                // Cerrar menú
                // Guard clausula: cuando se invoca desde el desglose no existe el menú de evento
                const menu = document.getElementById(`eventMenu${index}`);
                if (menu) {
                    menu.classList.add('hidden');
                }
                
                // Obtener datos del evento
                const eventos = await BillingService.getPanelChanges(panelId);
                const evento = eventos.find(e => e.id === eventoId);
                
                if (!evento) {
                    throw new Error('Evento no encontrado');
                }
                
                // Rellenar formulario
                document.getElementById('editEventoId').value = eventoId;
                document.getElementById('editEventoPanelId').value = panelId;
                document.getElementById('editEventoAccion').value = evento.action;
                
                const fecha = evento.effectiveDate.toDate ? 
                    evento.effectiveDate.toDate().toISOString().split('T')[0] : 
                    new Date(evento.effectiveDate).toISOString().split('T')[0];
                document.getElementById('editEventoFecha').value = fecha;
                
                document.getElementById('editEventoTarifa').value = evento.tarifaBaseMes || 37.70;
                document.getElementById('editEventoMotivo').value = evento.motivo || '';
                
                // Abrir modal de edición
                document.getElementById('modalEditarEvento').classList.remove('hidden');
                document.getElementById('modalEditarEvento').classList.add('show');
                
                // Actualizar preview
                await actualizarPreviewEdicion();
                
            } catch (error) {
                console.error('❌ Error abriendo edición:', error);
                alert(`Error:\n\n${error.message}`);
            }
        }

        /**
         * Ver un evento (solo lectura)
         */
        async function verEvento(panelId, eventoId, index) {
            try {
                console.log(`👁️ Viendo evento ${eventoId}`);
                const menu = document.getElementById(`eventMenu${index}`);
                if (menu) menu.classList.add('hidden');

                // Reutilizamos getPanelChanges para no tocar servicio (ya trae todos y luego filtramos)
                const eventos = await BillingService.getPanelChanges(panelId);
                const evento = eventos.find(e => e.id === eventoId);
                if (!evento) {
                    alert('Evento no encontrado');
                    return;
                }

                // Construir HTML de detalle
                const fecha = evento.effectiveDate?.toDate ? evento.effectiveDate.toDate() : new Date(evento.effectiveDate);
                const fechaStr = fecha.toLocaleDateString('es-ES');
                const horaStr = fecha.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
                const createdAtDate = evento.createdAt?.toDate ? evento.createdAt.toDate() : null;
                const createdStr = createdAtDate ? `${createdAtDate.toLocaleDateString('es-ES')} ${createdAtDate.toLocaleTimeString('es-ES',{hour:'2-digit',minute:'2-digit'})}` : '—';

                const actionTextMap = {
                    ALTA: 'ALTA',
                    REINSTALACION: 'REINSTALACIÓN',
                    DESMONTAJE_TEMPORAL: 'DESMONTAJE TEMPORAL',
                    BAJA_DEFINITIVA: 'BAJA DEFINITIVA',
                    CAMBIO_TARIFA: 'CAMBIO TARIFA'
                };
                const accion = actionTextMap[evento.action] || evento.action;

                // Crear modal si no existe
                let modal = document.getElementById('modalVerEvento');
                if (!modal) {
                    modal = document.createElement('div');
                    modal.id = 'modalVerEvento';
                    modal.className = 'modal-overlay hidden';
                    modal.innerHTML = `
                        <div class="modal-content" style="max-width:600px;">
                            <div class="modal-header">
                                <h2 style="font-size:20px;font-weight:600;margin:0;">Detalle del Evento</h2>
                                <button class="modal-close" onclick="closeModal('modalVerEvento')">&times;</button>
                            </div>
                            <div class="modal-body" id="detalleEventoBody" style="font-size:14px; line-height:1.5;"></div>
                            <div class="modal-actions" style="display:flex;justify-content:flex-end;margin-top:24px;">
                                <button class="btn-modal-secondary" onclick="closeModal('modalVerEvento')" style="width:auto;">Cerrar</button>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(modal);
                }

                const body = modal.querySelector('#detalleEventoBody');
                body.innerHTML = `
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
                        <div>
                            <div style=\"color:var(--gray);font-size:12px;\">Acción</div>
                            <div style=\"font-weight:600;\">${accion}</div>
                        </div>
                        <div>
                            <div style=\"color:var(--gray);font-size:12px;\">Fecha efectiva</div>
                            <div>${fechaStr} ${horaStr}</div>
                        </div>
                        <div>
                            <div style=\"color:var(--gray);font-size:12px;\">Creado</div>
                            <div>${createdStr}</div>
                        </div>
                        <div>
                            <div style=\"color:var(--gray);font-size:12px;\">Tarifa base mes</div>
                            <div>${(evento.tarifaBaseMes||0).toFixed(2)} €</div>
                        </div>
                        <div>
                            <div style=\"color:var(--gray);font-size:12px;\">Días facturables</div>
                            <div>${evento.diasFacturables||0}</div>
                        </div>
                        <div>
                            <div style=\"color:var(--gray);font-size:12px;\">Importe facturar</div>
                            <div>${formatEuro(evento.importeAFacturar||0)}</div>
                        </div>
                        <div>
                            <div style=\"color:var(--gray);font-size:12px;\">Estado antes</div>
                            <div>${evento.snapshotBefore?.estadoActual || '—'}</div>
                        </div>
                        <div>
                            <div style=\"color:var(--gray);font-size:12px;\">Estado después</div>
                            <div>${evento.snapshotAfter?.estadoActual || '—'}</div>
                        </div>
                    </div>
                    ${evento.motivo ? `<div style=\"margin-top:16px;\">\n                        <div style=\"color:var(--gray);font-size:12px;\">Motivo</div>\n                        <div style=\"background:var(--gray-lighter);padding:12px;border-radius:6px;white-space:pre-wrap;\">${evento.motivo}</div>\n                    </div>` : ''}
                    <div style="margin-top:16px;display:grid;grid-template-columns:1fr 1fr;gap:16px;">
                        <div>
                            <div style=\"color:var(--gray);font-size:12px;\">Usuario</div>
                            <div>${evento.createdBy?.email || '—'}</div>
                        </div>
                        <div>
                            <div style=\"color:var(--gray);font-size:12px;\">Idempotency Key</div>
                            <div style=\"font-size:12px;word-break:break-all;\">${evento.idempotencyKey || '—'}</div>
                        </div>
                    </div>
                `;

                modal.classList.remove('hidden');
                modal.classList.add('show');
            } catch (error) {
                console.error('Error viendo evento', error);
                alert('Error mostrando el evento: ' + error.message);
            }
        }

        /**
         * Actualizar vista previa de edición
         */
        async function actualizarPreviewEdicion() {
            try {
                const panelId = document.getElementById('editEventoPanelId').value;
                const action = document.getElementById('editEventoAccion').value;
                const fecha = document.getElementById('editEventoFecha').value;
                const tarifa = parseFloat(document.getElementById('editEventoTarifa').value) || 37.70;
                
                if (!fecha || !action) return;
                
                const preview = await BillingService.previewChange(panelId, action, fecha, {
                    tarifaBaseMes: tarifa
                });
                
                if (preview.valid) {
                    document.getElementById('editEventoPreview').style.display = 'block';
                    document.getElementById('editPreviewEstadoActual').textContent = preview.preview.estadoActual;
                    document.getElementById('editPreviewEstadoFuturo').textContent = preview.preview.estadoFuturo;
                    document.getElementById('editPreviewDias').textContent = preview.preview.diasFacturables;
                    document.getElementById('editPreviewImporte').textContent = formatEuro(preview.preview.importeAFacturar);
                }
                
            } catch (error) {
                console.error('Error en preview:', error);
            }
        }

        // Listeners para actualizar preview en tiempo real
        ['editEventoAccion', 'editEventoFecha', 'editEventoTarifa'].forEach(id => {
            const elem = document.getElementById(id);
            if (elem) {
                // Actualiza al cambiar y mientras se escribe (instantáneo)
                elem.addEventListener('change', actualizarPreviewEdicion);
                elem.addEventListener('input', actualizarPreviewEdicion);
            }
        });

        /**
         * Toggle del menú de 3 puntos en tabla de desglose
         */
        function toggleDesgloseMenu(event, index) {
            event.stopPropagation();
            const btn = event.currentTarget;
            const menu = document.getElementById(`desgloseMenu${index}`);

            // Cerrar otros menús del desglose
            document.querySelectorAll('.desglose-dropdown').forEach(m => {
                if (m !== menu) m.classList.add('hidden');
            });

            // Si ya está visible, ocultar
            if (!menu.classList.contains('hidden')) {
                menu.classList.add('hidden');
                return;
            }

            // Mostrar temporalmente para medir
            menu.classList.remove('hidden');
            menu.style.visibility = 'hidden';

            const rect = btn.getBoundingClientRect();
            const vw = window.innerWidth;
            const vh = window.innerHeight;
            const menuWidth = Math.max(180, menu.offsetWidth || 180);
            const menuHeight = Math.max(120, menu.offsetHeight || 160);

            let left = rect.right - menuWidth;
            let top = rect.bottom + 6;

            // Ajuste a bordes
            if (left + menuWidth > vw - 8) left = vw - menuWidth - 8;
            if (left < 8) left = 8;
            if (top + menuHeight > vh - 8) top = rect.top - menuHeight - 6;
            if (top < 8) top = 8;

            menu.style.left = `${left}px`;
            menu.style.top = `${top}px`;
            menu.style.visibility = 'visible';

            const closeOnScroll = () => {
                menu.classList.add('hidden');
                window.removeEventListener('scroll', closeOnScroll, true);
            };
            window.addEventListener('scroll', closeOnScroll, true);
        }

        /**
         * Editar el primer evento del panel (acceso rápido)
         */
        async function editarPrimerEvento(panelId, monthKey) {
            try {
                // Leer directamente desde panel_month_billing
                const billingDocId = `${panelId}_${monthKey.replace('-', '')}`;
                console.log(`🔍 Leyendo datos de panel_month_billing/${billingDocId}...`);
                
                const billingSnap = await firebaseDB.collection('panel_month_billing').doc(billingDocId).get();
                
                if (!billingSnap.exists) {
                    alert(
                        `❌ No hay datos de facturación para el panel ${panelId} en ${monthKey}.\n\n` +
                        `El documento panel_month_billing/${billingDocId} no existe en Firestore.`
                    );
                    return;
                }
                
                const data = billingSnap.data();
                console.log(`✅ Datos leídos desde Firestore:`, data);
                
                // Abrir modal de edición con los datos agregados
                await editarDatosAgregados(panelId, monthKey);
                
            } catch (error) {
                console.error('❌ Error:', error);
                alert(`Error: ${error.message}`);
            }
        }

        /**
         * Editar datos agregados de panel_month_billing directamente
         */
        async function editarDatosAgregados(panelId, monthKey) {
            try {
                const billingDocId = `${panelId}_${monthKey.replace('-', '')}`;
                console.log(`📋 Leyendo desde Firestore: panel_month_billing/${billingDocId}...`);
                
                const billingSnap = await firebaseDB.collection('panel_month_billing').doc(billingDocId).get();
                
                if (!billingSnap.exists) {
                    alert(`No hay datos de facturación para el panel ${panelId} en ${monthKey}`);
                    return;
                }
                
                const data = billingSnap.data();
                console.log('✅ Datos leídos de panel_month_billing:', data);
                
                // BUSCAR MUNICIPIO: primero en billing, luego en paneles
                let municipio = data.municipio || null;
                
                if (!municipio) {
                    console.log(`🔍 Municipio no encontrado en panel_month_billing. Buscando en colección 'paneles'...`);
                    
                    const panelIdStr = String(panelId).trim();
                    const panelIdNum = !isNaN(Number(panelIdStr)) ? Number(panelIdStr) : null;
                    
                    // Buscar panel por codigo
                    let panelQuery = await firebaseDB.collection('paneles')
                        .where('codigo', '==', panelIdStr)
                        .limit(1)
                        .get();
                    
                    if (panelQuery.empty && panelIdNum !== null) {
                        panelQuery = await firebaseDB.collection('paneles')
                            .where('codigo', '==', panelIdNum)
                            .limit(1)
                            .get();
                    }
                    
                    if (!panelQuery.empty) {
                        const panelData = panelQuery.docs[0].data();
                        municipio = panelData.municipio || null;
                        console.log(`✅ Municipio encontrado en 'paneles':`, municipio);
                    } else {
                        console.warn(`⚠️ Panel ${panelId} no encontrado en colección 'paneles'`);
                    }
                }
                
                // Rellenar formulario de edición
                document.getElementById('editAgregadoPanelId').value = panelId;
                document.getElementById('editAgregadoMonthKey').value = monthKey;
                document.getElementById('editAgregadoDocId').value = billingDocId;
                document.getElementById('editAgregadoDias').value = data.totalDiasFacturables || 0;
                document.getElementById('editAgregadoTarifa').value = 37.70; // Tarifa base por defecto
                document.getElementById('editAgregadoImporte').value = (data.totalImporte || 0).toFixed(2);
                
                // Mostrar información de contexto (incluyendo municipio)
                document.getElementById('editAgregadoInfo').innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">
                        <div style="background: white; padding: 12px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                            <div style="font-size: 11px; color: #6B7280; font-weight: 500; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px;">Panel</div>
                            <div style="font-size: 20px; font-weight: 700; color: #1F2937;">${panelId}</div>
                        </div>
                        <div style="background: white; padding: 12px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                            <div style="font-size: 11px; color: #6B7280; font-weight: 500; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px;">Municipio</div>
                            <div style="font-size: 16px; font-weight: 600; color: ${municipio ? '#059669' : '#DC2626'};">${municipio || 'Sin asignar'}</div>
                        </div>
                        <div style="background: white; padding: 12px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                            <div style="font-size: 11px; color: #6B7280; font-weight: 500; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px;">Mes</div>
                            <div style="font-size: 16px; font-weight: 600; color: #1F2937;">${monthKey}</div>
                        </div>
                        <div style="background: white; padding: 12px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                            <div style="font-size: 11px; color: #6B7280; font-weight: 500; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px;">Documento</div>
                            <div style="font-size: 11px; font-weight: 500; color: #6B7280; font-family: 'Courier New', monospace;">${billingDocId}</div>
                        </div>
                    </div>
                `;
                
                // Calcular y mostrar preview inicial
                recalcularImporteAgregado();
                
                // Abrir modal
                document.getElementById('modalEditarAgregado').classList.remove('hidden');
                document.getElementById('modalEditarAgregado').classList.add('show');
                
            } catch (error) {
                console.error('❌ Error abriendo editor:', error);
                alert(`Error: ${error.message}`);
            }
        }

        /**
         * Recalcular importe basado en días y tarifa
         */
        function recalcularImporteAgregado() {
            const dias = parseInt(document.getElementById('editAgregadoDias').value) || 0;
            const tarifa = parseFloat(document.getElementById('editAgregadoTarifa').value) || 37.70;
            
            const importe = (dias * tarifa) / 30;
            document.getElementById('editAgregadoImporte').value = importe.toFixed(2);
            
            // Actualizar preview
            const calculoEl = document.getElementById('editAgregadoCalculo');
            if (calculoEl) {
                calculoEl.textContent = `${dias} días × ${tarifa.toFixed(2)}€ ÷ 30 = ${importe.toFixed(2)}€`;
            }
        }

        /**
         * Guardar edición de datos agregados
         */
        async function guardarDatosAgregados() {
            try {
                const docId = document.getElementById('editAgregadoDocId').value;
                const dias = parseInt(document.getElementById('editAgregadoDias').value) || 0;
                const importe = parseFloat(document.getElementById('editAgregadoImporte').value) || 0;
                
                // Validaciones
                if (dias < 0 || dias > 30) {
                    alert('⚠️ Los días deben estar entre 0 y 30');
                    return;
                }
                
                if (importe < 0) {
                    alert('⚠️ El importe no puede ser negativo');
                    return;
                }
                
                console.log(`💾 Actualizando panel_month_billing/${docId} en Firestore...`);
                console.log('📦 Datos a guardar:', { dias, importe });
                
                // Construir objeto de actualización (solo días e importe)
                const updateData = {
                    totalDiasFacturables: dias,
                    totalImporte: importe,
                    lastChangeAt: firebase.firestore.FieldValue.serverTimestamp(),
                    lastChangeBy: {
                        uid: firebaseAuth.currentUser?.uid || 'system',
                        email: firebaseAuth.currentUser?.email || 'system@local'
                    }
                };
                
                await firebaseDB.collection('panel_month_billing').doc(docId).update(updateData);
                
                console.log('✅ Documento actualizado en Firestore');
                alert('✅ Facturación actualizada correctamente');
                
                // Cerrar modal y recargar desglose
                closeModal('modalEditarAgregado');
                
                const mes = parseInt(document.getElementById('currentMonth').value);
                const year = parseInt(document.getElementById('currentYear').value);
                const monthKey = `${year}-${String(mes).padStart(2, '0')}`;
                await mostrarDesgloseEventos(monthKey);
                
            } catch (error) {
                console.error('❌ Error guardando datos:', error);
                alert(`Error al guardar:\n\n${error.message}`);
            }
        }

        /**
         * Fallback: crea un evento base si no hay eventos pero existe facturación agregada
         * Lógica: lee panel_month_billing para estimar días facturables y genera una ALTA
         * que reproduce esos días (día de alta calculado inversamente).
         */
        async function ensureEventoBase(panelId, monthKey) {
            try {
                // PASO 1: Leer documento panel_month_billing usando panelId (codigo) del desglose
                const billingDocId = `${panelId}_${monthKey.replace('-', '')}`;
                console.log(`🔍 Leyendo facturación desde Firestore: panel_month_billing/${billingDocId}...`);
                
                const billingSnap = await firebaseDB.collection('panel_month_billing').doc(billingDocId).get();
                
                if (!billingSnap.exists) {
                    console.warn(`⚠️ panel_month_billing/${billingDocId} no existe en Firestore. No se puede generar evento base.`);
                    return false;
                }
                
                const data = billingSnap.data();
                console.log(`✅ Facturación leída desde Firestore:`, data);
                
                const totalDias = data.totalDiasFacturables || 0;
                const acciones = data.acciones || {};
                const numAcciones = Object.values(acciones).reduce((a,b)=>a+b,0);
                
                if (totalDias <= 0 && numAcciones === 0) {
                    console.warn('⚠️ Facturación sin días ni acciones. No generamos evento.');
                    return false;
                }

                // PASO 2: GARANTIZAR EXISTENCIA DEL DOCUMENTO DEL PANEL EN COLECCIÓN 'paneles'
                console.log(`🔍 Verificando existencia del panel ${panelId} en colección 'paneles'...`);
                const panelIdStr = String(panelId).trim();
                const panelIdNum = !isNaN(Number(panelIdStr)) ? Number(panelIdStr) : null;
                
                // Buscar por campo 'codigo' (string y numérico)
                let panelQuery = await firebaseDB.collection('paneles')
                    .where('codigo', '==', panelIdStr)
                    .limit(1)
                    .get();
                
                if (panelQuery.empty && panelIdNum !== null) {
                    panelQuery = await firebaseDB.collection('paneles')
                        .where('codigo', '==', panelIdNum)
                        .limit(1)
                        .get();
                }

                let panelDocRef = null;
                if (!panelQuery.empty) {
                    panelDocRef = panelQuery.docs[0].ref;
                    console.log(`✅ Panel encontrado en 'paneles' con docId: ${panelDocRef.id}`);
                } else {
                    // Panel NO existe: crearlo con estructura mínima
                    console.warn(`⚠️ Panel ${panelIdStr} NO existe en 'paneles'. Creándolo...`);
                    const uid = firebaseAuth.currentUser?.uid || 'system';
                    const email = firebaseAuth.currentUser?.email || 'system@local';
                    
                    const newPanelData = {
                        codigo: panelIdStr,
                        municipio: data.municipio || '',
                        tarifaBaseMes: BillingService.TARIFA_BASE_2025,
                        estadoActual: 'ACTIVO',
                        effectiveRanges: [],
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        createdBy: { uid, email }
                    };
                    
                    panelDocRef = await firebaseDB.collection('paneles').add(newPanelData);
                    console.log(`✅ Panel creado en 'paneles' con docId: ${panelDocRef.id}`);
                }

                // Ahora SÍ podemos crear el evento con applyChange
                const diasClamped = Math.min(30, Math.max(1, totalDias));
                let diaAlta = 30 - diasClamped + 1;
                diaAlta = Math.min(30, Math.max(1, diaAlta));
                const effectiveDate = `${monthKey}-${String(diaAlta).padStart(2,'0')}`;
                
                const payload = {
                    action: 'ALTA',
                    effectiveDate: effectiveDate,
                    motivo: `Evento base autogenerado (reconstrucción desde panel_month_billing: ${totalDias} días)`,
                    tarifaBaseMes: data.totalImporte ? (data.totalImporte / (totalDias/30)) : BillingService.TARIFA_BASE_2025,
                    uid: firebaseAuth.currentUser?.uid || 'system',
                    email: firebaseAuth.currentUser?.email || 'system@local'
                };
                console.log('🛠️ Generando evento base con payload:', payload);
                const result = await BillingService.applyChange(panelId, payload);
                if (result?.success) {
                    console.log('✅ Evento base creado');
                    return true;
                }
                console.warn('⚠️ applyChange no devolvió success para evento base');
                return false;
            } catch (e) {
                console.error('❌ Error creando evento base:', e);
                return false;
            }
        }

        /**
         * Eliminar el primer evento del panel (acceso rápido)
         */
        async function eliminarPrimerEvento(panelId, monthKey, municipio) {
            try {
                // Leer directamente desde panel_month_billing
                const billingDocId = `${panelId}_${monthKey.replace('-', '')}`;
                console.log(`🔍 Buscando facturación en panel_month_billing/${billingDocId}...`);
                
                const billingSnap = await firebaseDB.collection('panel_month_billing').doc(billingDocId).get();
                
                if (!billingSnap.exists) {
                    alert(
                        `❌ No hay datos de facturación para el panel ${panelId} en ${monthKey}.\n\n` +
                        `El documento panel_month_billing/${billingDocId} no existe en Firestore.`
                    );
                    return;
                }
                
                const data = billingSnap.data();
                console.log(`✅ Datos leídos desde Firestore:`, data);
                
                // Confirmar eliminación
                const confirmacion = confirm(
                    `¿Estás seguro de que quieres eliminar los datos de facturación del panel ${panelId} en ${monthKey}?\n\n` +
                    `Municipio: ${data.municipio || 'N/A'}\n` +
                    `Días: ${data.totalDiasFacturables || 0}\n` +
                    `Importe: ${formatEuro(data.totalImporte || 0)}\n\n` +
                    `Esta acción eliminará el documento panel_month_billing/${billingDocId}`
                );
                
                if (!confirmacion) return;
                
                console.log(`🗑️ Eliminando panel_month_billing/${billingDocId}...`);
                await firebaseDB.collection('panel_month_billing').doc(billingDocId).delete();
                
                alert('✅ Datos de facturación eliminados correctamente');
                
                // Recargar desglose
                const mes = parseInt(document.getElementById('currentMonth').value);
                const year = parseInt(document.getElementById('currentYear').value);
                const currentMonthKey = `${year}-${String(mes).padStart(2, '0')}`;
                await mostrarDesgloseEventos(currentMonthKey);
                
            } catch (error) {
                console.error('❌ Error:', error);
                alert(`Error: ${error.message}`);
            }
        }

        /**
         * Guardar edición del evento
         */
        async function guardarEdicionEvento() {
            try {
                const eventoId = document.getElementById('editEventoId').value;
                const panelId = document.getElementById('editEventoPanelId').value;
                const action = document.getElementById('editEventoAccion').value;
                const fecha = document.getElementById('editEventoFecha').value;
                const tarifa = parseFloat(document.getElementById('editEventoTarifa').value) || 37.70;
                const motivo = document.getElementById('editEventoMotivo').value;
                
                if (!fecha || !action) {
                    alert('Por favor completa todos los campos requeridos');
                    return;
                }
                
                const payload = {
                    action: action,
                    effectiveDate: fecha,
                    tarifaBaseMes: tarifa,
                    motivo: motivo,
                    uid: firebaseAuth.currentUser.uid,
                    email: firebaseAuth.currentUser.email
                };
                
                console.log('💾 Guardando cambios del evento...');
                
                await BillingService.updateChange(panelId, eventoId, payload);
                
                alert('✅ Evento actualizado exitosamente');
                
                // Cerrar modales y recargar
                closeModal('modalEditarEvento');
                closeModal('modalEventosPanel');
                await updateTable();
                await actualizarDashboard();
                
            } catch (error) {
                console.error('❌ Error guardando evento:', error);
                alert(`Error al guardar:\n\n${error.message}`);
            }
        }

        /**
         * Confirmar eliminación de evento
         */
        function confirmarEliminarEvento(panelId, eventoId, accionLabel, fecha) {
            if (confirm(`¿Seguro que deseas eliminar este evento?\n\n${accionLabel}\nFecha: ${fecha}\n\nEsta acción recalculará automáticamente la facturación del mes.`)) {
                eliminarEvento(panelId, eventoId);
            }
        }

        /**
         * Eliminar evento
         */
        async function eliminarEvento(panelId, eventoId) {
            try {
                console.log('🗑️ Eliminando evento...');
                
                await BillingService.deleteChange(panelId, eventoId);
                
                alert('✅ Evento eliminado y facturación recalculada');
                
                // Cerrar modal y recargar
                closeModal('modalEventosPanel');
                await updateTable();
                await actualizarDashboard();
                
            } catch (error) {
                console.error('❌ Error eliminando evento:', error);
                alert(`Error al eliminar:\n\n${error.message}`);
            }
        }
        
    </script>    </script>

        <!-- ============================================
             BOTñN FLOTANTE MINIMALISTA
             ============================================ -->
        <button class="minimal-fab" onclick="toggleDropdownMenu()" title="añadir nuevo cambio">
            +
        </button>

    </div> <!-- Fin de minimal-main -->
    </div> <!-- Fin de appContainer -->
</body>
</html>















